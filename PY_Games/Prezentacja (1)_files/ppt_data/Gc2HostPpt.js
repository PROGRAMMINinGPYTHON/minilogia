var Gc2HostPpt=function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}({5:function(e,t,r){"use strict";function i(e){if(null===e)return"";let t=e.toString().toUpperCase();return t.startsWith("{")||(t="{"+t),t.endsWith("}")||(t+="}"),t}r.d(t,"a",(function(){return i}))},7:function(e,t,r){"use strict";r.r(t),r.d(t,"pptGraphicFactoryGlobal",(function(){return lc}));var i=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};function n(e,t){return i(this,void 0,void 0,(function*(){try{yield t(e)}finally{e.dispose()}}))}let s={logOperation(e){},logTrace(e){}};function o(e,t,r){s.logTrace({level:0,id:e,category:t,message:r})}function a(e,t,r){s.logTrace({level:1,id:e,category:t,message:r})}function h(e,t,r){s.logTrace({level:2,id:e,category:t,message:r})}class c{constructor(e){this.props=new Map,this.name=e,performance.mark(this.getStartMarker())}setProp(e,t){this.props.set(e,t.toString())}dispose(){performance.mark(this.getEndMarker()),performance.measure(this.name,this.getStartMarker(),this.getEndMarker());const e=performance.getEntriesByName(this.name,"measure");e.length>0&&function(e,t,r){s.logOperation({name:e,durationMs:t,props:r})}(this.name,e[e.length-1].duration,this.props.size>0?this.props:void 0),performance.clearMarks(this.getStartMarker()),performance.clearMarks(this.getEndMarker()),performance.clearMeasures(this.name)}getStartMarker(){return this.name+".Start"}getEndMarker(){return this.name+".End"}}var l=function(){function e(){}return e.Error=function(t,r){return e.s_logger.sendTraceTag(t,306,10,r),new Error(r+" "+t)},e.Message=function(t,r){e.s_logger.sendTraceTag(t,306,50,r)},e.setLogger=function(t){t&&(e.s_logger=t)},e.s_logger={sendTraceTag:function(e,t,r,i){console.log(e,i)},shipAssertTag:function(){},debugAssertTag:function(){}},e}(),u=(function(){function e(){}e.load=function(t){e.m_settings=t},e.readBooleanOrDefault=function(t,r){var i=void 0===e.m_settings?"":typeof e.m_settings[t];return"string"===i?"true"===e.m_settings[t].toLowerCase():"boolean"===i?e.m_settings[t]:r},e.readNumberOrDefault=function(t,r){var i=void 0===e.m_settings?"":typeof e.m_settings[t];return"string"===i||"number"===i?Number(e.m_settings[t]):r},e.readStringOrDefault=function(t,r){return void 0===e.m_settings||"string"!=typeof e.m_settings[t]?r:e.m_settings[t]}}(),!0);var d=1,f=8,p=16;var g=0;
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var m=function(e,t){return(m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function _(e,t){function r(){this.constructor=e}m(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var v=function(){return(v=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function y(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))}function b(e,t){var r,i,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,i&&(n=2&s[0]?i.return:s[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,s[1])).done)return n;switch(i=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],i=0}finally{r=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}Object.create;Object.create;var w=function(){function e(e,t){this.x=e,this.y=t}return e.Flip=function(t,r){return new e(t?-1:1,r?-1:1)},e.prototype.negate=function(){return new e(-this.x,-this.y)},e.prototype.inverse=function(){return new e(1/this.x,1/this.y)},e.prototype.normalized=function(){var e=this.length();return e?this.scale(1/e):void 0},e.prototype.abs=function(){return new e(Math.abs(this.x),Math.abs(this.y))},e.prototype.floor=function(){return new e(Math.floor(this.x),Math.floor(this.y))},e.prototype.ceil=function(){return new e(Math.ceil(this.x),Math.ceil(this.y))},e.prototype.sign=function(){return new e(this.x<0?-1:1,this.y<0?-1:1)},e.prototype.isZero=function(){return 0==this.x&&0==this.y},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.Distance=function(e,t){return e.subtract(t).length()},e.prototype.equals=function(e){return this.x==e.x&&this.y==e.y},e.prototype.equalsWithEpsilon=function(e,t){return void 0===t&&(t=.001),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t},e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y)},e.prototype.subtract=function(t){return new e(this.x-t.x,this.y-t.y)},e.prototype.multiply=function(t){return new e(this.x*t.x,this.y*t.y)},e.prototype.divide=function(t){return new e(this.x/t.x,this.y/t.y)},e.prototype.dot=function(e){return this.x*e.x+this.y*e.y},e.prototype.scale=function(t){return new e(this.x*t,this.y*t)},e.prototype.rotate=function(t){return t?new e(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t)):this},e.prototype.transformVector=function(e){return e.transformVector(this)},e.prototype.transformPoint=function(e){return e.transformPoint(this)},e.InterpolateLinear=function(e,t,r){return e.add(t.subtract(e).scale(r))},e.InterpolateQuadratic=function(t,r,i,n){return e.InterpolateLinear(e.InterpolateLinear(t,r,n),e.InterpolateLinear(r,i,n),n)},e.QuadraticTangent=function(t,r,i,n){return e.InterpolateLinear(r,i,n).subtract(e.InterpolateLinear(t,r,n)).normalized()},e.CalculateLineIntersection=function(t,r,i,n,s){void 0===s&&(s=.001);var o=(n.x-i.x)*(t.y-i.y)-(n.y-i.y)*(t.x-i.x),a=(n.y-i.y)*(r.x-t.x)-(n.x-i.x)*(r.y-t.y);if(Math.abs(a)>s)return e.InterpolateLinear(t,r,o/a)},e.MeasureQuadraticLength=function(e,t,r){return I(e.x,e.y,t.x,t.y,r.x,r.y)},e.Zero=new e(0,0),e.One=new e(1,1),e}(),T=function(){function e(e,t,r,i,n,s,o,a,h){this.m=new Float32Array([e,t,r,i,n,s,o,a,h])}return e.prototype.toMatrix3=function(){return this},e.prototype.isIdentity=function(){return this==e.Identity||this.equals(e.Identity)},e.prototype.multiply=function(t){var r=this.m,i=t.m;return new e(r[0]*i[0]+r[1]*i[3]+r[2]*i[6],r[0]*i[1]+r[1]*i[4]+r[2]*i[7],r[0]*i[2]+r[1]*i[5]+r[2]*i[8],r[3]*i[0]+r[4]*i[3]+r[5]*i[6],r[3]*i[1]+r[4]*i[4]+r[5]*i[7],r[3]*i[2]+r[4]*i[5]+r[5]*i[8],r[6]*i[0]+r[7]*i[3]+r[8]*i[6],r[6]*i[1]+r[7]*i[4]+r[8]*i[7],r[6]*i[2]+r[7]*i[5]+r[8]*i[8])},e.prototype.inverse=function(){var t=this.m,r=t[0]*t[4]-t[1]*t[3];return 0==r?void 0:new e(t[4]/r,-t[1]/r,0,-t[3]/r,t[0]/r,0,(t[3]*t[7]-t[4]*t[6])/r,(-t[0]*t[7]+t[1]*t[6])/r,1)},e.prototype.transformVector=function(e){return new w(e.x*this.m[0]+e.y*this.m[3],e.x*this.m[1]+e.y*this.m[4])},e.prototype.transformPoint=function(e){return new w(e.x*this.m[0]+e.y*this.m[3]+this.m[6],e.x*this.m[1]+e.y*this.m[4]+this.m[7])},e.prototype.isSimpleScaleTranslationOnly=function(){return 0==this.m[1]&&0==this.m[2]&&0==this.m[3]&&0==this.m[5]&&1==this.m[8]},e.prototype.getSimpleScale=function(){return new w(this.m[0],this.m[4])},e.prototype.getSimpleTranslation=function(){return new w(this.m[6],this.m[7])},e.prototype.equals=function(e){for(var t=0;t<9;t++)if(this.m[t]!=e.m[t])return!1;return!0},e.prototype.tryGetTransform=function(e){var t=this.transformVector(new w(1,0)),r=this.transformVector(new w(0,1));if(!(Math.abs(t.x*r.x+t.y*r.y)>.001)){var i=t.x*r.y-t.y*r.x>0?new w(t.length(),r.length()):new w(t.length(),-r.length()),n=t.y>0?Math.acos(t.x/i.x):-Math.acos(t.x/i.x),s=this.transformPoint(e.negate());return new x(e,i,n,s)}},e.Translation2D=function(t){return new e(1,0,0,0,1,0,t.x,t.y,1)},e.Scale2D=function(t){return new e(t.x,0,0,0,t.y,0,0,0,1)},e.ScaleTranslation2D=function(t,r){return new e(t.x,0,0,0,t.y,0,r.x,r.y,1)},e.RotationZ=function(t){var r=Math.cos(t),i=Math.sin(t);return new e(r,i,0,-i,r,0,0,0,1)},e.RotationAroundPoint=function(e,t){return new x(t.negate(),w.One,e,t).toMatrix3()},e.FromTransforms=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];if(0==t.length)return e.Identity;for(var i=t[0].toMatrix3(),n=1;n<t.length;n++)i=i.multiply(t[n].toMatrix3());return i},e.Identity=new e(1,0,0,0,1,0,0,0,1),e}(),x=function(){function e(e,t,r,i){this.preTranslation=e||w.Zero,this.scale=t||w.One,this.rotation=null!=r?r:0,this.translation=i||w.Zero}return e.prototype.toMatrix3=function(){var e=Math.cos(this.rotation),t=Math.sin(this.rotation),r=this.scale.x*e,i=this.scale.x*t,n=this.scale.y*-t,s=this.scale.y*e;return new T(r,i,0,n,s,0,this.preTranslation.x*r+this.preTranslation.y*n+this.translation.x,this.preTranslation.y*s+this.preTranslation.x*i+this.translation.y,1)},e.prototype.isIdentity=function(){return this==e.Identity||this.equals(e.Identity)},e.prototype.toInverseMatrix3=function(){var e=Math.cos(-this.rotation),t=Math.sin(-this.rotation),r=e/this.scale.x,i=t/this.scale.y,n=-t/this.scale.x,s=e/this.scale.y;return new T(r,i,0,n,s,0,-this.translation.x*r-this.translation.y*n-this.preTranslation.x,-this.translation.y*s-this.translation.x*i-this.preTranslation.y,1)},e.prototype.transformVector=function(e){return e.multiply(this.scale).rotate(this.rotation)},e.prototype.transformPoint=function(e){return e.add(this.preTranslation).multiply(this.scale).rotate(this.rotation).add(this.translation)},e.prototype.applyScaleAndTranslationBefore=function(t,r){return new e(this.preTranslation.add(r).divide(t),this.scale.multiply(t),this.rotation,this.translation)},e.prototype.applyTranslationAfter=function(t){return new e(this.preTranslation,this.scale,this.rotation,this.translation.add(t))},e.prototype.equals=function(e){return this.preTranslation.equals(e.preTranslation)&&this.scale.equals(e.scale)&&this.rotation==e.rotation&&this.translation.equals(e.translation)},e.fromScaleAndTranslation=function(t,r){return new e(void 0,t,void 0,r)},e.fromTransformAndPretranslation=function(t,r){return new e(r,t.scale,t.rotation,t.translation)},e.fromTransformAndScale=function(t,r){return new e(t.preTranslation,r,t.rotation,t.translation)},e.fromTransformAndRotation=function(t,r){return new e(t.preTranslation,t.scale,r,t.translation)},e.fromTransformAndTranslation=function(t,r){return new e(t.preTranslation,t.scale,t.rotation,r)},e.Identity=new e,e}(),P=function(){function e(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),this.left=e,this.top=t,this.right=r,this.bottom=i}return e.FromSize=function(t){return new e(0,0,t.x,t.y)},e.FromSizeAndCenter=function(t,r){return new e(r.x-.5*t.x,r.y-.5*t.y,r.x+.5*t.x,r.y+.5*t.y)},e.FromPoints=function(t,r){return new e(Math.min(t.x,r.x),Math.min(t.y,r.y),Math.max(t.x,r.x),Math.max(t.y,r.y))},e.prototype.isEmpty=function(){return this.left==this.right&&this.top==this.bottom},e.prototype.isValid=function(){return this.left<=this.right&&this.top<=this.bottom},Object.defineProperty(e.prototype,"width",{get:function(){return this.right-this.left},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.bottom-this.top},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return new w(this.right-this.left,this.bottom-this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"center",{get:function(){return new w((this.left+this.right)/2,(this.top+this.bottom)/2)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"leftTop",{get:function(){return new w(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightBottom",{get:function(){return new w(this.right,this.bottom)},enumerable:!0,configurable:!0}),e.prototype.isPointInRect=function(e){return this.left<=e.x&&e.x<=this.right&&this.top<=e.y&&e.y<=this.bottom},e.prototype.equals=function(e){return this.left==e.left&&this.top==e.top&&this.right==e.right&&this.bottom==e.bottom},e.prototype.inflate=function(t){return new e(this.left-t,this.top-t,this.right+t,this.bottom+t)},e.prototype.multiply=function(t){return e.FromPoints(this.leftTop.multiply(t),this.rightBottom.multiply(t))},e.prototype.divide=function(t){return e.FromPoints(this.leftTop.divide(t),this.rightBottom.divide(t))},e.prototype.translate=function(t){return new e(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)},e.prototype.transformedBounds=function(t){for(var r=void 0,i=[new w(this.left,this.top),new w(this.right,this.top),new w(this.right,this.bottom),new w(this.left,this.bottom)],n=0;n<4;n++)r=e.UnionPoint(r,i[n].transformPoint(t));return r},e.UnionPoint=function(t,r){return t&&t.isValid()?new e(Math.min(t.left,r.x),Math.min(t.top,r.y),Math.max(t.right,r.x),Math.max(t.bottom,r.y)):new e(r.x,r.y,r.x,r.y)},e.UnionRect=function(t,r){return t&&r&&t.isValid()&&r.isValid()?new e(Math.min(t.left,r.left),Math.min(t.top,r.top),Math.max(t.right,r.right),Math.max(t.bottom,r.bottom)):t&&t.isValid()?t:r&&r.isValid()?r:void 0},e.IntersectRect=function(t,r){if(t&&r&&t.isValid()&&r.isValid()){var i=new e(Math.max(t.left,r.left),Math.max(t.top,r.top),Math.min(t.right,r.right),Math.min(t.bottom,r.bottom));return i.isValid()?i:void 0}},e.SegmentBounds=function(t,r){return new e(Math.min(t.x,r.x),Math.min(t.y,r.y),Math.max(t.x,r.x),Math.max(t.y,r.y))},e.QuadraticBezierBounds=function(t,r,i){var n;n=e.SegmentBounds(t,i);var s=(t.x-r.x)/(t.x+i.x-2*r.x);0<s&&s<1&&(n=e.UnionPoint(n,w.InterpolateQuadratic(t,r,i,s)));var o=(t.y-r.y)/(t.y+i.y-2*r.y);return 0<o&&o<1&&(n=e.UnionPoint(n,w.InterpolateQuadratic(t,r,i,o))),n},e.Zero=new e(0,0,0,0),e}(),C=function(){function e(e,t,r,i){this.xMin=e,this.yMin=t,this.xMax=r,this.yMax=i}return e.prototype.equals=function(e){return this.xMin===e.xMin&&this.yMin===e.yMin&&this.xMax===e.xMax&&this.yMax===e.yMax},e.prototype.clip=function(e){var t=new P(void 0===this.xMin?e.left:this.xMin,void 0===this.yMin?e.top:this.yMin,void 0===this.xMax?e.right:this.xMax,void 0===this.yMax?e.bottom:this.yMax);return P.IntersectRect(e,t)},e.CreateFromRect=function(t){return new e(t.left,t.top,t.right,t.bottom)},e}();function E(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))}function S(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))}function R(e,t,r){return Math.min(r,Math.max(t,e))}function M(e,t,r){return e+(t-e)*r}function I(e,t,r,i,n,s){var o=n-e,a=s-t;if(Math.abs(o*(i-t)-a*(r-e))<.001)return Math.sqrt(o*o+a*a);var h=n-2*r+e,c=s-2*i+t,l=2*r-2*n,u=2*i-2*s,d=4*(h*h+c*c),f=4*(h*l+c*u),p=l*l+u*u,g=2*Math.sqrt(d+f+p),m=Math.sqrt(d),_=2*Math.sqrt(p),v=f/m;return(m*(2*d*g+f*(g-_))+(4*p*d-f*f)*Math.log((2*m+v+g)/(v+_)))/(8*d*m)}var A=function(){function e(e){this.m_changeTracker=new F,this.m_elements=[],e&&(this.elements=e)}return Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.m_elements.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elements",{get:function(){return this.m_elements},set:function(e){this.removeAll();for(var t=0,r=e;t<r.length;t++){var i=r[t];this.push(i)}},enumerable:!0,configurable:!0}),e.prototype.getAt=function(e){if(e<0||e>=this.elements.length)throw l.Error(592520775,"Out of range");return this.m_elements[e]},e.prototype.setAt=function(e,t){F.RemoveListener(this.getAt(e).changeTracker,this.m_changeTracker),F.AddListener(t.changeTracker,this.m_changeTracker),this.m_elements[e]=t},e.prototype.push=function(e){F.AddListener(e.changeTracker,this.m_changeTracker),this.m_elements.push(e)},e.prototype.insertAt=function(e,t){F.AddListener(t.changeTracker,this.m_changeTracker),this.m_elements.splice(e,0,t)},e.prototype.removeAll=function(){for(var e=0,t=this.m_elements;e<t.length;e++){var r=t[e];F.RemoveListener(r.changeTracker,this.m_changeTracker)}this.m_elements=[]},e.prototype.removeAt=function(e){F.RemoveListener(this.getAt(e).changeTracker,this.m_changeTracker),this.m_elements.splice(e,1)},e}(),F=function(){function e(){this.trackerId=e.s_nextUniqueId++,this.m_version=0,this.m_currentUniqueId="",this.m_listeners=[]}return Object.defineProperty(e.prototype,"version",{get:function(){return this.m_version},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentUniqueId",{get:function(){return this.m_currentUniqueId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"listenerCount",{get:function(){return this.m_listeners.length},enumerable:!0,configurable:!0}),e.prototype.notifyChange=function(){this.m_version++,this.m_currentUniqueId=this.trackerId+"v"+this.m_version;for(var e=0,t=this.m_listeners;e<t.length;e++){t[e].notifyChange()}},e.prototype.replaceListener=function(t,r){t!=r&&(t&&e.RemoveListener(t?t.changeTracker:void 0,this),r&&e.AddListener(r?r.changeTracker:void 0,this))},e.AddListener=function(e,t){e&&-1==e.m_listeners.indexOf(t)&&(e.m_listeners.push(t),t.notifyChange())},e.RemoveListener=function(e,t){if(e){var r=e.m_listeners.indexOf(t);-1!=r&&(e.m_listeners.splice(r,1),t.notifyChange())}},e.s_nextUniqueId=1,e}(),B=function(){function e(t,r){if(t instanceof e)this.m_sharedPathStorage=t.m_sharedPathStorage,this.m_transform=r||t.transform;else{for(var i=[],n=0,s=t.figures;n<s.length;n++){var o=s[n];i.push(o instanceof O?o.createFigure():o)}this.m_sharedPathStorage={figures:i,fillMode:null==t.fillMode?1:t.fillMode,lineEnabled:null==t.lineEnabled||t.lineEnabled,extrusionEnabled:null==t.extrusionEnabled||t.extrusionEnabled,glyphCacheId:t.glyphCacheId?{fontId:t.glyphCacheId.fontId,glyphId:t.glyphCacheId.glyphId}:void 0,isUntransformedRect:G(i),untransformedBounds:N(i),renderDataMap:{}},this.m_transform=r||(t.transform?t.transform:x.Identity)}}return e.CreateFromFigure=function(t){return new e({figures:[t]})},e.CreateFromRect=function(t){return new e({figures:[L.CreateFromRect(t)]})},Object.defineProperty(e.prototype,"figures",{get:function(){return this.m_sharedPathStorage.figures},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transform",{get:function(){return this.m_transform},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillMode",{get:function(){return this.m_sharedPathStorage.fillMode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineEnabled",{get:function(){return this.m_sharedPathStorage.lineEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extrusionEnabled",{get:function(){return this.m_sharedPathStorage.extrusionEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"glyphCacheId",{get:function(){return this.m_sharedPathStorage.glyphCacheId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxPressure",{get:function(){return 4096},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderDataMap",{get:function(){return this.m_sharedPathStorage.renderDataMap},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasPressureInfo",{get:function(){return this.figures.some((function(e){return!!(8&e.format)}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isUntransformedRect",{get:function(){return this.m_sharedPathStorage.isUntransformedRect},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"untransformedBounds",{get:function(){return this.m_sharedPathStorage.untransformedBounds},enumerable:!0,configurable:!0}),e.prototype.measureLength=function(e){void 0===e&&(e=x.Identity);for(var t=0,r=0,i=this.figures;r<i.length;r++){t+=i[r].measureLength(e)}return t},e.prototype.equals=function(e){return this.m_sharedPathStorage==e.m_sharedPathStorage&&this.m_transform.equals(e.m_transform)},e}();function D(e){var t=(1&e?2:0)+(2&e?1:0)+(4&e?1:0)+(8&e?1:0)+(16&e?2:0);return 32&e&&(t=4*Math.ceil(t/4)),t}var L=function(){function e(e,t,r){if(void 0===t&&(t=!1),void 0===r&&(r=3),this.m_points=e,this.m_isClosed=t,this.m_format=r,this.m_pointDataSize=D(r),this.m_points.length%this.m_pointDataSize!=0)throw l.Error(592520776,"list of points invalid")}return e.CreateFromRect=function(t){return new e([t.left,t.top,1,t.right,t.top,1,t.right,t.bottom,1,t.left,t.bottom,1],!0)},Object.defineProperty(e.prototype,"points",{get:function(){return this.m_points},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"format",{get:function(){return this.m_format},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointDataSize",{get:function(){return this.m_pointDataSize},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isClosed",{get:function(){return this.m_isClosed},enumerable:!0,configurable:!0}),e.prototype.isLastPointDuplicated=function(){return this.getPoint(0).equalsWithEpsilon(this.getPoint(-1),.1)},e.prototype.getPointCount=function(){return this.m_points.length/this.m_pointDataSize},e.prototype.getPoint=function(e){var t=this.getPointCount(),r=e<0?e%t+t:e%t;return new w(this.m_points[r*this.m_pointDataSize],this.m_points[r*this.m_pointDataSize+1])},e.prototype.getPointType=function(e){if(!(2&this.m_format))return 1;var t=this.getPointCount(),r=e<0?e%t+t:e%t;return this.m_points[r*this.m_pointDataSize+2]},e.prototype.toPolygon=function(){for(var e=this.getPointCount(),t=new O([],this.m_isClosed,1),r=0;r<e;r++){var i=this.getPoint(r);if(2!=this.getPointType(r))t.pushPoint(i.x,i.y);else for(var n=this.getPoint(r-1),s=this.getPoint(r+1),o=1;o<8;o++){var a=w.InterpolateQuadratic(n,i,s,o/8);t.pushPoint(a.x,a.y)}}return t.createFigure()},e.prototype.measureLength=function(e){void 0===e&&(e=x.Identity);var t=0;return this.forEachSegment((function(e,r,i){return t+=r?w.MeasureQuadraticLength(e,r,i):w.Distance(e,i),!0}),e),t},e.prototype.getPointFromDist=function(e,t,r){void 0===t&&(t=x.Identity),void 0===r&&(r=!1);var i=0,n=void 0;return this.forEachSegment((function(t,r,s){var o=r?w.MeasureQuadraticLength(t,r,s):w.Distance(t,s);if(i+o>e){var a=(e-i)/o;n=r?w.InterpolateQuadratic(t,r,s,a):w.InterpolateLinear(t,s,a)}return(i+=o)<=e}),t,r),n||this.getPoint(r?0:this.getPointCount()-1).transformPoint(t)},e.prototype.getTangentFromDist=function(e,t,r){void 0===t&&(t=x.Identity),void 0===r&&(r=!1);var i=0,n=w.Zero;return this.forEachSegment((function(t,r,s){var o=r?w.MeasureQuadraticLength(t,r,s):w.Distance(t,s);return n=r?w.QuadraticTangent(t,r,s,(e-i)/o):s.subtract(t).scale(1/o),(i+=o)<e}),t,r),n},e.prototype.forEachSegment=function(e,t,r){void 0===t&&(t=x.Identity),void 0===r&&(r=!1);for(var i=this.getPointCount(),n=r?0:i-1,s=r?-1:1,o=r?i-1:0;o!=n;o+=s){var a=o+s,h=a+s,c=2==this.getPointType(a);if(2!=this.getPointType(o)&&(this.m_isClosed||a==a%i)&&(!c||this.m_isClosed||h==h%i))if(!e(this.getPoint(o).transformPoint(t),c?this.getPoint(a).transformPoint(t):void 0,this.getPoint(c?h:a).transformPoint(t)))return}},e}(),O=function(){function e(e,t,r){if(void 0===e&&(e=[]),void 0===t&&(t=!1),void 0===r&&(r=3),this._points=e,this.isClosed=t,this.format=r,this.pointDataSize=D(r),this.lastPointX=0,this.lastPointY=0,this._points.length%this.pointDataSize!=0)throw l.Error(592520777,"list of points invalid")}return e.prototype.createFigure=function(){return new L(this._points,this.isClosed,this.format)},e.prototype.pushPoint=function(e,t,r,i){switch(void 0===r&&(r=1),this.lastPointX=e,this.lastPointY=t,this.pointDataSize){case 2:return void this._points.push(e,t);case 3:return void this._points.push(e,t,r);case 4:return void this._points.push(e,t,r,i?i[0]:0);case 5:return void this._points.push(e,t,r,i?i[0]:0,i?i[1]:0);case 6:return void this._points.push(e,t,r,i?i[0]:0,i?i[1]:0,i?i[2]:0);case 7:return void this._points.push(e,t,r,i?i[0]:0,i?i[1]:0,i?i[2]:0,i?i[3]:0)}throw l.Error(592520778,"Unsupported data size")},e.prototype.moveTo=function(e,t,r){if(0!=this._points.length)throw l.Error(592520779,"Figures should have only one MoveTo");this.pushPoint(e,t,1,r)},e.prototype.moveToPoint=function(e,t){this.moveTo(e.x,e.y,t)},e.prototype.lineTo=function(e,t,r){if(this._points.length<this.pointDataSize)throw l.Error(592520780,"All figures should start with a MoveTo");(Math.abs(e-this.lastPointX)>.1||Math.abs(t-this.lastPointY)>.1)&&this.pushPoint(e,t,1,r)},e.prototype.lineToPoint=function(e,t){this.lineTo(e.x,e.y,t)},e.prototype.quadBezierTo=function(e,t,r,i,n){if(this._points.length<this.pointDataSize)throw l.Error(592520781,"All figures should start with a MoveTo");var s=this.lastPointX,o=this.lastPointY;if(Math.abs(r-s)>.1||Math.abs(i-o)>.1){var a=Math.sqrt((e-s)*(e-s)+(t-o)*(t-o)),h=Math.sqrt((r-e)*(r-e)+(i-t)*(i-t)),c=Math.abs(e-s)<.1&&Math.abs(t-o)<.1,u=Math.abs(r-e)<.1&&Math.abs(i-t)<.1;!c&&!u&&Math.abs(a/h)>.1&&Math.abs(h/a)>.1?(this.pushPoint(e,t,2),this.pushPoint(r,i,1,n)):this.pushPoint(r,i,1,n)}},e.prototype.quadBezierToPoint=function(e,t,r){this.quadBezierTo(e.x,e.y,t.x,t.y,r)},e.prototype.cubicBezierTo=function(e,t,r,i,n,s){this.cubicBezierToPoint(new w(e,t),new w(r,i),new w(n,s))},e.prototype.cubicBezierToPoint=function(e,t,r){if(this._points.length<this.pointDataSize)throw l.Error(592520782,"All figures should start with a MoveTo");var i=new w(this.lastPointX,this.lastPointY),n=Math.abs(e.x-i.x)<.1&&Math.abs(e.y-i.y)<.1,s=Math.abs(t.x-e.x)<.1&&Math.abs(t.y-e.y)<.1,o=Math.abs(r.x-t.x)<.1&&Math.abs(r.y-t.y)<.1;if(s&&(n||o))n!=o&&this.lineToPoint(r);else for(var a=i,h=i,c=e,u=0;u<4;u++){var d=(u+1)/4,f=w.InterpolateQuadratic(i,e,t,d),p=w.InterpolateQuadratic(e,t,r,d),g=w.InterpolateLinear(f,p,d),m=c.subtract(h).normalized(),_=p.subtract(f).normalized(),v=void 0;if(m&&_&&Math.abs(m.dot(_))<Math.sqrt(2)/2)v=w.CalculateLineIntersection(h,c,f,p,.001);else{var y=(u+.5)/4,b=w.InterpolateLinear(w.InterpolateQuadratic(i,e,t,y),w.InterpolateQuadratic(e,t,r,y),y),T=a.add(g).scale(.5);v=T.add(b.subtract(T).scale(2))}v?this.quadBezierTo(v.x,v.y,g.x,g.y):this.lineTo(g.x,g.y),a=g,h=f,c=p}},e.prototype.arcTo=function(e,t,r,i){if(this._points.length<this.pointDataSize)throw l.Error(592520783,"All figures should start with a MoveTo");var n=2*Math.PI,s=e<.001||t<.001,o=s?r:Math.atan2(e*Math.sin(r),t*Math.cos(r)),a=i<0?-1:1,h=Math.abs(i);if(h>=n)h=n;else{var c=r+h*a;(h=((c=s?c:Math.atan2(e*Math.sin(c),t*Math.cos(c)))-o)*a)<0&&(h+=n)}for(var u=this.lastPointX,d=this.lastPointY,f=u-Math.cos(o)*e,p=d-Math.sin(o)*t,g=Math.ceil(8*Math.abs(h)/n),m=0;m<g;m++){var _=a*n/8,v=o+m*_,y=m==g-1?a*h-m*_:_,b=v+y,T=v+y/2,x=1/Math.cos(y/2),P=new w(f+Math.cos(T)*x*e,p+Math.sin(T)*x*t),C=new w(f+Math.cos(b)*e,p+Math.sin(b)*t);Math.abs(y)>.001?this.quadBezierTo(P.x,P.y,C.x,C.y):this.lineTo(C.x,C.y)}},e.prototype.close=function(){if(this._points.length<this.pointDataSize)throw l.Error(592520784,"All figures should start with a MoveTo");this.isClosed=!0},e.prototype.isLastPointDuplicated=function(){return this.getPoint(0).equalsWithEpsilon(this.getPoint(-1),.1)},e.prototype.getPointCount=function(){return this._points.length/this.pointDataSize},e.prototype.getPoint=function(e){var t=this.getPointCount(),r=e<0?e%t+t:e%t;return new w(this._points[r*this.pointDataSize],this._points[r*this.pointDataSize+1])},Object.defineProperty(e.prototype,"data",{get:function(){return this._points},enumerable:!0,configurable:!0}),e}();function k(e){for(var t="["+e.replace(/(M|L|Q|C|A|E|;)/g,(function(e){return"M"==e?"0":"L"==e?"1":"Q"==e?"2":"C"==e?"3":"A"==e?"4":"E"==e?"5":","}))+"]",r=new Float32Array(JSON.parse(t)),i=[],n=void 0,s=0,o=2*Math.PI/216e5;s<r.length;)switch(r[s++]){case 0:if(s+1>=r.length)throw l.Error(592520785,"Invalid LineTo");n&&i.push(n),(n=new O).moveTo(r[s++],r[s++]);break;case 1:if(!n||s+1>=r.length)throw l.Error(592520786,"Invalid LineTo");n.lineTo(r[s++],r[s++]);break;case 2:if(!n||s+3>=r.length)throw l.Error(592520787,"Invalid MoveTo");n.quadBezierTo(r[s++],r[s++],r[s++],r[s++]);break;case 3:if(!n||s+5>=r.length)throw l.Error(592520788,"Invalid CubicBezierTo");n.cubicBezierTo(r[s++],r[s++],r[s++],r[s++],r[s++],r[s++]);break;case 4:if(!n||s+3>=r.length)throw l.Error(592520789,"Invalid Arc of ellipse");n.arcTo(r[s++],r[s++],r[s++]*o,r[s++]*o);break;case 5:if(!n)throw l.Error(592520790,"All paths should start with a MoveTo");n.close(),i.push(n),n=void 0}return n&&i.push(n),i}!function(){function e(e,t){this.m_changeTracker=new F,this.bounds=e,this.format=t,this.pointDataSize=D(t),this.m_figures=[new O([],!1,t)]}Object.defineProperty(e.prototype,"currentFigure",{get:function(){return this.m_figures[this.m_figures.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"figures",{get:function(){return this.m_figures},enumerable:!0,configurable:!0}),e.prototype.newFigure=function(){this.currentFigure.getPointCount()>0&&this.m_figures.push(new O([],!1,this.format))},Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0})}();function N(e){for(var t=void 0,r=0,i=e;r<i.length;r++){var n=i[r];if(!n.cachedBounds){var s=n.points.length/n.pointDataSize;if(s<1)return;for(var o=n.points[0],a=o,h=n.points[1],c=h,l=0;l<s;l++){var u=l*n.pointDataSize,d=(l-1+s)%s*n.pointDataSize,f=(l+1)%s*n.pointDataSize,p=void 0,g=void 0,m=void 0;2&n.format?(p=n.points[u+2],g=n.points[d+2],m=n.points[f+2]):p=g=m=1;var _=n.points[u],v=n.points[u+1];if(1==p&&1==m)o=_<o?_:o,a=_>a?_:a,h=v<h?v:h,c=v>c?v:c;else if(1==g&&2==p&&1==m){var y=n.points[d],b=n.points[d+1],w=n.points[f],T=n.points[f+1];o=w<(o=y<o?y:o)?w:o,a=w>(a=y>a?y:a)?w:a,h=T<(h=b<h?b:h)?T:h,c=T>(c=b>c?b:c)?T:c;var x=(y-_)/(y+w-2*_);if(0<x&&x<1)o=(S=y*((E=(C=x)*C)-2*C+1)+w*E+2*_*(C-E))<o?S:o,a=S>a?S:a,h=(R=b*(E-2*C+1)+T*E+2*v*(C-E))<h?R:h,c=R>c?R:c;var C,E,S,R,M=(b-v)/(b+T-2*v);if(0<M&&M<1)o=(S=y*((E=(C=M)*C)-2*C+1)+w*E+2*_*(C-E))<o?S:o,a=S>a?S:a,h=(R=b*(E-2*C+1)+T*E+2*v*(C-E))<h?R:h,c=R>c?R:c}}n.cachedBounds=new P(o,h,a,c)}t=P.UnionRect(t,n.cachedBounds)}return t}function G(e){if(1!=e.length)return!1;var t=e[0];if((4!=t.getPointCount()||!t.isClosed||t.isLastPointDuplicated())&&(5!=t.getPointCount()||!t.isClosed||!t.isLastPointDuplicated()))return!1;for(var r=[t.getPoint(0),t.getPoint(1),t.getPoint(2),t.getPoint(3)],i=new P(Math.min(r[0].x,r[1].x,r[2].x,r[3].x),Math.min(r[0].y,r[1].y,r[2].y,r[3].y),Math.max(r[0].x,r[1].x,r[2].x,r[3].x),Math.max(r[0].y,r[1].y,r[2].y,r[3].y)),n=0;n<4;n++){var s=r[n],o=r[(n+1)%4];if(s.x!=i.left&&s.x!=i.right||s.y!=i.top&&s.y!=i.bottom||s.x!=o.x&&s.y!=o.y)return!1}return!0}function U(e,t){var r,i=new w(t*V(e.width,e.end),t*z(e.length,e.end));if(1==e.end||5==e.end)r=new L([-.5*i.x,-1*i.y,1,0,0,1,.5*i.x,-1*i.y,1],1==e.end);else if(2==e.end)r=new L([-.5*i.x,-1*i.y,1,0,0,1,.5*i.x,-1*i.y,1,0,-.5*i.y,1],!0);else if(3==e.end)r=new L([0,.5*i.y,1,.5*i.x,0,1,0,-.5*i.y,1,-.5*i.x,0,1],!0);else if(4==e.end){var n=new O;n.moveTo(.5*i.x,0),n.arcTo(.5*i.x,.5*i.y,0,2*Math.PI),n.close(),r=n.createFigure()}return r||l.Error(592525391,"bad arrow head"),r}function V(e,t){return 0==e?5==t?2.5:2:1==e?5==t?3.5:3:2==e?5:(l.Error(592525392,"bad arrow head"),0)}function z(e,t){return 0==e?2:1==e?3:2==e?5==t?4.5:5:(l.Error(592525393,"bad arrow head"),0)}function W(e,t,r,i,n){var s=(3==r.end||4==r.end?.5:1)*z(r.length,r.end)*i,o=(t?e.getPoint(e.getPointCount()-1):e.getPoint(0)).transformPoint(n),a=e.getPointFromDist(s,n,t),h=o.subtract(a).normalized();if(h){var c=new w(-h.y,h.x);return new T(c.x,c.y,0,h.x,h.y,0,0,0,1).multiply(T.Translation2D(o))}}function H(e,t,r,i,n){if(0==r&&e.cachedBoundsContributor)return{points:e.cachedBoundsContributor.points,curves:e.cachedBoundsContributor.curves,transform:t};for(var s=0!=r,o={points:new Array,curves:new Array,transform:s?void 0:t},a=e.getPointCount(),h=0;h<a;h++){var c=e.getPoint(h-1),l=e.getPoint(h),u=e.getPoint(h+1);if(s&&(c=t.transformPoint(c),l=t.transformPoint(l),u=t.transformPoint(u)),2==e.getPointType(h))r?(o.curves.push([c.add(new w(-r,0)),l.add(new w(-r,0)),u.add(new w(-r,0))]),o.curves.push([c.add(new w(r,0)),l.add(new w(r,0)),u.add(new w(r,0))]),o.curves.push([c.add(new w(0,-r)),l.add(new w(0,-r)),u.add(new w(0,-r))]),o.curves.push([c.add(new w(0,r)),l.add(new w(0,r)),u.add(new w(0,r))])):o.curves.push([c,l,u]);else if(o.points.push(l),r)if(2==i)r?(o.points.push(l.add(new w(-r,0))),o.points.push(l.add(new w(r,0))),o.points.push(l.add(new w(0,-r))),o.points.push(l.add(new w(0,r)))):o.points.push(l);else{var d=l.subtract(c).normalized(),f=u.subtract(l).normalized();if(d&&f){d=d.scale(r),f=f.scale(r);var p=new w(-d.y,d.x),g=new w(-f.y,f.x);d.dot(g)<0&&(p=p.negate(),g=g.negate());var m=l.add(p),_=l.add(g);if(o.points.push(m),o.points.push(_),1==i||3==i){var v=w.CalculateLineIntersection(m,m.add(d),_,_.subtract(f));if(v)w.Distance(v,l)<n*r?o.points.push(v):1==i&&(o.points.push(m.add(d.scale(n))),o.points.push(_.subtract(f.scale(n))))}}}}return 0!=r||e.cachedBoundsContributor||(e.cachedBoundsContributor={points:o.points,curves:o.curves,transform:void 0}),o}function j(e,t){var r=!0,i=0,n=0,s=0,o=0,a=e.transform&&t?e.transform.multiply(t):t||e.transform,h=!a||a.isSimpleScaleTranslationOnly(),c=h?void 0:a,l=e.points,u=e.curves,d=l&&l.length>0?l[0]:u&&u.length>0?u[0][0]:void 0;if(d){var f=0,p=0,g=0,m=0,_=0,v=0;if(c&&(f=c.m[0],p=c.m[1],g=c.m[3],m=c.m[4],_=c.m[6],v=c.m[7]),r&&(n=i=c?d.x*f+d.y*g+_:d.x,o=s=c?d.x*p+d.y*m+v:d.y,r=!1),l&&l.length>0)for(var y=1;y<l.length;y++){var b=l[y];i=(k=c?b.x*f+b.y*g+_:b.x)<i?k:i,n=k>n?k:n,s=(N=c?b.x*p+b.y*m+v:b.y)<s?N:s,o=N>o?N:o}for(var w=0,T=u||[];w<T.length;w++){var x=T[w],C=x[0],E=x[1],S=x[2],R=c?C.x*f+C.y*g+_:C.x,M=c?C.x*p+C.y*m+v:C.y,I=c?E.x*f+E.y*g+_:E.x,A=c?E.x*p+E.y*m+v:E.y,F=c?S.x*f+S.y*g+_:S.x,B=c?S.x*p+S.y*m+v:S.y;i=F<(i=R<i?R:i)?F:i,n=F>(n=R>n?R:n)?F:n,s=B<(s=M<s?M:s)?B:s,o=B>(o=M>o?M:o)?B:o;var D=(R-I)/(R+F-2*I);if(0<D&&D<1){i=(k=R*((O=D*D)-2*D+1)+F*O+2*I*(D-O))<i?k:i,n=k>n?k:n,s=(N=M*(O-2*D+1)+B*O+2*A*(D-O))<s?N:s,o=N>o?N:o}var L=(M-A)/(M+B-2*A);if(0<L&&L<1){var O,k,N;i=(k=R*((O=L*L)-2*L+1)+F*O+2*I*(L-O))<i?k:i,n=k>n?k:n,s=(N=M*(O-2*L+1)+B*O+2*A*(L-O))<s?N:s,o=N>o?N:o}}var G=new P(i,s,n,o);return h&&(G=a?G.multiply(a.getSimpleScale()).translate(a.getSimpleTranslation()):G),G}}function q(e){for(var t=void 0,r=0,i=e;r<i.length;r++){var n=i[r];if(0!=n.transform.rotation)return;var s=n.untransformedBounds;s&&(t=P.UnionRect(t,s.transformedBounds(n.transform)))}return t}function X(e,t,r){t!=r&&e.notifyChange()}function K(e,t,r){t==r||t&&r&&t.equals(r)||e.notifyChange()}function Y(e,t,r){if(t!=r)if(t&&r&&t.length==r.length){for(var i=0;i<t.length;i++)if(!t[i].equals(r[i]))return void e.notifyChange()}else e.notifyChange()}var Q=function(){function e(e,t,r,i){void 0===i&&(i=1),this.r=e,this.g=t,this.b=r,this.a=i}return e.prototype.equals=function(e){return this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a},e.Gray=function(t){return new e(t,t,t,1)},e.FromRGBA=function(t){return new e(t.r,t.g,t.b,t.a)},e.Transparent=new e(0,0,0,0),e.Black=new e(0,0,0,1),e.White=new e(1,1,1,1),e.Red=new e(1,0,0,1),e.Orange=new e(1,.5,0,1),e.Yellow=new e(1,1,0,1),e.Green=new e(0,1,0,1),e.Cyan=new e(0,1,1,1),e.Blue=new e(0,0,1,1),e.Magenta=new e(1,0,1,1),e}(),Z=function(){function e(){this.renderDataMap={},this.m_changeTracker=new F}return Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.m_id},set:function(e){this.m_id!=e&&(this.m_changeTracker.notifyChange(),this.m_id=e)},enumerable:!0,configurable:!0}),e.prototype.releaseGeneratedResources=function(){for(var e in this.renderDataMap)this.renderDataMap[e].releaseGeneratedResources()},e}(),J=function(){function e(){this.m_changeTracker=new F}return Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"version",{get:function(){return this.m_changeTracker.version},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotateWithShape",{get:function(){return!0},enumerable:!0,configurable:!0}),e.IsGradient=function(e){return 2<=e&&e<=5},e}(),$=function(e){function t(t){var r=e.call(this)||this;return r.m_color=t,r}return _(t,e),t.prototype.clone=function(){return new t(this.m_color)},Object.defineProperty(t.prototype,"color",{get:function(){return this.m_color},set:function(e){K(this.changeTracker,this.m_color,e),this.m_color=e},enumerable:!0,configurable:!0}),t.prototype.getType=function(){return 1},t}(J),ee=function(){function e(e,t){this.position=e,this.color=t}return e.prototype.equals=function(e){return this.position==e.position&&this.color.equals(e.color)},e}(),te=function(e){function t(t,r){var i=e.call(this)||this;return i.m_type=t,i.m_angle=0,i.m_fillFromRect=new P(0,0,1,1),i.m_fillToRect=new P(.5,.5,.5,.5),i.m_rotateWithShape=!0,i.m_isStretched=!1,i.m_shadeFromTitle=!1,i.m_gradientStops=r?r.slice(0):[],i.m_isGammaCorrected=!0,i}return _(t,e),t.prototype.clone=function(){var e=new t(this.m_type,this.m_gradientStops);return e.m_angle=this.m_angle,e.m_fillFromRect=this.m_fillFromRect,e.m_fillToRect=this.m_fillToRect,e.m_rotateWithShape=this.m_rotateWithShape,e.m_isStretched=this.m_isStretched,e.m_shadeFromTitle=this.m_shadeFromTitle,e.m_isGammaCorrected=this.m_isGammaCorrected,e},Object.defineProperty(t.prototype,"gradientStops",{get:function(){return this.m_gradientStops},set:function(e){Y(this.changeTracker,this.m_gradientStops,e),this.m_gradientStops=e.slice(0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"angle",{get:function(){return this.m_angle},set:function(e){X(this.changeTracker,this.m_angle,e),this.m_angle=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fillFromRect",{get:function(){return this.m_fillFromRect},set:function(e){K(this.changeTracker,this.m_fillFromRect,e),this.m_fillFromRect=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fillToRect",{get:function(){return this.m_fillToRect},set:function(e){K(this.changeTracker,this.m_fillToRect,e),this.m_fillToRect=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isStretched",{get:function(){return this.m_isStretched},set:function(e){X(this.changeTracker,this.m_isStretched,e),this.m_isStretched=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadeFromTitle",{get:function(){return this.m_shadeFromTitle},set:function(e){X(this.changeTracker,this.m_shadeFromTitle,e),this.m_shadeFromTitle=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotateWithShape",{get:function(){return 5==this.m_type||this.m_rotateWithShape},set:function(e){X(this.changeTracker,this.m_rotateWithShape,e),this.m_rotateWithShape=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGammaCorrected",{get:function(){return this.m_isGammaCorrected},set:function(e){X(this.changeTracker,this.m_isGammaCorrected,e),this.m_isGammaCorrected=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"blendBellShape",{get:function(){return this.m_blendBellShape},set:function(e){K(this.changeTracker,this.m_blendBellShape,e),this.m_blendBellShape=e},enumerable:!0,configurable:!0}),t.prototype.getType=function(){return this.m_type},t}(J),re=function(e){function t(t){var r=e.call(this)||this;return r.changeTracker.replaceListener(void 0,t),r.m_image=t,r.m_isStretched=!0,r.m_scale=w.One,r.m_offset=w.Zero,r.m_alignment=4,r.m_opacity=1,r.m_rotateWithShape=!0,r}return _(t,e),t.prototype.clone=function(){var e=new t(this.m_image);return e.m_isStretched=this.m_isStretched,e.m_scale=this.m_scale,e.m_offset=this.m_offset,e.m_alignment=this.m_alignment,e.m_opacity=this.m_opacity,e.m_rotateWithShape=this.m_rotateWithShape,e},Object.defineProperty(t.prototype,"image",{get:function(){return this.m_image},set:function(e){this.changeTracker.replaceListener(this.m_image,e),this.m_image=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"wrapMode",{get:function(){return this.m_wrapMode},set:function(e){X(this.changeTracker,this.m_wrapMode,e),this.m_wrapMode=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isStretched",{get:function(){return this.m_isStretched},set:function(e){X(this.changeTracker,this.m_isStretched,e),this.m_isStretched=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this.m_scale},set:function(e){K(this.changeTracker,this.m_scale,e),this.m_scale=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"offset",{get:function(){return this.m_offset},set:function(e){K(this.changeTracker,this.m_offset,e),this.m_offset=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alignment",{get:function(){return this.m_alignment},set:function(e){X(this.changeTracker,this.m_alignment,e),this.m_alignment=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"opacity",{get:function(){return this.m_opacity},set:function(e){X(this.changeTracker,this.m_opacity,e),this.m_opacity=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotateWithShape",{get:function(){return this.m_rotateWithShape},set:function(e){X(this.changeTracker,this.m_rotateWithShape,e),this.m_rotateWithShape=e},enumerable:!0,configurable:!0}),t.prototype.getType=function(){return 6},t}(J),ie=function(e){function t(t,r,i){var n=e.call(this)||this;return n.m_pattern=t,n.m_foregroundColor=r,n.m_backgroundColor=i,n}return _(t,e),t.prototype.clone=function(){return new t(this.m_pattern,this.m_foregroundColor,this.m_backgroundColor)},Object.defineProperty(t.prototype,"pattern",{get:function(){return this.m_pattern},set:function(e){X(this.changeTracker,this.m_pattern,e),this.m_pattern=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"foregroundColor",{get:function(){return this.m_foregroundColor},set:function(e){K(this.changeTracker,this.m_foregroundColor,e),this.m_foregroundColor=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"backgroundColor",{get:function(){return this.m_backgroundColor},set:function(e){K(this.changeTracker,this.m_backgroundColor,e),this.m_backgroundColor=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotateWithShape",{get:function(){return!1},enumerable:!0,configurable:!0}),t.prototype.getType=function(){return 7},t}(J),ne=(function(e){function t(t){var r=e.call(this)||this;return r.m_type=t,8!=t&&9!=t&&l.Error(592520774,"SpecialBrush must be background or group"),r}_(t,e),t.prototype.clone=function(){return new t(this.m_type)},t.prototype.getType=function(){return this.m_type}}(J),function(e,t,r,i,n){this.widthMin=e,this.end=t,this.cap=r,this.width=i,this.length=n}),se=function(){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=2),void 0===r&&(r=8),this.headEnd=new ne(0,0,0,1,1),this.tailEnd=new ne(0,0,0,1,1),this.m_changeTracker=new F,this.m_lineWidth=e,this.m_lineJoin=t,this.m_miterLimit=r,this.m_dashType=0,this.m_compoundType=0,this.m_alignment=0,this.m_useRoundDash=!1}return e.prototype.clone=function(){var t=new e(this.m_lineWidth);return t.m_lineJoin=this.m_lineJoin,t.m_miterLimit=this.m_miterLimit,t.m_dashType=this.m_dashType,t.m_compoundType=this.m_compoundType,t.m_alignment=this.m_alignment,t.m_useRoundDash=this.m_useRoundDash,t},Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"version",{get:function(){return this.m_changeTracker.version},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineWidth",{get:function(){return this.m_lineWidth?this.m_lineWidth:this.m_lineHeight?this.m_lineHeight:0},set:function(e){X(this.changeTracker,this.m_lineWidth,e),this.m_lineWidth=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"adjustedLineWidth",{get:function(){return Math.max(d,this.lineWidth)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"adjustedLineWidthForArrowHead",{get:function(){return Math.max(f,this.lineWidth)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineHeight",{get:function(){return this.m_lineHeight?this.m_lineHeight:this.m_lineWidth?this.m_lineWidth:0},set:function(e){X(this.changeTracker,this.m_lineHeight,e),this.m_lineHeight=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tipScale",{get:function(){return this.m_lineWidth&&this.m_lineHeight?new w(1,this.m_lineHeight/this.m_lineWidth):w.One},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineJoin",{get:function(){return this.m_lineJoin},set:function(e){X(this.changeTracker,this.m_lineJoin,e),this.m_lineJoin=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"miterLimit",{get:function(){return this.m_miterLimit},set:function(e){X(this.changeTracker,this.m_miterLimit,e),this.m_miterLimit=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dashType",{get:function(){return this.m_dashType},set:function(e){X(this.changeTracker,this.m_dashType,e),this.m_dashType=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRoundDash",{get:function(){return this.m_useRoundDash},set:function(e){X(this.changeTracker,this.m_useRoundDash,e),this.m_useRoundDash=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dashOffset",{get:function(){return null==this.m_dashOffset?0:this.m_dashOffset},set:function(e){X(this.changeTracker,this.m_dashOffset,e),this.m_dashOffset=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"compoundType",{get:function(){return this.m_compoundType},set:function(e){X(this.changeTracker,this.m_compoundType,e),this.m_compoundType=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alignment",{get:function(){return this.m_alignment},set:function(e){X(this.changeTracker,this.m_alignment,e),this.m_alignment=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tipType",{get:function(){return null==this.m_tipType?0:this.m_tipType},set:function(e){X(this.changeTracker,this.m_tipType,e),this.m_tipType=e},enumerable:!0,configurable:!0}),e}(),oe=function(){function e(e,t,r,i){void 0===r&&(r=new se),void 0===i&&(i=0),this.m_changeTracker=new F,this.m_fillChangeTracker=new F,this.m_lineChangeTracker=new F,this.m_pictureChangeTracker=new F,this.m_penChangeTracker=new F,this.m_pen=r,this.fillBrush=e,this.lineBrush=t,this.m_blendingMode=i,this.m_penChangeTracker.replaceListener(void 0,r),F.AddListener(this.m_fillChangeTracker,this.m_changeTracker),F.AddListener(this.m_lineChangeTracker,this.m_changeTracker),F.AddListener(this.m_pictureChangeTracker,this.m_changeTracker),F.AddListener(this.m_penChangeTracker,this.m_changeTracker)}return e.prototype.clone=function(){var t=new e;return t.fillBrush=this.m_fillBrush?this.m_fillBrush.clone():void 0,t.lineBrush=this.m_lineBrush?this.m_lineBrush.clone():void 0,t.pictureBrush=this.m_pictureBrush?this.m_pictureBrush.clone():void 0,t.pen=this.m_pen.clone(),t.m_blendingMode=this.m_blendingMode,t},Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"penChangeTracker",{get:function(){return this.m_penChangeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"version",{get:function(){return this.m_changeTracker.version},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillBrush",{get:function(){return this.m_fillBrush},set:function(e){this.m_fillChangeTracker.replaceListener(this.m_fillBrush,e),this.m_fillBrush=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineBrush",{get:function(){return this.m_lineBrush},set:function(e){this.m_lineChangeTracker.replaceListener(this.m_lineBrush,e),this.m_lineBrush=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pictureBrush",{get:function(){return this.m_pictureBrush},set:function(e){this.m_pictureChangeTracker.replaceListener(this.m_pictureBrush,e),this.m_pictureBrush=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pen",{get:function(){return this.m_pen},set:function(e){this.m_penChangeTracker.replaceListener(this.m_pen,e),this.m_pen=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasLine",{get:function(){return null!=this.m_lineBrush},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendingMode",{get:function(){return this.m_blendingMode},set:function(e){X(this.changeTracker,this.m_blendingMode,e),this.m_blendingMode=e},enumerable:!0,configurable:!0}),e.prototype.getBrushImages=function(e){ae(e,this.fillBrush),ae(e,this.lineBrush),ae(e,this.pictureBrush)},e}();function ae(e,t){if(t&&6==t.getType()){var r=t;r.image&&e.push(r.image)}}var he=function(){function e(e,t){void 0===e&&(e=Q.Transparent),void 0===t&&(t=0),this.m_changeTracker=new F,this.m_color=e,this.m_radius=t}return Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this.m_color},set:function(e){K(this.m_changeTracker,this.m_color,e),this.m_color=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this.m_radius},set:function(e){X(this.m_changeTracker,this.m_radius,e),this.m_radius=e},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new e(this.m_color,this.m_radius)},e}(),ce=function(){function e(e,t,r,i,n,s,o,a,h){void 0===e&&(e=Q.Transparent),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===n&&(n=w.One),void 0===s&&(s=w.Zero),void 0===o&&(o=4),void 0===a&&(a=!1),void 0===h&&(h=0),this.m_changeTracker=new F,this.m_color=e,this.m_radius=t,this.m_angle=r,this.m_distance=i,this.m_scale=n,this.m_skew=s,this.m_alignment=o,this.m_rotateWithShape=a,this.m_shadowType=h}return Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this.m_color},set:function(e){K(this.m_changeTracker,this.m_color,e),this.m_color=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this.m_radius},set:function(e){X(this.m_changeTracker,this.m_radius,e),this.m_radius=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"angle",{get:function(){return this.m_angle},set:function(e){X(this.m_changeTracker,this.m_angle,e),this.m_angle=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"distance",{get:function(){return this.m_distance},set:function(e){X(this.m_changeTracker,this.m_distance,e),this.m_distance=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this.m_scale},set:function(e){K(this.m_changeTracker,this.m_scale,e),this.m_scale=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skew",{get:function(){return this.m_skew},set:function(e){K(this.m_changeTracker,this.m_skew,e),this.m_skew=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alignment",{get:function(){return this.m_alignment},set:function(e){X(this.m_changeTracker,this.m_alignment,e),this.m_alignment=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotateWithShape",{get:function(){return this.m_rotateWithShape},set:function(e){X(this.m_changeTracker,this.m_rotateWithShape,e),this.m_rotateWithShape=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shadowType",{get:function(){return this.m_shadowType},set:function(e){X(this.m_changeTracker,this.m_shadowType,e),this.m_shadowType=e},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new e(this.m_color,this.m_radius,this.m_angle,this.m_distance,this.m_scale,this.m_skew,this.m_alignment,this.m_rotateWithShape,this.m_shadowType)},e}(),le=function(){function e(e,t,r,i){void 0===e&&(e=Q.Transparent),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),this.m_changeTracker=new F,this.m_color=e,this.m_radius=t,this.m_angle=r,this.m_distance=i}return Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this.m_color},set:function(e){K(this.m_changeTracker,this.m_color,e),this.m_color=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this.m_radius},set:function(e){X(this.m_changeTracker,this.m_radius,e),this.m_radius=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"angle",{get:function(){return this.m_angle},set:function(e){X(this.m_changeTracker,this.m_angle,e),this.m_angle=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"distance",{get:function(){return this.m_distance},set:function(e){X(this.m_changeTracker,this.m_distance,e),this.m_distance=e},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new e(this.m_color,this.m_radius,this.m_angle,this.m_distance)},e}(),ue=function(){function e(e,t,r,i,n,s){void 0===e&&(e=0),void 0===t&&(t=1),void 0===r&&(r=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===s&&(s=0),this.m_changeTracker=new F,this.m_radius=e,this.m_startAlpha=t,this.m_startPosition=r,this.m_endAlpha=i,this.m_endPosition=n,this.m_distance=s}return Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this.m_radius},set:function(e){X(this.m_changeTracker,this.m_radius,e),this.m_radius=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"startAlpha",{get:function(){return this.m_startAlpha},set:function(e){X(this.m_changeTracker,this.m_startAlpha,e),this.m_startAlpha=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"startPosition",{get:function(){return this.m_startPosition},set:function(e){X(this.m_changeTracker,this.m_startPosition,e),this.m_startPosition=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"endAlpha",{get:function(){return this.m_endAlpha},set:function(e){X(this.m_changeTracker,this.m_endAlpha,e),this.m_endAlpha=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"endPosition",{get:function(){return this.m_endPosition},set:function(e){X(this.m_changeTracker,this.m_endPosition,e),this.m_endPosition=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"distance",{get:function(){return this.m_distance},set:function(e){X(this.m_changeTracker,this.m_distance,e),this.m_distance=e},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new e(this.m_radius,this.m_startAlpha,this.m_startPosition,this.m_endAlpha,this.m_endPosition,this.m_distance)},e}(),de=function(){function e(e){void 0===e&&(e=0),this.m_changeTracker=new F,this.m_radius=e}return Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),e.prototype.notifyChange=function(){this.m_changeTracker.notifyChange()},Object.defineProperty(e.prototype,"radius",{get:function(){return this.m_radius},set:function(e){this.m_radius!=e&&(this.notifyChange(),this.m_radius=e)},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new e(this.m_radius)},e}(),fe=function(){function e(e,t,r,i,n){this.m_changeTracker=new F,this.glow=e,this.shadow=t,this.innerShadow=r,this.reflection=i,this.softEdges=n}return Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),e.prototype.notifyChange=function(){this.m_changeTracker.notifyChange()},Object.defineProperty(e.prototype,"glow",{get:function(){return this.m_glow},set:function(e){this.m_changeTracker.replaceListener(this.m_glow,e),this.m_glow=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shadow",{get:function(){return this.m_shadow},set:function(e){this.m_changeTracker.replaceListener(this.m_shadow,e),this.m_shadow=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"innerShadow",{get:function(){return this.m_innerShadow},set:function(e){this.m_changeTracker.replaceListener(this.m_innerShadow,e),this.m_innerShadow=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"reflection",{get:function(){return this.m_reflection},set:function(e){this.m_changeTracker.replaceListener(this.m_reflection,e),this.m_reflection=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"softEdges",{get:function(){return this.m_softEdges},set:function(e){this.m_changeTracker.replaceListener(this.m_softEdges,e),this.m_softEdges=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"direction",{get:function(){return this.m_direction||0},set:function(e){X(this.m_changeTracker,this.m_direction,e),this.m_direction=e},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new e(this.m_glow?this.m_glow.clone():void 0,this.m_shadow?this.m_shadow.clone():void 0,this.m_innerShadow?this.m_innerShadow.clone():void 0,this.m_reflection?this.m_reflection.clone():void 0,this.m_softEdges?this.m_softEdges.clone():void 0)},e}(),pe=function(){function e(e,t){void 0===e&&(e=new fe),void 0===t&&(t=x.Identity),this.m_changeTracker=new F,this.m_animationChangeTracker=new F,this.renderDataMap={},this.m_changeTracker.replaceListener(void 0,e),this.m_effects=e,this.m_isHidden=!1,this.m_transform=t}return e.prototype.cloneItemData=function(e){e.effects=this.m_effects.clone(),e.m_transform=this.m_transform,e.fade=this.m_fade?this.m_fade.clone():void 0,e.m_animationTransform=this.m_animationTransform,e.m_isHidden=this.m_isHidden,e.clientData=this.clientData},Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"animationChangeTracker",{get:function(){return this.m_animationChangeTracker},enumerable:!0,configurable:!0}),e.prototype.notifyChange=function(){this.m_changeTracker.notifyChange()},Object.defineProperty(e.prototype,"version",{get:function(){return this.m_changeTracker.version},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"effects",{get:function(){return this.m_effects},set:function(e){this.m_changeTracker.replaceListener(this.m_effects,e),this.m_effects=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transform",{get:function(){return this.m_transform},set:function(e){this.m_transform.equals(e)||(this.onTransformChanged(this.m_transform,e),this.notifyChange(),this.m_transform=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isHidden",{get:function(){return this.m_isHidden},set:function(e){X(this.m_changeTracker,this.m_isHidden,e),this.m_isHidden=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instanceOffsets",{get:function(){return this.m_instanceOffsets},set:function(e){this.m_instanceOffsets=e?e.slice(0):void 0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fade",{get:function(){return this.m_fade},set:function(e){this.m_animationChangeTracker.replaceListener(this.m_fade,e),this.m_fade=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"animationTransform",{get:function(){return this.m_animationTransform},set:function(e){K(this.m_animationChangeTracker,this.m_animationTransform,e),this.m_animationTransform=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillBoundsOverride",{get:function(){return this.m_fillBoundsOverride},set:function(e){K(this.m_changeTracker,this.m_fillBoundsOverride,e),this.m_fillBoundsOverride=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"effectsBoundsOverride",{get:function(){return this.m_effectsBoundsOverride},set:function(e){K(this.m_changeTracker,this.m_effectsBoundsOverride,e),this.m_effectsBoundsOverride=e},enumerable:!0,configurable:!0}),e.prototype.getBounds=function(e,t,r,i){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===r&&(r=!0),void 0===i&&(i=void 0);var n=i?i.toMatrix3():T.Identity;return be(this,t,r?31:0,r?31:0,n=e&&this.animationTransform?n.multiply(this.animationTransform):n)},e.prototype.onTransformChanged=function(e,t){},e.prototype.clearCache=function(){for(var e in this.renderDataMap)this.renderDataMap[e].releaseGeneratedResources()},e.prototype.releaseGeneratedResources=function(){this.clearCache();var e=[];this.getBrushImages(e);for(var t=0,r=e;t<r.length;t++){r[t].releaseGeneratedResources()}},e}(),ge=function(e){function t(t,r,i,n){void 0===t&&(t=void 0),void 0===r&&(r=new oe),void 0===i&&(i=new fe),void 0===n&&(n=x.Identity);var s=e.call(this,i,n)||this;return s.m_role=0,s.m_geometryTracker=new F,s.m_paths=t,s.m_overlapMode=0,s.m_mergeMode=0,s.changeTracker.replaceListener(void 0,r),F.AddListener(r.penChangeTracker,s.m_geometryTracker),s.m_style=r,s.shapeBoundsCache={},s}return _(t,e),t.prototype.clone=function(){var e=new t;return e.paths=this.m_paths?this.m_paths.slice(0):void 0,e.m_overlapMode=this.m_overlapMode,e.m_mergeMode=this.m_mergeMode,e.style=this.m_style.clone(),e.text=this.m_text?this.m_text.clone():void 0,e.m_role=this.m_role,this.cloneItemData(e),e},t.CreateRectangle=function(e,r,i,n){return void 0===r&&(r=new oe),void 0===i&&(i=new fe),void 0===n&&(n=x.Identity),new t([B.CreateFromRect(e)],r,i,n)},Object.defineProperty(t.prototype,"paths",{get:function(){return this.m_paths},set:function(e){this.m_paths!=e&&(this.notifyGeometryChange(),this.m_paths=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"incrementalPath",{get:function(){return this.m_incrementalPath},set:function(e){this.changeTracker.replaceListener(this.m_incrementalPath,e),this.m_incrementalPath=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"overlapMode",{get:function(){return this.m_overlapMode},set:function(e){this.m_overlapMode!=e&&(this.notifyGeometryChange(),this.m_overlapMode=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mergeMode",{get:function(){return this.m_mergeMode},set:function(e){this.m_mergeMode!=e&&(this.notifyGeometryChange(),this.m_mergeMode=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"style",{get:function(){return this.m_style},set:function(e){this.m_style!=e&&(F.RemoveListener(this.m_style.penChangeTracker,this.m_geometryTracker),F.AddListener(e.penChangeTracker,this.m_geometryTracker),this.changeTracker.replaceListener(this.m_style,e),this.m_style=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"clipBounds",{get:function(){return this.m_clipBounds},set:function(e){K(this.changeTracker,this.m_clipBounds,e),this.m_clipBounds=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"text",{get:function(){return this.m_text},set:function(e){this.m_text!=e&&(this.m_text&&(this.m_text.cache&&this.m_text.cache.clearCache(),F.RemoveListener(this.m_text.changeTracker,this.changeTracker),F.RemoveListener(this.m_text.animationChangeTracker,this.animationChangeTracker)),this.text&&(F.RemoveListener(this.text.changeTracker,this.changeTracker),F.RemoveListener(this.text.animationChangeTracker,this.animationChangeTracker)),this.m_text=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textEffectMetrics",{get:function(){return this.m_textEffectMetrics},set:function(e){K(this.changeTracker,this.m_textEffectMetrics,e),this.m_textEffectMetrics=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"role",{get:function(){return this.m_role},set:function(e){this.m_role!=e&&(this.notifyChange(),this.m_geometryTracker.notifyChange(),this.m_role=e)},enumerable:!0,configurable:!0}),t.prototype.onTransformChanged=function(e,t){e.scale.equals(t.scale)||this.m_geometryTracker.notifyChange()},t.prototype.clearCache=function(){e.prototype.clearCache.call(this),this.text&&this.text.cache&&(this.text.cache.clearCache(),this.text.cache=void 0),this.shapeBoundsCache.pathsBounds=void 0,this.shapeBoundsCache.pathsBoundsWithLine=void 0,this.shapeBoundsCache.pathsBoundsContributors=void 0,this.shapeBoundsCache.pathsBoundsContributorsWithLine=void 0},Object.defineProperty(t.prototype,"geometryTracker",{get:function(){return this.m_geometryTracker},enumerable:!0,configurable:!0}),t.prototype.notifyGeometryChange=function(){this.notifyChange(),this.m_geometryTracker.notifyChange()},t.prototype.getBrushImages=function(e){this.style.getBrushImages(e),this.text&&this.text.getBrushImages(e)},t.prototype.isSolidRectGeometry=function(){return!(!this.m_paths||1!=this.m_paths.length||!this.m_paths[0].isUntransformedRect||1!=this.m_paths[0].fillMode||this.m_paths[0].transform instanceof T||this.m_paths[0].transform instanceof x&&0!=this.m_paths[0].transform.rotation)},t.prototype.isSolidRect=function(){return!!this.isSolidRectGeometry()&&!this.style.hasLine},t.prototype.hasSmallDetails=function(){return 3==this.role||this.style.hasLine&&this.style.pen.lineWidth<3||this.m_paths&&this.m_paths.some((function(e){return e.hasPressureInfo}))},t.prototype.getType=function(){return 1},t}(pe),me=function(e){function t(t,r,i){void 0===t&&(t=void 0),void 0===r&&(r=new fe),void 0===i&&(i=x.Identity);var n=e.call(this,r,i)||this,s=t instanceof A?t:new A(t);return n.changeTracker.replaceListener(void 0,s),n.m_items=s,n}return _(t,e),t.prototype.clone=function(){for(var e=new t,r=0,i=this.m_items.elements;r<i.length;r++){var n=i[r];e.items.push(n.clone())}return e.groupFillBrush=this.m_groupFillBrush?this.m_groupFillBrush.clone():void 0,e.m_isDocumentShape=this.m_isDocumentShape,this.cloneItemData(e),e},Object.defineProperty(t.prototype,"items",{get:function(){return this.m_items},set:function(e){this.setItems(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"groupFillBrush",{get:function(){return this.m_groupFillBrush},set:function(e){this.m_groupFillBrush=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDocumentShape",{get:function(){return this.m_isDocumentShape},set:function(e){this.m_isDocumentShape=e},enumerable:!0,configurable:!0}),t.prototype.setItems=function(e){void 0===e&&(e=void 0);var t=e instanceof A?e:new A(e);this.changeTracker.replaceListener(this.m_items,t),this.m_items=t},t.prototype.clearCache=function(){e.prototype.clearCache.call(this);for(var t=0;t<this.m_items.length;t++)this.m_items.getAt(t).clearCache()},t.prototype.getBrushImages=function(e){ae(e,this.groupFillBrush);for(var t=0,r=this.m_items.elements;t<r.length;t++){r[t].getBrushImages(e)}},t.prototype.getType=function(){return 2},t}(pe);function _e(e,t){if(!e)return!0;if(1==e.getType()){var r=e;if(t(r),r.text&&r.text.cache){for(var i=0,n=r.text.cache.getTextShapes();i<n.length;i++){if(!_e(n[i],t))return!1}for(var s=0,o=r.text.cache.getSelectionShapes()||[];s<o.length;s++){if(!_e(o[s],t))return!1}}}else{if(2!=e.getType())throw l.Error(591525086,"Unknown Item type");for(var a=0,h=e.items.elements;a<h.length;a++){if(!_e(h[a],t))return!1}}return!0}function ve(e){return 1==e.alignment?-1:2==e.alignment?1:0}function ye(e,t,r){if(void 0===r&&(r=void 0),e.incrementalPath)return r?e.incrementalPath.bounds.transformedBounds(r):e.incrementalPath.bounds;var i=0;t&&e.style.hasLine&&(i=e.style.pen.adjustedLineWidth*(.5+Math.abs(Math.max(ve(e.style.pen)))));var n=!r||r.isSimpleScaleTranslationOnly(),s=i?e.shapeBoundsCache.pathsBoundsWithLine:e.shapeBoundsCache.pathsBounds;if(!s&&!i&&n&&e.paths&&(s=e.shapeBoundsCache.pathsBounds=q(e.paths)),s){if(!r)return s;if(n)return s.multiply(r.getSimpleScale()).translate(r.getSimpleTranslation())}var o=i?e.shapeBoundsCache.pathsBoundsContributorsWithLine:e.shapeBoundsCache.pathsBoundsContributors;if(!o){var a=T.Scale2D(e.transform.scale);o=[],e.paths&&function(e,t,r,i,n){for(var s=0,o=e;s<o.length;s++)for(var a=o[s],h=a.transform.toMatrix3().multiply(i),c=0,l=a.figures;c<l.length;c++){var u=l[c];if(n.push(H(u,h,t,r.pen.lineJoin,r.pen.miterLimit)),t&&!u.isClosed&&r.pen){if(r.pen.headEnd&&0!=r.pen.headEnd.end){var d=U(r.pen.headEnd,r.pen.adjustedLineWidthForArrowHead);if(d){var f=W(u,!1,r.pen.headEnd,2*t,h);f&&n.push(H(d,f,t,1,r.pen.miterLimit))}}if(r.pen.tailEnd&&0!=r.pen.tailEnd.end){var p=U(r.pen.tailEnd,r.pen.adjustedLineWidthForArrowHead);if(p){var g=W(u,!0,r.pen.tailEnd,2*t,h);g&&n.push(H(p,g,t,1,r.pen.miterLimit))}}}}}(e.paths,i,e.style,a,o),i?e.shapeBoundsCache.pathsBoundsContributorsWithLine=o:e.shapeBoundsCache.pathsBoundsContributors=o}for(var h=T.Scale2D(e.transform.scale.inverse()),c=r?h.multiply(r):h,l=void 0,u=0,d=o||[];u<d.length;u++){var f=j(d[u],c);l=P.UnionRect(l,f)}if(l&&n){var p=r?l.translate(r.getSimpleTranslation().negate()).multiply(r.getSimpleScale().inverse()):l;t?e.shapeBoundsCache.pathsBoundsWithLine=p:e.shapeBoundsCache.pathsBounds=p}return l}function be(e,t,r,i,n,s,o){void 0===n&&(n=void 0),void 0===s&&(s=!0);var a=n?e.transform.toMatrix3().multiply(n):e.transform.toMatrix3(),h=void 0;if(1==e.getType()){var c=e;if(o||(h=ye(c,!0,a)),c.text&&t&&(s||o)){var l=new x(w.Zero,w.One,e.transform.rotation,e.transform.translation),u=n?l.toMatrix3().multiply(n):l.toMatrix3();h=P.UnionRect(h,c.text.getBoundsOfRange(o,u))}}else if(2==e.getType()&&!o&&s)for(var d=e,f=0;f<d.items.length;f++){var p=d.items.getAt(f),g=p instanceof ge&&3==p.role;!t&&g||(h=P.UnionRect(h,be(p,t,i,i,a)))}if(!o){var m=void 0,_=void 0,v=1&r&&e.effects&&e.effects.glow&&e.effects.glow.radius,y=2&r&&e.effects&&e.effects.shadow,b=4&r&&e.effects&&e.effects.reflection;if((v||y||b)&&(_=n?be(e,t,r,i):h),(y||b)&&(m=e.effectsBoundsOverride?e.effectsBoundsOverride:be(e,!1,0,1)),h&&_&&1&r&&e.effects&&e.effects.glow&&e.effects.glow.radius&&(_=_.inflate(2*e.effects.glow.radius),h=h.inflate(2*e.effects.glow.radius)),(y||b)&&!t&&e instanceof ge&&e.text){var C=be(e,!0,r,i);C&&(_=P.UnionRect(_,C))}if(h&&_&&m&&2&r&&e.effects&&e.effects.shadow){var E=Te(e.effects.shadow.alignment,m),S=xe(e.effects.shadow.angle,e.effects.shadow.distance,e.effects.shadow.scale,e.effects.shadow.skew,E),R=(e.effects.shadow.radius?_.inflate(e.effects.shadow.radius):_).transformedBounds(n?S.multiply(n):S),M=(e.effects.shadow.radius?_.inflate(e.effects.shadow.radius):_).transformedBounds(n?S.multiply(n):S);_=P.UnionRect(_,R),h=P.UnionRect(h,M)}if(h&&_&&m&&4&r&&e.effects&&e.effects.reflection){var I=e.effects.reflection,A=m.bottom+e.effects.reflection.distance/2;e instanceof ge&&e.textEffectMetrics&&(A-=e.textEffectMetrics.descent);var F=T.Translation2D(new w(0,-A)).multiply(T.Scale2D(new w(1,-1))).multiply(T.Translation2D(new w(0,A))),B=(I.radius?_.inflate(I.radius):_).transformedBounds(F),D=n?(I.radius?_.inflate(I.radius):_).transformedBounds(F.multiply(n)):B;h=P.UnionRect(h,D)}}return h}var we=[new w(0,0),new w(.5,0),new w(1,0),new w(0,.5),new w(.5,.5),new w(1,.5),new w(0,1),new w(.5,1),new w(1,1)];function Te(e,t){return void 0===t&&(t=void 0),t?we[e].multiply(t.size).add(t.leftTop):we[e]}function xe(e,t,r,i,n){var s=T.Translation2D(n.negate()),o=new w(t,0).rotate(e).add(n),a=new T(r.x,i.y,0,i.x,r.y,0,o.x,o.y,1);return s.multiply(a)}function Pe(e,t){var r=e.getType();if(1==r){var i=e.style;switch(t){case 0:return i.fillBrush;case 1:return i.lineBrush;case 2:return i.pictureBrush}}if(2==r&&0==t)return e.groupFillBrush;l.Error(591192835,"Invalid item or brush")}(function(){function e(e,t,r,i,n){this.renderDataMap={},this.contents=e,this.location=t,this.zPosition=r,this.parentTransform=n,this.morphingGrid=i}e.prototype.clearCache=function(){for(var e in this.renderDataMap)this.renderDataMap[e].releaseGeneratedResources()},e.CreateFromItem=function(t,r,i,n,s,o){var a=T.FromTransforms(t.transform,o||T.Identity,t.animationTransform||T.Identity),h=a.transformVector(new w(1,0)),c=a.transformVector(new w(0,1)),l=i.transformedBounds(a);return new e([{item:t,includeSubtree:n,textRange:s}],{center:l?l.center:w.Zero,size:l?i.size.multiply(new w(h.length(),c.length())):w.Zero,rotation:t.transform.rotation,flipX:t.transform.scale.x<0,flipY:t.transform.scale.y<0},r,void 0,o)},e.TryCreateFromShape=function(t,r,i,n){var s=ye(t,!1);return s?e.CreateFromItem(t,r,s,i,void 0,n):void 0},e.TryCreateFromText=function(t,r,i,n){if(t.text){var s=t.text.getFullRange(),o=i||s;if(s&&o&&s.contains(o)){var a=t.text.getBoundsOfRange(o);if(a){var h=a.transformedBounds(x.fromScaleAndTranslation(t.transform.scale.inverse(),t.transform.preTranslation.negate()));return h?e.CreateFromItem(t,r,h,!0,o,n):void 0}}else l.Error(592525387,"TryCreateFromText out of range: "+(i?(i.start,i.last,"]"):void 0)+" fullRange: "+(s?(s.start,s.last,"]"):"undefined"))}else l.Error(592525386,"TryCreateFromText on Shape with no Text")},e.TryCreateFromGroup=function(t,r,i,n){var s=be(t,!1,0,0,t.transform.toInverseMatrix3());return s?e.CreateFromItem(t,r,s,i,void 0,n):void 0}})(),function(){function e(e){void 0===e&&(e=[]),this.renderDataMap={},this.keyFrames=e}e.prototype.clearCache=function(){for(var e=0,t=this.keyFrames||[];e<t.length;e++){var r=t[e];r&&r.clearCache()}}}();var Ce=function(){function e(){this.elements=[]}return e.prototype.clearCache=function(){this.elements.forEach((function(e){return e.clearCache()}))},e}(),Ee=function(){function e(e,t){this.start=e,this.length=t}return Object.defineProperty(e.prototype,"last",{get:function(){return this.start+this.length-1},enumerable:!0,configurable:!0}),e.prototype.equals=function(e){return this.start==e.start&&this.length==e.length},e.prototype.includes=function(e){return e>=this.start&&e<=this.last},e.prototype.intersects=function(e){return this.start<=e.last&&this.last>=e.start},e.prototype.contains=function(e){return this.start<=e.start&&e.last<=this.last},e.prototype.getIntersection=function(t){var r=e.FromFirstLast(Math.max(this.start,t.start),Math.min(this.last,t.last));return r.length>=0?r:void 0},e.prototype.move=function(t){return new e(this.start+t,this.length)},e.FromFirstLast=function(t,r){return new e(t,r+1-t)},e}(),Se=function(){function e(e){this.m_defaultData=e}return e.prototype.onDataChange=function(){},e.prototype.onRangeChange=function(){},e.prototype.onDataRemoved=function(e){},e.prototype.onDataAdded=function(e){},Object.defineProperty(e.prototype,"defaultData",{get:function(){return this.m_defaultData},set:function(e){this.m_defaultData=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ranges",{get:function(){for(var e=[],t=0,r=this.m_dataPerRange||[];t<r.length;t++){var i=r[t];e.push(i.range)}return e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"allData",{get:function(){for(var e=[this.m_defaultData],t=0,r=this.m_dataPerRange||[];t<r.length;t++){var i=r[t];e.push(i.data)}return e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dataPerRange",{get:function(){return this.m_dataPerRange||[]},enumerable:!0,configurable:!0}),e.prototype.set=function(e,t){if(this.onDataChange(),t){for(var r=0,i=this.m_dataPerRange||[];r<i.length;r++){if((o=i[r]).range.start==t.start&&o.range.last==t.last)return this.onDataRemoved(o.data),o.data=e,void this.onDataAdded(o.data)}for(var n=0,s=this.m_dataPerRange||[];n<s.length;n++){var o=s[n];this.onDataRemoved(o.data)}this.onRangeChange();for(var a=[],h=!1,c=0,l=this.m_dataPerRange||[];c<l.length;c++){(o=l[c]).range.start<t.start&&a.push({range:Ee.FromFirstLast(o.range.start,Math.min(o.range.last,t.start-1)),data:o.data}),t.last<o.range.last&&(h||(a.push({range:t,data:e}),h=!0),a.push({range:Ee.FromFirstLast(Math.max(o.range.start,t.last+1),o.range.last),data:o.data}))}h||a.push({range:t,data:e}),this.m_dataPerRange=a;for(var u=0,d=this.m_dataPerRange||[];u<d.length;u++){o=d[u];this.onDataAdded(o.data)}}else{for(var f=0,p=this.m_dataPerRange||[];f<p.length;f++){var g=p[f];this.onDataRemoved(g.data)}this.m_defaultData=e,this.m_dataPerRange=void 0}},e.prototype.getAt=function(e){for(var t=0,r=this.m_dataPerRange||[];t<r.length;t++){var i=r[t];if(i.range.start<=e&&e<=i.range.last)return i.data}return this.m_defaultData},e.prototype.shiftIndices=function(e,t){if(this.m_dataPerRange){for(var r=[],i=t-e.length,n=0,s=this.m_dataPerRange;n<s.length;n++){var o=s[n];if(e.contains(o.range)&&e.start!=o.range.start)this.onDataRemoved(o.data);else if(o.range.includes(e.start)){var a=Math.min(e.length,o.range.last+1-e.start);r.push({range:new Ee(o.range.start,o.range.length+t-a),data:o.data})}else o.range.start<=e.last&&e.last<=o.range.last?r.push({range:Ee.FromFirstLast(e.start+t,o.range.last+i),data:o.data}):e.last<o.range.start?r.push({range:o.range.move(i),data:o.data}):r.push(o)}this.m_dataPerRange=r}},e}(),Re=function(e){function t(t){var r=e.call(this,t)||this;return r.m_changeTracker=new F,r.m_rangeChangeTracker=new F,r.m_changeTracker.replaceListener(void 0,t),r}return _(t,e),Object.defineProperty(t.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rangeChangeTracker",{get:function(){return this.m_rangeChangeTracker},enumerable:!0,configurable:!0}),t.prototype.onDataChange=function(){this.m_changeTracker.notifyChange()},t.prototype.onRangeChange=function(){this.rangeChangeTracker.notifyChange()},t.prototype.onDataRemoved=function(e){F.RemoveListener(e.changeTracker,this.m_changeTracker)},t.prototype.onDataAdded=function(e){F.AddListener(e.changeTracker,this.m_changeTracker)},t}(Se),Me=function(){function e(e,t,r,i){this.m_changeTracker=new F,this.m_type=e,this.m_verticalCenter=t,this.m_thickness=r,this.style=i}return e.prototype.clone=function(){return new e(this.m_type,this.m_verticalCenter,this.m_thickness,this.m_style?this.m_style.clone():void 0)},Object.defineProperty(e.prototype,"type",{get:function(){return this.m_type},set:function(e){X(this.changeTracker,this.m_type,e),this.m_type=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"verticalCenter",{get:function(){return this.m_verticalCenter},set:function(e){X(this.changeTracker,this.m_verticalCenter,e),this.m_verticalCenter=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"thickness",{get:function(){return this.m_thickness},set:function(e){X(this.changeTracker,this.m_thickness,e),this.m_thickness=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"style",{get:function(){return this.m_style},set:function(e){this.changeTracker.replaceListener(this.m_style,e),this.m_style=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),e}(),Ie=function(){function e(e,t,r){void 0===r&&(r=!1),this.m_changeTracker=new F,this.m_animationTransform=t,this.m_isHidden=r,this.fade=e}return e.prototype.clone=function(){return new e(this.m_fade?this.m_fade.clone():void 0,this.m_animationTransform)},Object.defineProperty(e.prototype,"fade",{get:function(){return this.m_fade},set:function(e){this.m_changeTracker.replaceListener(this.m_fade,e),this.m_fade=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"animationTransform",{get:function(){return this.m_animationTransform},set:function(e){K(this.m_changeTracker,this.m_animationTransform,e),this.m_animationTransform=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isHidden",{get:function(){return!!this.m_isHidden},set:function(e){e!=this.isHidden&&(this.m_changeTracker.notifyChange(),this.m_isHidden=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),e}(),Ae=new T(0,-1,0,1,0,0,0,0,1),Fe=function(){function e(e,t,r,i,n,s){this.lineRect=e,this.path=t,this.alignment=r,this.scale=i,this.pivot=n,this.isVerticalLayout=s,this.pathLength=t.measureLength(),this.equivalentWarpingEnvelope=this.calculateEquivalentWarpingEnvelope()}return e.prototype.equals=function(e){return this.lineRect.equals(e.lineRect)&&this.path==e.path&&this.alignment==e.alignment&&this.scale==e.scale&&this.pivot==e.pivot&&this.isVerticalLayout==e.isVerticalLayout},e.prototype.getPathPosition=function(e){var t=this.isVerticalLayout?e.transformedBounds(Ae):e,r=this.isVerticalLayout?this.lineRect.transformedBounds(Ae):this.lineRect;if(t&&r){var i=r.width,n=0;if(i*this.scale<this.pathLength){var s=this.pathLength-i*this.scale;n=this.alignment*(s/this.pathLength)}var o=(t.left-r.left)*this.scale/this.pathLength+n;return(o+(o+t.width/this.pathLength*this.scale))/2}},e.prototype.getTransform=function(e){var t=this.getPathPosition(e),r=this.isVerticalLayout?e.transformedBounds(Ae):e;if(t&&r){var i=R(t,0,1)*this.pathLength,n=this.path.getPointFromDist(i),s=this.path.getTangentFromDist(i);if(s){var o=(r.left+r.right)/2,a=r.top+r.height*this.pivot,h=T.Translation2D(new w(-o,-a));h=h.multiply(T.Scale2D(new w(this.scale,this.scale)));var c=s.x,l=s.y;return h=(h=h.multiply(new T(c,l,0,-l,c,0,0,0,1))).multiply(T.Translation2D(n)),this.isVerticalLayout&&(h=Ae.multiply(h)),h}}},e.prototype.calculateEquivalentWarpingEnvelope=function(){for(var e=new O,t=new O,r=this.isVerticalLayout?0:this.lineRect.height/2,i=this.isVerticalLayout?this.lineRect.top:this.lineRect.left,n=this.isVerticalLayout?this.lineRect.bottom:this.lineRect.right,s=this.lineRect,o=0;o<=1;o+=1/256){var a=i+(n-i)*o,h=this.isVerticalLayout?new P(this.lineRect.right,a-r,this.lineRect.left,a+r):new P(a-r,this.lineRect.top,a+r,this.lineRect.bottom),c=this.getPathPosition(h);if(null!=c&&c>=0&&c<=1){var l=a+(2*o-1)*r,u=this.getTransform(h);if(u){var d=u.transformPoint(this.isVerticalLayout?new w(h.left,l):new w(l,h.top)),f=u.transformPoint(this.isVerticalLayout?new w(h.right,l):new w(l,h.bottom));0==e.getPointCount()?(e.moveToPoint(d),t.moveToPoint(f),s=new P(this.isVerticalLayout?s.left:l,this.isVerticalLayout?l:s.top,s.right,s.bottom)):(e.lineToPoint(d),t.lineToPoint(f),s=new P(s.left,s.top,this.isVerticalLayout?s.right:l,this.isVerticalLayout?l:s.bottom))}}}return new De(s,e.createFigure(),t.createFigure(),this.isVerticalLayout)},e}(),Be=function(){function e(e){this.currentX=0,this.currentY=0,this.m_samplesX=new Float32Array(257),this.m_samplesY=new Float32Array(257);for(var t=e.measureLength(),r=0;r<=256;r++){var i=e.getPointFromDist(t*r/256);this.m_samplesX[r]=i.x,this.m_samplesY[r]=i.y}}return e.prototype.moveTo=function(e){var t=Math.floor(256*e),r=Math.min(t+1,256),i=256*e-t;this.currentX=this.m_samplesX[t]*(1-i)+this.m_samplesX[r]*i,this.currentY=this.m_samplesY[t]*(1-i)+this.m_samplesY[r]*i},e.prototype.equals=function(e){for(var t=0;t<=256;t++)if(this.m_samplesX[t]!=e.m_samplesX[t]||this.m_samplesY[t]!=e.m_samplesY[t])return!1;return!0},e}(),De=function(){function e(e,t,r,i){void 0===i&&(i=!1),this.sourceRect=e,this.topPath=t,this.bottomPath=r,this.isVerticalLayout=i,this.topCurve=new Be(t),this.bottomCurve=new Be(r)}return e.prototype.equals=function(e){return this.sourceRect.equals(e.sourceRect)&&this.topCurve.equals(e.topCurve)&&this.bottomCurve.equals(e.bottomCurve)&&this.isVerticalLayout==e.isVerticalLayout},e.prototype.warpPoint=function(e){var t=R(this.isVerticalLayout?(e.y-this.sourceRect.top)/this.sourceRect.height:(e.x-this.sourceRect.left)/this.sourceRect.width,0,1),r=R(this.isVerticalLayout?1-(e.x-this.sourceRect.left)/this.sourceRect.width:(e.y-this.sourceRect.top)/this.sourceRect.height,0,1);return this.topCurve.moveTo(t),this.bottomCurve.moveTo(t),new w(M(this.topCurve.currentX,this.bottomCurve.currentX,r),M(this.topCurve.currentY,this.bottomCurve.currentY,r))},e.prototype.warpPath=function(e){for(var t=this,r=[],i=Math.max(this.sourceRect.width)/4,n=T.FromTransforms(e.transform),s=function(e){if(e.getPointCount()>0){var s=new O;s.moveToPoint(o.warpPoint(e.getPoint(0).transformPoint(n))),e.forEachSegment((function(e,r,o){for(var a=r||w.InterpolateLinear(e,o,.5),h=Math.max(1,Math.ceil(Math.abs(o.x-e.x)/i)),c=0;c<h;c++){var l=t.warpPoint(w.InterpolateQuadratic(e,a,o,c/h).transformPoint(n)),u=t.warpPoint(w.InterpolateQuadratic(e,a,o,(c+.5)/h).transformPoint(n)),d=t.warpPoint(w.InterpolateQuadratic(e,a,o,(c+1)/h).transformPoint(n)),f=u.add(u.subtract(w.InterpolateLinear(l,d,.5)));s.quadBezierToPoint(f,d)}return!0})),e.isClosed&&s.close(),r.push(s.createFigure())}},o=this,a=0,h=e.figures;a<h.length;a++){s(h[a])}return new B({figures:r,fillMode:e.fillMode,lineEnabled:e.lineEnabled,extrusionEnabled:e.extrusionEnabled,transform:void 0})},e}(),Le=function(){function e(e,t,r){this.image=e,this.rect=t,this.transform=r}return e.prototype.equals=function(e){return this.image==e.image&&this.rect==e.rect},e}(),Oe=function(){function e(e,t,r,i,n){this.layoutBounds=e,this.paths=t instanceof Array?t.slice(0):t,this.forceWarping=r,this.isWhiteSpace=i,this.textImage=n}return e.prototype.equals=function(e){if(!this.layoutBounds.equals(e.layoutBounds))return!1;if(!this.paths&&!e.paths)return!0;if(this.paths instanceof B&&e.paths instanceof B)return this.paths.equals(e.paths);if(this.paths instanceof Array&&e.paths instanceof Array){if(this.paths.length!=e.paths.length)return!1;for(var t=0;t<this.paths.length;t++)if(!this.paths[t].equals(e.paths[t]))return!1;return!0}return!this.paths&&!e.paths},e.prototype.getTranslatedCopy=function(t){var r=void 0;if(this.paths instanceof B)r=new B(this.paths,this.paths.transform.applyTranslationAfter(t));else if(this.paths){r=new Array(this.paths.length);for(var i=0;i<this.paths.length;i++)r[i]=new B(this.paths[i],this.paths[i].transform.applyTranslationAfter(t))}return new e(this.layoutBounds.translate(t),r,this.forceWarping)},e}(),ke=function(){function e(e,t,r,i){this.m_changeTracker=new F,this.m_character=e,this.style=t,this.effects=r,this.strokes=i}return e.prototype.clone=function(){var t=new e(this.m_character,this.m_style?this.m_style.clone():void 0,this.m_effects?this.m_effects.clone():void 0);if(this.m_strokes){t.m_strokes=new A;for(var r=0,i=this.m_strokes.elements;r<i.length;r++){var n=i[r];t.m_strokes.push(n.clone())}}return t},Object.defineProperty(e.prototype,"character",{get:function(){return this.m_character},set:function(e){this.m_character.equals(e)||(this.m_changeTracker.notifyChange(),this.m_character=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"style",{get:function(){return this.m_style},set:function(e){this.m_changeTracker.replaceListener(this.m_style,e),this.m_style=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"effects",{get:function(){return this.m_effects},set:function(e){this.m_changeTracker.replaceListener(this.m_effects,e),this.m_effects=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strokes",{get:function(){return this.m_strokes},set:function(e){this.m_changeTracker.replaceListener(this.m_strokes,e),this.m_strokes=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),e.prototype.equals=function(e){return!!this.m_character.equals(e.m_character)&&(this.m_style==e.m_style&&this.m_effects==e.effects&&this.m_strokes==e.m_strokes)},e}(),Ne=function(){function e(e,t,r){this.ascent=e,this.descent=t,this.fontHeightInPoints=r}return e.prototype.equals=function(e){return this.ascent==e.ascent&&this.descent==e.descent&&this.fontHeightInPoints==e.fontHeightInPoints},e}(),Ge=function(){function e(e,t){this.m_changeTracker=new F,this.m_characters=[],this.m_localRange=e,this.m_layoutBounds=t,this.m_fillBounds=t,this.m_offset=w.Zero}return e.prototype.clone=function(){for(var t=new e(this.m_localRange,this.m_layoutBounds),r=0,i=this.m_characters;r<i.length;r++){var n=i[r];t.addCharacter(n)}return t.m_fillBounds=this.m_fillBounds,t.m_textEffectMetrics=this.m_textEffectMetrics,t.bender=this.m_bender,t},Object.defineProperty(e.prototype,"characters",{get:function(){return this.m_characters},set:function(e){Y(this.m_changeTracker,this.m_characters,e),this.m_characters=e.slice(0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localRange",{get:function(){return this.m_localRange},set:function(e){K(this.m_changeTracker,this.m_localRange,e),this.m_localRange=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offset",{get:function(){return this.m_offset},set:function(e){K(this.m_changeTracker,this.m_offset,e),this.m_offset=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"layoutBounds",{get:function(){return this.m_layoutBounds},set:function(e){K(this.m_changeTracker,this.m_layoutBounds,e),this.m_layoutBounds=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillBounds",{get:function(){return this.m_fillBounds},set:function(e){K(this.m_changeTracker,this.m_fillBounds,e),this.m_fillBounds=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textEffectMetrics",{get:function(){return this.m_textEffectMetrics},set:function(e){K(this.m_changeTracker,this.m_textEffectMetrics,e),this.m_textEffectMetrics=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bender",{get:function(){return this.m_bender},set:function(e){this.bender==e||this.bender instanceof Fe&&e instanceof Fe&&this.bender.equals(e)||this.bender instanceof De&&e instanceof De&&this.bender.equals(e)||(this.m_changeTracker.notifyChange(),this.m_bender=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"flowDirection",{get:function(){return 0==this.m_characters.length?0:Math.sign(this.m_characters[this.m_characters.length-1].layoutBounds.left-this.m_characters[0].layoutBounds.left)},enumerable:!0,configurable:!0}),e.prototype.removeAllCharacters=function(){this.characters=[]},e.prototype.addCharacter=function(e){this.m_changeTracker.notifyChange(),this.m_characters.push(e)},e}(),Ue=function(){function e(e,t){this.m_lines=[],this.m_localWordRanges=[],this.m_changeTracker=new F,this.m_globalRange=e,this.m_stylePerLocalRange=new Re(t),this.m_effectsPerLocalRange=new Re(new fe),this.m_strokesPerLocalRange=new Re(new A),this.m_changeTracker.replaceListener(void 0,this.m_stylePerLocalRange),this.m_offset=w.Zero}return e.prototype.clone=function(){for(var t=new e(this.m_globalRange,this.m_stylePerLocalRange.defaultData),r=0,i=this.m_lines;r<i.length;r++){var n=i[r];t.addLine(n.clone())}t.m_offset=this.m_offset,t.bullet=this.m_bullet?this.m_bullet.clone():void 0;for(var s=0,o=this.m_stylePerLocalRange.ranges;s<o.length;s++){var a=o[s];t.m_stylePerLocalRange.set(this.m_stylePerLocalRange.getAt(a.start).clone(),a)}t.m_effectsPerLocalRange.defaultData=this.m_effectsPerLocalRange.defaultData;for(var h=0,c=this.m_effectsPerLocalRange.ranges;h<c.length;h++){var l=c[h];t.m_effectsPerLocalRange.set(this.m_effectsPerLocalRange.getAt(l.start).clone(),l)}t.m_strokesPerLocalRange.defaultData=this.m_strokesPerLocalRange.defaultData;for(var u=0,d=this.m_strokesPerLocalRange.ranges;u<d.length;u++){for(var f=d[u],p=this.m_strokesPerLocalRange.getAt(f.start),g=new A,m=0,_=p.elements;m<_.length;m++){var v=_[m];g.push(v.clone())}t.m_strokesPerLocalRange.set(g,f)}return t.m_localWordRanges=this.m_localWordRanges.slice(0),t},Object.defineProperty(e.prototype,"lines",{get:function(){return this.m_lines},set:function(e){this.removeAllLines();for(var t=0,r=e;t<r.length;t++){var i=r[t];this.addLine(i)}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stylePerLocalRange",{get:function(){return this.m_stylePerLocalRange},set:function(e){this.m_changeTracker.replaceListener(this.m_stylePerLocalRange,e),this.m_stylePerLocalRange=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"effectsPerLocalRange",{get:function(){return this.m_effectsPerLocalRange},set:function(e){this.m_changeTracker.replaceListener(this.m_effectsPerLocalRange,e),this.m_effectsPerLocalRange=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strokesPerLocalRange",{get:function(){return this.m_strokesPerLocalRange},set:function(e){this.m_changeTracker.replaceListener(this.m_strokesPerLocalRange,e),this.m_strokesPerLocalRange=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"globalRange",{get:function(){return this.m_globalRange},set:function(e){this.m_globalRange.equals(e)||(this.m_changeTracker.notifyChange(),this.m_globalRange=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offset",{get:function(){return this.m_offset},set:function(e){K(this.m_changeTracker,this.m_offset,e),this.m_offset=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bullet",{get:function(){return this.m_bullet},set:function(e){this.m_changeTracker.replaceListener(this.m_bullet,e),this.m_bullet=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localWordRanges",{get:function(){return this.m_localWordRanges},set:function(e){Y(this.m_changeTracker,this.m_localWordRanges,e),this.m_localWordRanges=e.slice(0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),e.prototype.removeAllLocalWordRanges=function(){this.localWordRanges=[]},e.prototype.addLocalWordRange=function(e){this.m_changeTracker.notifyChange(),this.m_localWordRanges.push(e)},e.prototype.removeAllLines=function(){for(var e=0,t=this.m_lines;e<t.length;e++){var r=t[e];F.RemoveListener(r.changeTracker,this.m_changeTracker)}this.m_lines=[]},e.prototype.addLine=function(e){F.AddListener(e.changeTracker,this.m_changeTracker),this.m_lines.push(e)},e}(),Ve=(function(){function e(e,t,r,i){this.m_isAnchoredToPrevious=!1,this.m_changeTracker=new F,this.m_changeTracker.replaceListener(void 0,t),this.m_range=e,this.m_style=t,this.m_caretWidth=r,this.m_isAnchoredToPrevious=i}e.CreateCaret=function(t,r,i,n){return new e(new Ee(t,0),n||new oe(new $(Q.White),void 0,new se,2),r,i)},e.CreateRangeSelection=function(t,r){return new e(t,r,0,!1)},e.prototype.clone=function(){return new e(this.m_range,this.m_style.clone(),this.m_caretWidth,this.m_isAnchoredToPrevious)},Object.defineProperty(e.prototype,"range",{get:function(){return this.m_range},set:function(e){this.m_range.equals(e)||(this.m_changeTracker.notifyChange(),this.m_range=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"style",{get:function(){return this.m_style},set:function(e){this.m_changeTracker.replaceListener(this.m_style,e),this.m_style=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"caretWidth",{get:function(){return this.m_caretWidth},set:function(e){X(this.m_changeTracker,this.m_caretWidth,e),this.m_caretWidth=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isAnchoredToPrevious",{get:function(){return this.m_isAnchoredToPrevious},set:function(e){X(this.m_changeTracker,this.m_isAnchoredToPrevious,e),this.m_isAnchoredToPrevious=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0})}(),function(){function e(){this.m_paragraphs=[],this.m_changeTracker=new F,this.m_animationChangeTracker=new F,this.m_selectionChangeTracker=new F,this.m_layoutToFrame=x.Identity,this.m_frameToShape=x.Identity}return e.prototype.clone=function(){for(var t=new e,r=0,i=this.m_paragraphs;r<i.length;r++){var n=i[r];t.addParagraph(n.clone())}if(t.m_layoutToFrame=this.m_layoutToFrame,t.m_frameToShape=this.m_frameToShape,this.m_animationProps){t.m_animationProps=new Re(new Ie),t.m_animationProps.defaultData=this.m_animationProps.defaultData;for(var s=0,o=this.m_animationProps.ranges;s<o.length;s++){var a=o[s];t.m_animationProps.set(this.m_animationProps.getAt(a.start).clone(),a)}}if(this.m_selectionHighlights){t.m_selectionHighlights=[];for(var h=0,c=this.m_selectionHighlights;h<c.length;h++){var l=c[h];t.m_selectionHighlights.push(l.clone())}}return t},e.prototype.createAnimationProps=function(){this.animationProps=new Re(new Ie)},e.prototype.hasAnimationProps=function(){return!!this.animationProps},Object.defineProperty(e.prototype,"paragraphs",{get:function(){return this.m_paragraphs},set:function(e){if(this.m_paragraphs!=e){this.removeAllParagraphs();for(var t=0,r=e;t<r.length;t++){var i=r[t];this.addParagraph(i)}}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"layoutToFrame",{get:function(){return this.m_layoutToFrame},set:function(e){K(this.m_changeTracker,this.m_layoutToFrame,e),this.m_layoutToFrame=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"frameToShape",{get:function(){return this.m_frameToShape},set:function(e){K(this.m_changeTracker,this.m_frameToShape,e),this.m_frameToShape=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"animationProps",{get:function(){return this.m_animationProps},set:function(e){this.m_animationProps!=e&&(this.m_animationProps&&(F.RemoveListener(this.m_animationProps.changeTracker,this.m_animationChangeTracker),F.RemoveListener(this.m_animationProps.rangeChangeTracker,this.m_changeTracker)),e&&(F.AddListener(e.changeTracker,this.m_animationChangeTracker),F.AddListener(e.rangeChangeTracker,this.m_changeTracker)),this.m_animationProps=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"selectionHighlights",{get:function(){return this.m_selectionHighlights},set:function(e){!function(e,t,r){if(t!=r)if(t&&r&&t.length==r.length){for(var i=0;i<t.length;i++)if(t[i]!=r[i])return void e.notifyChange()}else e.notifyChange()}(this.m_selectionChangeTracker,this.m_selectionHighlights,e),this.m_selectionHighlights=e?e.slice(0):void 0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clipBounds",{get:function(){return this.m_clipBounds},set:function(e){K(this.m_changeTracker,this.m_clipBounds,e),this.m_clipBounds=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"applyEffectsPerCharacter",{get:function(){return!!this.m_applyEffectsPerCharacter},set:function(e){X(this.m_changeTracker,!!this.m_applyEffectsPerCharacter,e),this.m_applyEffectsPerCharacter=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"animationChangeTracker",{get:function(){return this.m_animationChangeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textVersion",{get:function(){return this.m_changeTracker.version},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"selectionVersion",{get:function(){return this.m_selectionChangeTracker.version},enumerable:!0,configurable:!0}),e.prototype.forceSplit=function(e){(!this.m_explicitTextSplit||e>this.m_explicitTextSplit)&&(this.m_changeTracker.notifyChange(),this.m_explicitTextSplit=e)},e.prototype.removeAllParagraphs=function(){for(var e=0,t=this.m_paragraphs;e<t.length;e++){var r=t[e];F.RemoveListener(r.changeTracker,this.m_changeTracker)}this.m_paragraphs=[]},e.prototype.addParagraph=function(e){F.AddListener(e.changeTracker,this.m_changeTracker),this.m_paragraphs.push(e)},e.prototype.removeParagraph=function(e){F.RemoveListener(this.m_paragraphs[e].changeTracker,this.m_changeTracker),this.m_paragraphs.splice(e)},e.prototype.getFullRange=function(){return this.paragraphs.length<1?void 0:Ee.FromFirstLast(this.paragraphs[0].globalRange.start,this.paragraphs[this.paragraphs.length-1].globalRange.last)},e.prototype.getRunRanges=function(){var e=this.getFullRange();if(e){for(var t=[],r=0,i=this.paragraphs;r<i.length;r++){var n=i[r];if(2==this.m_explicitTextSplit||this.applyEffectsPerCharacter)for(var s=n.globalRange.start;s<=n.globalRange.last;s++)ze(t,s);else{for(var o=n.globalRange.start,a=0,h=n.lines;a<h.length;a++){var c=h[a];ze(t,o+c.localRange.start),ze(t,o+c.localRange.last+1)}for(var l=0,u=n.stylePerLocalRange.ranges;l<u.length;l++){var d=u[l];ze(t,o+d.start),ze(t,o+d.last+1)}for(var f=0,p=n.effectsPerLocalRange.ranges;f<p.length;f++){d=p[f];ze(t,o+d.start),ze(t,o+d.last+1)}for(var g=0,m=n.strokesPerLocalRange.ranges;g<m.length;g++){d=m[g];ze(t,o+d.start),ze(t,o+d.last+1)}if(1==this.m_explicitTextSplit)for(var _=0,v=n.localWordRanges;_<v.length;_++){d=v[_];ze(t,o+d.start),ze(t,o+d.last+1)}}}if(this.animationProps)for(var y=function(e){t.some((function(t){return t==e.start}))||t.push(e.start),t.some((function(t){return t==e.last+1}))||t.push(e.last+1)},b=0,w=this.animationProps.ranges;b<w.length;b++){y(w[b])}return We(t,e)}return[]},e.prototype.getAnimatablePartRanges=function(e,t,r){var i=t||this.getFullRange();if(i&&0!=i.length){if(t&&r){if(t.start<0||t.start>=this.paragraphs.length||t.last<0||t.last>=this.paragraphs.length)return void l.Error(592525336,"bad paragraph range");i=Ee.FromFirstLast(this.paragraphs[t.start].globalRange.start,this.paragraphs[t.last].globalRange.last)}if(0==e)return i?[i]:void 0;for(var n=[],s=0,o=this.paragraphs;s<o.length;s++){for(var a=o[s],h=a.globalRange.start,c=0,u=a.lines;c<u.length;c++){var d=u[c];if(ze(n,h+d.localRange.start),ze(n,h+d.localRange.last+1),2==e)for(var f=h+d.localRange.start,p=!1,g=0;g<d.characters.length;g++)p||ze(n,f+g),p=1==d.characters[g].isWhiteSpace}if(1==e)for(var m=0,_=a.localWordRanges;m<_.length;m++){ze(n,h+_[m].start)}}return We(n,i)}},e.prototype.getTextPathsForCharacter=function(e,t,r){for(var i=[],n=0,s=e.paths instanceof B?[e.paths]:e.paths?e.paths:[];n<s.length;n++){var o=s[n],a=T.Translation2D(t).multiply(this.layoutToFrame.toMatrix3()),h=o.transform.toMatrix3().multiply(a).tryGetTransform(o.transform.preTranslation);if(!h)throw l.Error(592525337,"unexpected transform");var c=new B(o,h),u=r instanceof De?r:void 0;if(r instanceof Fe){var d=e.layoutBounds.isEmpty()?void 0:e.layoutBounds.transformedBounds(a);if(e.forceWarping||!d)u=r.equivalentWarpingEnvelope;else{var f=r.getTransform(d);f&&(c=(h=h.toMatrix3().multiply(f.toMatrix3()).tryGetTransform(o.transform.preTranslation))?new B(o,h):void 0)}}u&&c&&(c=u.warpPath(c)),c&&i.push(c)}return i},e.prototype.getTextPathsForRange=function(e){for(var t=[],r=0,i=this.paragraphs;r<i.length;r++){var n=i[r];if(n.globalRange.intersects(e))for(var s=0,o=n.lines;s<o.length;s++){var a=o[s],h=new Ee(0,a.characters.length).getIntersection(e.move(-n.globalRange.start-a.localRange.start));if(h)for(var c=h.start;c<=h.last;c++){var l=this.getTextPathsForCharacter(a.characters[c],a.offset.add(n.offset),a.bender);t.push.apply(t,l)}}}return t},e.prototype.getLineAndParagraphAt=function(e){for(var t=0,r=this.paragraphs;t<r.length;t++){var i=r[t];if(i.globalRange.includes(e))for(var n=e-i.globalRange.start,s=0,o=i.lines;s<o.length;s++){var a=o[s];if(a.localRange.includes(n))return{line:a,paragraph:i}}}},e.prototype.getStyleAt=function(e){for(var t=0,r=this.paragraphs;t<r.length;t++){var i=r[t];if(i.globalRange.includes(e))return i.stylePerLocalRange.getAt(e-i.globalRange.start)}},e.prototype.getEffetcsAt=function(e){for(var t=0,r=this.paragraphs;t<r.length;t++){var i=r[t];if(i.globalRange.includes(e))return i.effectsPerLocalRange.getAt(e-i.globalRange.start)}},e.prototype.getStrokesAt=function(e){for(var t=0,r=this.paragraphs;t<r.length;t++){var i=r[t];if(i.globalRange.includes(e))return i.strokesPerLocalRange.getAt(e-i.globalRange.start)}},e.prototype.getPathFromLayoutRect=function(e,t,r){var i=T.Translation2D(r).multiply(this.layoutToFrame.toMatrix3()).tryGetTransform(w.Zero);if(i){var n=new B({figures:[L.CreateFromRect(e)],transform:i}),s=t.bender instanceof Fe?t.bender.equivalentWarpingEnvelope:t.bender;return s&&(n=s.warpPath(n)),n}},e.prototype.getSelectionRectPaths=function(e){for(var t=void 0,r=0,i=this.paragraphs;r<i.length;r++)for(var n=i[r],s=e?e.move(-n.globalRange.start):void 0,o=0,a=n.lines;o<a.length;o++){var h=a[o],c=void 0;if(!s||h.characters&&s.intersects(h.localRange))for(var l=0;l<h.characters.length;l++){var u=h.localRange.start+l;(!s||s.start<=u&&u<=s.last)&&(c=P.UnionRect(c,h.characters[l].layoutBounds))}if(c){var d=this.getPathFromLayoutRect(c,h,h.offset.add(n.offset));d&&(t||(t=[]),t.push(d))}}return t},e.prototype.getBoundsOfRange=function(e,t){for(var r,i=t?this.frameToShape.toMatrix3().multiply(t.toMatrix3()):this.frameToShape,n=this.getSelectionRectPaths(e),s=0,o=this.paragraphs;s<o.length;s++){var a=o[s];if(a.bullet&&a.lines.length>0&&(!e||e.includes(a.globalRange.start)))(l=this.getPathFromLayoutRect(a.bullet.character.layoutBounds,a.lines[0],a.offset))&&(n=n?n.concat(l):[l])}for(var h=0,c=n||[];h<c.length;h++){var l;(l=c[h]).untransformedBounds&&(r=P.UnionRect(r,l.untransformedBounds.transformedBounds(l.transform.toMatrix3().multiply(i.toMatrix3()))))}return r},e.prototype.getSelectionLayoutCaretPath=function(e,t,r){for(var i=0,n=this.paragraphs;i<n.length;i++)for(var s=n[i],o=e-s.globalRange.start,a=0,h=s.lines;a<h.length;a++){var c=h[a];c.localRange.length!=c.characters.length&&l.Error(592525338,"character count mismatch");var u=e-c.localRange.start,d=void 0;if(0<=u&&u<c.characters.length){var f=c.characters[u].layoutBounds,p=c.flowDirection>0?f.left:f.right;d=new P(p-.5*t,f.top,p+.5*t,f.bottom)}else if(0==u&&0==c.characters.length){p=c.flowDirection>0?c.layoutBounds.left:c.layoutBounds.right;d=new P(p-.5*t,c.layoutBounds.top,p+.5*t,c.layoutBounds.bottom)}else if(r&&o==c.localRange.last+1){f=c.characters[c.characters.length-1].layoutBounds,p=c.flowDirection>0?f.right:f.left;d=new P(p-.5*t,f.top,p+.5*t,f.bottom)}if(d)return this.getPathFromLayoutRect(d,c,c.offset.add(s.offset))}},e.prototype.getLineAndParagraphFromLayoutPosition=function(e){for(var t=void 0,r=void 0,i=0,n=this.paragraphs;i<n.length;i++)for(var s=n[i],o=0,a=s.lines;o<a.length;o++){var h=a[o];if(e.subtract(s.offset).subtract(h.offset).y<h.layoutBounds.bottom)return{paragraph:s,line:h};t=h,r=s}return{paragraph:r,line:t}},e.prototype.getSelectionFromLayoutPosition=function(e){var t=this.getLineAndParagraphFromLayoutPosition(e);if(t.paragraph&&t.line&&t.line.characters){for(var r=e.subtract(t.paragraph.offset).subtract(t.line.offset),i=0;i<t.line.characters.length;i++)if(r.x<(t.line.characters[i].layoutBounds.right+t.line.characters[i].layoutBounds.left)/2)return{characterIndex:t.paragraph.globalRange.start+t.line.localRange.start+i,isAnchoredToPrevious:!1};return{characterIndex:t.paragraph.globalRange.start+t.line.localRange.last+1,isAnchoredToPrevious:!0}}},e.prototype.hitTest=function(e){for(var t=0,r=this.paragraphs;t<r.length;t++)for(var i=r[t],n=0,s=i.lines||[];n<s.length;n++){var o=s[n],a=e.subtract(i.offset).subtract(o.offset);if(o.layoutBounds.isPointInRect(a))return!0}return!1},e.prototype.getBrushImages=function(e){for(var t=0,r=this.paragraphs;t<r.length;t++){var i=r[t];i.bullet&&i.bullet.style&&i.bullet.style.getBrushImages(e),i.stylePerLocalRange.allData.forEach((function(t){t.getBrushImages(e)})),i.strokesPerLocalRange.allData.forEach((function(t){for(var r=0,i=t.elements;r<i.length;r++){var n=i[r];n.style&&n.style.getBrushImages(e)}}));for(var n=0,s=i.lines;n<s.length;n++)for(var o=0,a=s[n].characters;o<a.length;o++){var h=a[o];h.textImage&&e.push(h.textImage.image)}}},e}());function ze(e,t){e.some((function(e){return e==t}))||e.push(t)}function We(e,t){ze(e,t.start),ze(e,t.last+1),e.sort((function(e,t){return e-t}));for(var r=[],i=0;i<e.length-1;i++){var n=Ee.FromFirstLast(e[i],e[i+1]-1).getIntersection(t);n&&n.length>0&&r.push(n)}return r}var He=function(){function e(){this.textShapes=[],this.hitTestLineShapes=[]}return e.prototype.clearCache=function(){for(var e=0,t=this.textShapes;e<t.length;e++){t[e].clearCache()}for(var r=0,i=this.hitTestLineShapes;r<i.length;r++){i[r].clearCache()}for(var n=0,s=this.selectionShapes||[];n<s.length;n++){s[n].clearCache()}},e.prototype.getTextShapes=function(){return this.textShapes},e.prototype.getSelectionShapes=function(){return this.selectionShapes||[]},e.prototype.initShapeEffectsAndBoundsOverrides=function(e,t,r,i,n){if(t.effects=function(e,t,r){if(!e)return;var i=t?t.fontHeightInPoints:0,n=e.clone(),s=0==i?1:i/nt;n.glow&&(n.glow.radius=Ke(n.glow.radius,i,Ye,Qe,Ze)/2);n.shadow&&(n.shadow.radius=Ke(n.shadow.radius,i,Je,$e,et),n.shadow.distance=Ke(n.shadow.distance,i,Je,$e,et));n.innerShadow&&(n.innerShadow.radius=Ke(n.innerShadow.radius,i,tt,rt,it),n.innerShadow.distance=Ke(n.innerShadow.distance,i,tt,rt,it));n.reflection&&(n.reflection.radius*=s,t&&(n.reflection.distance*=0!=t.ascent&&0!=t.descent?i*t.descent/t.ascent/st:s));n.softEdges&&(n.softEdges.radius*=s);return n.direction=r,n}(e.getEffetcsAt(n),r?r.textEffectMetrics:void 0,-e.frameToShape.rotation)||new fe,!r.bender){if(e.applyEffectsPerCharacter){var s=e.getBoundsOfRange(new Ee(n,1));t.fillBoundsOverride=t.effectsBoundsOverride=s}else{s=r.fillBounds.translate(i).transformedBounds(T.FromTransforms(e.layoutToFrame,e.frameToShape));t.fillBoundsOverride=t.effectsBoundsOverride=s}t.textEffectMetrics=r.textEffectMetrics}},e.prototype.getTextShape=function(e,t){var r=new ge(e.getTextPathsForRange(t),e.getStyleAt(t.start)),i=e.getLineAndParagraphAt(t.start);return i&&this.initShapeEffectsAndBoundsOverrides(e,r,i.line,i.line.offset.add(i.paragraph.offset),t.start),r.role=3,r.textRange=t,r.overlapMode=1,r.transform=e.frameToShape,r},e.prototype.getStrokeShape=function(e,t,r){var i=new ge(this.getStrokePaths(e,t,r),r.style?r.style:e.getStyleAt(t.start)),n=e.getLineAndParagraphAt(t.start);return n&&this.initShapeEffectsAndBoundsOverrides(e,i,n.line,n.line.offset.add(n.paragraph.offset),t.start),i.role=3,i.textRange=t,i.overlapMode=1,i.transform=e.frameToShape,i},e.prototype.getSelectionHighlightShapes=function(e){if(e.selectionHighlights){for(var t=[],r=0,i=e.selectionHighlights;r<i.length;r++){var n=i[r];if(n.range.length>0){var s=e.getSelectionRectPaths(n.range);s&&t.push(new ge(s,n.style))}else{var o=e.getSelectionLayoutCaretPath(n.range.start,n.caretWidth,n.isAnchoredToPrevious);o&&t.push(new ge([o],n.style))}}return t}},e.prototype.update=function(e){var t;if(e.textVersion!=this.lastKnownTextVersion){this.lastKnownTextVersion=e.textVersion,this.clearCache(),this.textShapes=[],this.hitTestLineShapes=[];for(var r=0,i=e.paragraphs;r<i.length;r++){if((G=i[r]).bullet){var n=e.getLineAndParagraphAt(G.globalRange.start);if(n){for(var s=new Ee(G.globalRange.start,0),o=0,a=G.bullet.strokes?G.bullet.strokes.elements:[];o<a.length;o++){0==(O=a[o]).type&&this.textShapes.push(this.getStrokeShape(e,s,O))}var h=e.getTextPathsForCharacter(G.bullet.character,G.offset,G.lines.length>0?G.lines[0].bender:void 0),c=new ge(h,G.bullet.style?G.bullet.style:e.getStyleAt(s.start));this.initShapeEffectsAndBoundsOverrides(e,c,n.line,n.paragraph.offset,s.start),c.role=3,c.textRange=new Ee(G.globalRange.start,0),c.transform=e.frameToShape,this.textShapes.push(c);for(var l=0,u=G.bullet.strokes?G.bullet.strokes.elements:[];l<u.length;l++){0!=(O=u[l]).type&&this.textShapes.push(this.getStrokeShape(e,s,O))}}}for(var d=0,f=e.getSelectionRectPaths(void 0)||[];d<f.length;d++){var p=f[d],g=new ge([p],new oe(new $(Q.Black)));this.hitTestLineShapes.push(g)}}for(var m=[],_=0,v=e.getRunRanges();_<v.length;_++){var y=v[_],b=e.getBoundsOfRange(y);if(b&&b.width>2048)for(var w=Math.ceil(b.width/2048),T=0;T<w;T++){var x=Math.floor(y.start+T*y.length/w),P=T==w-1?y.last+1:Math.floor(y.start+(T+1)*y.length/w);x<P&&m.push(Ee.FromFirstLast(x,P-1))}else m.push(y)}for(var C=0,E=m;C<E.length;C++){y=E[C];for(var S=0,R=(B=e.getStrokesAt(y.start))?B.elements:[];S<R.length;S++){0==(O=R[S]).type&&this.textShapes.push(this.getStrokeShape(e,y,O))}}for(var M=0,I=m;M<I.length;M++){y=I[M];this.textShapes.push(this.getTextShape(e,y))}for(var A=0,F=m;A<F.length;A++){y=F[A];for(var B,D=0,L=(B=e.getStrokesAt(y.start))?B.elements:[];D<L.length;D++){var O;0!=(O=L[D]).type&&this.textShapes.push(this.getStrokeShape(e,y,O))}}for(var k=0,N=e.paragraphs;k<N.length;k++)for(var G,U=0,V=(G=N[k]).lines;U<V.length;U++)for(var z=V[U],W=0;W<z.characters.length;W++){var H=z.characters[W];if(H.textImage){var j=ge.CreateRectangle(H.textImage.rect,new oe(new re(H.textImage.image)));j.role=3,j.textRange=new Ee(W+z.localRange.start+G.globalRange.start,1),j.transform=H.textImage.transform,this.textShapes.push(j)}}for(var q=0,X=this.textShapes;q<X.length;q++){X[q].clipBounds=e.clipBounds}}if(e.selectionVersion!=this.lastKnownSelectionVersion){this.lastKnownSelectionVersion=e.selectionVersion;var K=this.getSelectionHighlightShapes(e);if(K){if(this.selectionShapes=[],new oe(new $(Q.White)).blendingMode=2,K){(t=this.selectionShapes).push.apply(t,K);for(var Y=0,Z=this.selectionShapes;Y<Z.length;Y++){Z[Y].transform=e.frameToShape}}}else{for(var J=0,ee=this.selectionShapes||[];J<ee.length;J++){ee[J].clearCache()}this.selectionShapes=void 0}}},e.prototype.getStrokePaths=function(e,t,r){for(var i=[],n=0,s=e.paragraphs;n<s.length;n++){var o=s[n];if(o.globalRange.intersects(t))for(var a=0,h=o.lines;a<h.length;a++){var c=h[a],l=void 0,u=void 0,d=new Ee(0,c.characters.length).getIntersection(t.move(-o.globalRange.start-c.localRange.start));if(d)for(var f=d.start;f<=d.last;f++){var p=c.characters[f].layoutBounds;p.isEmpty()||(l=null==l?p.left:Math.min(l,p.left),u=null==u?p.right:Math.max(u,p.right))}if(null!=l&&null!=u&&l<u){var g=T.Translation2D(c.offset.add(o.offset)).multiply(e.layoutToFrame.toMatrix3()).tryGetTransform(w.Zero);if(g){var m=new B({figures:Xe(r,l,u),transform:g}),_=c.bender instanceof Fe?c.bender.equivalentWarpingEnvelope:c.bender;_&&(m=_.warpPath(m)),i.push(m)}}}}return i},e}();function je(e,t,r){var i=t.y-r,n=Math.ceil(t.x/(2*i)),s=e.x,o=new O;o.moveTo(s,e.y),o.lineTo(s,e.y+r);for(var a=0;a<n;a++)s+=i,o.lineTo(s,e.y+t.y),s+=i,o.lineTo(s,e.y+r);o.lineTo(s,e.y);for(a=0;a<n;a++)s-=i,o.lineTo(s,e.y+t.y-r),s-=i,o.lineTo(s,e.y);return o.close(),o.createFigure()}function qe(e,t,r,i,n,s){for(var o=[],a=e.x,h=t.y,c=t.y*r,l=t.y*i,u=s?e.y-t.y:e.y,d=s?e.y+t.y/2:e.y+t.y,f=0;a<e.x+t.x;){var p=!n||f%(n+1)==0?c:h,g=Math.min(a+p,t.x+e.x);o.push(L.CreateFromRect(new P(a,u,g,d))),a+=l+p,f++}return o}function Xe(e,t,r){var i=new w(t,e.verticalCenter-.5*e.thickness),n=new w(r-t,e.thickness),s=[],o=3==e.type||5==e.type||7==e.type||9==e.type||11==e.type||13==e.type||15==e.type;switch(e.type){case 3:case 1:case 0:o?s.push(L.CreateFromRect(new P(i.x,i.y-n.y,i.x+n.x,i.y+Math.ceil(n.y/2)))):s.push(L.CreateFromRect(new P(i.x,i.y,i.x+n.x,i.y+n.y)));break;case 2:s.push.apply(s,function(e,t,r){var i=[];return r?(i.push(L.CreateFromRect(new P(e.x,e.y,e.x+t.x,e.y+t.y/2))),i.push(L.CreateFromRect(new P(e.x,e.y+t.y,e.x+t.x,e.y+3*t.y/2)))):(i.push(L.CreateFromRect(new P(e.x,e.y-t.y,e.x+t.x,e.y-t.y/2))),i.push(L.CreateFromRect(new P(e.x,e.y+t.y/2,e.x+t.x,e.y+t.y)))),i}(i,n,!1));break;case 5:case 4:s.push.apply(s,qe(i,n,1,1,1,o));break;case 7:case 6:s.push.apply(s,qe(i,n,3,2,0,o));break;case 9:case 8:s.push.apply(s,qe(i,n,7,4,0,o));break;case 10:case 11:s.push.apply(s,qe(i,n,3,2,1,o));break;case 12:case 13:s.push.apply(s,qe(i,n,3,2,2,o));break;case 14:case 15:var a=2*n.y,h=1;15==e.type&&(a=Math.floor(Math.max(3,2*n.y)),h=Math.max(2,Math.floor(n.y/2))),s.push(je(new w(i.x,i.y-Math.ceil(n.y/2)),new w(n.x,a),h));break;case 16:h=1,a=Math.max(2,n.y);var c=i.y-a;s.push(je(new w(i.x,c),new w(n.x,a),h)),s.push(je(i,new w(n.x,a),h));break;default:l.Error(591525085,"Unknown stroke type")}return s}function Ke(e,t,r,i,n){return 0!=t&&n<e?(e-n)*Math.pow(t,i)/Math.pow(r,i)+n:0==t?e:0}var Ye=72,Qe=.7,Ze=1,Je=72,$e=.7,et=.4,tt=108,rt=1,it=.001,nt=72,st=4,ot=function(){function e(){this.totalCostMs=0,this.shapeRenderCostMs=0,this.distanceFieldForTextCostMs=0,this.distanceFieldForGlyphTableCostMs=0,this.distanceFieldForShapeCostMs=0,this.patternTextureCostMs=0,this.pathGradientTextureCostMs=0,this.gradientTextureCostMs=0,this.fadeTextureCostMs=0,this.effectsCostMs=0,this.cacheToSpriteCostMs=0,this.drawTapeCostMs=0,this.glResetCostMs=0,this.glRestoreCostMs=0,this.pathCount=0,this.glyphCount=0,this.pixelCountDistanceField=0,this.pixelCountShapeRender=0,this.dynamicTextureAlloc=0,this.beginTime=0,this.endTime=0}return e.prototype.add=function(e){this.totalCostMs+=e.totalCostMs,this.shapeRenderCostMs+=e.shapeRenderCostMs,this.distanceFieldForTextCostMs+=e.distanceFieldForTextCostMs,this.distanceFieldForGlyphTableCostMs+=e.distanceFieldForGlyphTableCostMs,this.distanceFieldForShapeCostMs+=e.distanceFieldForShapeCostMs,this.patternTextureCostMs+=e.patternTextureCostMs,this.pathGradientTextureCostMs+=e.pathGradientTextureCostMs,this.gradientTextureCostMs+=e.gradientTextureCostMs,this.fadeTextureCostMs+=e.fadeTextureCostMs,this.effectsCostMs+=e.effectsCostMs,this.cacheToSpriteCostMs+=e.cacheToSpriteCostMs,this.drawTapeCostMs+=e.drawTapeCostMs,this.glResetCostMs+=e.glResetCostMs,this.glRestoreCostMs+=e.glRestoreCostMs,this.pathCount+=e.pathCount,this.glyphCount+=e.glyphCount,this.pixelCountDistanceField+=e.pixelCountDistanceField,this.pixelCountShapeRender+=e.pixelCountShapeRender,this.dynamicTextureAlloc+=e.dynamicTextureAlloc,this.beginTime=0,this.endTime=0},e}(),at=function(){this.frameCount=0},ht=1,ct=1,lt=0,ut=0;var dt=!0;function ft(e,t){return{center:e.center.add(t.preTranslation).multiply(t.scale).rotate(t.rotation).add(t.translation),size:e.size.multiply(t.scale.abs()),rotation:t.rotation,flipX:t.scale.x<0,flipY:t.scale.y<0}}var pt=function(){function e(e,t,r,i,n,s){void 0===s&&(s=!1),this.m_ownsTexture=!0,this.m_animatedContent=!1,this.m_originalSize=w.Zero,this.m_changeTracker=new F,this.m_compatibleGraphicsProcessorId=0,this.m_graphicsProcessor=e.getGraphicsProcessor(),this.m_wrapMode=i,this.updateTexture(e,t,r,n,s)}return e.prototype.setBabylonTexture=function(e,t,r,i){this.m_babylonTexture&&this.release(),this.m_babylonTexture=t,this.m_compatibleGraphicsProcessorId=e.getUniqueGraphicsProcessorId(),this.m_ownsTexture=r,this.m_animatedContent=i},e.prototype.updateTexture=function(e,t,r,i,n){if(this.m_graphicsProcessor=e.getGraphicsProcessor(),!this.m_graphicsProcessor)throw l.Error(592525214,"Unable to set texture if processor not initialized");this.m_originalSize=null!=r?r.ceil():this.m_originalSize;var s=t?this.m_graphicsProcessor.createTextureGraphicsResourceFromExternalWebGLTexture(r,t,void 0):void 0;this.setBabylonTexture(this.m_graphicsProcessor,s,i,n),this.initExternalTexture(e),this.m_changeTracker.notifyChange()},e.prototype.copyFromRGBABuffer=function(e,t,r,i,n,s,o){if(this.m_graphicsProcessor=e.getGraphicsProcessor(),this.m_graphicsProcessor){this.m_originalSize=t;var a=this.m_graphicsProcessor.createTextureGraphicsResource(t,r,i,n,!1,!1,s,o);this.setBabylonTexture(this.m_graphicsProcessor,a,!0,!1),this.initExternalTexture(e),this.m_changeTracker.notifyChange()}else l.Error(592525215,"No Graphics Processor")},e.prototype.copyFromHTMLImageElement=function(e,t,r,i){if(void 0===r&&(r=4),void 0===i&&(i=!0),this.m_graphicsProcessor=e.getGraphicsProcessor(),this.m_graphicsProcessor){var n=new w(t.width,t.height);this.m_originalSize=n;var s=this.m_graphicsProcessor.createTextureGraphicsResource(n,t,!0,!1,!1,!1,r,i);this.setBabylonTexture(this.m_graphicsProcessor,s,!0,!1),this.initExternalTexture(e),this.m_changeTracker.notifyChange()}else l.Error(592525216,"No Graphics Processor")},Object.defineProperty(e.prototype,"graphicsProcessor",{get:function(){return this.m_graphicsProcessor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"babylonTexture",{get:function(){return this.m_babylonTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"wrapMode",{get:function(){return this.m_wrapMode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ownsTexture",{get:function(){return this.m_ownsTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"animatedContent",{get:function(){return this.m_animatedContent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this.m_babylonTexture?new w(this.m_babylonTexture.width,this.m_babylonTexture.height):w.Zero},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"originalSize",{get:function(){return this.m_originalSize},set:function(e){this.m_changeTracker.notifyChange(),this.m_originalSize=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changeTracker",{get:function(){return this.m_changeTracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentLocation",{get:function(){var e=this.size;return this.m_contentLocation?this.m_contentLocation:{logicalCenter:e.scale(.5),logicalSize:e,physicalCenter:e.scale(.5),physicalSize:e,rotation:0,flipX:!1,flipY:!1}},set:function(e){this.m_changeTracker.notifyChange(),this.m_contentLocation=e},enumerable:!0,configurable:!0}),e.prototype.isValid=function(e){var t=e.getGraphicsProcessor();return this.m_babylonTexture&&t&&this.m_graphicsProcessor==t&&this.m_compatibleGraphicsProcessorId==t.getUniqueGraphicsProcessorId()},e.prototype.tryGetWebGLTexture=function(){return this.m_babylonTexture&&this.m_babylonTexture._webGLTexture||void 0},e.prototype.release=function(){this.m_babylonTexture&&this.m_ownsTexture&&this.m_babylonTexture.dispose(),this.m_babylonTexture=void 0,this.m_changeTracker.notifyChange()},e.prototype.cloneWithNewWrapMode=function(t,r){this.wrapMode==r&&l.Error(592472277,"Why cloning if the wrapmode is the same?");var i=new e(t,null,w.Zero,r,!0);return i.copyTextureFrom(t,this,this.size,r),i},e.prototype.copyTextureFrom=function(e,t,r,i){var n=this.m_graphicsProcessor;if(n){var s=n.needPowerOf2TexturesForTilingOrMipMap()&&4!=this.wrapMode?yt(r):r,o=new gt(e,s,!0,!1);e.drawTextureToTexture(o,t,s),this.m_ownsTexture=!0,this.m_originalSize=t.m_originalSize,this.m_babylonTexture&&this.release(),this.m_babylonTexture=o.m_babylonTexture,o.decreatseMemoryCounter(),o.m_babylonTexture=void 0,o.release(),this.m_babylonTexture?n.setWrapMode(this.m_babylonTexture,i):l.Error(592472280,"Failed to copy texture")}else l.Error(592472278,"Failed to get graphicsProcessor")},e.prototype.initExternalTexture=function(e){var t=this.m_graphicsProcessor;t?this.babylonTexture&&t.needPowerOf2TexturesForTilingOrMipMap()&&4!=this.wrapMode&&!this.size.equals(yt(this.size))&&this.copyTextureFrom(e,this,this.size,this.wrapMode):l.Error(592472281,"Failed to get graphicsProcessor")},e}(),gt=function(e){function t(t,r,i,n,s,o,a){void 0===r&&(r=w.Zero),void 0===i&&(i=!0),void 0===n&&(n=!1);var h=e.call(this,t,null,w.Zero,4,!s&&!o)||this;return h.initTexture(t,r,i,n,s,o,a),h.originalSize=r.ceil(),h.hasAlpha=i,h.useFloat=n,h.isDirty=!1,h}return _(t,e),t.prototype.tryConvertToBufferRGBA=function(){if(this.m_graphicsProcessor&&this.babylonTexture)return this.m_graphicsProcessor.copyTexturePixelsToArray(this.babylonTexture,P.FromSize(this.size),!0)},t.prototype.tryConvertToCanvas=function(){if(this.m_graphicsProcessor&&this.babylonTexture){var e=document.createElement("canvas");e.width=this.babylonTexture.width,e.height=this.babylonTexture.height;var t=e.getContext("2d");if(t){var r=this.tryConvertToBufferRGBA();if(r){var i=this.size,n=t.createImageData(i.x,i.y);return n.data.set(r),t.putImageData(n,0,0),t.globalCompositeOperation="copy",t.setTransform(1,0,0,-1,0,i.y),t.drawImage(e,0,0),e}}}},t.prototype.tryConvertToDataURL=function(){var e=this.tryConvertToCanvas();if(e)return e.toDataURL()},t.prototype.getMemoryUsage=function(){if(!this.graphicsProcessor)return 0;var e=this.hasAlpha?4:3;return this.size.x*this.size.y*e*(this.useFloat?4:1)},t.prototype.getRenderBufferMemoryUsage=function(){return this.needsRenderBuffer?this.size.x*this.size.y:0},t.prototype.initTexture=function(e,t,r,i,n,s,o){var a=e.getGraphicsProcessor();if(!a)return l.Error(592525217,"Graphics processor not initialized"),!1;if(this.needsRenderBuffer=!!o,n){this.originalSize=t,this.hasAlpha=r,this.useFloat=i,this.m_graphicsProcessor=a;var h=a.createTextureGraphicsResourceFromExternalWebGLTexture(t,n,s);return this.setBabylonTexture(a,h,this.ownsTexture,!1),!0}if(this.size.x==t.x&&this.size.y==t.y&&this.hasAlpha==r&&this.useFloat==i&&this.babylonTexture&&this.isValid(e))return!0;if(this.originalSize=t,this.hasAlpha=r,this.useFloat=i,this.babylonTexture&&this.release(),t.isZero())return!1;this.m_graphicsProcessor=a;var c=a.createTextureGraphicsResource(t,void 0,this.hasAlpha,this.useFloat,!0,this.needsRenderBuffer,4,!0);return this.setBabylonTexture(a,c,this.ownsTexture,!1),lt+=this.getMemoryUsage(),e.getCurrentFramePerformanceSummary().dynamicTextureAlloc+=this.getMemoryUsage(),this.needsRenderBuffer&&(ut+=this.getRenderBufferMemoryUsage()),!0},t.prototype.generateMipMap=function(){var e=this.graphicsProcessor;e&&this.babylonTexture?e.generateMipMap(this.babylonTexture):l.Error(592525218,"Cannot generate mipmaps")},t.prototype.detachWebGLTexture=function(){if(this.ownsTexture){var e=this.tryGetWebGLTexture();return e||l.Error(592525248,"No texture to detach"),this.m_babylonTexture=void 0,this.release(),e}l.Error(592525219,"Cannot give away a texture the target doesn't own")},t.prototype.decreatseMemoryCounter=function(){lt-=this.getMemoryUsage(),this.needsRenderBuffer&&(ut-=this.getRenderBufferMemoryUsage())},t.prototype.release=function(){this.decreatseMemoryCounter(),e.prototype.release.call(this)},t.RecycleOrReplace=function(e,r,i,n,s,o){var a=r.getGraphicsProcessor();if(e){if(e.graphicsProcessor==a&&e.size.equals(i)&&e.hasAlpha==n&&e.useFloat==s)return e;e.release()}return new t(r,i,n,s,void 0,void 0,o)},t}(pt),mt=[{attributeName:"a_0",attributeSize:4,offset:0}],_t=[{attributeName:"a_1",attributeSize:4,offset:0}];function vt(e,t,r,i,n,s,o){if(void 0===o&&(o=1),r.babylonTexture){var a=Math.max(i.length,n.length);if(0!=a){for(var h=new Float32Array(4*a),c=new Float32Array(4*a),u=0;u<a;u++){var d=i[Math.min(u,i.length-1)],f=n[Math.min(u,n.length-1)];h[4*u+0]=d.left/r.size.x,h[4*u+1]=d.top/r.size.y,h[4*u+2]=d.right/r.size.x,h[4*u+3]=d.bottom/r.size.y,c[4*u+0]=f.left/s.x,c[4*u+1]=f.top/s.y,c[4*u+2]=f.right/s.x,c[4*u+3]=f.bottom/s.y}var p=e.getBabylonEngine(),g=p.createVertexBuffer(h),m=p.createVertexBuffer(c);p.bindInstancesBuffer(g,mt,!1),p.bindInstancesBuffer(m,_t,!1),t.setTexture("t_0",r.babylonTexture),t.getBabylonEffect().setFloat("ufrag_0",o),t.drawQuadInstances(a),t.disableInstanceAttribute("a_0"),t.disableInstanceAttribute("a_1"),p._releaseBuffer(g),p._releaseBuffer(m)}}else l.Error(591192838,"No Texture")}function yt(e){return new w(R(E(e.x),1,2048),R(E(e.y),1,2048))}var bt=function(){function e(e,t,r,i){this.triangleCount=t,this.vertexBuffer=r,this.indexBuffer=i,this.m_engine=e.getBabylonEngine(),this.m_compatibleGraphicsProcessorId=e.getUniqueGraphicsProcessorId()}return e.prototype.isValid=function(e){return this.m_compatibleGraphicsProcessorId==e.getUniqueGraphicsProcessorId()},e.prototype.discard=function(){this.m_engine._releaseBuffer(this.vertexBuffer),this.m_engine._releaseBuffer(this.indexBuffer)},e.CreateGridXY=function(t,r,i){for(var n=new Float32Array(r.x*r.y*2),s=0;s<r.y;s++)for(var o=M(i.top,i.bottom,s/(r.y-1)),a=0;a<r.x;a++){n[c=2*(a+s*r.x)]=M(i.left,i.right,a/(r.x-1)),n[c+1]=o}var h=new Uint16Array((r.x-1)*(r.y-1)*2*3);for(s=0;s<r.y-1;s++)for(a=0;a<r.x-1;a++){var c;h[c=6*(a+s*(r.x-1))]=a+s*r.x,h[c+1]=a+1+s*r.x,h[c+2]=a+(s+1)*r.x,h[c+3]=a+1+(s+1)*r.x,h[c+4]=a+(s+1)*r.x,h[c+5]=a+1+s*r.x}var l=t.getBabylonEngine();return new e(t,(r.x-1)*(r.y-1)*2,l.createVertexBuffer(n),l.createIndexBuffer(h))},e}(),wt=[{attributeName:"a_0",attributeSize:2,offset:0,divisor:0}],Tt=[{attributeName:"a_1",attributeSize:2,offset:0,divisor:0}];function xt(e,t,r,i,n,s,o,a,h){if(r.babylonTexture){var c=e.activateShaderProgram(3);c.begin(i.babylonTexture,Q.Transparent,!1);var u=c.getBabylonEffect();u.setFloat("u_0",s),u.setVector2("u_1",t),u.setVector2("u_2",a),u.setVector2("u_3",r.size),u.setInt("u_4",h?1:2),c.setTexture("tex_0",r.babylonTexture),u.setDirectColor4("ufrag_0",n||Q.Transparent),u.setFloat("ufrag_2",Math.log(s/4)/Math.log(2)),u.setInt("ufrag_3",o),u.setInt("ufrag_4",h?1:2),c.drawQuads(1),c.end(),i.generateMipMap()}else l.Error(592525250,"No Texture")}function Pt(e,t){var r=It(t,e.contentLocation.logicalSize),i=T.Scale2D(r.multiply(w.Flip(e.contentLocation.flipX,e.contentLocation.flipY)));return i=(i=(i=(i=i.multiply(T.RotationZ(e.contentLocation.rotation))).multiply(T.Translation2D(e.contentLocation.logicalCenter))).multiply(T.Scale2D(e.size.inverse()))).multiply(T.Translation2D(new w(-.5,-.5)))}function Ct(e){return e?e.size.x+"x"+e.size.y:"undefined"}var Et=function(){function e(e,t){this.contentRotation=0,this.depth=0,this.depthFar=0,this.depthNear=0,this.blendingMode=0,this.contentCenter=e?e.center:w.Zero,this.contentSize=e?e.size:w.One,this.contentFlip=e?w.Flip(e.flipX,e.flipY):w.One,this.contentRotation=e?e.rotation:0,this.customMesh=t}return e.prototype.getDebugStringInfo=function(){return["Layer"]},e}(),St=function(e){function t(t,r,i){var n=e.call(this,r,i)||this;return n.texture=t,n}return _(t,e),t.prototype.getDebugStringInfo=function(){return["Texture: "+Ct(this.texture),(this.fadeInfo?" +Fade ":"")+(this.reflectionGradient?" + Reflection ":"")+(this.customMesh?" + CustomMesh ":"")]},t}(Et),Rt=function(e){function t(t,r,i,n,s,o){var a=e.call(this,{center:w.Zero,size:w.One,rotation:0,flipX:!1,flipY:!1},s)||this;return a.progress=0,a.textureA=t,a.textureB=r,a.panVector=o,i&&n&&(a.morphingGrid=[i,n]),a}return _(t,e),t.prototype.getDebugStringInfo=function(){return["Textures: "+Ct(this.textureA)+" ➡️ "+Ct(this.textureB),(this.fadeInfo?" +Fade ":"")+(this.customMesh?" + CustomMesh ":"")+(this.morphingGrid?" + MorphingGrid ":"")]},t}(Et),Mt=function(e){function t(t,r,i,n){var s=e.call(this,t,r,n)||this;return s.fillBrightness=0,s.style=i,s}return _(t,e),t.prototype.getDebugStringInfo=function(){return["Texture: "+Ct(this.texture),(this.fadeInfo?" +Fade ":"")+(this.reflectionGradient?" + Reflection ":"")+(this.customMesh?" + CustomMesh ":"")]},t}(St);function It(e,t){return 0!=e.x&&0!=e.y?t.divide(e):0!=e.x?w.One.scale(t.x/e.x):0!=e.y?w.One.scale(t.y/e.y):w.Zero}function At(e,t,r){var i=It(t,e.logicalSize),n=P.FromSizeAndCenter(e.physicalSize,e.physicalCenter.subtract(e.logicalCenter)),s=T.RotationZ(-e.rotation),o=T.ScaleTranslation2D(w.Flip(e.flipX,e.flipY).divide(i),r);return n.transformedBounds(s.multiply(o))}function Ft(e,t,r,i,n,s){var o=e instanceof St?e:void 0,a=e instanceof Rt?e:void 0,h=a?a.textureA:o?o.texture:void 0,c=a?a.textureB:void 0,u=a&&a.panVector&&(!h||!c),d=0;a&&(d=u?h?0:1:a.progress);var f=o?o.reflectionGradient:void 0,m=e instanceof Mt&&!h;if(m||h&&h.babylonTexture||c&&c.babylonTexture){var _=e.contentCenter,v=T.Identity,y=T.Identity,b=t.getBabylonEffect(),x=t.getBabylonEngine();if(a&&a.morphingGrid&&2==a.morphingGrid.length)b.setInt("u_16",1),b.setFloat("u_17",a.progress),x.bindInstancesBuffer(a.morphingGrid[0],wt),x.bindInstancesBuffer(a.morphingGrid[1],Tt),v=T.Scale2D(e.contentSize),y=T.Scale2D(e.contentSize);else{b.setInt("u_16",0),b.setFloat("u_17",0),t.setDummyPointerAttribute("a_0"),t.setDummyPointerAttribute("a_1");var C=h?At(h.contentLocation,e.contentSize,e.contentCenter):m?P.FromSizeAndCenter(e.contentSize,e.contentCenter):void 0,E=c?At(c.contentLocation,e.contentSize,e.contentCenter):void 0,S=C&&E?P.UnionRect(C,E):C||E;if(!S)return void l.Error(592525253,"Undefined physical bounds");if(S=S.translate(e.contentCenter.negate()),!(S=(S=e.effectTransform?S.transformedBounds(e.effectTransform):S)&&e.localClipRect?P.IntersectRect(S,e.localClipRect):S))return;S=S.translate(e.contentCenter),v=T.ScaleTranslation2D(S.size,S.center.subtract(_));var M=e.effectTransform?e.effectTransform.inverse():void 0;y=M?v.multiply(M):v}var I=h?y.multiply(Pt(h,e.contentSize)):T.Identity,A=c?y.multiply(Pt(c,e.contentSize)):T.Identity,F=_;u&&a&&a.panVector&&(F=_.add(a.panVector.scale(a.progress-(c?1:0))));var B=T.RotationZ(e.contentRotation).multiply(T.Translation2D(F));i&&(B=B.multiply(i)),b.setMatrix3x3("u_0",v.m),b.setVector2("u_15",e.contentFlip),b.setMatrix3x3("u_1",B.m),b.setVector2("u_2",r),b.setMatrix3x3("u_3",I.m),b.setMatrix3x3("u_4",A.m),b.setFloat2("ufrag_12",f?f.opacity0:1,f?f.opacity1:1),b.setVector2("u_20",f?f.pos0:w.Zero),b.setVector2("u_21",f?f.pos1:w.Zero),b.setDirectColor4("ufrag_13",n||Q.Transparent),b.setFloat("ufrag_36",d),t.setTexture("t_0",h?h.babylonTexture:void 0);var D=e.fadeInfo?e.fadeInfo.fadeTexture:void 0;t.setTexture("t_3",D?D.babylonTexture:void 0);var L=0;if(e.fadeInfo&&e.fadeInfo.fade){L=1;var O=e.fadeInfo.fade,k=O.reverse?1-O.progress:O.progress;b.setVector2("ufrag_17",O.getFadeScaleOffset(k,0)),0!=O.preset&&(e.fadeInfo.fadeTexture&&e.fadeInfo.fadeTexture.babylonTexture?(L=2,b.setMatrix3x3("u_10",13==O.preset?y.multiply(Pt(e.fadeInfo.fadeTexture,e.contentSize)).m:I.multiply(O.getFadeTransform()).m)):l.Error(592525254,"fade texture missing"))}b.setInt("ufrag_16",L),b.setFloat("u_18",e.depthFar),b.setFloat("u_19",e.depthNear),e instanceof Mt?(!function(e,t,r,i,n){var s=t.texture,o=t.style;e.setInt("ufrag_15",4==n?1:5==g?3:0!=g&&7!=g?g+10:0),e.setFloat("ufrag_0",t.distRangeSize?.5/t.distRangeSize:1),e.setInt("ufrag_34",s?0:1);var a=o.fillBrush,h=a?a.getType():0,c=6==h?t.fillTexture:void 0;6!=h||c||(h=0);var u=1==h?!a.color.equals(Q.Transparent):0!=h;if(e.setInt("ufrag_10",h),4==h)e.setFloatArray4("ufrag_3",Bt(a));else{var d=1==h?a.color:7==h?a.foregroundColor:Q.Transparent;e.setDirectColor4("ufrag_3",d)}e.setInt("ufrag_18",6==h&&c&&4==c.wrapMode?1:0),e.setFloat("ufrag_20",6==h?a.opacity:1),e.setInt("u_13",7==h?1:0),e.setMatrix3x3("u_4",t.fillTransformUV?7==h?t.fillTransformUV.m:r.multiply(t.fillTransformUV).m:r.m),e.setDirectColor4("ufrag_22",7==h?a.backgroundColor:Q.Transparent),e.setFloat("ufrag_28",t.fillBrightness);var f=t.pictureTexture;if(e.setInt("ufrag_30",f?1:0),f){var m=o.pictureBrush;e.setInt("ufrag_31",f&&4==f.wrapMode?1:0),e.setFloat("ufrag_32",m.opacity),e.setMatrix3x3("u_5",t.pictureTransformUV?r.multiply(t.pictureTransformUV).m:T.Identity.m)}var _=7==g?3:4!=n||!o.hasLine||u||f?0:p,v=o.lineBrush&&2!=n?o.lineBrush.getType():0,y=6==v?t.lineTexture:void 0;6!=v||y||(v=0);_&&(v=1);var b=7==g?_:Math.max(_,o.hasLine?o.pen.adjustedLineWidth:0);if(e.setFloat("ufrag_1",b),e.setInt("ufrag_11",v),4==v)e.setFloatArray4("ufrag_4",Bt(o.lineBrush));else{d=Q.Transparent;_?d=7==g?Q.Red:Q.White:1==v?d=o.lineBrush.color:7==v&&(d=o.lineBrush.foregroundColor),e.setDirectColor4("ufrag_4",d)}e.setInt("ufrag_19",6==v&&y&&4==y.wrapMode?1:0),e.setFloat("ufrag_21",6==v?o.lineBrush.opacity:1),e.setInt("u_14",7==v?1:0),e.setMatrix3x3("u_6",t.lineTransformUV?7==v?t.lineTransformUV.m:r.multiply(t.lineTransformUV).m:r.m),e.setDirectColor4("ufrag_23",7==v?o.lineBrush.backgroundColor:Q.Transparent),e.setFloat("ufrag_29",1==t.mergeMode?1:0),e.setFloat("ufrag_6",o.pen&&0!=o.pen.dashType&&o.pen.useRoundDash?1:0);var x=_?Dt[0]:function(e){if(!e.compoundType||e.tipType&&0!=e.tipType)return Dt[0];if(e.compoundType>=0&&e.compoundType<Dt.length)return Dt[e.compoundType];return l.Error(587220940,"unsupported compoundType"),Dt[0]}(o.pen);e.setFloatArray3("ufrag_8",x.centers),e.setFloatArray3("ufrag_9",x.slopes);var P=Math.sqrt(2)/2,C=new w(P,P),E=i?i.transformVector(C).length():1;e.setFloat("ufrag_2",1/E),e.setFloat("ufrag_27",R(ve(o.pen),-1,1)*b/2),e.setInt("ufrag_37",s&&2==s.distanceFieldMode?1:0),t.softEdges&&t.softEdges.radius>0&&t.softEdgesTexture&&t.softEdgesTexture.babylonTexture&&t.softEdgesTexture.uvScale&&t.softEdgesTexture.localBounds?(e.setInt("ufrag_24",1),e.setMatrix3x3("u_7",r.multiply(Pt(t.softEdgesTexture,t.contentSize)).m)):(e.setInt("ufrag_24",0),t.softEdges&&t.softEdges.radius>0&&l.Error(588006213,"soft edges texture not ready"));if(t.innerShadow&&t.innerShadow.color.a>0&&t.innerShadowTexture&&t.innerShadowTexture.babylonTexture&&t.innerShadowTexture.uvScale&&t.innerShadowTexture.localBounds){var S=new w(t.innerShadow.distance,0).rotate(t.innerShadow.angle),M=r.multiply(T.Translation2D(S)).multiply(Pt(t.innerShadowTexture,t.contentSize));e.setInt("ufrag_25",1),e.setMatrix3x3("u_8",M.m),e.setDirectColor4("ufrag_26",t.innerShadow.color)}else e.setInt("ufrag_25",0),t.innerShadow&&t.innerShadow.color.a>0&&l.Error(588006214,"inner shadow  exture not ready");e.setInt("ufrag_15",4==n?1:5==g?3:0!=g&&7!=g?g+10:0),7==g&&(e.setInt("ufrag_10",0),e.setInt("ufrag_11",1));0==n&&3==t.blendingMode&&e.setDirectColor4("ufrag_13",Q.White)}(b,e,y,i,s),t.setTexture("t_1",e.fillTexture?e.fillTexture.babylonTexture:void 0),t.setTexture("t_2",e.lineTexture?e.lineTexture.babylonTexture:void 0),t.setTexture("t_4",e.softEdgesTexture?e.softEdgesTexture.babylonTexture:void 0),t.setTexture("t_5",e.innerShadowTexture?e.innerShadowTexture.babylonTexture:void 0),t.setTexture("t_6",e.pictureTexture?e.pictureTexture.babylonTexture:void 0)):(!function(e){e.setFloat("ufrag_0",0),e.setFloat("ufrag_1",0),e.setFloat("ufrag_2",0),e.setDirectColor4("ufrag_3",Q.Transparent),e.setDirectColor4("ufrag_4",Q.Transparent),e.setFloat("ufrag_6",0),e.setFloatArray3("ufrag_8",new Float32Array([0,0,0])),e.setFloatArray3("ufrag_9",new Float32Array([0,0,0])),e.setInt("ufrag_10",0),e.setInt("ufrag_11",0),e.setInt("ufrag_15",2),e.setInt("ufrag_18",0),e.setInt("ufrag_19",0),e.setFloat("ufrag_20",1),e.setFloat("ufrag_21",1),e.setDirectColor4("ufrag_22",Q.Transparent),e.setDirectColor4("ufrag_23",Q.Transparent),e.setInt("ufrag_24",0),e.setInt("ufrag_25",0),e.setDirectColor4("ufrag_26",Q.Transparent),e.setFloat("ufrag_27",0),e.setFloat("ufrag_28",0),e.setFloat("ufrag_29",0),e.setInt("ufrag_30",0),e.setInt("ufrag_31",0),e.setFloat("ufrag_32",0),e.setInt("ufrag_34",0),e.setInt("u_13",0),e.setInt("u_14",0)}(b),t.setTexture("t_1",c?c.babylonTexture:void 0),t.setTexture("t_2",void 0),t.setTexture("t_4",void 0),t.setTexture("t_5",void 0),t.setTexture("t_6",void 0));var N=0==s;b.setInt("ufrag_35",N&&1==e.blendingMode?1:0),t.setBlendingMode(N?e.blendingMode:0),e.customMesh?t.drawMesh(e.customMesh):t.drawQuads(1)}else l.Error(592525252,"No Texture")}function Bt(e){var t=e.fillToRect?e.fillToRect:new P(.5,.5,.5,.5),r=e.fillFromRect?e.fillFromRect:new P(0,0,1,1),i=t.translate(r.leftTop.negate()).multiply(r.size.inverse());return new Float32Array([1/i.left,1/i.top,1/(1-i.right),1/(1-i.bottom)])}var Dt=[{centers:new Float32Array([0,0,0]),slopes:new Float32Array([1,1,1])},{centers:new Float32Array([-2/3,2/3,2/3]),slopes:new Float32Array([3,3,3])},{centers:new Float32Array([-.4,.8,.8]),slopes:new Float32Array([5/3,5,5])},{centers:new Float32Array([-.8,.4,.4]),slopes:new Float32Array([5,5/3,5/3])},{centers:new Float32Array([-5/6,0,5/6]),slopes:new Float32Array([6,3,6])}],Lt=[1,1,2,4,8,16,16];function Ot(e,t,r,i,n){void 0===r&&(r=!1),void 0===i&&(i=!1);var s=[],o=i?[]:void 0;if(!e.figures||0==e.figures.length)return{buffers:s,endDistance:0};for(var a=0,h=0;h<e.figures.length;h++){var c=r?e.figures[h].toPolygon():e.figures[h],u=D(43),d=c.isLastPointDuplicated(),f=c.isClosed||d,p=kt(c.points,c.format,43,0,d?c.points.length-c.pointDataSize:c.points.length,1,3,f,e.maxPressure),g=p.length/u,m=void 0;if(i){var _=Nt(p,43,f,a,n,1,3);m=_.distanceArray,a=_.endDistance}var v=p.length;if(v>t)for(var y=t/u-4,b=Math.ceil((g-4)/y),w=y+4,T=0,x=0;x<b;x++){var P=Math.min(w,g-T),C=P-4;s.push(p.subarray(T*u,(T+P)*u)),o&&m&&o.push(m.subarray(T,T+P)),T+=C}else{var E=new Float32Array(4*Math.ceil(v/4));E.set(p,0),s.push(E),o&&m&&o.push(m)}}return o&&o.length!=s.length&&l.Error(592525388,"Invalid distance array"),{buffers:s,distanceBuffers:o,endDistance:a}}function kt(e,t,r,i,n,s,o,a,h){void 0===i&&(i=0),void 0===n&&(n=e.length),void 0===s&&(s=0),void 0===o&&(o=0),void 0===a&&(a=!0),void 0===h&&(h=1);var c=D(t),u=n-i;if(!(u%c==0&&1&t&&1&r))throw l.Error(592525389,"list of source points invalid");var d=e,f=u/c;1==f&&((d=new Float32Array(2*e.length)).set(e,0),d.set(e,e.length),f=2);var p=c;c=D(r);for(var g=new Float32Array((s+f+o)*c),m=0;m<f;m++)for(var _=i+m*p,v=(s+m)*c,y=0,b=Lt;y<b.length;y++){var w=b[y];w&r&&(g[v]=8==w?w&t?d[_]/h:1:w&t?d[_]:2==w?1:0,v++),w&t&&_++}if((s||o)&&(s>0&&g.copyWithin(0,g.length-(s+o)*c,g.length-o*c),o>0&&g.copyWithin(g.length-o*c,s*c,(s+o)*c),!a&&2&r)){for(var T=0;T<s;T++)g[T*c+2]=0;for(T=0;T<o;T++)g[g.length-(T+1)*c+2]=0}return g}function Nt(e,t,r,i,n,s,o){void 0===i&&(i=0),void 0===s&&(s=0),void 0===o&&(o=0);var a=n?function(e,t,r){var i=D(t);if(0==i||e.length%i!=0||!(1&t))throw l.Error(592525390,"list of points for invalid for measuring distance");for(var n=r.m,s=new Float32Array(e),o=0;o<e.length;o+=i){var a=e[o],h=e[o+1];s[o]=a*n[0]+h*n[3]+n[6],s[o+1]=a*n[1]+h*n[4]+n[7]}return s}(e,t,n):e,h=D(t);if(0==h||a.length%h!=0||a.length/h<s+o+1||!(1&t))throw l.Error(587534800,"list of points for invalid for measuring distance");for(var c=new Float32Array(a.length/h),u=s*h,d=(a.length-o*h-u)/h,f=2&t,p=i||0,g=0;g<d;g++){var m=u+g*h;if(2!=(f?a[m+2]:1)&&(c[s+g]=p,r||g<d-1)){var _=u+(g+1)%d*h,v=f?a[_+2]:1;if(2!=v){var y=a[_]-a[m],b=a[_+1]-a[m+1];p+=Math.sqrt(y*y+b*b)}else if(2==v&&(r||g<d-2)){var w=u+(g+2)%d*h;p+=I(a[m],a[m+1],a[_],a[_+1],a[w],a[w+1])}}}for(var T=p-i,x=0;x<s;x++)c[x]=c[s+d-s+x]-T;for(x=s+d;x<a.length/h;x++)c[x]=c[x+s-(s+d)]+T;for(g=0;g<d;g++){m=u+g*h;if(f&&2==a[m+2]){var P=0==s&&0==g?d-1:s+g-1,C=0==o&&g==d-1?s:s+g+1;c[s+g]=.5*(c[P]+c[C])}}return{distanceArray:c,endDistance:p}}var Gt=function(e){function t(t,r,i,n,s){void 0===i&&(i=1),void 0===n&&(n=0),void 0===s&&(s=0);var o=this,a=t,h=a.getGraphicsProcessor();if(!h)throw l.Error(591524386,"no graphicsProcessor");var c=5==g&&h.isFloatTextureSupported();return(o=e.call(this,t,w.Zero,!0,c)||this).m_renderer=a,o.pathIndexRange=r,o.fillMode=i,o.distRangeSize=0,o.contentQuality=0,o.enableMipMap=!1,o.mergeMode=0,o.distanceFieldMode=s,o}return _(t,e),t.prototype.refresh=function(e,t,r,i){if(!e.getGraphicsProcessor())throw l.Error(591524387,"Graphics processor not initialized");t instanceof ge&&t.incrementalPath&&(this.contentBoundsOverride=t.incrementalPath.bounds);var n=this.getRequiredTextureSize(t,r),s=this.babylonTexture;return!!this.initTexture(e,n,this.hasAlpha,this.useFloat,void 0,void 0,!0)&&(i&&s!=this.babylonTexture?(l.Error(591524416,"Cannot update incrementally: texture had to be recreated"),!1):(n.isZero()||this.rasterize(t,r,i,e.getCurrentFramePerformanceSummary()),!0))},t.prototype.getQualityToUse=function(e){return this.contentBoundsOverride?1:e.hasSmallDetails()?2*ht:ht},t.prototype.getContentBounds=function(e){if(this.contentBoundsOverride)return this.contentBoundsOverride;var t=ye(e,1!=this.distanceFieldMode);return t?t.multiply(e.transform.scale.abs()).inflate(this.getPixelPadding()):void 0},t.prototype.getRequiredTextureSize=function(e,t){if(1!=e.getType())throw l.Error(591524417,"item not a shape");var r=e,i=this.getContentBounds(r);if(!i)return w.Zero;var n=i.size,s=this.getQualityToUse(r),o=new w(Math.ceil(n.x*s),Math.ceil(n.y*s));return this.enableMipMap&&(o=new w(S(o.x),S(o.y))),new w(R(o.x,16,4096),R(o.y,16,4096))},t.prototype.getFillBrightness=function(){return 2==this.fillMode?.4:3==this.fillMode?.2:4==this.fillMode?-.4:5==this.fillMode?-.2:0},t.prototype.getPixelPadding=function(){return Math.ceil(p/2)},t.prototype.rasterize=function(e,t,r,i){if(!this.graphicsProcessor)throw l.Error(591524418,"No gl context");if(1!=e.getType())throw l.Error(591524419,"item not a shape");var n=e,s=n.transform.scale.abs(),o=this.getContentBounds(n),a=ye(n,!1,T.Scale2D(s));if(!o||!a)return l.Error(591524420,"Nothing to render"),!1;var h=this.getPixelPadding(),c=this.getQualityToUse(n),u=o.size,d=Math.min(Math.min(this.size.x-2*h,u.x*c)/u.x,Math.min(this.size.y-2*h,u.y*c)/u.y),f=u.scale(d),m=this.size.scale(.5),_=new x(o.center.negate(),new w(d,d),0,m),v=o.transformedBounds(_),y=a.transformedBounds(_);if(!v||!y)return l.Error(588006216,"Nothing to render"),!1;if(this.localBounds=o?o.divide(s):void 0,this.contentQuality=d,this.renderScale=f.divide(u.multiply(this.size)),this.uvScale=u.multiply(this.renderScale).multiply(n.transform.scale.sign()),this.m_contentLocation={logicalCenter:y.center,logicalSize:y.size,physicalCenter:v.center,physicalSize:v.size,rotation:0,flipX:n.transform.scale.x<0,flipY:n.transform.scale.y<0},!this.localBounds||!this.renderScale)return l.Error(591524421,"no bounds or renderScale"),!1;i.pixelCountDistanceField+=Math.floor(this.size.x*this.size.y);var b=5==g,P=.5*(n.style.pen?n.style.pen.adjustedLineWidth*(1+Math.min(Math.abs(ve(n.style.pen)),1)):0);return n.distRangeSize=this.distRangeSize=b?Math.max(u.x/2,u.y/2):P+h/d,function(e,t,r,i,n,s,o,a,h,c,u){if(!i.distRangeSize)return l.Error(592525083,"distRangeSize not initialized"),!1;var d,f=c?void 0:Q.Transparent;if(i.paths&&!i.incrementalPath)d=Kt(e,t,i.paths,i.style.hasLine?i.style.pen:void 0,!1,1!=h,2==h,i.transform.scale,n,u);else if(i.incrementalPath){var p=r.tag,m=p&&p.incrementalPathTrackerId==i.incrementalPath.changeTracker.trackerId;(!m||p&&(0==p.figureCount||1==p.figureCount&&0==p.lastFigurePointCount))&&(f=Q.Transparent);for(var _=m&&p.figureCount>0?p.figureCount-1:0,v=[],y=_;y<i.incrementalPath.figures.length;y++){var b=i.incrementalPath.figures[y],T=m&&y==_&&p.lastFigurePointCount>0?p.lastFigurePointCount-1:0,x=b.getPointCount();v.push(new L(b.data.slice(T*i.incrementalPath.pointDataSize,x*i.incrementalPath.pointDataSize),!1,i.incrementalPath.format))}r.tag={incrementalPathTrackerId:i.incrementalPath.changeTracker.trackerId,figureCount:i.incrementalPath.figures.length,lastFigurePointCount:i.incrementalPath.figures.length>0?i.incrementalPath.figures[i.incrementalPath.figures.length-1].getPointCount():0};var P=new B({figures:v,fillMode:0});d=Kt(e,t,[P],i.style.hasLine?i.style.pen:void 0,!1,1!=h,2==h,i.transform.scale,n,u)}if(!d)return l.Error(592525084,"Nothing to render"),!1;var C=e.activateShaderProgram(0);C.begin(r.babylonTexture,f,!1);var E=C.getBabylonEffect();E.setVector2("u_0",s.center.multiply(i.transform.scale)),E.setVector2("u_1",i.transform.scale),E.setVector2("u_2",o),E.setFloat("u_3",i.distRangeSize),E.setFloat("ufrag_10",i.style&&i.style.pen?2*i.distRangeSize/(i.style.pen.adjustedLineWidthForArrowHead+1):0),E.setFloat("ufrag_11",i.transform.scale.x*i.transform.scale.y),E.setInt("ufrag_7",g),E.setInt("u_13",g),E.setInt("u_15",0==i.style.pen.compoundType?0:1),E.setVector2("u_17",i.style.pen.tipScale?i.style.pen.tipScale:w.One),E.setInt("u_18",i.style.pen.tipType?i.style.pen.tipType:0);var S=(i.style.pen.adjustedLineWidth/2+1/r.contentQuality)/(2*i.distRangeSize);E.setFloat("ufrag_15",0==i.style.pen.alignment?S:2*S);for(var R=0,M=d.transformedPaths;R<M.length;R++){var I=M[R],A=qt(a);if(A)for(var F=A.start;F<=A.last;F++)Xt(F,!0,I,a,u)&&(Qt(C,F,!0,i),2==F?C.drawQuads(1):Jt(C,F,!0,i,[I],a,h,u,t.getCurrentFramePerformanceSummary()))}var D=function(e){return 1==e?Ee.FromFirstLast(0,0):Ee.FromFirstLast(0,1==g||2==g?0:2)}(a);if(D)for(F=D.start;F<=D.last;F++)Qt(C,F,!1,i),2==F?C.drawQuads(1):Jt(C,F,!1,i,d.transformedPaths,a,h,u,t.getCurrentFramePerformanceSummary());if(C.end(),dt&&Vt&&d.cachedGlyphsPages.length>0){var O=e.activateShaderProgram(5);if(O.begin(r.babylonTexture,void 0,!1),Yt(O,0,0),r.localBounds&&r.uvScale)for(var k=0,N=d.cachedGlyphsPages;k<N.length;k++){var G=N[k];if(G.cachedGlyphInstances.length>0){for(var U=new Array(G.cachedGlyphInstances.length),V=new Array(G.cachedGlyphInstances.length),z=0;z<G.cachedGlyphInstances.length;z++){var W=G.cachedGlyphInstances[z];U[z]=W.srcRect,V[z]=W.dstRect.translate(r.localBounds.center.negate()).multiply(r.size.multiply(r.uvScale).multiply(r.localBounds.size.inverse())).translate(r.size.scale(.5))}vt(e,O,Vt[G.page],U,V,r.size,Vt[G.page].distRangeSize/r.distRangeSize*(G.cachedGlyphInstances[0].dstRect.size.y/G.cachedGlyphInstances[0].srcRect.size.y))}}O.end()}return!0}(this.graphicsProcessor,this.m_renderer,this,n,this.pathIndexRange,this.localBounds,this.renderScale,this.mergeMode,this.distanceFieldMode,r,1==this.generateDrawFadeMask)&&(this.geometryVersion=n.geometryTracker.version,this.lastKnownQualitySetting=ht,this.lastKnownLineWidth=n.style.pen.adjustedLineWidth,this.lastKnownLineWidthForArrowHead=n.style.pen.adjustedLineWidthForArrowHead,this.lastKnownHitTestSlop=p,this.enableMipMap&&this.generateMipMap()),!1},t}(gt);function Ut(e){return e?e.fontId+":"+e.glyphId:void 0}var Vt,zt={},Wt=[];var Ht=[{attributeName:"a_p0",attributeSize:4,offset:0},{attributeName:"a_p1",attributeSize:4,offset:16},{attributeName:"a_p2",attributeSize:4,offset:32},{attributeName:"a_p3",attributeSize:4,offset:48},{attributeName:"a_p4",attributeSize:4,offset:64}],jt=[{attributeName:"a_d1",attributeSize:1,offset:4},{attributeName:"a_d2",attributeSize:1,offset:8}];function qt(e){if(1==e)return Ee.FromFirstLast(0,3)}function Xt(e,t,r,i,n){return(!n||0==e)&&((1==i||!t)&&(0==e||0!=r.fillMode))}function Kt(e,t,r,i,n,s,o,a,h,c){var u=[],d=[];if(0==r.length)return{transformedPaths:u,cachedGlyphsPages:d};h&&(h.start<0||h.last>=r.length)&&l.Error(592525078,"pathIndexRange out of range");for(var f=h?Math.max(h.start,0):0,p=h?Math.min(h.last,r.length-1):r.length-1,g=i&&(Zt(i.headEnd,i.adjustedLineWidthForArrowHead)>0||Zt(i.tailEnd,i.adjustedLineWidthForArrowHead)>0),m=c||!!i&&0!=i.dashType||g,_=dt&&!i,v=function(h){var c=r[h];c.glyphCacheId?t.getCurrentFramePerformanceSummary().glyphCount++:t.getCurrentFramePerformanceSummary().pathCount++;var f=t.ensurePathRenderData(c);f.refreshCachedHwTapeBuffers(c,e);var p=!1,g=Ut(c.glyphCacheId);if(g&&_&&Vt&&0==c.transform.rotation&&Math.abs(c.transform.scale.x-c.transform.scale.y)<.001&&c.transform.scale.x<56/4096&&zt[g]){var v=zt[g];if(v.page<0||v.page>=Vt.length)l.Error(592525079,"Invalid glyph page");else{var y=Vt[v.page],b=y.localBounds?y.localBounds.center:void 0,x=y.localBounds&&b&&y.uvScale?y.localBounds.translate(b.negate()).multiply(y.uvScale.inverse()).translate(b):void 0,P=y.localBounds&&x&&y.uvScale?v.bounds.multiply(y.uvScale).translate(x.leftTop.negate()):void 0,C=v.bounds.translate(v.offset.negate()).multiply(new w(1/v.scale,1/v.scale)).transformedBounds(c.transform);if(P)if(C)if(P.right<0||P.bottom<0||P.left>=1024||P.top>=1024)l.Error(592525082,"Cached glyph src rect out of bounds");else{for(var E={srcRect:P,dstRect:C,distanceScale:1},S=void 0,R=0;R<d.length&&!S;R++)d[R].page==v.page&&(S=d[R]);S||(S={page:v.page,cachedGlyphInstances:[]},d.push(S)),S.cachedGlyphInstances.push(E),p=!0}else l.Error(592525081,"Cached glyph dst rect undefined");else l.Error(592525080,"Cached glyph src rect undefined")}}if(!p){var M=f.tapeBuffers,I=void 0,A=0;if(!M||m||n)if(m||n){var F=Ot(c,4096,n,m,m?T.FromTransforms(c.transform,T.Scale2D(a)):void 0);M=F.buffers,I=F.distanceBuffers,A=F.endDistance}else M=f.refreshCachedTapeBuffers(c);var D=e.getBabylonEngine(),L=f.hwTapeBuffers;L||(L=M.map((function(e){return D.createVertexBuffer(e)})));var O=void 0;I&&(O=I.map((function(e){return D.createVertexBuffer(e)})));var k=c.transform.toMatrix3(),N={tapeBuffers:M,hwTapeBuffers:L,hwDistanceBuffers:O,fillMode:o?0:c.fillMode,lineEnabled:s&&c.lineEnabled,isArrowHead:!1,transform:k,startDistance:0,endDistance:A};if(u.push(N),o&&i&&(0!=i.headEnd.end||0!=i.tailEnd.end))for(var G=i.adjustedLineWidthForArrowHead,V=k.multiply(T.Scale2D(a)),z=T.Scale2D(a.inverse()),H=0,j=c.figures;H<j.length;H++){var q=j[H],X=q.isClosed||q.isLastPointDuplicated();if(i.headEnd&&0!=i.headEnd.end&&!X){var K=U(i.headEnd,G);if(K){var Y=W(q,!1,i.headEnd,G,V),Q=Ot(B.CreateFromFigure(K),4096).buffers;u.push({tapeBuffers:Q,hwTapeBuffers:Q.map((function(e){return D.createVertexBuffer(e)})),hwDistanceBuffers:void 0,fillMode:5==i.headEnd.end?0:1,lineEnabled:!0,isArrowHead:!0,transform:Y?Y.multiply(z):void 0,startDistance:0,endDistance:0})}}if(i.tailEnd&&0!=i.tailEnd.end&&!X){var Z=U(i.tailEnd,G);if(Z){var J=W(q,!0,i.tailEnd,G,V),$=Ot(B.CreateFromFigure(Z),4096).buffers;u.push({tapeBuffers:$,hwTapeBuffers:$.map((function(e){return D.createVertexBuffer(e)})),hwDistanceBuffers:void 0,fillMode:5==i.tailEnd.end?0:1,lineEnabled:!0,isArrowHead:!0,transform:J?J.multiply(z):void 0,startDistance:0,endDistance:0})}}}}},y=f;y<=p;y++)v(y);return{transformedPaths:u,cachedGlyphsPages:d}}function Yt(e,t,r){var i=e.getBabylonEngine();0==t?(i.setColorWrite(!0),i.depthCullingState.depthMask=!0,i.stencilState.stencilTest=!1,i.stencilState.stencilMask=255,i.stencilState.stencilFunc=519,i.stencilState.stencilFuncRef=0,i.stencilState.stencilFuncMask=3,i.alphaState.alphaBlend=!0,i.alphaState.setAlphaBlendFunctionParameters(1,1,1,1),i.alphaState.setAlphaEquationParameters(32776,32776),i.clear(null,!1,!1,!0)):1==t?(i.setColorWrite(!1),i.depthCullingState.depthMask=!1,i.stencilState.stencilTest=!0,i.stencilState.stencilMask=255,i.stencilState.stencilFunc=519,i.stencilState.stencilFuncRef=1,i.stencilState.stencilFuncMask=255):(i.setColorWrite(!0),i.depthCullingState.depthMask=!0,i.stencilState.stencilMask=0,2==t?(i.stencilState.stencilTest=!0,i.stencilState.stencilFunc=517,i.stencilState.stencilFuncRef=0,i.stencilState.stencilFuncMask=1==r?255:3,i.alphaState.alphaBlend=!0,i.alphaState.setAlphaBlendFunctionParameters(775,769,773,771),i.alphaState.setAlphaEquationParameters(32774,32774)):3==t&&(i.stencilState.stencilTest=!1,i.alphaState.alphaBlend=!0,i.alphaState.setAlphaBlendFunctionParameters(772,1,0,0),i.alphaState.setAlphaEquationParameters(32774,32774)))}function Qt(e,t,r,i){var n=r&&!(3==t);Yt(e,t,i.overlapMode);var s=e.getBabylonEffect();s.setInt("u_7",t),s.setInt("ufrag_0",t),s.setFloat("ufrag_8",n?1:0);var o=0,a=tr(i.style.pen);if(a&&a.length>0)for(var h=0;h<a.length;h++)o+=a[h];0==o&&(o=1);var c=0==i.style.pen.headEnd.cap?1:0;s.setFloat("ufrag_5",a&&a.length>0?.5-(a[0]-c)/(2*o):0),s.setFloat("ufrag_4",a&&a.length>0?1/(o*i.style.pen.adjustedLineWidth):0)}function Zt(e,t){return e?0==e.end||4==e.end||3==e.end?0:5==e.end||2==e.end?t*z(e.length,e.end)/V(e.width,e.end):2*t:0}function Jt(e,t,r,i,n,s,o,a,h){if(0!=t||3!=g){var c=-performance.now(),l=e.getBabylonEffect(),u=e.getBabylonEngine();l.setFloat("u_12",i.style.pen.adjustedLineWidth),l.setFloat("u_5",i.style.pen.miterLimit);var d=0,f=tr(i.style.pen),p=f?f.length:0;if(i.style.pen&&f){for(var m=0;m<p;m++)d+=f[m];d=d>0?d:1,l.setFloat("ufrag_12",d/2),l.setFloat4("ufrag_13",p>=2?f[0]/2:d,p>=3?f[0]/2+f[1]:d,p>=4?f[0]/2+f[1]+f[2]:d,p>=5?f[0]/2+f[1]+f[2]+f[3]:d)}else l.setFloat("ufrag_12",.5),l.setFloat4("ufrag_13",1,1,1,1);l.setFloat("u_14",n.length>0&&n[0].isArrowHead||0==i.style.pen.headEnd.cap?1:0);for(var _=0,v=n;_<v.length;_++){var y=v[_];if(Xt(t,r,y,s,a)){var b=(0!=y.fillMode||2==o)&&2==o==y.isArrowHead&&(0==s||1==s&&r),w=y.lineEnabled&&!y.isArrowHead,x=y.isArrowHead&&0==y.fillMode,P=x?w:b,C=x?b:w;l.setMatrix3x3("u_8",y.transform?y.transform.m:T.Identity.m),l.setInt("ufrag_17",a?1:0),a&&l.setFloat("ufrag_12",1/y.endDistance),l.setFloat("ufrag_19",y.isArrowHead&&0==y.fillMode&&i.distRangeSize?i.style.pen.adjustedLineWidth/4/i.distRangeSize:0);var E=n.length>0&&y.isArrowHead?1:i.style.pen?i.style.pen.lineJoin:0;l.setInt("u_4",E),l.setInt("ufrag_1",E);for(m=0;m<y.tapeBuffers.length;m++){var S=y.tapeBuffers[m],R=y.hwTapeBuffers[m],M=y.hwDistanceBuffers?y.hwDistanceBuffers[m]:void 0,I=S.length/4-4;if(u.bindInstancesBuffer(R,Ht,!1),M?(l.setInt("u_19",0),u.bindInstancesBuffer(M,jt,!1)):(l.setInt("u_19",1),e.setDummyPointerAttribute("a_d1"),e.setDummyPointerAttribute("a_d2")),0==S[2]&&y.startDistance!=y.endDistance){var A=Zt(i.style.pen.headEnd,i.style.pen.adjustedLineWidthForArrowHead),F=Zt(i.style.pen.tailEnd,i.style.pen.adjustedLineWidthForArrowHead);l.setFloat2("ufrag_16",y.startDistance+A,y.endDistance-F)}else l.setFloat2("ufrag_16",0,0);l.setFloat("ufrag_2",P?1:0),l.setFloat("ufrag_3",C?1:0),l.setFloat("ufrag_18",x?1:0),1==t?(l.setFloat("ufrag_6",1),e.setDistanceFieldStencilSumIncrement(!0),e.drawQuadInstances(I),l.setFloat("ufrag_6",-1),e.setDistanceFieldStencilSumIncrement(!1),e.drawQuadInstances(I)):e.drawQuadInstances(I)}}}e.disableInstanceAttribute("a_p0"),e.disableInstanceAttribute("a_p1"),e.disableInstanceAttribute("a_p2"),e.disableInstanceAttribute("a_p3"),e.disableInstanceAttribute("a_p4"),e.disableInstanceAttribute("a_d1"),e.disableInstanceAttribute("a_d2"),c+=performance.now(),h.drawTapeCostMs+=c}}function $t(e,t,r,i){for(var n=[],s=0,o=Wt[t];s<o.length;s++){var a=o[s];i&&a.ready||(n.push(a.path),a.ready=!0)}if(n.length>0){var h=new ge(n);return h.style.pen.lineWidth=4,r.refresh(e,h,!0,i)}return!0}function er(e,t){if(dt&&e.getGraphicsProcessor()){var r,i=performance.now(),n=Vt;Vt=void 0,n||(n=[]),r=function(e){return function(e){var t=Ut(e.glyphCacheId);if(t&&null==zt[t]){var r=new B(e,x.Identity),i=q([r]);if(i){0!=Wt.length&&256!=Wt[Wt.length-1].length||Wt.push([]);var n=Wt.length-1,s=Wt[n],o=i.size,a=56/Math.max(4096,Math.max(o.x,o.y)),h=new w(a,a),c=s.length,l=.5+c%16,u=.5+(c-l)/16,d=i.center.scale(-a).add(new w(64*l,64*u)),f=x.fromScaleAndTranslation(h,d),p={page:n,scale:a,offset:d,bounds:i.multiply(h).translate(d).inflate(4),path:new B(r,f),ready:!1};s.push(p),zt[t]=p}}}(e),!0},_e(t,(function(e){for(var t=0,i=e.paths||[];t<i.length;t++){var n=i[t];if(!r(n))return!1}return!0}));for(var s=0;s<Wt.length;s++){var o=!0,a=s<n.length?n[s]:void 0;if(a)a.isValid(e)||(l.Error(592525085,"invalid glyph table texture. recreating."),o=!1);else{for(;n.length<s+1;)n.push(new Gt(e));(a=n[s]).contentBoundsOverride=new P(0,0,1024,1024),o=!1}var h=!1;o&&(h=$t(e,s,a,!0)),h||$t(e,s,a,!1)}Vt=n,e.getCurrentFramePerformanceSummary().distanceFieldForGlyphTableCostMs+=performance.now()-i}}function tr(e){if(!e.tipType||0==e.tipType)return e.dashType>=0&&e.dashType<rr.length?rr[e.dashType]:void l.Error(591192836,"unsupported dashType")}var rr=[null,new Float32Array([3,1]),new Float32Array([1,1]),new Float32Array([3,1,1,1]),new Float32Array([3,1,1,1,1,1]),new Float32Array([1,3]),new Float32Array([4,3]),new Float32Array([8,3]),new Float32Array([4,3,1,3]),new Float32Array([8,3,1,3]),new Float32Array([8,3,1,3,1,3])],ir=function(){function e(){this.m_compatibleGraphicsProcessorId=0}return Object.defineProperty(e.prototype,"tapeBuffers",{get:function(){return this.m_tapeBuffers},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hwTapeBuffers",{get:function(){return this.m_hwTapeBuffers},enumerable:!0,configurable:!0}),e.prototype.releaseGeneratedResources=function(){if(this.m_hwTapeBuffers&&this.m_engine)for(var e=0,t=this.m_hwTapeBuffers;e<t.length;e++){var r=t[e];this.m_engine._releaseBuffer(r)}this.m_hwTapeBuffers=void 0},e.prototype.refreshCachedTapeBuffers=function(e){return this.m_tapeBuffers||(this.m_tapeBuffers=Ot(e,4096).buffers),this.m_tapeBuffers},e.prototype.refreshCachedHwTapeBuffers=function(e,t){if(!this.m_hwTapeBuffers||!this.m_engine||this.m_compatibleGraphicsProcessorId!=t.getUniqueGraphicsProcessorId()){var r=Ot(e,4096,!1,!1,void 0),i=t.getBabylonEngine();this.m_hwTapeBuffers=r.buffers.map((function(e){return i.createVertexBuffer(e)})),this.m_compatibleGraphicsProcessorId=t.getUniqueGraphicsProcessorId(),this.m_engine=t.getBabylonEngine()}return this.m_hwTapeBuffers},e}(),nr=function(){function e(e,t){this.m_state=e,this.m_texture=t}return e.prototype.getState=function(){return this.m_state},e.prototype.getSize=function(){return this.m_texture&&this.m_texture.babylonTexture?this.m_texture.size:void 0},e.prototype.getLogicalCenter=function(){return this.m_texture&&this.m_texture.contentLocation?this.m_texture.contentLocation.logicalCenter:void 0},e.prototype.tryConvertToBufferRGBA=function(){return this.m_texture instanceof gt?this.m_texture.tryConvertToBufferRGBA():void 0},e}(),sr=function(){function e(){this.m_state=0}return e.prototype.releaseGeneratedResources=function(){this.m_texture&&(this.m_texture.release(),this.m_state=2)},Object.defineProperty(e.prototype,"texture",{get:function(){return this.m_texture},set:function(e){this.m_texture&&this.m_texture!=e&&this.m_texture.release(),this.m_texture=e,this.m_state=1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return this.m_state},enumerable:!0,configurable:!0}),e}();function or(e,t,r,i){if(e.getGraphicsProcessor()){var n=t,s=Pe(r,i);if(s){var o=s.getType();if(6==o){var a=s;if(a.image){var h=e.ensureImageRenderData(a.image);2==h.state?l.Error(592472275,"Trying to use deleted texture id:"+a.image.id):0==h.state&&l.Error(592472276,"Trying to use uninitialized texture id:"+a.image.id);var c=h.texture;if(!t||!(t==c||c&&t.tag==c.changeTracker.currentUniqueId)){var u=s.wrapMode;n=null!=u&&c&&c.wrapMode!=u?c.cloneWithNewWrapMode(e,u):c}}else n=void 0}else if(7==o){var d=-performance.now();t&&t.tag==s.pattern||(n=function(e,t){if(!e.getGraphicsProcessor())throw l.Error(592525326,"Graphics processor not initialized");if(t<0||t>53)return void l.Error(592525327,"pattern out of range");for(var r=new Uint8Array(192),i=fr[t],n=0;n<16;n++)for(var s=i[n],o=0;o<4;o++){var a=(s&3<<2*o)>>2*o,h=0==a?255:1==a?127:0,c=3*(4*n+o);r[c+0]=r[c+1]=r[c+2]=h?255:0}var u=new pt(e,null,ur,0,!0);return u.copyFromRGBABuffer(e,ur,r,!1,!1,0,!1),u.tag=t,u}(e,s.pattern)),d+=performance.now(),e.getCurrentFramePerformanceSummary().patternTextureCostMs+=d}else if(J.IsGradient(o)){var f,p=-performance.now();if(5==o)(f=t instanceof gt?t:void 0)&&f.isValid(e)&&f.tag==r.changeTracker.currentUniqueId||(r instanceof ge?n=function(e,t,r,i){var n=e.getGraphicsProcessor();if(!n)throw l.Error(592525324,"Graphics processor not initialized");if(5!=i.getType())throw l.Error(592525325,"This is not a path gradient");var s=ye(r,!1);if(!s||s.isEmpty()||!r.paths)return new gt(e);var o=s.size.multiply(r.transform.scale.abs()),a=o.scale(Math.min(1,4096/o.x,4096/o.y)),h=new w(Math.floor(a.x+1),Math.floor(a.y+1)),c=gt.RecycleOrReplace(t,e,h,!0,!1,!1);return c.tag=r.changeTracker.currentUniqueId,function(e,t,r,i,n,s){var o=cr(r),a=o.colors,h=o.colors.length<4?Q.Transparent:new Q(a[a.length-4],a[a.length-3],a[a.length-2],a[a.length-1]),c=e.activateShaderProgram(2);c.begin(t.babylonTexture,h,!1);var l=c.getBabylonEffect(),u=c.getBabylonEngine();if(l.setInt("u_0",1),l.setVector2("u_1",n),l.setVector2("u_2",s),l.setFloatArray("bfrag_0",o.stops),l.setFloatArray4("bfrag_1",o.colors),l.setInt("ufrag_0",0),l.setInt("ufrag_3",r&&r.isGammaCorrected?1:0),l.setInt("ufrag_4",r.blendBellShape?1:0),l.setVector2("ufrag_5",r.blendBellShape||w.Zero),i){for(var d=0,f=i;d<f.length;d++)for(var p=f[d],g=p.transform.toMatrix3(),m=Ot(p,4096,!0).buffers,_=m.map((function(e){return u.createVertexBuffer(e)})),v=0;v<m.length;v++){var y=m[v].length/4-4;u.bindInstancesBuffer(_[v],lr,!1),l.setMatrix3x3("u_3",g.m),c.drawQuadInstances(y),u._releaseBuffer(_[v])}c.disableInstanceAttribute("a_p1"),c.disableInstanceAttribute("a_p2")}c.end()}(n,c,i,r.paths,s.center,s.size.inverse()),c}(e,f,r,s):l.Error(592525320,"Path gradient only supported on Shape items")),p+=performance.now(),e.getCurrentFramePerformanceSummary().pathGradientTextureCostMs+=p;else(f=t instanceof gt?t:void 0)&&f.isValid(e)&&f.tag==s.changeTracker.currentUniqueId||(n=function(e,t,r){var i=e.getGraphicsProcessor();if(!i)throw l.Error(592525322,"Graphics processor not initialized");if(5==r.getType())throw l.Error(592525323,"pathGradient should not use this code");var n=2==r.getType()||4==r.getType(),s=new w(256,n?1:256),o=gt.RecycleOrReplace(t,e,s,!0,!1,!1);return o.tag=r.changeTracker.currentUniqueId,function(e,t,r){var i=cr(r),n=e.activateShaderProgram(2);n.begin(t.babylonTexture,Q.Black,!1);var s=n.getBabylonEffect();n.setDummyPointerAttribute("a_p1"),n.setDummyPointerAttribute("a_p2"),s.setFloatArray("bfrag_0",i.stops),s.setFloatArray4("bfrag_1",i.colors),s.setInt("u_0",0);var o=r&&3==r.getType();if(s.setInt("ufrag_0",o?1:0),s.setInt("ufrag_3",r&&r.isGammaCorrected?1:0),r&&o){var a=r.fillToRect?r.fillToRect.center:new w(.5,.5),h=r.fillFromRect?a.subtract(r.fillFromRect.leftTop).divide(r.fillFromRect.size):a;s.setVector2("ufrag_2",h)}s.setInt("ufrag_4",r.blendBellShape?1:0),s.setVector2("ufrag_5",r.blendBellShape||w.Zero),n.drawQuads(1),n.end()}(i,o,r),o}(e,f,s)),p+=performance.now(),e.getCurrentFramePerformanceSummary().gradientTextureCostMs+=p}}else n=null;return t&&t!=n&&t.release(),n}}var ar=new w(1024,1024);function hr(e,t,r,i,n){var s=e.getGraphicsProcessor();if(!s)throw l.Error(592525321,"Graphics processor not initialized");var o=gt.RecycleOrReplace(t,e,ar,!0,!1,!1);return o.tag=n,function(e,t,r,i){var n=e.activateShaderProgram(4);n.begin(t.babylonTexture,Q.Black,!1);var s=n.getBabylonEffect();s.setInt("ufrag_0",r),s.setFloat("ufrag_1",i),n.drawQuads(1),n.end()}(s,o,r,i),o}function cr(e){for(var t=e.gradientStops.length,r=new Float32Array(t+2),i=new Float32Array(4*(t+2)),n=0;n<t+2;n++){var s=Math.min(Math.max(n-1,0),t-1),o=e.gradientStops[s].color;r[n]=0==n?0:n==t+1?1:e.gradientStops[s].position,i[4*n+0]=o.r,i[4*n+1]=o.g,i[4*n+2]=o.b,i[4*n+3]=o.a}return{stops:r,colors:i}}var lr=[{attributeName:"a_p1",attributeSize:4,offset:16},{attributeName:"a_p2",attributeSize:4,offset:32}];var ur=new w(8,8);var dr,fr=[[255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[3,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0],[7,64,29,0,116,0,208,1,64,7,0,29,0,116,1,208],[1,208,0,116,0,29,64,7,208,1,116,0,29,0,7,64],[255,255,3,0,3,0,3,0,3,0,3,0,3,0,3,0],[7,208,29,116,116,29,208,7,208,7,116,29,29,116,7,208],[3,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0],[3,0,0,0,0,3,0,0,3,0,0,0,0,3,0,0],[3,3,0,0,48,48,0,0,3,3,0,0,48,48,0,0],[3,3,48,48,3,3,48,48,3,3,48,48,3,3,48,48],[51,51,12,12,51,51,192,192,51,51,12,12,51,51,192,192],[51,51,204,204,51,51,204,192,51,51,204,204,51,51,192,204],[51,51,204,204,51,51,204,204,51,51,204,204,51,51,204,204],[63,63,204,204,243,243,204,204,63,63,204,204,243,243,204,204],[252,252,207,207,252,252,207,207,252,252,207,207,252,252,207,207],[252,252,255,255,207,207,255,255,252,252,255,255,207,207,255,255],[63,255,255,255,255,63,255,255,63,255,255,255,255,63,255,255],[255,255,255,255,255,255,255,252,255,255,255,255,255,255,252,255],[3,3,12,12,48,48,192,192,3,3,12,12,48,48,192,192],[192,192,48,48,12,12,3,3,192,192,48,48,12,12,3,3],[15,15,60,60,240,240,195,195,15,15,60,60,240,240,195,195],[240,240,60,60,15,15,195,195,240,240,60,60,15,15,195,195],[15,192,63,0,252,0,240,3,192,15,0,63,0,252,3,240],[3,240,0,252,0,63,192,15,240,3,252,0,63,0,15,192],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0],[204,204,204,204,204,204,204,204,204,204,204,204,204,204,204,204],[255,255,0,0,255,255,0,0,255,255,0,0,255,255,0,0],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],[255,255,255,255,0,0,0,0,255,255,255,255,0,0,0,0],[0,0,0,0,3,3,12,12,48,48,192,192,0,0,0,0],[0,0,0,0,192,192,48,48,12,12,3,3,0,0,0,0],[255,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0],[3,0,3,0,3,0,3,0,0,3,0,3,0,3,0,3],[3,0,0,3,12,0,0,48,192,0,0,192,48,0,0,12],[243,192,240,0,0,240,192,243,207,3,15,0,0,15,3,207],[3,192,12,48,48,12,192,3,3,192,12,48,48,12,192,3],[0,0,192,3,48,204,15,0,0,0,192,3,48,204,15,0],[0,192,0,48,0,12,0,3,192,3,48,12,12,48,3,192],[255,255,3,0,3,0,3,0,255,255,0,3,0,3,0,3],[3,3,204,12,48,48,12,204,3,3,192,12,48,48,204,192],[51,51,204,204,51,51,204,204,255,0,255,0,255,0,255,0],[0,0,192,0,0,3,192,0,0,0,3,0,0,192,3,0],[51,51,0,0,3,0,0,0,3,0,0,0,3,0,0,0],[3,0,0,0,48,48,0,0,0,3,0,0,48,48,0,0],[0,240,3,12,12,3,240,0,0,15,0,48,0,192,0,192],[255,255,60,60,255,255,195,195,255,255,60,60,255,255,195,195],[252,252,3,195,3,255,3,255,252,252,195,3,255,3,255,3],[255,255,3,3,3,3,3,3,255,255,3,3,3,3,3,3],[195,195,60,60,60,60,195,195,195,195,60,60,60,60,195,195],[255,0,255,0,255,0,255,0,0,255,0,255,0,255,0,255],[3,48,12,12,48,3,192,0,48,3,12,12,3,48,0,192],[192,0,240,3,252,15,255,63,252,15,240,3,192,0,0,0]];!function(e){e[e.fromBegining=0]="fromBegining",e[e.distanceFieldsReady=1]="distanceFieldsReady",e[e.brushTexturesReady=2]="brushTexturesReady",e[e.fadeReady=3]="fadeReady",e[e.effectsReady=4]="effectsReady"}(dr||(dr={}));var pr=function(){function e(){this.cachedGraphicsProcessorId=-1,this.initTextureStage=dr.fromBegining,this.isFillTextureDisposable=!1,this.isLineTextureDisposable=!1,this.isPictureTextureDisposable=!1}return e.prototype.checkIfUpdateNeeded=function(e,t){if(t.getUniqueGraphicsProcessorId()!=this.cachedGraphicsProcessorId&&this.clearTextures(),this.cachedGraphicsProcessorId=t.getUniqueGraphicsProcessorId(),this.checkDistanceFields(e),e.version!=this.lastKnownShapeVersion&&(this.clearEffectsTextures(),this.lastKnownShapeVersion=e.version,this.drawDistribution=void 0),1==e.getType()){var r=e;r.geometryTracker.version!=this.lastKnownGeometryVersion&&(this.initTextureStage=dr.fromBegining,this.lastKnownGeometryVersion=r.geometryTracker.version,this.setEffectsDirty())}},e.prototype.checkDistanceFields=function(e){if(1==e.getType())for(var t=e,r=0,i=this.distanceFields||[];r<i.length;r++){var n=i[r];if(n.geometryVersion!=t.geometryTracker.version||n.lastKnownQualitySetting!=ht||n.lastKnownLineWidth!=t.style.pen.adjustedLineWidth||n.lastKnownLineWidthForArrowHead!=t.style.pen.adjustedLineWidthForArrowHead||n.lastKnownHitTestSlop!=p)return void this.clearTextures()}},e.prototype.clearBounds=function(){this.initTextureStage=dr.fromBegining},e.prototype.setEffectsDirty=function(){this.spriteTexture&&(this.spriteTexture.isDirty=!0)},e.prototype.clearEffectsTextures=function(){this.initTextureStage=dr.fromBegining,this.fillTexture&&this.isFillTextureDisposable&&(this.fillTexture.release(),this.fillTexture=void 0),this.lineTexture&&this.isLineTextureDisposable&&(this.lineTexture.release(),this.lineTexture=void 0),this.pictureTexture&&this.isPictureTextureDisposable&&(this.pictureTexture.release(),this.pictureTexture=void 0),this.innerShadowTexture&&this.innerShadowTexture.release(),this.softEdgesTexture&&this.softEdgesTexture.release(),this.glowTexture&&this.glowTexture.release(),this.shadowTexture&&this.shadowTexture.release(),this.reflectionTexture&&this.reflectionTexture.release(),this.fadeTexture&&this.fadeTexture.release(),this.spriteTexture&&this.spriteTexture.release(),this.innerShadowTexture=this.softEdgesTexture=this.glowTexture=this.shadowTexture=this.reflectionTexture=this.fadeTexture=this.spriteTexture=void 0},e.prototype.clearTextures=function(){this.initTextureStage=dr.fromBegining;for(var e=0,t=this.distanceFields||[];e<t.length;e++){var r=t[e];r&&r.release()}this.clearEffectsTextures(),this.distanceFields=void 0},e.prototype.clear=function(){this.clearBounds(),this.clearTextures()},e.prototype.initFadeTexture=function(e,t,r){if(e.getGraphicsProcessor()){var i=r?13==r.preset?t.changeTracker.currentUniqueId:r.param+":"+r.preset:"";if(!this.fadeTexture||r&&0!=r.preset&&this.fadeTexture.isValid(e)&&this.fadeTexture.tag==i||(this.fadeTexture.release(),this.fadeTexture=void 0),!this.fadeTexture)if(1==t.getType()&&r&&13==r.preset){var n=t;n.paths&&n.paths.length>0&&(this.fadeTexture=new Gt(e,void 0,1,n.mergeMode),this.fadeTexture.generateDrawFadeMask=!0,this.fadeTexture.refresh(e,t,!1,!1))}else r&&0!=r.preset&&13!=r.preset&&(this.fadeTexture=hr(e,this.fadeTexture,r.preset,r.param,i))}},e.prototype.getBrushTexture=function(e){switch(e){case 0:return this.fillTexture;case 1:return this.lineTexture;case 2:return this.pictureTexture}l.Error(591192833,"Invalid brush source")},e.prototype.setBrushTexture=function(e,t,r){switch(e){case 0:this.fillTexture=t,this.isFillTextureDisposable=r;break;case 1:this.lineTexture=t,this.isLineTextureDisposable=r;break;case 2:this.pictureTexture=t,this.isPictureTextureDisposable=r;break;default:l.Error(591192834,"Invalid brush source")}},e.prototype.initBrushTexture=function(e,t,r){var i=Pe(t,r),n=this.getBrushTexture(r),s=or(e,n,t,r);n!=s&&this.setBrushTexture(r,s,!(i instanceof re))},e}(),gr=function(){function e(){}return e.prototype.releaseGeneratedResources=function(){this.texture&&this.texture.release()},e}();(function(){function e(){}e.prototype.releaseGeneratedResources=function(){}})(),function(){function e(){}e.prototype.tryInitMorphKeyFrame=function(e,t){var r=e.ensureMorphKeyFrameRenderData(t);if(r.texture&&!r.texture.size.isZero()&&r.texture.isValid(e))return!0;for(var i=void 0,n=0,s=t.contents;n<s.length;n++){var o=s[n],a=T.FromTransforms(t.parentTransform||T.Identity,o.item.animationTransform||T.Identity),h=be(o.item,o.includeSubtree||null!=o.textRange,31,31,a,o.includeSubtree,o.textRange);i=P.UnionRect(i,h)}if(i){for(var c=Math.min(ht,4096/Math.max(i.width,i.height)),u=new gt(e,new w(Math.max(1,Math.ceil(i.size.x*c)),Math.max(1,Math.ceil(i.size.y*c)))),d=new x(i.leftTop.negate(),new w(c,c)),f=0;f<t.contents.length;f++){o=t.contents[f];e.renderItemInWebGLRenderScope(o.item,0==f?Q.Transparent:void 0,{target:u,noSubtree:!o.includeSubtree,textRange:o.textRange,transform:T.FromTransforms(t.parentTransform||T.Identity,T.FromTransforms(d))})}if(t.location)u.contentLocation={logicalCenter:t.location.center.subtract(i.leftTop).scale(c),logicalSize:t.location.size.scale(c),physicalCenter:u.size.scale(.5),physicalSize:u.size,rotation:t.location.rotation,flipX:t.location.flipX,flipY:t.location.flipY},e.ensureMorphKeyFrameRenderData(t).texture=u;else l.Error(591672911,"No KeyFrame location")}return!0},e.prototype.tryPrepareMorphInRenderScope=function(e,t,r){if(!e.getGraphicsProcessor())return l.Error(575942947,"glContext must be provided"),!1;var i=performance.now();e.m_initDeadline=r?i+r:void 0;for(var n=[],s=0,o=t.elements;s<o.length;s++)for(var a=0,h=o[s].keyFrames;a<h.length;a++){if(T=h[a]){var c=e.ensureMorphKeyFrameRenderData(T);if(!c.texture||c.texture.size.isZero()||!c.texture.isValid(e))for(var u=function(e){if(e.item instanceof ge){var t=e.item;if(e.textRange)if(t.text){var r=t.text.getFullRange();r&&r.contains(e.textRange)?e.textRange.equals(r)||t.text.forceSplit(2):l.Error(591672913,"Text KeyFrame out of range: ["+e.textRange.start+", "+e.textRange.last+"], fullRange: "+(r?"["+r.start+", "+r.last+"]":"undefined"))}else l.Error(591672914,"Text KeyFrame on Shape with no Text")}e.item&&!n.find((function(t){return t==e.item}))&&n.push(e.item)},d=0,f=T.contents;d<f.length;d++){u(f[d])}}}for(var p=0,g=n;p<g.length;p++){var m=g[p],_=e.m_initDeadline?e.m_initDeadline-performance.now():void 0;if(null!=_&&_<=0)return!1;if(!e.tryPrepareItemInWebGlScope(m,e.getGraphicsProcessor(),!0,_))return!1}for(var v=0,y=t.elements;v<y.length;v++)for(var b=0,w=y[v].keyFrames;b<w.length;b++){var T;if(T=w[b]){if(!this.tryInitMorphKeyFrame(e,T))return!1;if(e.initOutOfTime())return!1}}return!0},e.prototype.tryPrepareMorph=function(e,t,r){var i=e.getGraphicsProcessor();if(!i)return l.Error(591672912,"glContext must be provided"),!1;var n=i.isInRenderScope(),s=!1;return(n||i.beginRenderScope())&&(s=this.tryPrepareMorphInRenderScope(e,t,r),n||i.endRenderScope()),s},e.prototype.renderMorph=function(e,t,r,i,n){var s=e.getGraphicsProcessor();if(s){if(!s||s.beginRenderScope()){var o=s.getBabylonEngine();if(this.tryPrepareMorph(e,t,void 0)){for(var a,h,c,u,d,f=[],p=0,g=t.elements;p<g.length;p++){var m=g[p],_=m.keyFrames.length>0&&m.keyFrames[0]?m.keyFrames[0]:void 0,v=m.keyFrames.length>1&&m.keyFrames[1]?m.keyFrames[1]:void 0,y=_?_.location:v?v.location:void 0,b=v?v.location:y,T=_?e.ensureMorphKeyFrameRenderData(_):void 0,x=v?e.ensureMorphKeyFrameRenderData(v):void 0,C=T?T.texture:void 0,E=x?x.texture:void 0,S=e.ensureMorphElementRenderData(m);if(y&&b){if(!S.layer||S.layer.textureA!=C||S.layer.textureB!=E){var I=void 0,A=void 0,F=void 0;if(_&&v&&_.morphingGrid&&v.morphingGrid){var B=_.morphingGrid.size.x*_.morphingGrid.size.y*2;_.morphingGrid.size.equals(v.morphingGrid.size)&&B>0&&_.morphingGrid.data.length==B&&v.morphingGrid.data.length==B?(I=o.createVertexBuffer(_.morphingGrid.data),A=o.createVertexBuffer(v.morphingGrid.data),F=bt.CreateGridXY(s,_.morphingGrid.size,new P(-1,-1,1,1))):l.Error(591672917,"Wrong morphing grid size")}else(_&&_.morphingGrid||v&&v.morphingGrid)&&l.Error(591672918,"Morphing grids should come by pair");S.layer=new Rt(T?T.texture:void 0,x?x.texture:void 0,I,A,F,t.panVector)}if(S.layer){var D=_?_.zPosition:v?v.zPosition:0,L=v?v.zPosition:D,O=!(_&&v||t.panVector);S.layer.progress=O?R(_?3*r:3*r-2,0,1):r,S.layer.contentCenter=w.InterpolateLinear(y.center,b.center,r),S.layer.contentSize=w.InterpolateLinear(y.size,b.size,r),S.layer.contentFlip=w.InterpolateLinear(w.Flip(y.flipX,y.flipY),w.Flip(b.flipX,b.flipY),r),S.layer.contentRotation=(a=y.rotation,h=b.rotation,c=r,u=m.rotateClockwise,d=void 0,d=(h-a)/(2*Math.PI),d-=Math.floor(d),(u&&d>0||null==u&&d>.5)&&d--,M(a,a+d*(2*Math.PI),c)),S.layer.depth=M(D,L,r),f.push(S.layer)}}}s.updateViewportSize();var k=s.getCurrentViewportSize(),N=s.activateShaderProgram(1);N.begin(void 0,i,!0),f.sort((function(e,t){return e.depth-t.depth}));for(var G=0;G<f.length;G++){var U=f[G];U.depthFar=1-G/t.elements.length,U.depthNear=1-(G+.9)/t.elements.length,Ft(U,N,k,n?n.toMatrix3():void 0,void 0)}N.end(),s.endRenderScope()}else l.Error(591672916,"failed to initialize Morph")}}else l.Error(591672915,"glContext must be provided")}}();function mr(e,t,r,i,n){if(!r)return T.Identity;var s=r.getType();if(7==s)return T.Scale2D(n.scale(1/16));var o=J.IsGradient(s);if(6!=s&&!o)return T.Identity;var a=r.rotateWithShape,h=0,c=a?T.Scale2D(t.transform.scale):t.transform.toMatrix3(),u=ye(t,i,c),d=t.fillBoundsOverride?t.fillBoundsOverride:u;if(t.fillBoundsOverride&&d&&a&&(d=d.transformedBounds(T.FromTransforms(t.transform.toInverseMatrix3(),c))),!u||!d)return T.Identity;var f=d.size,p=w.One,g=w.Zero,m=!0,_=4;if(6==s){var v=r;if(g=v.offset,p=v.scale.abs(),m=v.isStretched,_=v.alignment,m)p=p.multiply(f),g=g.multiply(f);else{var y=e.getTextureFromImage(v.image);y?p=p.multiply(y.originalSize):l.Error(590960595,"No texture")}}else if(5==s)p=f;else if(o){var b=r;if(p=b.fillFromRect?b.fillFromRect.size:w.One,g=(b.fillFromRect?b.fillFromRect.center:w.Zero).subtract(new w(.5,.5)).multiply(f),m=b.isStretched||4==s,2==s){p=p.multiply(f);var x=m?P.FromSize(w.One):P.FromSize(p),C=x.transformedBounds(T.RotationZ(b.angle));p=C?p.scale(C.width/x.width):p,h-=b.angle}else m?p=p.multiply(f):(p=p.scale(Math.max(f.x,f.y)),3==s&&(p=p.scale(Math.sqrt(f.x*f.x+f.y*f.y)/Math.max(f.x,f.y))))}else p=p.multiply(f);var E=new P(-f.x/2+p.x/2,-f.y/2+p.y/2,f.x/2-p.x/2,f.y/2-p.y/2);g=g.add(Te(_,E)).multiply(new w(1,-1));var S=T.Identity;return S=(S=S.multiply(T.Scale2D(new w(1,-1)))).multiply(T.Translation2D(u.center.subtract(d.center))),a||(S=(S=S.multiply(T.Scale2D(t.transform.scale.sign()))).multiply(T.RotationZ(-t.transform.rotation))),S=S.multiply(T.Translation2D(g.negate())),2==s&&(m&&(S=S.multiply(T.Scale2D(f.inverse()))),S=S.multiply(T.RotationZ(-h)),m&&(S=S.multiply(T.Scale2D(f)))),S=(S=S.multiply(T.Scale2D(p.inverse()))).multiply(T.Scale2D(new w(1,-1)))}function _r(e,t,r,i,n,s,o,a,h,c,u){var d=s.isSolidRect(),f=ye(s,!1);if(f){var p=new Mt(r,ft(f,s.transform),s.style);p.fillTexture=t.fillTexture||void 0,p.lineTexture=t.lineTexture||void 0,p.pictureTexture=t.pictureTexture||void 0,p.innerShadowTexture=t.innerShadowTexture||void 0,p.softEdgesTexture=t.softEdgesTexture||void 0,p.fillTransformUV=mr(e,s,s.style.fillBrush,!1,o),p.pictureTransformUV=mr(e,s,s.style.pictureBrush,!1,o),p.lineTransformUV=mr(e,s,s.style.lineBrush,!0,o),p.localClipRect=u,p.fillBrightness=r?r.getFillBrightness():0,p.mergeMode=s.mergeMode,p.distRangeSize=d?0:s.distRangeSize,p.softEdges=s.effects&&16&i?s.effects.softEdges:void 0,p.innerShadow=s.effects&&8&i?s.effects.innerShadow:void 0,p.blendingMode=s.style.blendingMode,(0==h||4==h)&&t.fade&&(p.fadeInfo={fade:t.fade,fadeTexture:t.fadeTexture}),Ft(p,n,o,a,c,h)}else l.Error(588006215,"Unable to get bounds")}var vr,yr=function(){function e(e,t,r,i){void 0===t&&(t=!1),this.initalize(e,t,r,i)}return e.prototype.initalize=function(e,t,r,i){return void 0===t&&(t=!1),this.mask=e,this.skipNextObservers=t,this.target=r,this.currentTarget=i,this},e}(),br=function(e,t,r){void 0===r&&(r=null),this.callback=e,this.mask=t,this.scope=r,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1},wr=(function(){function e(){}e.prototype.dispose=function(){if(this._observers&&this._observables)for(var e=0;e<this._observers.length;e++)this._observables[e].remove(this._observers[e]);this._observers=null,this._observables=null},e.Watch=function(t,r,i,n){void 0===i&&(i=-1),void 0===n&&(n=null);var s=new e;s._observers=new Array,s._observables=t;for(var o=0,a=t;o<a.length;o++){var h=a[o].add(r,i,!1,n);h&&s._observers.push(h)}return s}}(),function(){function e(e){this._observers=new Array,this._eventState=new yr(0),e&&(this._onObserverAdded=e)}return Object.defineProperty(e.prototype,"observers",{get:function(){return this._observers},enumerable:!1,configurable:!0}),e.prototype.add=function(e,t,r,i,n){if(void 0===t&&(t=-1),void 0===r&&(r=!1),void 0===i&&(i=null),void 0===n&&(n=!1),!e)return null;var s=new br(e,t,i);return s.unregisterOnNextCall=n,r?this._observers.unshift(s):this._observers.push(s),this._onObserverAdded&&this._onObserverAdded(s),s},e.prototype.addOnce=function(e){return this.add(e,void 0,void 0,void 0,!0)},e.prototype.remove=function(e){return!!e&&(-1!==this._observers.indexOf(e)&&(this._deferUnregister(e),!0))},e.prototype.removeCallback=function(e,t){for(var r=0;r<this._observers.length;r++){var i=this._observers[r];if(!i._willBeUnregistered&&(i.callback===e&&(!t||t===i.scope)))return this._deferUnregister(i),!0}return!1},e.prototype._deferUnregister=function(e){var t=this;e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout((function(){t._remove(e)}),0)},e.prototype._remove=function(e){if(!e)return!1;var t=this._observers.indexOf(e);return-1!==t&&(this._observers.splice(t,1),!0)},e.prototype.makeObserverTopPriority=function(e){this._remove(e),this._observers.unshift(e)},e.prototype.makeObserverBottomPriority=function(e){this._remove(e),this._observers.push(e)},e.prototype.notifyObservers=function(e,t,r,i,n){if(void 0===t&&(t=-1),!this._observers.length)return!0;var s=this._eventState;s.mask=t,s.target=r,s.currentTarget=i,s.skipNextObservers=!1,s.lastReturnValue=e,s.userInfo=n;for(var o=0,a=this._observers;o<a.length;o++){var h=a[o];if(!h._willBeUnregistered&&(h.mask&t&&(h.scope?s.lastReturnValue=h.callback.apply(h.scope,[e,s]):s.lastReturnValue=h.callback(e,s),h.unregisterOnNextCall&&this._deferUnregister(h)),s.skipNextObservers))return!1}return!0},e.prototype.notifyObserversWithPromise=function(e,t,r,i,n){var s=this;void 0===t&&(t=-1);var o=Promise.resolve(e);if(!this._observers.length)return o;var a=this._eventState;return a.mask=t,a.target=r,a.currentTarget=i,a.skipNextObservers=!1,a.userInfo=n,this._observers.forEach((function(r){a.skipNextObservers||r._willBeUnregistered||r.mask&t&&(o=r.scope?o.then((function(t){return a.lastReturnValue=t,r.callback.apply(r.scope,[e,a])})):o.then((function(t){return a.lastReturnValue=t,r.callback(e,a)})),r.unregisterOnNextCall&&s._deferUnregister(r))})),o.then((function(){return e}))},e.prototype.notifyObserver=function(e,t,r){void 0===r&&(r=-1);var i=this._eventState;i.mask=r,i.skipNextObservers=!1,e.callback(t,i)},e.prototype.hasObservers=function(){return this._observers.length>0},e.prototype.clear=function(){this._observers=new Array,this._onObserverAdded=null},e.prototype.clone=function(){var t=new e;return t._observers=this._observers.slice(0),t},e.prototype.hasSpecificMask=function(e){void 0===e&&(e=-1);for(var t=0,r=this._observers;t<r.length;t++){var i=r[t];if(i.mask&e||i.mask===e)return!0}return!1},e}()),Tr=function(){},xr=function(){function e(){}return e.WarnImport=function(e){return e+" needs to be imported before as it contains a side-effect required by your code."},e}();!function(e){e[e.Unknown=0]="Unknown",e[e.Url=1]="Url",e[e.Temp=2]="Temp",e[e.Raw=3]="Raw",e[e.Dynamic=4]="Dynamic",e[e.RenderTarget=5]="RenderTarget",e[e.MultiRenderTarget=6]="MultiRenderTarget",e[e.Cube=7]="Cube",e[e.CubeRaw=8]="CubeRaw",e[e.CubePrefiltered=9]="CubePrefiltered",e[e.Raw3D=10]="Raw3D",e[e.Raw2DArray=11]="Raw2DArray",e[e.Depth=12]="Depth",e[e.CubeRawRGBD=13]="CubeRawRGBD"}(vr||(vr={}));var Pr=function(){function e(e,t,r){void 0===r&&(r=!1),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.samplingMode=-1,this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new wr,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=vr.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._MSAARenderBuffer=null,this._attachments=null,this._textureArray=null,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._isDisabled=!1,this._compression=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._comparisonFunction=0,this._sphericalPolynomial=null,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._webGLTexture=null,this._references=1,this._gammaSpace=null,this._engine=e,this._source=t,r||(this._webGLTexture=e._createTexture())}return e.prototype.getEngine=function(){return this._engine},Object.defineProperty(e.prototype,"source",{get:function(){return this._source},enumerable:!1,configurable:!0}),e.prototype.incrementReferences=function(){this._references++},e.prototype.updateSize=function(e,t,r){void 0===r&&(r=1),this.width=e,this.height=t,this.depth=r,this.baseWidth=e,this.baseHeight=t,this.baseDepth=r,this._size=e*t*r},e.prototype._rebuild=function(){var t,r,i=this;switch(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedAnisotropicFilteringLevel=null,this.source){case vr.Temp:return;case vr.Url:return void(r=this._engine.createTexture(null!==(t=this._originalUrl)&&void 0!==t?t:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(function(){r._swapAndDie(i),i.isReady=!0}),null,this._buffer,void 0,this.format));case vr.Raw:return(r=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this),void(this.isReady=!0);case vr.Raw3D:return(r=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this),void(this.isReady=!0);case vr.Raw2DArray:return(r=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this),void(this.isReady=!0);case vr.Dynamic:return(r=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode))._swapAndDie(this),void this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);case vr.RenderTarget:var n=new Tr;if(n.generateDepthBuffer=this._generateDepthBuffer,n.generateMipMaps=this.generateMipMaps,n.generateStencilBuffer=this._generateStencilBuffer,n.samplingMode=this.samplingMode,n.type=this.type,this.isCube)r=this._engine.createRenderTargetCubeTexture(this.width,n);else{var s={width:this.width,height:this.height,layers:this.is2DArray?this.depth:void 0};r=this._engine.createRenderTargetTexture(s,n)}return r._swapAndDie(this),void(this.isReady=!0);case vr.Depth:var o={bilinearFiltering:2!==this.samplingMode,comparisonFunction:this._comparisonFunction,generateStencil:this._generateStencilBuffer,isCube:this.isCube},a={width:this.width,height:this.height,layers:this.is2DArray?this.depth:void 0};return(r=this._engine.createDepthStencilTexture(a,o))._swapAndDie(this),void(this.isReady=!0);case vr.Cube:return void(r=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(function(){r._swapAndDie(i),i.isReady=!0}),null,this.format,this._extension));case vr.CubeRaw:return(r=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this),void(this.isReady=!0);case vr.CubeRawRGBD:return r=this._engine.createRawCubeTexture(null,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),void e._UpdateRGBDAsync(r,this._bufferViewArrayArray,this._sphericalPolynomial,this._lodGenerationScale,this._lodGenerationOffset).then((function(){r._swapAndDie(i),i.isReady=!0}));case vr.CubePrefiltered:return void((r=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(function(e){e&&e._swapAndDie(i),i.isReady=!0}),null,this.format,this._extension))._sphericalPolynomial=this._sphericalPolynomial)}},e.prototype._swapAndDie=function(e){e._webGLTexture=this._webGLTexture,e._isRGBD=this._isRGBD,this._framebuffer&&(e._framebuffer=this._framebuffer),this._depthStencilBuffer&&(e._depthStencilBuffer=this._depthStencilBuffer),e._depthStencilTexture=this._depthStencilTexture,this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);var t,r=this._engine.getLoadedTexturesCache();-1!==(t=r.indexOf(this))&&r.splice(t,1),-1===(t=r.indexOf(e))&&r.push(e)},e.prototype.dispose=function(){this._webGLTexture&&(this._references--,0===this._references&&(this._engine._releaseTexture(this),this._webGLTexture=null))},e._UpdateRGBDAsync=function(e,t,r,i,n){throw xr.WarnImport("environmentTextureTools")},e}(),Cr=function(){function e(){}return e._AddLogEntry=function(t){e._LogCache=t+e._LogCache,e.OnNewCacheEntry&&e.OnNewCacheEntry(t)},e._FormatMessage=function(e){var t=function(e){return e<10?"0"+e:""+e},r=new Date;return"["+t(r.getHours())+":"+t(r.getMinutes())+":"+t(r.getSeconds())+"]: "+e},e._LogDisabled=function(e){},e._LogEnabled=function(t){var r=e._FormatMessage(t);console.log("BJS - "+r);var i="<div style='color:white'>"+r+"</div><br>";e._AddLogEntry(i)},e._WarnDisabled=function(e){},e._WarnEnabled=function(t){var r=e._FormatMessage(t);console.warn("BJS - "+r);var i="<div style='color:orange'>"+r+"</div><br>";e._AddLogEntry(i)},e._ErrorDisabled=function(e){},e._ErrorEnabled=function(t){e.errorsCount++;var r=e._FormatMessage(t);console.error("BJS - "+r);var i="<div style='color:red'>"+r+"</div><br>";e._AddLogEntry(i)},Object.defineProperty(e,"LogCache",{get:function(){return e._LogCache},enumerable:!1,configurable:!0}),e.ClearLogCache=function(){e._LogCache="",e.errorsCount=0},Object.defineProperty(e,"LogLevels",{set:function(t){(t&e.MessageLogLevel)===e.MessageLogLevel?e.Log=e._LogEnabled:e.Log=e._LogDisabled,(t&e.WarningLogLevel)===e.WarningLogLevel?e.Warn=e._WarnEnabled:e.Warn=e._WarnDisabled,(t&e.ErrorLogLevel)===e.ErrorLogLevel?e.Error=e._ErrorEnabled:e.Error=e._ErrorDisabled},enumerable:!1,configurable:!0}),e.NoneLogLevel=0,e.MessageLogLevel=1,e.WarningLogLevel=2,e.ErrorLogLevel=4,e.AllLogLevel=7,e._LogCache="",e.errorsCount=0,e.Log=e._LogEnabled,e.Warn=e._WarnEnabled,e.Error=e._ErrorEnabled,e}(),Er=function(){function e(){}return Object.defineProperty(e,"LastCreatedEngine",{get:function(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedScene",{get:function(){return this._LastCreatedScene},enumerable:!1,configurable:!0}),e.Instances=new Array,e._LastCreatedScene=null,e.UseFallbackTexture=!0,e.FallbackTexture="",e}(),Sr=function(){function e(){}return e.IsWindowObjectExist=function(){return"undefined"!=typeof window},e.IsNavigatorAvailable=function(){return"undefined"!=typeof navigator},e.IsDocumentAvailable=function(){return"undefined"!=typeof document},e.GetDOMTextContent=function(e){for(var t="",r=e.firstChild;r;)3===r.nodeType&&(t+=r.textContent),r=r.nextSibling;return t},e}(),Rr=function(){function e(){}return e.EndsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},e.StartsWith=function(e,t){return!!e&&0===e.indexOf(t)},e.Decode=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",r=0;r<e.byteLength;r++)t+=String.fromCharCode(e[r]);return t},e.EncodeArrayBufferToBase64=function(e){for(var t,r,i,n,s,o,a,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c="",l=0,u=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);l<u.length;)n=(t=u[l++])>>2,s=(3&t)<<4|(r=l<u.length?u[l++]:Number.NaN)>>4,o=(15&r)<<2|(i=l<u.length?u[l++]:Number.NaN)>>6,a=63&i,isNaN(r)?o=a=64:isNaN(i)&&(a=64),c+=h.charAt(n)+h.charAt(s)+h.charAt(o)+h.charAt(a);return c},e.PadNumber=function(e,t){for(var r=String(e);r.length<t;)r="0"+r;return r},e}(),Mr=function(){function e(){this.children=[]}return e.prototype.isValid=function(e){return!0},e.prototype.process=function(e,t){var r="";if(this.line){var i=this.line,n=t.processor;if(n){if(n.lineProcessor&&(i=n.lineProcessor(i,t.isFragment)),n.attributeProcessor&&Rr.StartsWith(this.line,"attribute"))i=n.attributeProcessor(this.line);else if(n.varyingProcessor&&Rr.StartsWith(this.line,"varying"))i=n.varyingProcessor(this.line,t.isFragment);else if((n.uniformProcessor||n.uniformBufferProcessor)&&Rr.StartsWith(this.line,"uniform")){/uniform (.+) (.+)/.test(this.line)?n.uniformProcessor&&(i=n.uniformProcessor(this.line,t.isFragment)):n.uniformBufferProcessor&&(i=n.uniformBufferProcessor(this.line,t.isFragment),t.lookForClosingBracketForUniformBuffer=!0)}n.endOfUniformBufferProcessor&&t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,i=n.endOfUniformBufferProcessor(this.line,t.isFragment))}r+=i+"\r\n"}return this.children.forEach((function(i){r+=i.process(e,t)})),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),r},e}(),Ir=function(){function e(){}return Object.defineProperty(e.prototype,"currentLine",{get:function(){return this._lines[this.lineIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canRead",{get:function(){return this.lineIndex<this._lines.length-1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lines",{set:function(e){this._lines=[];for(var t=0,r=e;t<r.length;t++){var i=r[t];if("#"!==i[0])for(var n=i.split(";"),s=0;s<n.length;s++){var o=n[s];(o=o.trim())&&this._lines.push(o+(s!==n.length-1?";":""))}else this._lines.push(i)}},enumerable:!1,configurable:!0}),e}(),Ar=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return _(t,e),t.prototype.process=function(e,t){for(var r=0;r<this.children.length;r++){var i=this.children[r];if(i.isValid(e))return i.process(e,t)}return""},t}(Mr),Fr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return _(t,e),t.prototype.isValid=function(e){return this.testExpression.isTrue(e)},t}(Mr),Br=function(){function e(){}return e.prototype.isTrue=function(e){return!0},e.postfixToInfix=function(t){for(var r=[],i=0,n=t;i<n.length;i++){var s=n[i];if(void 0===e._OperatorPriority[s])r.push(s);else{var o=r[r.length-1],a=r[r.length-2];r.length-=2,r.push("("+a+s+o+")")}}return r[r.length-1]},e.infixToPostfix=function(t){for(var r=[],i=-1,n=function(){""!==(c=c.trim())&&(r.push(c),c="")},s=function(t){i<e._Stack.length-1&&(e._Stack[++i]=t)},o=function(){return e._Stack[i]},a=function(){return-1===i?"!!INVALID EXPRESSION!!":e._Stack[i--]},h=0,c="";h<t.length;){var l=t.charAt(h),u=h<t.length-1?t.substr(h,2):"";if("("===l)c="",s(l);else if(")"===l){for(n();-1!==i&&"("!==o();)r.push(a());a()}else if(e._OperatorPriority[u]>1){for(n();-1!==i&&e._OperatorPriority[o()]>=e._OperatorPriority[u];)r.push(a());s(u),h++}else c+=l;h++}for(n();-1!==i;)"("===o()?a():r.push(a());return r},e._OperatorPriority={")":0,"(":1,"||":2,"&&":3},e._Stack=["","","","","","","","","","","","","","","","","","","",""],e}(),Dr=function(e){function t(t,r){void 0===r&&(r=!1);var i=e.call(this)||this;return i.define=t,i.not=r,i}return _(t,e),t.prototype.isTrue=function(e){var t=void 0!==e[this.define];return this.not&&(t=!t),t},t}(Br),Lr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return _(t,e),t.prototype.isTrue=function(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)},t}(Br),Or=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return _(t,e),t.prototype.isTrue=function(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)},t}(Br),kr=function(e){function t(t,r,i){var n=e.call(this)||this;return n.define=t,n.operand=r,n.testValue=i,n}return _(t,e),t.prototype.isTrue=function(e){var t=e[this.define];void 0===t&&(t=this.define);var r=!1,i=parseInt(t),n=parseInt(this.testValue);switch(this.operand){case">":r=i>n;break;case"<":r=i<n;break;case"<=":r=i<=n;break;case">=":r=i>=n;break;case"==":r=i===n}return r},t}(Br),Nr=/defined\s*?\((.+?)\)/g,Gr=/defined\s*?\[(.+?)\]/g,Ur=function(){function e(){}return e.Process=function(e,t,r,i){var n=this;this._ProcessIncludes(e,t,(function(e){var s=n._ProcessShaderConversion(e,t,i);r(s)}))},e._ProcessPrecision=function(e,t){var r=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=r?"precision highp float;\n"+e:"precision mediump float;\n"+e:r||(e=e.replace("precision highp float","precision mediump float")),e},e._ExtractOperation=function(e){var t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new Dr(t[1].trim(),"!"===e[0]);for(var r="",i=0,n=0,s=["==",">=","<=","<",">"];n<s.length&&(r=s[n],!((i=e.indexOf(r))>-1));n++);if(-1===i)return new Dr(e);var o=e.substring(0,i).trim(),a=e.substring(i+r.length).trim();return new kr(o,r,a)},e._BuildSubExpression=function(e){e=e.replace(Nr,"defined[$1]");for(var t=[],r=0,i=Br.infixToPostfix(e);r<i.length;r++){var n=i[r];if("||"!==n&&"&&"!==n)t.push(n);else if(t.length>=2){var s=t[t.length-1],o=t[t.length-2];t.length-=2;var a="&&"==n?new Or:new Lr;"string"==typeof s&&(s=s.replace(Gr,"defined($1)")),"string"==typeof o&&(o=o.replace(Gr,"defined($1)")),a.leftOperand="string"==typeof o?this._ExtractOperation(o):o,a.rightOperand="string"==typeof s?this._ExtractOperation(s):s,t.push(a)}}var h=t[t.length-1];return"string"==typeof h&&(h=h.replace(Gr,"defined($1)")),"string"==typeof h?this._ExtractOperation(h):h},e._BuildExpression=function(e,t){var r=new Fr,i=e.substring(0,t),n=e.substring(t);return n=n.substring(0,(n.indexOf("//")+1||n.length+1)-1).trim(),r.testExpression="#ifdef"===i?new Dr(n):"#ifndef"===i?new Dr(n,!0):this._BuildSubExpression(n),r},e._MoveCursorWithinIf=function(e,t,r){for(var i=e.currentLine;this._MoveCursor(e,r);){var n=(i=e.currentLine).substring(0,5).toLowerCase();if("#else"===n){var s=new Mr;return t.children.push(s),void this._MoveCursor(e,s)}if("#elif"===n){var o=this._BuildExpression(i,5);t.children.push(o),r=o}}},e._MoveCursor=function(e,t){for(;e.canRead;){e.lineIndex++;var r=e.currentLine,i=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(r);if(i&&i.length){switch(i[0]){case"#ifdef":var n=new Ar;t.children.push(n);var s=this._BuildExpression(r,6);n.children.push(s),this._MoveCursorWithinIf(e,n,s);break;case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":n=new Ar;t.children.push(n);s=this._BuildExpression(r,7);n.children.push(s),this._MoveCursorWithinIf(e,n,s);break;case"#if":n=new Ar,s=this._BuildExpression(r,3);t.children.push(n),n.children.push(s),this._MoveCursorWithinIf(e,n,s)}}else{var o=new Mr;if(o.line=r,t.children.push(o),"#"===r[0]&&"d"===r[1]){var a=r.replace(";","").split(" ");o.additionalDefineKey=a[1],3===a.length&&(o.additionalDefineValue=a[2])}}}return!1},e._EvaluatePreProcessors=function(e,t,r){var i=new Mr,n=new Ir;return n.lineIndex=-1,n.lines=e.split("\n"),this._MoveCursor(n,i),i.process(t,r)},e._PreparePreProcessors=function(e){for(var t={},r=0,i=e.defines;r<i.length;r++){var n=i[r].replace("#define","").replace(";","").trim().split(" ");t[n[0]]=n.length>1?n[1]:""}return t.GL_ES="true",t.__VERSION__=e.version,t[e.platformName]="true",t},e._ProcessShaderConversion=function(e,t,r){var i=this._ProcessPrecision(e,t);if(!t.processor)return i;if(-1!==i.indexOf("#version 3"))return i.replace("#version 300 es","");var n=t.defines,s=this._PreparePreProcessors(t);return t.processor.preProcessor&&(i=t.processor.preProcessor(i,n,t.isFragment)),i=this._EvaluatePreProcessors(i,s,t),t.processor.postProcessor&&(i=t.processor.postProcessor(i,n,t.isFragment,r)),i},e._ProcessIncludes=function(t,r,i){for(var n=this,s=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g,o=s.exec(t),a=new String(t),h=!1;null!=o;){var c=o[1];if(-1!==c.indexOf("__decl__")&&(c=c.replace(/__decl__/,""),r.supportsUniformBuffers&&(c=(c=c.replace(/Vertex/,"Ubo")).replace(/Fragment/,"Ubo")),c+="Declaration"),!r.includesShadersStore[c]){var l=r.shadersRepository+"ShadersInclude/"+c+".fx";return void e._FileToolsLoadFile(l,(function(e){r.includesShadersStore[c]=e,n._ProcessIncludes(a,r,i)}))}var u=r.includesShadersStore[c];if(o[2])for(var d=o[3].split(","),f=0;f<d.length;f+=2){var p=new RegExp(d[f],"g"),g=d[f+1];u=u.replace(p,g)}if(o[4]){var m=o[5];if(-1!==m.indexOf("..")){var _=m.split(".."),v=parseInt(_[0]),y=parseInt(_[1]),b=u.slice(0);u="",isNaN(y)&&(y=r.indexParameters[_[1]]);for(var w=v;w<y;w++)r.supportsUniformBuffers||(b=b.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))),u+=b.replace(/\{X\}/g,w.toString())+"\n"}else r.supportsUniformBuffers||(u=u.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))),u=u.replace(/\{X\}/g,m)}a=a.replace(o[0],u),h=h||u.indexOf("#include<")>=0,o=s.exec(t)}h?this._ProcessIncludes(a.toString(),r,i):i(a)},e._FileToolsLoadFile=function(e,t,r,i,n,s){throw xr.WarnImport("FileTools")},e}(),Vr=function(){function e(t,r,i,n,s,o,a,h,c,l){var u,d=this;void 0===n&&(n=null),void 0===o&&(o=null),void 0===a&&(a=null),void 0===h&&(h=null),void 0===c&&(c=null),this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new wr,this.onErrorObservable=new wr,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._bonesComputationForcedToCPU=!1,this._multiTarget=!1,this._uniformBuffersNames={},this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._pipelineContext=null,this._valueCache={},this.name=t;var f,p,g=null;if(r.attributes){var m=r;if(this._engine=i,this._attributesNames=m.attributes,this._uniformsNames=m.uniformsNames.concat(m.samplers),this._samplerList=m.samplers.slice(),this.defines=m.defines,this.onError=m.onError,this.onCompiled=m.onCompiled,this._fallbacks=m.fallbacks,this._indexParameters=m.indexParameters,this._transformFeedbackVaryings=m.transformFeedbackVaryings||null,this._multiTarget=!!m.multiTarget,m.uniformBuffersNames){this._uniformBuffersNamesList=m.uniformBuffersNames.slice();for(var _=0;_<m.uniformBuffersNames.length;_++)this._uniformBuffersNames[m.uniformBuffersNames[_]]=_}g=null!==(u=m.processFinalCode)&&void 0!==u?u:null}else this._engine=s,this.defines=null==o?"":o,this._uniformsNames=i.concat(n),this._samplerList=n?n.slice():[],this._attributesNames=r,this._uniformBuffersNamesList=[],this.onError=c,this.onCompiled=h,this._indexParameters=l,this._fallbacks=a;this._attributeLocationByName={},this.uniqueId=e._uniqueIdSeed++;var v=Sr.IsWindowObjectExist()?this._engine.getHostDocument():null;t.vertexSource?f="source:"+t.vertexSource:t.vertexElement?(f=v?v.getElementById(t.vertexElement):null)||(f=t.vertexElement):f=t.vertex||t,t.fragmentSource?p="source:"+t.fragmentSource:t.fragmentElement?(p=v?v.getElementById(t.fragmentElement):null)||(p=t.fragmentElement):p=t.fragment||t;var y={defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._shaderProcessor,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:e.ShadersRepository,includesShadersStore:e.IncludesShadersStore,version:(100*this._engine.webGLVersion).toString(),platformName:this._engine.webGLVersion>=2?"WEBGL2":"WEBGL1"};this._loadShader(f,"Vertex","",(function(e){d._rawVertexSourceCode=e,d._loadShader(p,"Fragment","Pixel",(function(r){d._rawFragmentSourceCode=r,Ur.Process(e,y,(function(e){g&&(e=g("vertex",e)),y.isFragment=!0,Ur.Process(r,y,(function(r){g&&(r=g("fragment",r)),d._useFinalCode(e,r,t)}),d._engine)}),d._engine)}))}))}return Object.defineProperty(e.prototype,"onBindObservable",{get:function(){return this._onBindObservable||(this._onBindObservable=new wr),this._onBindObservable},enumerable:!1,configurable:!0}),e.prototype._useFinalCode=function(e,t,r){if(r){var i=r.vertexElement||r.vertex||r.spectorName||r,n=r.fragmentElement||r.fragment||r.spectorName||r;this._vertexSourceCode="#define SHADER_NAME vertex:"+i+"\n"+e,this._fragmentSourceCode="#define SHADER_NAME fragment:"+n+"\n"+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()},Object.defineProperty(e.prototype,"key",{get:function(){return this._key},enumerable:!1,configurable:!0}),e.prototype.isReady=function(){try{return this._isReadyInternal()}catch(e){return!1}},e.prototype._isReadyInternal=function(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady},e.prototype.getEngine=function(){return this._engine},e.prototype.getPipelineContext=function(){return this._pipelineContext},e.prototype.getAttributesNames=function(){return this._attributesNames},e.prototype.getAttributeLocation=function(e){return this._attributes[e]},e.prototype.getAttributeLocationByName=function(e){return this._attributeLocationByName[e]},e.prototype.getAttributesCount=function(){return this._attributes.length},e.prototype.getUniformIndex=function(e){return this._uniformsNames.indexOf(e)},e.prototype.getUniform=function(e){return this._uniforms[e]},e.prototype.getSamplers=function(){return this._samplerList},e.prototype.getUniformNames=function(){return this._uniformsNames},e.prototype.getUniformBuffersNames=function(){return this._uniformBuffersNamesList},e.prototype.getIndexParameters=function(){return this._indexParameters},e.prototype.getCompilationError=function(){return this._compilationError},e.prototype.allFallbacksProcessed=function(){return this._allFallbacksProcessed},e.prototype.executeWhenCompiled=function(e){var t=this;this.isReady()?e(this):(this.onCompileObservable.add((function(t){e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||setTimeout((function(){t._checkIsReady(null)}),16))},e.prototype._checkIsReady=function(e){var t=this;try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}setTimeout((function(){t._checkIsReady(e)}),16)},e.prototype._loadShader=function(t,r,i,n){var s;if("undefined"!=typeof HTMLElement&&t instanceof HTMLElement)return void n(Sr.GetDOMTextContent(t));"source:"!==t.substr(0,7)?"base64:"!==t.substr(0,7)?e.ShadersStore[t+r+"Shader"]?n(e.ShadersStore[t+r+"Shader"]):i&&e.ShadersStore[t+i+"Shader"]?n(e.ShadersStore[t+i+"Shader"]):(s="."===t[0]||"/"===t[0]||t.indexOf("http")>-1?t:e.ShadersRepository+t,this._engine._loadFile(s+"."+r.toLowerCase()+".fx",n)):n(window.atob(t.substr(7))):n(t.substr(7))},Object.defineProperty(e.prototype,"vertexSourceCode",{get:function(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._vertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fragmentSourceCode",{get:function(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._fragmentSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rawVertexSourceCode",{get:function(){return this._rawVertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rawFragmentSourceCode",{get:function(){return this._rawFragmentSourceCode},enumerable:!1,configurable:!0}),e.prototype._rebuildProgram=function(e,t,r,i){var n=this;this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=function(e,t){i&&i(t)},this.onCompiled=function(){var e=n.getEngine().scenes;if(e)for(var t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(63);n._pipelineContext._handlesSpectorRebuildCallback(r)},this._fallbacks=null,this._prepareEffect()},e.prototype._prepareEffect=function(){var e=this,t=this._attributesNames,r=this.defines;this._valueCache={};var i=this._pipelineContext;try{var n=this._engine;this._pipelineContext=n.createPipelineContext();var s=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?n._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,s,null,this._transformFeedbackVaryings):n._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,s,r,this._transformFeedbackVaryings),n._executeWhenRenderingStateIsCompiled(this._pipelineContext,(function(){if(n.supportsUniformBuffers)for(var r in e._uniformBuffersNames)e.bindUniformBlock(r,e._uniformBuffersNames[r]);var s;if(n.getUniforms(e._pipelineContext,e._uniformsNames).forEach((function(t,r){e._uniforms[e._uniformsNames[r]]=t})),e._attributes=n.getAttributes(e._pipelineContext,t),t)for(var o=0;o<t.length;o++){var a=t[o];e._attributeLocationByName[a]=e._attributes[o]}for(s=0;s<e._samplerList.length;s++){null==e.getUniform(e._samplerList[s])&&(e._samplerList.splice(s,1),s--)}e._samplerList.forEach((function(t,r){e._samplers[t]=r})),n.bindSamplers(e),e._compilationError="",e._isReady=!0,e.onCompiled&&e.onCompiled(e),e.onCompileObservable.notifyObservers(e),e.onCompileObservable.clear(),e._fallbacks&&e._fallbacks.unBindMesh(),i&&e.getEngine()._deletePipelineContext(i)})),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(e){this._processCompilationErrors(e,i)}},e.prototype._getShaderCodeAndErrorLine=function(e,t,r){var i=r?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,n=null;if(t&&e){var s=t.match(i);if(s&&2===s.length){var o=parseInt(s[1]),a=e.split("\n",-1);a.length>=o&&(n="Offending line ["+o+"] in "+(r?"fragment":"vertex")+" code: "+a[o-1])}}return[e,n]},e.prototype._processCompilationErrors=function(t,r){var i,n,s,o,a;void 0===r&&(r=null),this._compilationError=t.message;var h=this._attributesNames,c=this._fallbacks;if(Cr.Error("Unable to compile effect:"),Cr.Error("Uniforms: "+this._uniformsNames.map((function(e){return" "+e}))),Cr.Error("Attributes: "+h.map((function(e){return" "+e}))),Cr.Error("Defines:\r\n"+this.defines),e.LogShaderCodeOnCompilationError){var l=null,u=null,d=null;(null===(s=this._pipelineContext)||void 0===s?void 0:s._getVertexShaderCode())&&(d=(i=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1))[0],l=i[1],d&&(Cr.Error("Vertex code:"),Cr.Error(d))),(null===(o=this._pipelineContext)||void 0===o?void 0:o._getFragmentShaderCode())&&(d=(n=this._getShaderCodeAndErrorLine(null===(a=this._pipelineContext)||void 0===a?void 0:a._getFragmentShaderCode(),this._compilationError,!0))[0],u=n[1],d&&(Cr.Error("Fragment code:"),Cr.Error(d))),l&&Cr.Error(l),u&&Cr.Error(u)}Cr.Error("Error: "+this._compilationError),r&&(this._pipelineContext=r,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)),c?(this._pipelineContext=null,c.hasMoreFallbacks?(this._allFallbacksProcessed=!1,Cr.Error("Trying next fallback."),this.defines=c.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):this._allFallbacksProcessed=!0},Object.defineProperty(e.prototype,"isSupported",{get:function(){return""===this._compilationError},enumerable:!1,configurable:!0}),e.prototype._bindTexture=function(e,t){this._engine._bindTexture(this._samplers[e],t)},e.prototype.setTexture=function(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t)},e.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t)},e.prototype.setTextureArray=function(e,t){var r=e+"Ex";if(-1===this._samplerList.indexOf(r+"0")){for(var i=this._samplerList.indexOf(e),n=1;n<t.length;n++){var s=r+(n-1).toString();this._samplerList.splice(i+n,0,s)}for(var o=0,a=0,h=this._samplerList;a<h.length;a++){var c=h[a];this._samplers[c]=o,o+=1}}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t)},e.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t)},e.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t)},e.prototype._cacheMatrix=function(e,t){var r=this._valueCache[e],i=t.updateFlag;return(void 0===r||r!==i)&&(this._valueCache[e]=i,!0)},e.prototype._cacheFloat2=function(e,t,r){var i=this._valueCache[e];if(!i||2!==i.length)return i=[t,r],this._valueCache[e]=i,!0;var n=!1;return i[0]!==t&&(i[0]=t,n=!0),i[1]!==r&&(i[1]=r,n=!0),n},e.prototype._cacheFloat3=function(e,t,r,i){var n=this._valueCache[e];if(!n||3!==n.length)return n=[t,r,i],this._valueCache[e]=n,!0;var s=!1;return n[0]!==t&&(n[0]=t,s=!0),n[1]!==r&&(n[1]=r,s=!0),n[2]!==i&&(n[2]=i,s=!0),s},e.prototype._cacheFloat4=function(e,t,r,i,n){var s=this._valueCache[e];if(!s||4!==s.length)return s=[t,r,i,n],this._valueCache[e]=s,!0;var o=!1;return s[0]!==t&&(s[0]=t,o=!0),s[1]!==r&&(s[1]=r,o=!0),s[2]!==i&&(s[2]=i,o=!0),s[3]!==n&&(s[3]=n,o=!0),o},e.prototype.bindUniformBuffer=function(t,r){var i=this._uniformBuffersNames[r];void 0!==i&&e._baseCache[i]!==t&&(e._baseCache[i]=t,this._engine.bindUniformBufferBase(t,i))},e.prototype.bindUniformBlock=function(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)},e.prototype.setInt=function(e,t){var r=this._valueCache[e];return void 0!==r&&r===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t),this},e.prototype.setIntArray=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t),this},e.prototype.setIntArray2=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t),this},e.prototype.setIntArray3=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t),this},e.prototype.setIntArray4=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t),this},e.prototype.setFloatArray=function(e,t){return this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t),this},e.prototype.setFloatArray2=function(e,t){return this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t),this},e.prototype.setFloatArray3=function(e,t){return this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t),this},e.prototype.setFloatArray4=function(e,t){return this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t),this},e.prototype.setArray=function(e,t){return this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t),this},e.prototype.setArray2=function(e,t){return this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t),this},e.prototype.setArray3=function(e,t){return this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t),this},e.prototype.setArray4=function(e,t){return this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t),this},e.prototype.setMatrices=function(e,t){return t?(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t),this):this},e.prototype.setMatrix=function(e,t){return this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null)),this},e.prototype.setMatrix3x3=function(e,t){return this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t),this},e.prototype.setMatrix2x2=function(e,t){return this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t),this},e.prototype.setFloat=function(e,t){var r=this._valueCache[e];return void 0!==r&&r===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t),this},e.prototype.setBool=function(e,t){var r=this._valueCache[e];return void 0!==r&&r===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t),this},e.prototype.setVector2=function(e,t){return this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null)),this},e.prototype.setFloat2=function(e,t,r){return this._cacheFloat2(e,t,r)&&(this._engine.setFloat2(this._uniforms[e],t,r)||(this._valueCache[e]=null)),this},e.prototype.setVector3=function(e,t){return this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null)),this},e.prototype.setFloat3=function(e,t,r,i){return this._cacheFloat3(e,t,r,i)&&(this._engine.setFloat3(this._uniforms[e],t,r,i)||(this._valueCache[e]=null)),this},e.prototype.setVector4=function(e,t){return this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null)),this},e.prototype.setFloat4=function(e,t,r,i,n){return this._cacheFloat4(e,t,r,i,n)&&(this._engine.setFloat4(this._uniforms[e],t,r,i,n)||(this._valueCache[e]=null)),this},e.prototype.setColor3=function(e,t){return this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null)),this},e.prototype.setColor4=function(e,t,r){return this._cacheFloat4(e,t.r,t.g,t.b,r)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,r)||(this._valueCache[e]=null)),this},e.prototype.setDirectColor4=function(e,t){return this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null)),this},e.prototype.dispose=function(){this._engine._releaseEffect(this)},e.RegisterShader=function(t,r,i){r&&(e.ShadersStore[t+"PixelShader"]=r),i&&(e.ShadersStore[t+"VertexShader"]=i)},e.ResetCache=function(){e._baseCache={}},e.ShadersRepository="src/Shaders/",e.LogShaderCodeOnCompilationError=!0,e._uniqueIdSeed=0,e._baseCache={},e.ShadersStore={},e.IncludesShadersStore={},e}(),zr=function(){function e(){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zOffset",{get:function(){return this._zOffset},set:function(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cullFace",{get:function(){return this._cullFace},set:function(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cull",{get:function(){return this._cull},set:function(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthMask",{get:function(){return this._depthMask},set:function(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frontFace",{get:function(){return this._frontFace},set:function(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1},e.prototype.apply=function(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,0)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))},e}(),Wr=function(){function e(){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilFunc",{get:function(){return this._stencilFunc},set:function(e){this._stencilFunc!==e&&(this._stencilFunc=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilFuncRef",{get:function(){return this._stencilFuncRef},set:function(e){this._stencilFuncRef!==e&&(this._stencilFuncRef=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilFuncMask",{get:function(){return this._stencilFuncMask},set:function(e){this._stencilFuncMask!==e&&(this._stencilFuncMask=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpStencilFail",{get:function(){return this._stencilOpStencilFail},set:function(e){this._stencilOpStencilFail!==e&&(this._stencilOpStencilFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpDepthFail",{get:function(){return this._stencilOpDepthFail},set:function(e){this._stencilOpDepthFail!==e&&(this._stencilOpDepthFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpStencilDepthPass",{get:function(){return this._stencilOpStencilDepthPass},set:function(e){this._stencilOpStencilDepthPass!==e&&(this._stencilOpStencilDepthPass=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilMask",{get:function(){return this._stencilMask},set:function(e){this._stencilMask!==e&&(this._stencilMask=e,this._isStencilMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilTest",{get:function(){return this._stencilTest},set:function(e){this._stencilTest!==e&&(this._stencilTest=e,this._isStencilTestDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=e.ALWAYS,this._stencilFuncRef=1,this._stencilFuncMask=255,this._stencilOpStencilFail=e.KEEP,this._stencilOpDepthFail=e.KEEP,this._stencilOpStencilDepthPass=e.REPLACE,this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0},e.prototype.apply=function(e){this.isDirty&&(this._isStencilTestDirty&&(this.stencilTest?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.stencilMask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.stencilFunc,this.stencilFuncRef,this.stencilFuncMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.stencilOpStencilFail,this.stencilOpDepthFail,this.stencilOpStencilDepthPass),this._isStencilOpDirty=!1))},e.ALWAYS=519,e.KEEP=7680,e.REPLACE=7681,e}(),Hr=function(){function e(){this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.setAlphaBlendConstants=function(e,t,r,i){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===r&&this._blendConstants[3]===i||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=r,this._blendConstants[3]=i,this._isBlendConstantsDirty=!0)},e.prototype.setAlphaBlendFunctionParameters=function(e,t,r,i){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===r&&this._blendFunctionParameters[3]===i||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=r,this._blendFunctionParameters[3]=i,this._isBlendFunctionParametersDirty=!0)},e.prototype.setAlphaEquationParameters=function(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)},e.prototype.reset=function(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1},e.prototype.apply=function(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))},e}(),jr=function(){function e(){}return e.prototype.postProcessor=function(e,t,r,i){if(!i.getCaps().drawBuffersExtension){e=e.replace(/#extension.+GL_EXT_draw_buffers.+(enable|require)/g,"")}return e},e}(),qr=function(){function e(){}return e.prototype.attributeProcessor=function(e){return e.replace("attribute","in")},e.prototype.varyingProcessor=function(e,t){return e.replace("varying",t?"in":"out")},e.prototype.postProcessor=function(e,t,r){var i=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),r)e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(i?"":"out vec4 glFragColor;\n")+"void main(");else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e},e}(),Xr=function(e){function t(t){var r=e.call(this)||this;return r._buffer=t,r}return _(t,e),Object.defineProperty(t.prototype,"underlyingResource",{get:function(){return this._buffer},enumerable:!1,configurable:!0}),t}(function(){function e(){this.references=0,this.capacity=0,this.is32Bits=!1}return Object.defineProperty(e.prototype,"underlyingResource",{get:function(){return null},enumerable:!1,configurable:!0}),e}()),Kr=function(){function e(){this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}return Object.defineProperty(e.prototype,"isAsync",{get:function(){return this.isParallelCompiled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isReady",{get:function(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))},enumerable:!1,configurable:!0}),e.prototype._handlesSpectorRebuildCallback=function(e){e&&this.program&&e(this.program)},e.prototype._getVertexShaderCode=function(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null},e.prototype._getFragmentShaderCode=function(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null},e}(),Yr=function(){function e(){}return e.CreateCanvas=function(e,t){if("undefined"==typeof document)return new OffscreenCanvas(e,t);var r=document.createElement("canvas");return r.width=e,r.height=t,r},e}(),Qr=function(){function e(){}return e.SetMatrixPrecision=function(t){if(e.MatrixTrackPrecisionChange=!1,t&&!e.MatrixUse64Bits&&e.MatrixTrackedMatrices)for(var r=0;r<e.MatrixTrackedMatrices.length;++r){var i=e.MatrixTrackedMatrices[r],n=i._m;i._m=new Array(16);for(var s=0;s<16;++s)i._m[s]=n[s]}e.MatrixUse64Bits=t,e.MatrixCurrentType=e.MatrixUse64Bits?Array:Float32Array,e.MatrixTrackedMatrices=null},e.MatrixUse64Bits=!1,e.MatrixTrackPrecisionChange=!0,e.MatrixCurrentType=Float32Array,e.MatrixTrackedMatrices=[],e}(),Zr=function(){},Jr=function(){function e(t,r,i,n){var s=this;void 0===n&&(n=!1),this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=!0,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this.useReverseDepthBuffer=!1,this.disableUniformBuffers=!1,this._uniformBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new wr,this.onContextRestoredObservable=new wr,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new zr,this._stencilState=new Wr,this._alphaState=new Hr,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._activeRequests=new Array,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new wr,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._getDepthStencilBuffer=function(e,t,r,i,n,o){var a=s._gl,h=a.createRenderbuffer();return a.bindRenderbuffer(a.RENDERBUFFER,h),r>1&&a.renderbufferStorageMultisample?a.renderbufferStorageMultisample(a.RENDERBUFFER,r,n,e,t):a.renderbufferStorage(a.RENDERBUFFER,i,e,t),a.framebufferRenderbuffer(a.FRAMEBUFFER,o,a.RENDERBUFFER,h),a.bindRenderbuffer(a.RENDERBUFFER,null),h},this._boundUniforms={};var o=null;if(t){if(i=i||{},Qr.SetMatrixPrecision(!!i.useHighPrecisionMatrix),t.getContext){if(o=t,this._renderingCanvas=o,null!=r&&(i.antialias=r),void 0===i.deterministicLockstep&&(i.deterministicLockstep=!1),void 0===i.lockstepMaxSteps&&(i.lockstepMaxSteps=4),void 0===i.timeStep&&(i.timeStep=1/60),void 0===i.preserveDrawingBuffer&&(i.preserveDrawingBuffer=!1),void 0===i.audioEngine&&(i.audioEngine=!0),void 0===i.stencil&&(i.stencil=!0),!1===i.premultipliedAlpha&&(this.premultipliedAlpha=!1),void 0===i.xrCompatible&&(i.xrCompatible=!0),this._doNotHandleContextLost=!!i.doNotHandleContextLost,navigator&&navigator.userAgent){var a=navigator.userAgent;this.hostInformation.isMobile=-1!==a.indexOf("Mobile");for(var h=0,c=e.ExceptionList;h<c.length;h++){var l=c[h],u=l.key,d=l.targets;if(new RegExp(u).test(a)){if(l.capture&&l.captureConstraint){var f=l.capture,p=l.captureConstraint,g=new RegExp(f).exec(a);if(g&&g.length>0)if(parseInt(g[g.length-1])>=p)continue}for(var m=0,_=d;m<_.length;m++){switch(_[m]){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0}}}}}if(this._doNotHandleContextLost||(this._onContextLost=function(e){e.preventDefault(),s._contextWasLost=!0,Cr.Warn("WebGL context lost."),s.onContextLostObservable.notifyObservers(s)},this._onContextRestored=function(){setTimeout((function(){s._initGLContext(),s._rebuildEffects(),s._rebuildInternalTextures(),s._rebuildBuffers(),s.wipeCaches(!0),Cr.Warn("WebGL context successfully restored."),s.onContextRestoredObservable.notifyObservers(s),s._contextWasLost=!1}),0)},o.addEventListener("webglcontextlost",this._onContextLost,!1),o.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference="high-performance"),!i.disableWebGL2Support)try{this._gl=o.getContext("webgl2",i)||o.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._gl.deleteQuery||(this._webGLVersion=1))}catch(e){}if(!this._gl){if(!o)throw new Error("The provided canvas is null or undefined.");try{this._gl=o.getContext("webgl",i)||o.getContext("experimental-webgl",i)}catch(e){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=t,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample&&(this._webGLVersion=2);var v=this._gl.getContextAttributes();v&&(i.stencil=v.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==i.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats);var y=Sr.IsWindowObjectExist()&&window.devicePixelRatio||1,b=i.limitDeviceRatio||y;this._hardwareScalingLevel=n?1/Math.min(b,y):1,this.resize(),this._isStencilEnable=!!i.stencil,this._initGLContext();for(var w=0;w<this._caps.maxVertexAttribs;w++)this._currentBufferPointers[w]=new Zr;this.webGLVersion>1?this._shaderProcessor=new qr:this._shaderProcessor=new jr,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._creationOptions=i,console.log("Babylon.js v"+e.Version+" - "+this.description)}}return Object.defineProperty(e,"NpmPackage",{get:function(){return"babylonjs@4.2.0"},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Version",{get:function(){return"4.2.0"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){var e="WebGL"+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ShadersRepository",{get:function(){return Vr.ShadersRepository},set:function(e){Vr.ShadersRepository=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportsUniformBuffers",{get:function(){return this.webGLVersion>1&&!this.disableUniformBuffers},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_shouldUseHighPrecisionShader",{get:function(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"needPOTTextures",{get:function(){return this._webGLVersion<2||this.forcePOTTextures},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"doNotHandleContextLost",{get:function(){return this._doNotHandleContextLost},set:function(e){this._doNotHandleContextLost=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"framebufferDimensionsObject",{set:function(e){this._framebufferDimensionsObject=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentViewport",{get:function(){return this._cachedViewport},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture",{get:function(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture3D",{get:function(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture2DArray",{get:function(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyCubeTexture",{get:function(){if(!this._emptyCubeTexture){var e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture},enumerable:!1,configurable:!0}),e.prototype._rebuildInternalTextures=function(){for(var e=0,t=this._internalTexturesCache.slice();e<t.length;e++){t[e]._rebuild()}},e.prototype._rebuildEffects=function(){for(var e in this._compiledEffects){this._compiledEffects[e]._prepareEffect()}Vr.ResetCache()},e.prototype.areAllEffectsReady=function(){for(var e in this._compiledEffects){if(!this._compiledEffects[e].isReady())return!1}return!0},e.prototype._rebuildBuffers=function(){for(var e=0,t=this._uniformBuffers;e<t.length;e++){t[e]._rebuild()}},e.prototype._initGLContext=function(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile"),standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float"),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1},this._glVersion=this._gl.getParameter(this._gl.VERSION);var e=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=e&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor="Unknown vendor"),this._glRenderer||(this._glRenderer="Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._gl.getParameter(this._gl.MAX_SAMPLES);else{var t=this._gl.getExtension("WEBGL_draw_buffers");if(null!==t){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=t["COLOR_ATTACHMENT"+r+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{var i=this._gl.getExtension("WEBGL_depth_texture");null!=i&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{var n=this._gl.getExtension("OES_vertex_array_object");null!=n&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=n.createVertexArrayOES.bind(n),this._gl.bindVertexArray=n.bindVertexArrayOES.bind(n),this._gl.deleteVertexArray=n.deleteVertexArrayOES.bind(n))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{var s=this._gl.getExtension("ANGLE_instanced_arrays");null!=s?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),this._gl.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),this._gl.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){var o=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),a=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);o&&a&&(this._caps.highPrecisionShaderSupported=0!==o.precision&&0!==a.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{var h=this._gl.getExtension("EXT_blend_minmax");null!=h&&(this._caps.blendMinMax=!0,this._gl.MAX=h.MAX_EXT,this._gl.MIN=h.MIN_EXT)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var c=0;c<this._maxSimultaneousTextures;c++)this._nextFreeTextureSlots.push(c)},Object.defineProperty(e.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"ThinEngine"},Object.defineProperty(e.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:!1,configurable:!0}),e.prototype._prepareWorkingCanvas=function(){if(!this._workingCanvas){this._workingCanvas=Yr.CreateCanvas(1,1);var e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}},e.prototype.resetTextureCache=function(){for(var e in this._boundTexturesCache)this._boundTexturesCache.hasOwnProperty(e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1},e.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},e.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e,this.resize()},e.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},e.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache},e.prototype.getCaps=function(){return this._caps},e.prototype.stopRenderLoop=function(e){if(e){var t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)}else this._activeRenderLoops=[]},e.prototype._renderLoop=function(){if(!this._contextWasLost){var e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(var t=0;t<this._activeRenderLoops.length;t++){(0,this._activeRenderLoops[t])()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},e.prototype.getRenderingCanvas=function(){return this._renderingCanvas},e.prototype.getHostWindow=function(){return Sr.IsWindowObjectExist()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null},e.prototype.getRenderWidth=function(e){return void 0===e&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth},e.prototype.getRenderHeight=function(e){return void 0===e&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight},e.prototype._queueNewFrame=function(t,r){return e.QueueNewFrame(t,r)},e.prototype.runRenderLoop=function(e){-1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))},e.prototype.clear=function(e,t,r,i){void 0===i&&(i=!1),this.applyStates();var n=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),n|=this._gl.COLOR_BUFFER_BIT),r&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GREATER,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),i&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)},e.prototype._viewport=function(e,t,r,i){e===this._viewportCached.x&&t===this._viewportCached.y&&r===this._viewportCached.z&&i===this._viewportCached.w||(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=r,this._viewportCached.w=i,this._gl.viewport(e,t,r,i))},e.prototype.setViewport=function(e,t,r){var i=t||this.getRenderWidth(),n=r||this.getRenderHeight(),s=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(s*i,o*n,i*e.width,n*e.height)},e.prototype.beginFrame=function(){},e.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer()},e.prototype.resize=function(){var e,t;Sr.IsWindowObjectExist()?(e=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,t=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(e=this._renderingCanvas?this._renderingCanvas.width:100,t=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(e/this._hardwareScalingLevel,t/this._hardwareScalingLevel)},e.prototype.setSize=function(e,t){return!!this._renderingCanvas&&(e|=0,t|=0,(this._renderingCanvas.width!==e||this._renderingCanvas.height!==t)&&(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0))},e.prototype.bindFramebuffer=function(e,t,r,i,n,s,o){void 0===t&&(t=0),void 0===s&&(s=0),void 0===o&&(o=0),this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(e._MSAAFramebuffer?e._MSAAFramebuffer:e._framebuffer);var a=this._gl;e.is2DArray?a.framebufferTextureLayer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,e._webGLTexture,s,o):e.isCube&&a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+t,e._webGLTexture,s);var h=e._depthStencilTexture;if(h){var c=h._generateStencilBuffer?a.DEPTH_STENCIL_ATTACHMENT:a.DEPTH_ATTACHMENT;e.is2DArray?a.framebufferTextureLayer(a.FRAMEBUFFER,c,h._webGLTexture,s,o):e.isCube?a.framebufferTexture2D(a.FRAMEBUFFER,c,a.TEXTURE_CUBE_MAP_POSITIVE_X+t,h._webGLTexture,s):a.framebufferTexture2D(a.FRAMEBUFFER,c,a.TEXTURE_2D,h._webGLTexture,s)}this._cachedViewport&&!n?this.setViewport(this._cachedViewport,r,i):(r||(r=e.width,s&&(r/=Math.pow(2,s))),i||(i=e.height,s&&(i/=Math.pow(2,s))),this._viewport(0,0,r,i)),this.wipeCaches()},e.prototype._bindUnboundFramebuffer=function(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)},e.prototype.unBindFramebuffer=function(e,t,r){void 0===t&&(t=!1),this._currentRenderTarget=null;var i=this._gl;if(e._MSAAFramebuffer){if(e._textureArray)return void this.unBindMultiColorAttachmentFramebuffer(e._textureArray,t,r);i.bindFramebuffer(i.READ_FRAMEBUFFER,e._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,e._framebuffer),i.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,i.COLOR_BUFFER_BIT,i.NEAREST)}!e.generateMipMaps||t||e.isCube||(this._bindTextureDirectly(i.TEXTURE_2D,e,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null)),r&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),r()),this._bindUnboundFramebuffer(null)},e.prototype.flushFramebuffer=function(){this._gl.flush()},e.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},e.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null},e.prototype.createVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)},e.prototype._createVertexBuffer=function(e,t){var r=this._gl.createBuffer();if(!r)throw new Error("Unable to create vertex buffer");var i=new Xr(r);return this.bindArrayBuffer(i),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.STATIC_DRAW),this._resetVertexBufferBinding(),i.references=1,i},e.prototype.createDynamicVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)},e.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null},e.prototype.createIndexBuffer=function(e,t){var r=this._gl.createBuffer(),i=new Xr(r);if(!r)throw new Error("Unable to create index buffer");this.bindIndexBuffer(i);var n=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),i.references=1,i.is32Bits=4===n.BYTES_PER_ELEMENT,i},e.prototype._normalizeIndexData=function(e){if(e instanceof Uint16Array)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(var t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)},e.prototype.bindArrayBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.bindBuffer(e,this._gl.ARRAY_BUFFER)},e.prototype.bindUniformBlock=function(e,t,r){var i=e.program,n=this._gl.getUniformBlockIndex(i,t);this._gl.uniformBlockBinding(i,n,r)},e.prototype.bindIndexBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)},e.prototype.bindBuffer=function(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)},e.prototype.updateArrayBuffer=function(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)},e.prototype._vertexAttribPointer=function(e,t,r,i,n,s,o){var a=this._currentBufferPointers[t];if(a){var h=!1;a.active?(a.buffer!==e&&(a.buffer=e,h=!0),a.size!==r&&(a.size=r,h=!0),a.type!==i&&(a.type=i,h=!0),a.normalized!==n&&(a.normalized=n,h=!0),a.stride!==s&&(a.stride=s,h=!0),a.offset!==o&&(a.offset=o,h=!0)):(h=!0,a.active=!0,a.index=t,a.size=r,a.type=i,a.normalized=n,a.stride=s,a.offset=o,a.buffer=e),(h||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),this._gl.vertexAttribPointer(t,r,i,n,s,o))}},e.prototype._bindIndexBufferWithCache=function(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)},e.prototype._bindVertexBuffersAttributes=function(e,t){var r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var i=0;i<r.length;i++){var n=t.getAttributeLocation(i);if(n>=0){var s=e[r[i]];if(!s)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);var o=s.getBuffer();o&&(this._vertexAttribPointer(o,n,s.getSize(),s.type,s.normalized,s.byteStride,s.byteOffset),s.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,s.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(o))))}}},e.prototype.recordVertexArrayObject=function(e,t,r){var i=this._gl.createVertexArray();return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(i),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),i},e.prototype.bindVertexArrayObject=function(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=!0)},e.prototype.bindBuffersDirectly=function(e,t,r,i,n){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=n;var s=n.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var o=0,a=0;a<s;a++)if(a<r.length){var h=n.getAttributeLocation(a);h>=0&&(this._gl.enableVertexAttribArray(h),this._vertexAttribArraysEnabled[h]=!0,this._vertexAttribPointer(e,h,r[a],this._gl.FLOAT,!1,i,o)),o+=4*r[a]}}this._bindIndexBufferWithCache(t)},e.prototype._unbindVertexArrayObject=function(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))},e.prototype.bindBuffers=function(e,t,r){this._cachedVertexBuffers===e&&this._cachedEffectForVertexBuffers===r||(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r,this._bindVertexBuffersAttributes(e,r)),this._bindIndexBufferWithCache(t)},e.prototype.unbindInstanceAttributes=function(){for(var e,t=0,r=this._currentInstanceLocations.length;t<r;t++){var i=this._currentInstanceBuffers[t];e!=i&&i.references&&(e=i,this.bindArrayBuffer(i));var n=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(n,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0},e.prototype.releaseVertexArrayObject=function(e){this._gl.deleteVertexArray(e)},e.prototype._releaseBuffer=function(e){return e.references--,0===e.references&&(this._deleteBuffer(e),!0)},e.prototype._deleteBuffer=function(e){this._gl.deleteBuffer(e.underlyingResource)},e.prototype.updateAndBindInstancesBuffer=function(e,t,r){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==r[0].index)this.bindInstancesBuffer(e,r,!0);else for(var i=0;i<4;i++){var n=r[i];this._vertexAttribArraysEnabled[n]||(this._gl.enableVertexAttribArray(n),this._vertexAttribArraysEnabled[n]=!0),this._vertexAttribPointer(e,n,4,this._gl.FLOAT,!1,64,16*i),this._gl.vertexAttribDivisor(n,1),this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(e)}},e.prototype.bindInstancesBuffer=function(e,t,r){void 0===r&&(r=!0),this.bindArrayBuffer(e);var i=0;if(r)for(var n=0;n<t.length;n++){i+=4*(s=t[n]).attributeSize}for(n=0;n<t.length;n++){var s;void 0===(s=t[n]).index&&(s.index=this._currentEffect.getAttributeLocationByName(s.attributeName)),s.index<0||(this._vertexAttribArraysEnabled[s.index]||(this._gl.enableVertexAttribArray(s.index),this._vertexAttribArraysEnabled[s.index]=!0),this._vertexAttribPointer(e,s.index,s.attributeSize,s.attributeType||this._gl.FLOAT,s.normalized||!1,i,s.offset),this._gl.vertexAttribDivisor(s.index,void 0===s.divisor?1:s.divisor),this._currentInstanceLocations.push(s.index),this._currentInstanceBuffers.push(e))}},e.prototype.disableInstanceAttributeByName=function(e){if(this._currentEffect){var t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}},e.prototype.disableInstanceAttribute=function(e){for(var t,r=!1;-1!==(t=this._currentInstanceLocations.indexOf(e));)this._currentInstanceLocations.splice(t,1),this._currentInstanceBuffers.splice(t,1),r=!0,t=this._currentInstanceLocations.indexOf(e);r&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))},e.prototype.disableAttributeByIndex=function(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1},e.prototype.draw=function(e,t,r,i){this.drawElementsType(e?0:1,t,r,i)},e.prototype.drawPointClouds=function(e,t,r){this.drawArraysType(2,e,t,r)},e.prototype.drawUnIndexed=function(e,t,r,i){this.drawArraysType(e?0:1,t,r,i)},e.prototype.drawElementsType=function(e,t,r,i){this.applyStates(),this._reportDrawCall();var n=this._drawMode(e),s=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;i?this._gl.drawElementsInstanced(n,r,s,t*o,i):this._gl.drawElements(n,r,s,t*o)},e.prototype.drawArraysType=function(e,t,r,i){this.applyStates(),this._reportDrawCall();var n=this._drawMode(e);i?this._gl.drawArraysInstanced(n,t,r,i):this._gl.drawArrays(n,t,r)},e.prototype._drawMode=function(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}},e.prototype._reportDrawCall=function(){},e.prototype._releaseEffect=function(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))},e.prototype._deletePipelineContext=function(e){var t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))},e.prototype.createEffect=function(e,t,r,i,n,s,o,a,h){var c=(e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e)+"+"+(e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e)+"@"+(n||t.defines);if(this._compiledEffects[c]){var l=this._compiledEffects[c];return o&&l.isReady()&&o(l),l}var u=new Vr(e,t,r,i,this,n,s,o,a,h);return u._key=c,this._compiledEffects[c]=u,u},e._ConcatenateShader=function(e,t,r){return void 0===r&&(r=""),r+(t?t+"\n":"")+e},e.prototype._compileShader=function(t,r,i,n){return this._compileRawShader(e._ConcatenateShader(t,i,n),r)},e.prototype._compileRawShader=function(e,t){var r=this._gl,i=r.createShader("vertex"===t?r.VERTEX_SHADER:r.FRAGMENT_SHADER);if(!i)throw new Error("Something went wrong while compile the shader.");return r.shaderSource(i,e),r.compileShader(i),i},e.prototype._getShaderSource=function(e){return this._gl.getShaderSource(e)},e.prototype.createRawShaderProgram=function(e,t,r,i,n){void 0===n&&(n=null),i=i||this._gl;var s=this._compileRawShader(t,"vertex"),o=this._compileRawShader(r,"fragment");return this._createShaderProgram(e,s,o,i,n)},e.prototype.createShaderProgram=function(e,t,r,i,n,s){void 0===s&&(s=null),n=n||this._gl;var o=this._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"",a=this._compileShader(t,"vertex",i,o),h=this._compileShader(r,"fragment",i,o);return this._createShaderProgram(e,a,h,n,s)},e.prototype.createPipelineContext=function(){var e=new Kr;return e.engine=this,this._caps.parallelShaderCompile&&(e.isParallelCompiled=!0),e},e.prototype._createShaderProgram=function(e,t,r,i,n){void 0===n&&(n=null);var s=i.createProgram();if(e.program=s,!s)throw new Error("Unable to create program");return i.attachShader(s,t),i.attachShader(s,r),i.linkProgram(s),e.context=i,e.vertexShader=t,e.fragmentShader=r,e.isParallelCompiled||this._finalizePipelineContext(e),s},e.prototype._finalizePipelineContext=function(e){var t=e.context,r=e.vertexShader,i=e.fragmentShader,n=e.program;if(!t.getProgramParameter(n,t.LINK_STATUS)){var s,o;if(!this._gl.getShaderParameter(r,this._gl.COMPILE_STATUS))if(s=this._gl.getShaderInfoLog(r))throw e.vertexCompilationError=s,new Error("VERTEX SHADER "+s);if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS))if(s=this._gl.getShaderInfoLog(i))throw e.fragmentCompilationError=s,new Error("FRAGMENT SHADER "+s);if(o=t.getProgramInfoLog(n))throw e.programLinkError=o,new Error(o)}if(this.validateShaderPrograms&&(t.validateProgram(n),!t.getProgramParameter(n,t.VALIDATE_STATUS)&&(o=t.getProgramInfoLog(n))))throw e.programValidationError=o,new Error(o);t.deleteShader(r),t.deleteShader(i),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)},e.prototype._preparePipelineContext=function(e,t,r,i,n,s,o){var a=e;a.program=i?this.createRawShaderProgram(a,t,r,void 0,o):this.createShaderProgram(a,t,r,s,void 0,o),a.program.__SPECTOR_rebuildProgram=n},e.prototype._isRenderingStateCompiled=function(e){var t=e;return!!this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)&&(this._finalizePipelineContext(t),!0)},e.prototype._executeWhenRenderingStateIsCompiled=function(e,t){var r=e;if(r.isParallelCompiled){var i=r.onCompiled;r.onCompiled=i?function(){i(),t()}:t}else t()},e.prototype.getUniforms=function(e,t){for(var r=new Array,i=e,n=0;n<t.length;n++)r.push(this._gl.getUniformLocation(i.program,t[n]));return r},e.prototype.getAttributes=function(e,t){for(var r=[],i=e,n=0;n<t.length;n++)try{r.push(this._gl.getAttribLocation(i.program,t[n]))}catch(e){r.push(-1)}return r},e.prototype.enableEffect=function(e){e&&e!==this._currentEffect&&(this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))},e.prototype.setInt=function(e,t){return!!e&&(this._gl.uniform1i(e,t),!0)},e.prototype.setIntArray=function(e,t){return!!e&&(this._gl.uniform1iv(e,t),!0)},e.prototype.setIntArray2=function(e,t){return!(!e||t.length%2!=0)&&(this._gl.uniform2iv(e,t),!0)},e.prototype.setIntArray3=function(e,t){return!(!e||t.length%3!=0)&&(this._gl.uniform3iv(e,t),!0)},e.prototype.setIntArray4=function(e,t){return!(!e||t.length%4!=0)&&(this._gl.uniform4iv(e,t),!0)},e.prototype.setArray=function(e,t){return!!e&&(this._gl.uniform1fv(e,t),!0)},e.prototype.setArray2=function(e,t){return!(!e||t.length%2!=0)&&(this._gl.uniform2fv(e,t),!0)},e.prototype.setArray3=function(e,t){return!(!e||t.length%3!=0)&&(this._gl.uniform3fv(e,t),!0)},e.prototype.setArray4=function(e,t){return!(!e||t.length%4!=0)&&(this._gl.uniform4fv(e,t),!0)},e.prototype.setMatrices=function(e,t){return!!e&&(this._gl.uniformMatrix4fv(e,!1,t),!0)},e.prototype.setMatrix3x3=function(e,t){return!!e&&(this._gl.uniformMatrix3fv(e,!1,t),!0)},e.prototype.setMatrix2x2=function(e,t){return!!e&&(this._gl.uniformMatrix2fv(e,!1,t),!0)},e.prototype.setFloat=function(e,t){return!!e&&(this._gl.uniform1f(e,t),!0)},e.prototype.setFloat2=function(e,t,r){return!!e&&(this._gl.uniform2f(e,t,r),!0)},e.prototype.setFloat3=function(e,t,r,i){return!!e&&(this._gl.uniform3f(e,t,r,i),!0)},e.prototype.setFloat4=function(e,t,r,i,n){return!!e&&(this._gl.uniform4f(e,t,r,i,n),!0)},e.prototype.applyStates=function(){if(this._depthCullingState.apply(this._gl),this._stencilState.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;var e=this._colorWrite;this._gl.colorMask(e,e,e,e)}},e.prototype.setColorWrite=function(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)},e.prototype.getColorWrite=function(){return this._colorWrite},Object.defineProperty(e.prototype,"depthCullingState",{get:function(){return this._depthCullingState},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alphaState",{get:function(){return this._alphaState},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilState",{get:function(){return this._stencilState},enumerable:!1,configurable:!0}),e.prototype.clearInternalTexturesCache=function(){this._internalTexturesCache=[]},e.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilState.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))},e.prototype._getSamplingParameters=function(e,t){var r=this._gl,i=r.NEAREST,n=r.NEAREST;switch(e){case 11:i=r.LINEAR,n=t?r.LINEAR_MIPMAP_NEAREST:r.LINEAR;break;case 3:i=r.LINEAR,n=t?r.LINEAR_MIPMAP_LINEAR:r.LINEAR;break;case 8:i=r.NEAREST,n=t?r.NEAREST_MIPMAP_LINEAR:r.NEAREST;break;case 4:i=r.NEAREST,n=t?r.NEAREST_MIPMAP_NEAREST:r.NEAREST;break;case 5:i=r.NEAREST,n=t?r.LINEAR_MIPMAP_NEAREST:r.LINEAR;break;case 6:i=r.NEAREST,n=t?r.LINEAR_MIPMAP_LINEAR:r.LINEAR;break;case 7:i=r.NEAREST,n=r.LINEAR;break;case 1:i=r.NEAREST,n=r.NEAREST;break;case 9:i=r.LINEAR,n=t?r.NEAREST_MIPMAP_NEAREST:r.NEAREST;break;case 10:i=r.LINEAR,n=t?r.NEAREST_MIPMAP_LINEAR:r.NEAREST;break;case 2:i=r.LINEAR,n=r.LINEAR;break;case 12:i=r.LINEAR,n=r.NEAREST}return{min:n,mag:i}},e.prototype._createTexture=function(){var e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e},e.prototype.createTexture=function(t,r,i,n,s,o,a,h,c,l,u,d,f){var p=this;void 0===s&&(s=3),void 0===o&&(o=null),void 0===a&&(a=null),void 0===h&&(h=null),void 0===c&&(c=null),void 0===l&&(l=null),void 0===u&&(u=null);var g="data:"===(t=t||"").substr(0,5),m="blob:"===t.substr(0,5),_=g&&-1!==t.indexOf(";base64,"),v=c||new Pr(this,vr.Url),y=t;!this._transformTextureUrl||_||c||h||(t=this._transformTextureUrl(t)),y!==t&&(v._originalUrl=y);var b=t.lastIndexOf("."),w=u||(b>-1?t.substring(b).toLowerCase():""),T=null;w.indexOf("?")>-1&&(w=w.split("?")[0]);for(var x=0,P=e._TextureLoaders;x<P.length;x++){var C=P[x];if(C.canLoad(w,d)){T=C;break}}n&&n._addPendingData(v),v.url=t,v.generateMipMaps=!r,v.samplingMode=s,v.invertY=i,this._doNotHandleContextLost||(v._buffer=h);var E=null;o&&!c&&(E=v.onLoadedObservable.add(o)),c||this._internalTexturesCache.push(v);var S=function(e,i){n&&n._removePendingData(v),t===y?(E&&v.onLoadedObservable.remove(E),Er.UseFallbackTexture&&p.createTexture(Er.FallbackTexture,r,v.invertY,n,s,null,a,h,v),a&&a((e||"Unknown error")+(Er.UseFallbackTexture?" - Fallback texture was used":""),i)):(Cr.Warn("Failed to load "+t+", falling back to "+y),p.createTexture(y,r,v.invertY,n,s,o,a,h,v,l,u,d,f))};if(T){var R=function(e){T.loadData(e,v,(function(e,t,r,i,o,a){a?S("TextureLoader failed to load data"):p._prepareWebGLTexture(v,n,e,t,v.invertY,!r,i,(function(){return o(),!1}),s)}),f)};h?h instanceof ArrayBuffer?R(new Uint8Array(h)):ArrayBuffer.isView(h)?R(h):a&&a("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(t,(function(e){return R(new Uint8Array(e))}),void 0,n?n.offlineProvider:void 0,!0,(function(e,t){S("Unable to load "+(e&&e.responseURL,t))}))}else{var M=function(e){m&&!p._doNotHandleContextLost&&(v._buffer=e),p._prepareWebGLTexture(v,n,e.width,e.height,v.invertY,r,!1,(function(t,r,i){var s=p._gl,o=e.width===t&&e.height===r,a=l?p._getInternalFormat(l):".jpg"===w?s.RGB:s.RGBA;if(o)return s.texImage2D(s.TEXTURE_2D,0,a,a,s.UNSIGNED_BYTE,e),!1;var h=p._caps.maxTextureSize;if(e.width>h||e.height>h||!p._supportsHardwareTextureRescaling)return p._prepareWorkingCanvas(),!(!p._workingCanvas||!p._workingContext)&&(p._workingCanvas.width=t,p._workingCanvas.height=r,p._workingContext.drawImage(e,0,0,e.width,e.height,0,0,t,r),s.texImage2D(s.TEXTURE_2D,0,a,a,s.UNSIGNED_BYTE,p._workingCanvas),v.width=t,v.height=r,!1);var c=new Pr(p,vr.Temp);return p._bindTextureDirectly(s.TEXTURE_2D,c,!0),s.texImage2D(s.TEXTURE_2D,0,a,a,s.UNSIGNED_BYTE,e),p._rescaleTexture(c,v,n,a,(function(){p._releaseTexture(c),p._bindTextureDirectly(s.TEXTURE_2D,v,!0),i()})),!0}),s)};!g||_?h&&(h.decoding||h.close)?M(h):e._FileToolsLoadImage(t,M,S,n?n.offlineProvider:null,d):"string"==typeof h||h instanceof ArrayBuffer||ArrayBuffer.isView(h)||h instanceof Blob?e._FileToolsLoadImage(h,M,S,n?n.offlineProvider:null,d):h&&M(h)}return v},e._FileToolsLoadImage=function(e,t,r,i,n){throw xr.WarnImport("FileTools")},e.prototype._rescaleTexture=function(e,t,r,i,n){},e.prototype.createRawTexture=function(e,t,r,i,n,s,o,a,h){throw void 0===a&&(a=null),void 0===h&&(h=0),xr.WarnImport("Engine.RawTexture")},e.prototype.createRawCubeTexture=function(e,t,r,i,n,s,o,a){throw void 0===a&&(a=null),xr.WarnImport("Engine.RawTexture")},e.prototype.createRawTexture3D=function(e,t,r,i,n,s,o,a,h,c){throw void 0===h&&(h=null),void 0===c&&(c=0),xr.WarnImport("Engine.RawTexture")},e.prototype.createRawTexture2DArray=function(e,t,r,i,n,s,o,a,h,c){throw void 0===h&&(h=null),void 0===c&&(c=0),xr.WarnImport("Engine.RawTexture")},e.prototype._unpackFlipY=function(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))},e.prototype._getUnpackAlignement=function(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)},e.prototype._getTextureTarget=function(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D},e.prototype.updateTextureSamplingMode=function(e,t,r){void 0===r&&(r=!1);var i=this._getTextureTarget(t),n=this._getSamplingParameters(e,t.generateMipMaps||r);this._setTextureParameterInteger(i,this._gl.TEXTURE_MAG_FILTER,n.mag,t),this._setTextureParameterInteger(i,this._gl.TEXTURE_MIN_FILTER,n.min),r&&(t.generateMipMaps=!0,this._gl.generateMipmap(i)),this._bindTextureDirectly(i,null),t.samplingMode=e},e.prototype.updateTextureWrappingMode=function(e,t,r,i){void 0===r&&(r=null),void 0===i&&(i=null);var n=this._getTextureTarget(e);null!==t&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),null!==r&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(r),e),e._cachedWrapV=r),(e.is2DArray||e.is3D)&&null!==i&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(i),e),e._cachedWrapR=i),this._bindTextureDirectly(n,null)},e.prototype._setupDepthStencilTexture=function(e,t,r,i,n){var s=t.width||t,o=t.height||t,a=t.layers||0;e.baseWidth=s,e.baseHeight=o,e.width=s,e.height=o,e.is2DArray=a>0,e.depth=a,e.isReady=!0,e.samples=1,e.generateMipMaps=!1,e._generateDepthBuffer=!0,e._generateStencilBuffer=r,e.samplingMode=i?2:1,e.type=0,e._comparisonFunction=n;var h=this._gl,c=this._getTextureTarget(e),l=this._getSamplingParameters(e.samplingMode,!1);h.texParameteri(c,h.TEXTURE_MAG_FILTER,l.mag),h.texParameteri(c,h.TEXTURE_MIN_FILTER,l.min),h.texParameteri(c,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(c,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),0===n?(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,515),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.NONE)):(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,n),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.COMPARE_REF_TO_TEXTURE))},e.prototype._uploadCompressedDataToTextureDirectly=function(e,t,r,i,n,s,o){void 0===s&&(s=0),void 0===o&&(o=0);var a=this._gl,h=a.TEXTURE_2D;e.isCube&&(h=a.TEXTURE_CUBE_MAP_POSITIVE_X+s),this._gl.compressedTexImage2D(h,o,t,r,i,0,n)},e.prototype._uploadDataToTextureDirectly=function(e,t,r,i,n,s){void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=!1);var o=this._gl,a=this._getWebGLTextureType(e.type),h=this._getInternalFormat(e.format),c=void 0===n?this._getRGBABufferInternalSizedFormat(e.type,e.format):this._getInternalFormat(n);this._unpackFlipY(e.invertY);var l=o.TEXTURE_2D;e.isCube&&(l=o.TEXTURE_CUBE_MAP_POSITIVE_X+r);var u=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),f=s?e.width:Math.pow(2,Math.max(u-i,0)),p=s?e.height:Math.pow(2,Math.max(d-i,0));o.texImage2D(l,i,c,f,p,0,h,a,t)},e.prototype.updateTextureData=function(e,t,r,i,n,s,o,a){void 0===o&&(o=0),void 0===a&&(a=0);var h=this._gl,c=this._getWebGLTextureType(e.type),l=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);var u=h.TEXTURE_2D;e.isCube&&(u=h.TEXTURE_CUBE_MAP_POSITIVE_X+o),h.texSubImage2D(u,a,r,i,n,s,l,c,t)},e.prototype._uploadArrayBufferViewToTexture=function(e,t,r,i){void 0===r&&(r=0),void 0===i&&(i=0);var n=this._gl,s=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(s,e,!0),this._uploadDataToTextureDirectly(e,t,r,i),this._bindTextureDirectly(s,null,!0)},e.prototype._prepareWebGLTextureContinuation=function(e,t,r,i,n){var s=this._gl;if(s){var o=this._getSamplingParameters(n,!r);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o.mag),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o.min),r||i||s.generateMipmap(s.TEXTURE_2D),this._bindTextureDirectly(s.TEXTURE_2D,null),t&&t._removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}},e.prototype._prepareWebGLTexture=function(t,r,i,n,s,o,a,h,c){var l=this;void 0===c&&(c=3);var u=this.getCaps().maxTextureSize,d=Math.min(u,this.needPOTTextures?e.GetExponentOfTwo(i,u):i),f=Math.min(u,this.needPOTTextures?e.GetExponentOfTwo(n,u):n),p=this._gl;p&&(t._webGLTexture?(this._bindTextureDirectly(p.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===s||!!s),t.baseWidth=i,t.baseHeight=n,t.width=d,t.height=f,t.isReady=!0,h(d,f,(function(){l._prepareWebGLTextureContinuation(t,r,o,a,c)}))||this._prepareWebGLTextureContinuation(t,r,o,a,c)):r&&r._removePendingData(t))},e.prototype._setupFramebufferDepthAttachments=function(e,t,r,i,n){void 0===n&&(n=1);var s=this._gl;if(e&&t)return this._getDepthStencilBuffer(r,i,n,s.DEPTH_STENCIL,s.DEPTH24_STENCIL8,s.DEPTH_STENCIL_ATTACHMENT);if(t){var o=s.DEPTH_COMPONENT16;return this._webGLVersion>1&&(o=s.DEPTH_COMPONENT32F),this._getDepthStencilBuffer(r,i,n,o,o,s.DEPTH_ATTACHMENT)}return e?this._getDepthStencilBuffer(r,i,n,s.STENCIL_INDEX8,s.STENCIL_INDEX8,s.STENCIL_ATTACHMENT):null},e.prototype._releaseFramebufferObjects=function(e){var t=this._gl;e._framebuffer&&(t.deleteFramebuffer(e._framebuffer),e._framebuffer=null),e._depthStencilBuffer&&(t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(t.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null),e._MSAARenderBuffer&&(t.deleteRenderbuffer(e._MSAARenderBuffer),e._MSAARenderBuffer=null)},e.prototype._releaseTexture=function(e){this._releaseFramebufferObjects(e),this._deleteTexture(e._webGLTexture),this.unbindAllTextures();var t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()},e.prototype._deleteTexture=function(e){this._gl.deleteTexture(e)},e.prototype._setProgram=function(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)},e.prototype.bindSamplers=function(e){var t=e.getPipelineContext();this._setProgram(t.program);for(var r=e.getSamplers(),i=0;i<r.length;i++){var n=e.getUniform(r[i]);n&&(this._boundUniforms[i]=n)}this._currentEffect=null},e.prototype._activateCurrentTexture=function(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)},e.prototype._bindTextureDirectly=function(e,t,r,i){void 0===r&&(r=!1),void 0===i&&(i=!1);var n=!1,s=t&&t._associatedChannel>-1;return r&&s&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||i?(this._activateCurrentTexture(),t&&t.isMultiview?this._gl.bindTexture(e,t?t._colorTextureArray:null):this._gl.bindTexture(e,t?t._webGLTexture:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)):r&&(n=!0,this._activateCurrentTexture()),s&&!r&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),n},e.prototype._bindTexture=function(e,t){if(void 0!==e){t&&(t._associatedChannel=e),this._activeChannel=e;var r=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,t)}},e.prototype.unbindAllTextures=function(){for(var e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))},e.prototype.setTexture=function(e,t,r){void 0!==e&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,r))},e.prototype._bindSamplerUniformToChannel=function(e,t){var r=this._boundUniforms[e];r&&r._currentState!==t&&(this._gl.uniform1i(r,t),r._currentState=t)},e.prototype._getTextureWrapMode=function(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT},e.prototype._setTexture=function(e,t,r,i){if(void 0===r&&(r=!1),void 0===i&&(i=!1),!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;var n;n=i?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!r&&n&&(n._associatedChannel=e);var s=!0;this._boundTexturesCache[e]===n&&(r||this._bindSamplerUniformToChannel(n._associatedChannel,e),s=!1),this._activeChannel=e;var o=this._getTextureTarget(n);if(s&&this._bindTextureDirectly(o,n,r),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;var a=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=a,t.wrapV=a}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(o,n,t.anisotropicFilteringLevel)}return!0},e.prototype.setTextureArray=function(e,t,r){if(void 0!==e&&t){this._textureUnits&&this._textureUnits.length===r.length||(this._textureUnits=new Int32Array(r.length));for(var i=0;i<r.length;i++){var n=r[i].getInternalTexture();n?(this._textureUnits[i]=e+i,n._associatedChannel=e+i):this._textureUnits[i]=-1}this._gl.uniform1iv(t,this._textureUnits);for(var s=0;s<r.length;s++)this._setTexture(this._textureUnits[s],r[s],!0)}},e.prototype._setAnisotropicLevel=function(e,t,r){var i=this._caps.textureAnisotropicFilterExtension;11!==t.samplingMode&&3!==t.samplingMode&&2!==t.samplingMode&&(r=1),i&&t._cachedAnisotropicFilteringLevel!==r&&(this._setTextureParameterFloat(e,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=r)},e.prototype._setTextureParameterFloat=function(e,t,r,i){this._bindTextureDirectly(e,i,!0,!0),this._gl.texParameterf(e,t,r)},e.prototype._setTextureParameterInteger=function(e,t,r,i){i&&this._bindTextureDirectly(e,i,!0,!0),this._gl.texParameteri(e,t,r)},e.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(var e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e)}else{e=0;for(var t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}},e.prototype.releaseEffects=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}},e.prototype.dispose=function(){this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),this.unbindAllAttributes(),this._boundUniforms=[],Sr.IsWindowObjectExist()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored))),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers=[],this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,Vr.ResetCache();for(var e=0,t=this._activeRequests;e<t.length;e++){t[e].abort()}},e.prototype.attachContextLostEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)},e.prototype.attachContextRestoredEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)},e.prototype.getError=function(){return this._gl.getError()},e.prototype._canRenderToFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)},e.prototype._canRenderToHalfFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)},e.prototype._canRenderToFramebuffer=function(e){for(var t=this._gl;t.getError()!==t.NO_ERROR;);var r=!0,i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);var n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0);var s=t.checkFramebufferStatus(t.FRAMEBUFFER);if((r=(r=r&&s===t.FRAMEBUFFER_COMPLETE)&&t.getError()===t.NO_ERROR)&&(t.clear(t.COLOR_BUFFER_BIT),r=r&&t.getError()===t.NO_ERROR),r){t.bindFramebuffer(t.FRAMEBUFFER,null);var o=t.RGBA,a=t.UNSIGNED_BYTE,h=new Uint8Array(4);t.readPixels(0,0,1,1,o,a,h),r=r&&t.getError()===t.NO_ERROR}for(t.deleteTexture(i),t.deleteFramebuffer(n),t.bindFramebuffer(t.FRAMEBUFFER,null);!r&&t.getError()!==t.NO_ERROR;);return r},e.prototype._getWebGLTextureType=function(e){if(1===this._webGLVersion){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE},e.prototype._getInternalFormat=function(e){var t=this._gl.RGBA;switch(e){case 0:t=this._gl.ALPHA;break;case 1:t=this._gl.LUMINANCE;break;case 2:t=this._gl.LUMINANCE_ALPHA;break;case 6:t=this._gl.RED;break;case 7:t=this._gl.RG;break;case 4:t=this._gl.RGB;break;case 5:t=this._gl.RGBA}if(this._webGLVersion>1)switch(e){case 8:t=this._gl.RED_INTEGER;break;case 9:t=this._gl.RG_INTEGER;break;case 10:t=this._gl.RGB_INTEGER;break;case 11:t=this._gl.RGBA_INTEGER}return t},e.prototype._getRGBABufferInternalSizedFormat=function(e,t){if(1===this._webGLVersion){if(void 0!==t)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return this._gl.RGB8;case 5:return this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return this._gl.RGBA8},e.prototype._getRGBAMultiSampleBufferFormat=function(e){return 1===e?this._gl.RGBA32F:2===e?this._gl.RGBA16F:this._gl.RGBA8},e.prototype._loadFile=function(t,r,i,n,s,o){var a=this,h=e._FileToolsLoadFile(t,r,i,n,s,o);return this._activeRequests.push(h),h.onCompleteObservable.add((function(e){a._activeRequests.splice(a._activeRequests.indexOf(e),1)})),h},e._FileToolsLoadFile=function(e,t,r,i,n,s){throw xr.WarnImport("FileTools")},e.prototype.readPixels=function(e,t,r,i,n){void 0===n&&(n=!0);var s=n?4:3,o=n?this._gl.RGBA:this._gl.RGB,a=new Uint8Array(i*r*s);return this._gl.readPixels(e,t,r,i,o,this._gl.UNSIGNED_BYTE,a),a},Object.defineProperty(e,"IsSupported",{get:function(){return this.isSupported()},enumerable:!1,configurable:!0}),e.isSupported=function(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{var e=Yr.CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=null!=t&&!!window.WebGLRenderingContext}catch(e){this._IsSupported=!1}return this._IsSupported},Object.defineProperty(e,"HasMajorPerformanceCaveat",{get:function(){if(null===this._HasMajorPerformanceCaveat)try{var e=Yr.CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(e){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat},enumerable:!1,configurable:!0}),e.CeilingPOT=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},e.FloorPOT=function(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)-(e>>1)},e.NearestPOT=function(t){var r=e.CeilingPOT(t),i=e.FloorPOT(t);return r-t>t-i?i:r},e.GetExponentOfTwo=function(t,r,i){var n;switch(void 0===i&&(i=2),i){case 1:n=e.FloorPOT(t);break;case 2:n=e.NearestPOT(t);break;case 3:default:n=e.CeilingPOT(t)}return Math.min(n,r)},e.QueueNewFrame=function(e,t){return Sr.IsWindowObjectExist()?(t||(t=window),t.requestPostAnimationFrame?t.requestPostAnimationFrame(e):t.requestAnimationFrame?t.requestAnimationFrame(e):t.msRequestAnimationFrame?t.msRequestAnimationFrame(e):t.webkitRequestAnimationFrame?t.webkitRequestAnimationFrame(e):t.mozRequestAnimationFrame?t.mozRequestAnimationFrame(e):t.oRequestAnimationFrame?t.oRequestAnimationFrame(e):window.setTimeout(e,16)):"undefined"!=typeof requestAnimationFrame?requestAnimationFrame(e):setTimeout(e,16)},e.prototype.getHostDocument=function(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:document},e.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]}],e._TextureLoaders=[],e.CollisionsEpsilon=.001,e._IsSupported=null,e._HasMajorPerformanceCaveat=null,e}();Jr.prototype.createRenderTargetTexture=function(e,t){var r=new Tr;void 0!==t&&"object"==typeof t?(r.generateMipMaps=t.generateMipMaps,r.generateDepthBuffer=!!t.generateDepthBuffer,r.generateStencilBuffer=!!t.generateStencilBuffer,r.type=void 0===t.type?0:t.type,r.samplingMode=void 0===t.samplingMode?3:t.samplingMode,r.format=void 0===t.format?5:t.format):(r.generateMipMaps=t,r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.type=0,r.samplingMode=3,r.format=5),(1!==r.type||this._caps.textureFloatLinearFiltering)&&(2!==r.type||this._caps.textureHalfFloatLinearFiltering)||(r.samplingMode=1),1!==r.type||this._caps.textureFloat||(r.type=0,Cr.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var i=this._gl,n=new Pr(this,vr.RenderTarget),s=e.width||e,o=e.height||e,a=e.layers||0,h=this._getSamplingParameters(r.samplingMode,!!r.generateMipMaps),c=0!==a?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,l=this._getRGBABufferInternalSizedFormat(r.type,r.format),u=this._getInternalFormat(r.format),d=this._getWebGLTextureType(r.type);this._bindTextureDirectly(c,n),0!==a?(n.is2DArray=!0,i.texImage3D(c,0,l,s,o,a,0,u,d,null)):i.texImage2D(c,0,l,s,o,0,u,d,null),i.texParameteri(c,i.TEXTURE_MAG_FILTER,h.mag),i.texParameteri(c,i.TEXTURE_MIN_FILTER,h.min),i.texParameteri(c,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(c,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),r.generateMipMaps&&this._gl.generateMipmap(c),this._bindTextureDirectly(c,null);var f=this._currentFramebuffer,p=i.createFramebuffer();return this._bindUnboundFramebuffer(p),n._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!r.generateStencilBuffer,r.generateDepthBuffer,s,o),n.is2DArray||i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,n._webGLTexture,0),this._bindUnboundFramebuffer(f),n._framebuffer=p,n.baseWidth=s,n.baseHeight=o,n.width=s,n.height=o,n.depth=a,n.isReady=!0,n.samples=1,n.generateMipMaps=!!r.generateMipMaps,n.samplingMode=r.samplingMode,n.type=r.type,n.format=r.format,n._generateDepthBuffer=r.generateDepthBuffer,n._generateStencilBuffer=!!r.generateStencilBuffer,this._internalTexturesCache.push(n),n},Jr.prototype.createDepthStencilTexture=function(e,t){if(t.isCube){var r=e.width||e;return this._createDepthStencilCubeTexture(r,t)}return this._createDepthStencilTexture(e,t)},Jr.prototype._createDepthStencilTexture=function(e,t){var r=this._gl,i=e.layers||0,n=0!==i?r.TEXTURE_2D_ARRAY:r.TEXTURE_2D,s=new Pr(this,vr.Depth);if(!this._caps.depthTextureExtension)return Cr.Error("Depth texture is not supported by your browser or hardware."),s;var o=v({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t);this._bindTextureDirectly(n,s,!0),this._setupDepthStencilTexture(s,e,o.generateStencil,o.bilinearFiltering,o.comparisonFunction);var a=o.generateStencil?r.UNSIGNED_INT_24_8:r.UNSIGNED_INT,h=o.generateStencil?r.DEPTH_STENCIL:r.DEPTH_COMPONENT,c=h;return this.webGLVersion>1&&(c=o.generateStencil?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24),s.is2DArray?r.texImage3D(n,0,c,s.width,s.height,i,0,h,a,null):r.texImage2D(n,0,c,s.width,s.height,0,h,a,null),this._bindTextureDirectly(n,null),s};var $r=1,ei=[{v:"precision highp float;const int pc=0,qc=1,rc=2,sc=3,tc=-1;const int k=0,l=1,m=2,n=3;const int uc=0,vc=1,wc=2;uniform vec2 u_0;uniform vec2 u_1;uniform vec2 u_2;uniform float u_3;uniform int u_4;uniform float u_5;uniform int u_6;uniform int u_7;uniform mat3 u_8;uniform float u_12;uniform int u_13;uniform float u_14;uniform int u_15;uniform vec2 u_17;uniform int u_18;uniform int u_19;attribute vec2 a_v;attribute vec4 a_p0;attribute vec4 a_p1;attribute vec4 a_p2;attribute vec4 a_p3;attribute vec4 a_p4;attribute float a_d1;attribute float a_d2;const float o=0.0,p=1.0,q=3.0,s=4.0,t=5.0,u=6.0,v=7.0;const float xc=0.001;const float yc=0.001;varying float frag_type;varying vec3 frag_geoUVS;varying vec2 frag_geoRange;varying vec4 frag_specialParam1;varying vec4 frag_specialParam2;varying vec4 frag_specialParam3;varying vec3 frag_specialParam4;varying vec2 frag_specialParam5;const int zc=2,Ac=5;const int Bc=0,Cc=1,Dc=2,Ec=3;vec2 Fc(vec4 Gc){mat3 Hc=u_8;vec2 Ic=u_0;vec2 Jc=u_1;vec2 Kc=u_17;return((Hc*vec3(Gc.xy,1.0)).xy*Jc-Ic)/Kc;}vec2 Lc(vec2 wb){return vec2(-wb.y,wb.x);}void main(){vec2 Mc=a_v;int Y=u_7;vec2 Nc=u_2;float Oc=u_3;int Z=u_4;float Pc=u_5;float Qc=u_12;int fb=u_13;float Rc=u_14;int Sc=u_15;vec2 Kc=u_17;bool Tc=u_18 !=0;bool Uc=u_19 !=0;frag_type=0.0;frag_geoRange=frag_specialParam5=vec2(0.0,0.0);frag_geoUVS=frag_specialParam4=vec3(0.0,0.0,0.0);frag_specialParam1=frag_specialParam2=frag_specialParam3=vec4(0.0,0.0,0.0,0.0);if(Y==rc || Y==sc){gl_Position=vec4(Mc,0.0,1.0);frag_type=p;}else{vec2 Vc=Fc(a_p0),Wc=Fc(a_p1),Xc=Fc(a_p2),Yc=Fc(a_p3),Zc=Fc(a_p4);int ad=int(a_p0.z),bd=int(a_p1.z),cd=int(a_p2.z),dd=int(a_p3.z),ed=int(a_p4.z);float fd=Uc ? 0.0 : a_d1,gd=Uc ? 0.0 : a_d2;float hd=a_p1.w,id=a_p2.w,jd=a_p3.w;bool kd=bd==wc;bool ld=cd==wc;vec2 md,nd,od;int pd,qd;if(ld){md=Wc;nd=Xc;od=Yc;pd=bd;qd=dd;}else if(kd){md=Vc;nd=Wc;od=Xc;pd=ad;qd=cd;}else{md=Wc;nd=(Wc+Xc)*0.5;od=Xc;pd=bd;qd=cd;}vec2 rd=od-md,sd=nd-md,td=od-nd;float ud=length(rd),vd=length(sd),wd=length(td);vec2 xd=rd/ud,yd=sd/vd,zd=td/wd;vec2 Ad=Lc(xd),Bd=Lc(yd),Cd=Lc(zd);float Dd=dot(Bd,zd);mat2 Ed;vec2 Fd,Gd;float Hd;bool Id=false;vec2 Jd;if(ld || kd){vec2 Kd=td-sd;float Ld=(dot(-sd,td)+dot(-sd,-sd))/dot(Kd,Kd);vec2 Md=mix(md,nd,Ld),Nd=mix(nd,od,Ld),Od=normalize(Nd-Md);float Pd=sign(Dd);mat2 Qd=mat2(Od,vec2(-Od.y,Od.x)*Pd);vec2 Rd=mix(Md,Nd,Ld);vec2 Sd=(md-Rd)*Qd,Td=(od-Rd)*Qd;float Ud=abs(Sd.x)> abs(Td.x)?(Sd.x*Sd.x)/Sd.y :(Td.x*Td.x)/Td.y;Ed=Qd/Ud;Fd=Rd;Gd=vec2(Sd.x,Td.x)/Ud;Hd=Ud*Pd;Id=Tc || abs(Dd)< xc || min(abs(ud),min(abs(vd/ud),abs(wd/ud)))< Oc*yc;if(Id){nd=(md+od)*0.5;sd=nd-md;td=od-nd;vd=wd=ud*0.5;yd=zd=xd;Bd=Cd=Ad;Dd=1.0;}}bool Vd=ld || kd;vec2 Wd=Vc;int Xd=ad;vec2 Yd=Vd ? Zc : Yc;int Zd=Vd ? ed : dd;bool ae=(Xd==0),be=(Zd==0),ce=(qd==0);if(Xd==0)Wd=md-(nd-md);if(Zd==0)Yd=od-(od-nd);vec2 de=md-Wd,ee=-de,fe=Yd-od,ge=-fe;float he=length(de),ie=length(fe);vec2 je=de/he,ke=fe/ie;vec2 le=Lc(je),me=Lc(ke);if(! Vd || Id){if(vd < yc){yd=je;Bd=le;}if(wd < yc){zd=ke;Cd=me;}if(ud < yc){xd=normalize(Yd-Wd);Ad=Lc(xd);}if(ud < yc){xd=vec2(1.0,0.0);Ad=vec2(0.0,-1.0);ud=yc;}if(vd < yc){yd=xd;Bd=Ad;}if(wd < yc){zd=xd;Cd=Ad;}if(he < yc){je=yd;le=Bd;}if(ie < yc){ke=zd;me=Cd;}Ed=mat2(xd/ud,Ad/ud);Fd=md;Gd=vec2(0.0,1.0);Hd=ud;}vec2 ne=vec2(0.0,0.0);if(Y==pc &&(! Vd || ld)){if(Tc){bool ce=(qd==0);if(ce || abs(ud)< Oc*yc)frag_type=o;else{float oe=clamp(hd,0.0,1.0);float pe=clamp((Vd ? jd : id),0.0,1.0);float qe=Vd ? fd+(gd-fd)*2.0 : gd;float re=Qc*0.5;vec4 se=vec4(min(md.x,od.x)-Oc*Kc.x,min(md.y,od.y)-Oc*Kc.y,max(md.x,od.x)+Oc*Kc.x,max(md.y,od.y)+Oc*Kc.y);ne=Mc*vec2(se [ 2 ]-se [ 0 ],se [ 3 ]-se [ 1 ])/2.0+vec2(se [ 2 ]+se [ 0 ],se [ 3 ]+se [ 1 ])/2.0;vec2 te=vec2(xd.x==0.0 ? 1.0 : sign(xd.x),xd.y==0.0 ? 1.0 : sign(xd.y));float ue=re*(1.0-oe),ve=re*(1.0-pe);float we=re*oe,xe=re*pe;vec2 ye=md-te*we,ze=od+te*xe;vec2 Ae=ye+vec2(te.x*2.0*we,0.0),Be=ze-vec2(te.x*2.0*xe,0.0);vec2 Ce=ye+vec2(0.0,te.y*2.0*we),De=ze-vec2(0.0,te.y*2.0*xe);bool Ee=dot(Ad,Ae-md)>=0.0,Fe=dot(Ad,Be-md)>=0.0;vec2 Ge=Ee ? Ae : Ce,He=Fe ? Be : De;vec2 Ie=Ee ? Ce : Ae,Je=Fe ? De : Be;float Ke=max(abs(xd.x),abs(xd.y));float Le=dot(ne-Ge,Lc(normalize(He-Ge)))*Ke+re;float Me=dot(ne-Ie,-Lc(normalize(Je-Ie)))*Ke+re;float Ne=dot(ne-md,Ad);float Oe=dot(ne-md,(oe > xc)? Lc(Ie-Ge): xd);float Pe=dot(ne-od,(pe > xc)? Lc(He-Je):-xd);frag_specialParam1=vec4(ne-md,ne-od)*0.5/Oc;frag_specialParam2=vec4(Le,Me,ue,ve)*0.5/Oc;frag_specialParam3=vec4(gd-fd,fd,0.0,0.0);frag_specialParam4=vec3(Ne,Oe,Pe);frag_type=v;}}else{float Qe=dot(le,yd),Re=dot(Cd,ke),Se=dot(le,xd),Te=dot(Ad,ke);bool Ue=abs(Qe)< xc,Ve=abs(Re)< xc;bool We=Ue && dot(je,yd)< 0.0,Xe=Ve && dot(zd,ke)< 0.0;float Ye=(! Ue)? sign(Qe):(Se !=0.0)? sign(Se): sign(Te);float Ze=(! Ve)? sign(Re):(Te !=0.0)? sign(Te): sign(Se);vec2 af=normalize(le+Bd)*-Ye;float bf=abs(dot(af,Bd));float cf=(Z==k)? bf :(Z==l)? 1.0/max(bf,xc): 1.0;vec2 df=We ? yd*Ye : af*cf;vec2 ef=normalize(Cd+me)*-Ze;float ff=abs(dot(ef,Cd));float gf=(Z==k)? ff :(Z==l)? 1.0/max(ff,xc): 1.0;vec2 hf=Xe ?-zd*Ze : ef*gf;vec4 se=vec4(min(min(min(min(md.x,od.x),nd.x),md.x+df.x*Oc),od.x+hf.x*Oc)-Oc,min(min(min(min(md.y,od.y),nd.y),md.y+df.y*Oc),od.y+hf.y*Oc)-Oc,max(max(max(max(md.x,od.x),nd.x),md.x+df.x*Oc),od.x+hf.x*Oc)+Oc,max(max(max(max(md.y,od.y),nd.y),md.y+df.y*Oc),od.y+hf.y*Oc)+Oc);ne=Mc*vec2(se [ 2 ]-se [ 0 ],se [ 3 ]-se [ 1 ])/2.0+vec2(se [ 2 ]+se [ 0 ],se [ 3 ]+se [ 1 ])/2.0;vec2 jf=normalize(Bd+df*Ye);vec2 kf=-normalize(le+df*Ye);bool lf=ce || We || Ue || cf > vd*10.0 || cf > he*10.0;vec2 mf=ne-md;vec2 nf=normalize(df);float Cb=-dot(mf,(vd < xc || We)? xd : yd);float Db=lf ? Cb :-dot(mf,Lc(nf))*Ye;float Eb=lf ?-dot(mf,Bd)*Ye : dot(mf,Lc(jf))/(2.0*Oc*length(df+jf*dot(-df,jf)));float Fb=lf ? 0.5 :(dot(mf,nf)/Oc-Pc)/abs(dot(nf,Bd));float Gb=lf ? 1.0 : dot(mf,Lc(kf))/(2.0*Oc*length(df+kf*dot(-df,kf)));vec2 of=-normalize(Cd+hf*Ze);vec2 pf=normalize(me+hf*Ze);bool qf=ce || Xe || Ve || gf > wd*10.0 || gf > ie*10.0;vec2 rf=ne-od;vec2 sf=normalize(hf);float Hb=dot(rf,(wd < xc || Xe)? xd : zd);float Ib=qf ? Hb : dot(rf,Lc(sf))*Ze;float Jb=qf ?-dot(rf,Cd)*Ze : dot(rf,Lc(of))/(2.0*Oc*length(hf+of*dot(-hf,of)));float Kb=qf ? 0.5 :(dot(rf,sf)/Oc-Pc)/abs(dot(sf,Cd));float Lb=qf ? 1.0 : dot(rf,Lc(pf))/(2.0*Oc*length(hf+pf*dot(-hf,pf)));float tf=(1.0-Rc)*Qc/(4.0*Oc);if(ae)Gb=-dot(mf,yd)/(2.0*Oc)+tf;if(be)Lb=dot(rf,zd)/(2.0*Oc)+tf;float uf,vf;if(Vd && ! Id){float wf=fd,qe=fd+(gd-fd)*2.0;float xf=sqrt(1.0+4.0*Gd [ 0 ]*Gd [ 0 ]),yf=sqrt(1.0+4.0*Gd [ 1 ]*Gd [ 1 ]);float zf=sign(Gd [ 0 ])*0.5*(abs(Gd [ 0 ])*xf+0.5*log(2.0*abs(Gd [ 0 ])+xf));float Af=sign(Gd [ 1 ])*0.5*(abs(Gd [ 1 ])*yf+0.5*log(2.0*abs(Gd [ 1 ])+yf));uf=(qe-wf)/abs(Af-zf);vf=wf-zf*uf;}else{float wf=fd;float qe=gd;uf=qe-wf;vf=wf;}float oe=hd;float pe=Vd ? jd : id;vec2 Bf=(vec2(1.0,1.0)-clamp(vec2(oe,pe),0.0,1.0))*Qc/(4.0*Oc);frag_specialParam1=vec4(vec2(Cb,Db)/Qc,Eb,Fb);frag_specialParam2=vec4(vec2(Hb,Ib)/Qc,Jb,Kb);frag_specialParam3=vec4(uf,vf,Bf.x,Bf.y);if(Sc==0 || Rc > 0.0)frag_specialParam4=vec3(ae ? 0.0 : 1.0,be ? 0.0 : 1.0,ce ? 0.0 : 1.0);else frag_specialParam4=vec3(1.0,1.0,ce ? 0.0 : 1.0);frag_specialParam5=vec2(Gb,Lb);frag_type=(Vd && ! Id)? s : q;}}else if(Y==qc &&(! Id || ld)){float Cf=(Mc.y)/(Kc.x*Nc.x);if(! Vd || Id){vec2 Df=(Mc.x < 0.0)? md : od;ne=Df+vec2(Cf,0.0);frag_type=t;}else{float Ef=clamp((md.y-nd.y)/(md.y+od.y-2.0*nd.y),0.0,1.0);vec2 Ff=mix(mix(md,nd,Ef),mix(nd,od,Ef),Ef);vec2 Gf=ld ? md : Ff;vec2 Hf=ld ? Ff : od;vec2 Df=(Mc.x < 0.0)? Gf : Hf;vec2 If=(Ff-Fd)*Ed;vec2 Jf=(Df+vec2(Cf,0.0)-Fd)*Ed;vec2 Kf=((ld ? md : od)-Fd)*Ed;float Lf=Jf.x-If.x;float Mf=sign(Kf.x-If.x);float fc=Lf*Mf;float gc=sign(dot(Bd,zd));ne=Df+vec2(Cf,0.0);frag_specialParam1.x=dot(ne-md,Bd*sign(dot(Bd,xd)));frag_specialParam1.y=dot(ne-nd,Cd*sign(dot(Cd,-yd)));frag_specialParam1.z=dot(ne-od,Ad*sign(dot(Ad,-zd)));frag_specialParam1.w=dot(ne-Gf,vec2(Gf.y-Hf.y,Hf.x-Gf.x));frag_specialParam2.x=fc;frag_specialParam2.y=gc;frag_type=u;}}else{gl_Position=vec4(0.0,0.0,0.0,0.0);frag_type=o;}gl_Position=vec4(ne.x*Nc.x*2.0*Kc.x,-ne.y*Nc.y*2.0*Kc.y,0.0,1.0);frag_geoRange=Gd;frag_geoUVS.xy=(ne-Fd)*Ed;frag_geoUVS.z=Hd*0.5/Oc;if(fb==2)frag_specialParam3=vec4(Mc.x*0.5+0.5,Mc.y*0.5+0.5,rd.x+rd.y,0.0);}}",f:"precision highp float;const int c=0,d=1,e=2,f=3,h=4,i=5,j=6;const int k=0,l=1,m=2,n=3;uniform int ufrag_0;uniform int ufrag_1;uniform float ufrag_2;uniform float ufrag_3;uniform float ufrag_4;uniform float ufrag_5;uniform float ufrag_6;uniform int ufrag_7;uniform float ufrag_8;uniform float ufrag_10;uniform float ufrag_11;uniform float ufrag_12;uniform vec4 ufrag_13;uniform float ufrag_15;uniform vec2 ufrag_16;uniform int ufrag_17;uniform float ufrag_18;uniform float ufrag_19;varying float frag_type;const float o=0.0,p=1.0,q=3.0,s=4.0,t=5.0,u=6.0,v=7.0;varying vec3 frag_geoUVS;varying vec2 frag_geoRange;varying vec4 frag_specialParam1;varying vec4 frag_specialParam2;varying vec4 frag_specialParam3;varying vec3 frag_specialParam4;varying vec2 frag_specialParam5;float A(vec2 B,vec2 C){float a=0.5-B.y;float b=-0.5*B.x;float D=b*0.5;float E=(b*b)*0.25;float F=(a*a*a)/27.0;if(E+F > 0.0){float G=sqrt(E+F);float H=G-D;float I=sign(H)*pow(abs(H),1.0/3.0);float J=G+D;float K=-sign(J)*pow(abs(J),1.0/3.0);float x=I+K;return clamp(x,C [ 0 ],C [ 1 ]);}else{const float L=0.333333333;const vec3 M=vec3(0.0,2.094395102,4.188790205);float N=1.0/a;vec3 O=2.0*sqrt(-a*L)*cos(L*acos(sqrt(-6.75*N)*b*N)-M);vec3 x=clamp(O,C [ 0 ],C [ 1 ]);vec3 P=B.x-x,Q=B.y-x*x,R=P*P+Q*Q;return(R [ 0 ] < R [ 1 ] && R [ 0 ] < R [ 2 ])? x [ 0 ] :(R [ 1 ] < R [ 2 ])? x [ 1 ] : x [ 2 ];}}bool S(float T){return T-0.4 < frag_type && frag_type < T+0.4;}float U(float V,float a,float b,float W,float X){return clamp((abs(V*2.0-a-b)+a-b)*W*0.5+X,0.0,1.0);}void main(){int Y=ufrag_0;int Z=ufrag_1;float ab=ufrag_2;float bb=ufrag_3;float cb=ufrag_4;float db=ufrag_5;float eb=ufrag_6;int fb=ufrag_7;float gb=ufrag_8;float hb=ufrag_10;float ib=ufrag_11;float jb=ufrag_12;vec4 kb=ufrag_13;float lb=ufrag_15;vec2 mb=ufrag_16;bool nb=(ufrag_17==1);float ob=ufrag_18;float pb=ufrag_19;const float qb=1.0;float F=qb;float rb;float sb=0.0;float tb=0.0;if(Y==0 && ! S(v)){float V=0.0;float ub=0.0;vec2 vb;if(S(s)){float x=A(frag_geoUVS.xy,frag_geoRange);vb=frag_geoUVS.xy-vec2(x,x*x);vec2 wb=normalize(vec2(1.0,2.0*x));sb=dot(vb,vec2(-wb.y,wb.x))*frag_geoUVS.z;float xb=2.0*abs(x),yb=sqrt(1.0+xb*xb);float zb=sign(x)*(xb*yb+log(xb+yb))*0.25;float Ab=1.0-abs(sign((x-frag_geoRange [ 0 ])*(x-frag_geoRange [ 1 ])));V=zb+Ab*dot(vb,wb);ub=(x-frag_geoRange [ 0 ])/(frag_geoRange [ 1 ]-frag_geoRange [ 0 ]);}else{vb=frag_geoUVS.xy-vec2(clamp(frag_geoUVS.x,0.0,1.0),0.0);V=ub=frag_geoUVS.x;sb=frag_geoUVS.y;}F=length(vb)*abs(frag_geoUVS.z);ub=clamp(ub,0.0,1.0);const float Bb=0.01;float Cb=frag_specialParam1 [ 0 ],Db=frag_specialParam1 [ 1 ],Eb=frag_specialParam1 [ 2 ],Fb=frag_specialParam1 [ 3 ],Gb=frag_specialParam5 [ 0 ];float Hb=frag_specialParam2 [ 0 ],Ib=frag_specialParam2 [ 1 ],Jb=frag_specialParam2 [ 2 ],Kb=frag_specialParam2 [ 3 ],Lb=frag_specialParam5 [ 1 ];float Mb=frag_specialParam4.x,Nb=frag_specialParam4.y,Ob=frag_specialParam4.z;bool Pb=ub < 0.5 ?(Mb !=0.0 &&(Db > Bb || Fb > 1.0)):(Nb !=0.0 &&(Ib > Bb || Kb > 1.0));if(Z !=m){if(Pb)F=qb;else{const float Qb=0.001;if(ub < 0.5 && Cb > Bb && Mb !=0.0)F=(Db <=Qb)? Eb :(Fb >=0.0)? Gb : qb;if(ub > 0.5 && Hb > Bb && Nb !=0.0)F=(Ib <=Qb)? Jb :(Kb >=0.0)? Lb : qb;}}float Rb=F;if(Mb==0.0)Rb=max(Rb,Gb);if(Nb==0.0)Rb=max(Rb,Lb);tb=V*frag_specialParam3.x+frag_specialParam3.y;bool Sb=(mb==vec2(0.0,0.0))||(mb [ 0 ] <=tb && tb <=mb [ 1 ]);bb=Sb ? bb*Ob : 0.0;float Tb=(F <=lb && Sb)? bb : 0.0;float Ub=Pb ? 0.0 : Tb;const float Vb=0.2;const float Wb=(1.0-2.0*Vb)*2.0;float Xb=abs(fract(db+tb*cb)*2.0-1.0)*jb;float Yb=U(Xb,kb [ 0 ],kb [ 1 ],Wb,Vb)*U(Xb,kb [ 2 ],kb [ 3 ],Wb,Vb)*Tb;float Zb=clamp(0.5-F*sign(sb)*ib,0.0,1.0)*Ub;rb=sign(Rb)*max(0.0,abs(Rb)+mix(frag_specialParam3.z,frag_specialParam3.w,ub));float ac=(0.5-rb+pb)*bb;float bc=(0.5-F)*ab;vec4 cc=vec4(bc,ac,Zb,Yb);vec4 dc=vec4(ac,bc,0.0,0.0);vec4 ec=mix(cc,dc,ob);gl_FragColor=clamp(ec,0.0,1.0);}else if(S(t)){gl_FragColor=vec4(0.0,0.0,0.0,1.0);if(eb==sign(frag_geoUVS.y))discard;}else if(S(u)){gl_FragColor=vec4(0.0,0.0,0.0,0.0);if(frag_specialParam1.x > 0.0 && frag_specialParam1.y > 0.0 && frag_specialParam1.z > 0.0){float fc=frag_specialParam2.x,gc=frag_specialParam2.y;float hc=((fc >=0.0)? sign((frag_geoUVS.y-frag_geoUVS.x*frag_geoUVS.x)): 1.0)*gc;if(eb==hc)discard;}else if(eb==sign(frag_specialParam1.w))discard;}else if(S(v)){tb=frag_geoUVS.x*frag_specialParam3.x+frag_specialParam3.y;float ic=max(abs(frag_specialParam1.x),abs(frag_specialParam1.y))+frag_specialParam2.z;float jc=max(abs(frag_specialParam1.z),abs(frag_specialParam1.w))+frag_specialParam2.w;rb=min(ic,jc);if(frag_specialParam4.y >=0.0 && frag_specialParam4.z >=0.0)rb=min(rb,frag_specialParam4.x >=0.0 ? frag_specialParam2.x : frag_specialParam2.y);float kc=0.5-clamp(rb,0.0,0.5);gl_FragColor=vec4(kc*ab,kc*bb,0.0,1.0);}else gl_FragColor=vec4(frag_type*(1.0-gb),0.0,0.0,frag_type*gb);if(Y==0 && nb){float lc=smoothstep(lb,lb*1.5,rb);float mc=(tb+32.0*rb/lb)*jb;float nc=1.0-(mc+lc);gl_FragColor=vec4(nc,nc,nc,1.0);}if(fb==e){gl_FragColor.rgb=clamp(vec3(1.0-F*2.0,1.0-F*4.0,1.0-F*8.0),0.0,1.0);float oc=0.25+clamp((abs(frag_specialParam3.x+frag_specialParam3.y-1.0)+abs(frag_specialParam3.x-frag_specialParam3.y))*4.0-2.75,0.0,1.0);gl_FragColor+=vec4(oc*(1.0+sin(frag_specialParam3.z))/2.0,oc*(1.0+cos(frag_specialParam3.z))/2.0,oc*frag_specialParam3.z/18.0,1.0);}}",a:["a_v","a_p0","a_p1","a_p2","a_p3","a_p4","a_d1","a_d2"],u:["ufrag_0","ufrag_1","ufrag_2","ufrag_3","ufrag_4","ufrag_5","ufrag_6","ufrag_7","ufrag_8","ufrag_10","ufrag_11","ufrag_12","ufrag_13","ufrag_15","ufrag_16","ufrag_17","ufrag_18","ufrag_19","u_0","u_1","u_2","u_3","u_4","u_5","u_6","u_7","u_8","u_12","u_13","u_14","u_15","u_17","u_18","u_19"],s:[]},{v:"precision highp float;uniform mat3 u_0;uniform mat3 u_1;uniform vec2 u_2;uniform mat3 u_3;uniform mat3 u_4;uniform mat3 u_5;uniform mat3 u_6;uniform mat3 u_7;uniform mat3 u_8;uniform mat3 u_10;uniform int u_13;uniform int u_14;uniform vec2 u_15;uniform int u_16;uniform float u_17;uniform float u_18;uniform float u_19;uniform vec2 u_20;uniform vec2 u_21;attribute vec2 a_v;attribute vec2 a_0;attribute vec2 a_1;varying vec2 k,l,m,n,o,p,q;varying float s;mat2 Lc(float Mc){return mat2(cos(Mc),-sin(Mc),sin(Mc),cos(Mc));}vec2 Nc(vec2 Oc){return vec2(Oc.x/2.0,Oc.y/-2.0)+vec2(0.5,0.5);}vec2 Pc(vec2 Oc,mat3 Qc){return(Qc*vec3(vec2(Oc.x/2.0,Oc.y/2.0),1.0)).xy*vec2(1.0,-1.0)+vec2(0.5,0.5);}mat4 Rc(float Sc,float Tc,float Uc,float Vc){float a=1.0/tan(Sc*0.5),b=1.0/(Uc-Vc);return mat4(a/Tc,0.0,0.0,0.0,0.0,-a,0.0,0.0,0.0,0.0,(Uc+Vc)*b,-1.0,0.0,0.0,2.0*Uc*Vc*b,0.0);}mat4 Wc(float Mc){float Xc=cos(Mc),Yc=sin(Mc);return mat4(1.0,0.0,0.0,0.0,0.0,Xc,-Yc,0.0,0.0,Yc,Xc,0.0,0.0,0.0,0.0,1.0);}mat4 Zc(float Mc){float Xc=cos(Mc),Yc=sin(Mc);return mat4(Xc,0.0,Yc,0.0,0.0,1.0,0.0,0.0,-Yc,0.0,Xc,0.0,0.0,0.0,0.0,1.0);}void main(){vec2 ad=a_v;mat3 bd=u_0;vec2 cd=u_15;mat3 dd=u_1;vec2 ed=u_2;mat3 fd=u_3;mat3 gd=u_4;mat3 hd=u_5;mat3 id=u_6;mat3 jd=u_7;mat3 kd=u_8;mat3 ld=u_10;vec2 md=u_20;vec2 nd=u_21;int od=u_13;int pd=u_14;float qd=u_18;float rd=u_19;vec2 sd=ad;vec2 td=ad;if(u_16 !=0){sd=ad+a_0*2.0;td=ad+a_1*2.0;ad=mix(sd,td,u_17);}vec2 ud=(bd*vec3(ad.xy/2.0,1.0)).xy;vec2 vd;if(cd !=vec2(1.0,1.0)){const float wd=1.57079632679;mat4 xd=Zc((1.0-cd.x)*wd),yd=Wc((1.0-cd.y)*wd);mat4 zd=mat4(mat2(dd));zd [ 3 ] [ 0 ]=dd [ 2 ] [ 0 ];zd [ 3 ] [ 1 ]=dd [ 2 ] [ 1 ];vec4 Ad=zd*yd*xd*vec4(ud,0.0,1.0)-vec4(ed*0.5,0.0,0.0);gl_Position=vec4((Ad.xy/ed)*vec2(2.0,-2.0),0.0,1.0);const float Bd=0.78539816339;float Cd=ed.y/(2.0*tan(Bd*0.5));Ad.z-=Cd;vec4 Dd=Rc(Bd,ed.x/ed.y,Cd/2.0,Cd*2.0)*Ad;gl_Position=Dd/Dd.w;}else{vec2 vd=(dd*vec3(ud,1.0)).xy;gl_Position=vec4((vd/ed-vec2(0.5,0.5))*vec2(2.0,-2.0),0.0,1.0);}gl_Position.z=mix(qd,rd,ad.y*0.5+0.5);k=Pc(sd.xy,fd);l=Pc((od !=0)? gl_Position.xy : td.xy,gd);n=Pc((pd !=0)? gl_Position.xy : ad.xy,id);m=Pc(ad.xy,hd);p=Pc(ad.xy,jd);q=Pc(ad.xy,kd);o=Pc(ad.xy,ld);if(md==nd){s=1.0;}else{vec2 Ed=nd-md;s=dot(ud-md,Ed)/dot(Ed,Ed);}}",f:"precision highp float;uniform sampler2D t_0;uniform sampler2D t_1;uniform sampler2D t_2;uniform sampler2D t_3;uniform sampler2D t_4;uniform sampler2D t_5;uniform sampler2D t_6;uniform float ufrag_0;uniform float ufrag_1;uniform float ufrag_2;uniform vec4 ufrag_3;uniform vec4 ufrag_4;uniform float ufrag_6;uniform vec3 ufrag_8;uniform vec3 ufrag_9;uniform int ufrag_10;uniform int ufrag_11;uniform vec2 ufrag_12;uniform vec4 ufrag_13;uniform int ufrag_14;uniform int ufrag_15;uniform int ufrag_16;uniform vec2 ufrag_17;uniform int ufrag_18;uniform int ufrag_19;uniform float ufrag_20;uniform float ufrag_21;uniform vec4 ufrag_22;uniform vec4 ufrag_23;uniform int ufrag_24;uniform int ufrag_25;uniform vec4 ufrag_26;uniform float ufrag_27;uniform float ufrag_28;uniform float ufrag_29;uniform int ufrag_30;uniform int ufrag_31;uniform float ufrag_32;uniform int ufrag_34;uniform int ufrag_35;uniform float ufrag_36;uniform int ufrag_37;const int c=0,d=1,e=2,f=3,h=11,i=14,j=16;varying vec2 k,l,m,n,o,p,q;varying float s;float t(float u){return clamp(u,0.0,1.0);}const vec3 v=vec3(2.2,2.2,2.2);const vec3 A=vec3(1.0/2.2,1.0/2.2,1.0/2.2);const vec2 B=vec2(.5,.5);vec4 C(vec4 D,vec3 E){return vec4(pow(D.rgb,E),D.a);}vec4 F(vec4 G,vec4 H){float I=H.a+G.a*(1.0-H.a);return vec4((H.rgb*H.a+G.rgb*G.a*(1.0-H.a))/I,I);}float J(float K,vec3 L,vec3 M){float N=clamp(K,L [ 0 ],L [ 2 ]);vec3 O=abs((N-L)*M);return min(O [ 0 ],min(O [ 1 ],O [ 2 ]));}float P(vec2 Q){vec2 R=sign(B-abs(Q-B));return max(0.0,R.x+R.y)*.5;}float S(float T,float U,float V){const float W=-0.5;const float X=0.16;const float Y=0.5;float Z=mix(X,W,t(V*Y));float ab=min(V,U);float bb=1.0-t((T-Z)/ab);return bb*bb;}vec2 cb(vec4 db,float eb,float fb,float gb,vec3 hb,vec3 ib,float V,float jb){bool kb=ufrag_15==d;float lb=max(fb,V)*0.5;float mb=db.r-0.5;float nb=S(-mb/eb,0.5/eb,V);float ob=clamp(0.5-mix(db.g,min(1.0-db.r,db.g),ufrag_29),0.0,0.5);float pb=(kb && jb==0.0)? ob : 0.5-db.b;float K=ob*sign(pb)/eb;bool qb=ib [ 0 ]==ib [ 2 ];if(! qb && abs(K)< fb*0.5-V*2.0)K=pb/eb;K+=jb;const float rb=0.2;const float sb=1.0/(1.0-rb*2.0);const float tb=0.5-0.5*sb;float ub=db.a;float vb=ub*sb+tb;float wb=(1.0-vb)*(lb+V);float xb=abs(K);if(ub <(1.0-rb)&& ! kb)xb=mix(max(wb,xb),length(vec2(wb,xb)),gb);const float yb=0.49;float zb=min(lb,yb/eb);float Ab=S(xb-zb,0.5/eb-zb,V);if(vb >=gb && ! kb){float Bb=J(K,hb*lb,ib);float Cb=min(min(ib [ 0 ],ib [ 1 ]),ib [ 2 ]);float Db=V*Cb;float Eb=S(Bb-zb,0.5/eb-zb,Db);Ab=min(Ab,Eb);}if(ufrag_37==0)return vec2(clamp(nb,0.0,1.0),clamp(Ab,0.0,1.0));else return vec2(0.0,clamp(max(nb,Ab),0.0,1.0));}const int Fb=0,Gb=1,Hb=2,Ib=3,Jb=4,Kb=5,Lb=6,Mb=7,Nb=8,Ob=9;vec2 Pb(int Qb,vec4 Rb,vec2 Q,float eb){if(Qb==Jb)return vec2(1.0-min(min(Rb [ 0 ]*Q.x,Rb [ 3 ]*Q.y),min(Rb [ 2 ]*(1.0-Q.x),Rb [ 1 ]*(1.0-Q.y))),0.0);if(Qb==Hb){float Sb=Q.x,Tb=floor(Sb),N=Sb-Tb;Sb=(fract(Tb*0.5)==0.0)? N : 1.0-N;return vec2(Sb,0.0);}else return Q;}vec4 Ub(int Qb,vec4 Rb,vec4 Vb,vec2 Q,sampler2D Wb,int Xb,vec4 db,float eb){if(Qb==Fb)return vec4(0.0,0.0,0.0,0.0);if(Qb==Gb)return Rb;if(Xb !=0 && Qb !=0 && Qb > 1 &&(Q.x < 0.0 || Q.x > 1.0 || Q.y < 0.0 || Q.y > 1.0))return vec4(0.0,0.0,0.0,0.0);vec4 bb=texture2D(Wb,Pb(Qb,Rb,Q,eb));if(Qb==Mb)return mix(Rb,Vb,bb.r);else{if(Qb==Lb)bb.rgb/=bb.a;return bb;}}void main(){float eb=ufrag_0;float fb=ufrag_1;float Yb=ufrag_2;vec4 Zb=ufrag_3;vec4 ac=ufrag_4;float gb=ufrag_6;vec3 hb=ufrag_8;vec3 ib=ufrag_9;int bc=ufrag_10;int cc=ufrag_11;vec2 dc=ufrag_12;vec4 ec=ufrag_13;int fc=ufrag_15;int gc=ufrag_16;vec2 hc=ufrag_17;int ic=ufrag_18;int jc=ufrag_19;float kc=ufrag_20;float lc=ufrag_21;vec4 mc=ufrag_22;vec4 nc=ufrag_23;int oc=ufrag_24;int pc=ufrag_25;vec4 qc=ufrag_26;float jb=ufrag_27;float rc=ufrag_28;int sc=ufrag_30;int tc=ufrag_31;float uc=ufrag_32;bool vc=ufrag_34 !=0;float wc=ufrag_36;vec4 xc=vc ? vec4(0.0,0.0,0.0,0.0): texture2D(t_0,k);if(fc==e){xc*=P(k);if(wc > 0.0){vec4 yc=texture2D(t_1,l)*P(l);xc=mix(xc,yc,t(wc));}gl_FragColor=xc;gl_FragColor.rgb/=gl_FragColor.a;}else if(fc <=d){vec2 zc=vc ? vec2(1.0,0.0): cb(xc,eb,fb,gb,hb,ib,Yb,jb);vec4 Ac=Ub(bc,Zb,mc,l,t_1,ic,xc,eb);Ac.rgb=clamp(mix(Ac.rgb,vec3(0.5)*sign(rc)+0.5,abs(rc)),0.0,1.0);Ac.a*=kc;if(sc !=0){vec4 Bc=Ub(Lb,vec4(0.0,0.0,0.0,0.0),vec4(0.0,0.0,0.0,0.0),m,t_6,tc,xc,eb);Bc.a*=uc;if(Bc.a > 0.0)Ac=F(Ac,Bc);}if(pc !=0){float Cc=texture2D(t_5,q).a;Ac.rgb=mix(Ac.rgb,qc.rgb,(1.0-Cc)*qc.a);}vec4 Dc=vec4(Ac.rgb,Ac.a*zc [ 0 ]);vec4 Ec=Ub(cc,ac,nc,n,t_2,jc,xc,eb);vec4 Fc=vec4(Ec.rgb,Ec.a*zc [ 1 ]*lc);gl_FragColor=F(Dc,Fc);if(fc==d){if(gl_FragColor.a > 0.0)gl_FragColor=ec;else gl_FragColor=vec4(0.0,0.0,0.0,0.0);}}else if(fc==f){float Gc=(xc.r-0.5);float Hc=t(1.0-2.0*abs(sin(Gc*64.0)))*0.5;if(Gc < 0.0)gl_FragColor=vec4(0.0,Hc*(1.0+Gc),1.0+Gc,1.0+Gc);else gl_FragColor=vec4(1.0-Gc,Hc*(1.0-Gc),0.0,1.0);}else{if(fc==h)gl_FragColor=vec4(xc.r,xc.g*2.0,0.0,1.0);else if(fc==i)gl_FragColor=vec4(xc.r,0.0,0.0,1.0);else if(fc==j)gl_FragColor=vec4(xc.b,xc.b > 0.95 ?(xc.b-0.95)*20.0 : 0.0,xc.a,1.0);else gl_FragColor=vec4(xc.r,xc.g,xc.b,1.0);}float Ic=dc [ 0 ]+(dc [ 1 ]-dc [ 0 ])*t(s);if(oc !=0)Ic-=1.0-texture2D(t_4,p).a;if(gc !=0 &&(fc==0 || fc==2)){if(gc==1){Ic-=1.0-hc [ 1 ];}else if(gc==2){float Jc=1.0-texture2D(t_3,o).r;Ic-=1.0-t(Jc*hc [ 0 ]+hc [ 1 ]);}}gl_FragColor.a=t(gl_FragColor.a)*t(Ic);if(fc !=1 && ec.a > 0.0)gl_FragColor.rgb=ec.rgb;gl_FragColor.rgb*=gl_FragColor.a;gl_FragColor.rgb=clamp(gl_FragColor.rgb,0.0,1.0);if(ufrag_35==1){float Kc=1.0-gl_FragColor.a;gl_FragColor=vec4(Kc+gl_FragColor.rgb,gl_FragColor.a);}}",a:["a_v","a_0","a_1"],u:["ufrag_0","ufrag_1","ufrag_2","ufrag_3","ufrag_4","ufrag_6","ufrag_8","ufrag_9","ufrag_10","ufrag_11","ufrag_12","ufrag_13","ufrag_14","ufrag_15","ufrag_16","ufrag_17","ufrag_18","ufrag_19","ufrag_20","ufrag_21","ufrag_22","ufrag_23","ufrag_24","ufrag_25","ufrag_26","ufrag_27","ufrag_28","ufrag_29","ufrag_30","ufrag_31","ufrag_32","ufrag_34","ufrag_35","ufrag_36","ufrag_37","u_0","u_1","u_2","u_3","u_4","u_5","u_6","u_7","u_8","u_10","u_13","u_14","u_15","u_16","u_17","u_18","u_19","u_20","u_21"],s:["t_0","t_1","t_2","t_3","t_4","t_5","t_6"]},{v:"precision highp float;uniform int u_0;uniform vec2 u_1;uniform vec2 u_2;uniform mat3 u_3;attribute vec2 a_v;attribute vec4 a_p1;attribute vec4 a_p2;varying vec2 c;void main(){if(u_0==0){gl_Position=vec4(a_v,0.0,1.0);}else{vec2 p;if(a_v.x > 0.0){vec2 L=(a_v.y < 0.0)? a_p1.xy : a_p2.xy;gl_Position=vec4((((u_3*vec3(L,1.0)).xy-u_1)*u_2)*vec2(2.0,-2.0),0.0,1.0);}else gl_Position=vec4(0.0,0.0,0.0,1.0);}c=a_v*vec2(0.5,-0.5)+vec2(0.5,0.5);}",f:"precision highp float;uniform float bfrag_0 [ 11 ];uniform vec4 bfrag_1 [ 11 ];uniform int ufrag_0;uniform vec2 ufrag_2;uniform int ufrag_3;uniform int ufrag_4;uniform vec2 ufrag_5;varying vec2 c;const float d=2.2;const float e=1.0/2.2;vec4 f(vec4 h,float i){if(ufrag_3==1)return vec4(pow(h.r,i),pow(h.g,i),pow(h.b,i),h.a);else return h;}vec4 j(float k){for(int l=0;l < 10;l++){if(k <=bfrag_0 [ l+1 ]){vec4 m=f(bfrag_1 [ l ],d);vec4 n=f(bfrag_1 [ l+1 ],d);return f(mix(m,n,(k-bfrag_0 [ l ])/(bfrag_0 [ l+1 ]-bfrag_0 [ l ])),e);}}return bfrag_1 [ 10 ];}float o(vec2 p,vec2 q){vec2 s=p-q;float t=dot(s,s);float u=q.x*p.y-p.x*q.y;vec2 v=s*u;float A=sqrt(t-u*u);vec2 B=s*A;vec2 C=vec2((v.y+sign(B.y)*B.x),(-v.x+abs(B.y)))/t;vec2 D=vec2((v.y-sign(B.y)*B.x),(-v.x-abs(B.y)))/t;vec2 E=sign(length(C-q)-length(D-q))==sign(dot(q-p,q))? C : D;float k=length(p-q)/length(E-q);return clamp(k,0.0,1.0);}float F(float x){return x < 0.5 ? 2.0*x*x : 2.0*x*(2.0-x)-1.0;}float G(float x,float H){return x < H ? F(x/H): F((1.0-x)/(1.0-H));}float I(float x,float H){return x < H ? x/H :(1.0-x)/(1.0-H);}void main(){float k=c.x;if(ufrag_0==1){vec2 q=ufrag_2;k=o(c*2.0-1.0,q*2.0-1.0);}if(ufrag_4 !=0){float J=G(k,ufrag_5.x)*ufrag_5.y;float K=I(k,ufrag_5.x)*ufrag_5.y;gl_FragColor=vec4(j(J).rgb,j(K).a);}else{gl_FragColor=j(k);}}",a:["a_v","a_p1","a_p2"],u:["bfrag_0","bfrag_1","ufrag_0","ufrag_2","ufrag_3","ufrag_4","ufrag_5","u_0","u_1","u_2","u_3"],s:[]},{v:"precision highp float;uniform float u_0;uniform vec2 u_1;uniform vec2 u_2;uniform vec2 u_3;uniform int u_4;attribute vec2 a_v;varying vec2 c,d,e,f,h,i,j,k,l;void main(){vec2 G=a_v;float H=u_0;vec2 I=u_1;vec2 J=u_2;vec2 K=u_3;int p=u_4;gl_Position=vec4(G.x,-G.y,0.0,1.0);vec2 L=(vec2(G.x,-G.y)*I/2.0)+vec2(0.5,0.5);if(p==1){vec2 M=J*vec2(2.0*H/(K.x*8.0),2.0*H/(K.y*8.0));vec2 N=L-J*vec2(H/K.x,H/K.y);c=N;d=N+M;e=N+M*2.0;f=N+M*3.0;h=N+M*4.0;i=N+M*5.0;j=N+M*6.0;k=N+M*7.0;l=N+M*8.0;}else{vec2 r=vec2(H/K.x,H/K.y);c=L+r*vec2(-0.7,-0.7);d=L+r*vec2(0.0,-1.0);e=L+r*vec2(0.7,-0.7);f=L+r*vec2(-1.0,0.0);h=L;i=L+r*vec2(1.0,0.0);j=L+r*vec2(-0.7,0.7);k=L+r*vec2(0.0,1.0);l=L+r*vec2(0.7,0.7);}}",f:"precision highp float;uniform sampler2D tex_0;uniform vec4 ufrag_0;uniform float ufrag_2;uniform int ufrag_3;uniform int ufrag_4;varying vec2 c,d,e,f,h,i,j,k,l;void main(){vec4 m=ufrag_0;int n=ufrag_3;float o=ufrag_2;int p=ufrag_4;vec4 q=p==1 ? vec4(1.20,1.15,1.10,1.05)*o : vec4(1.20,1.20,1.20,1.20)*o;vec4 s=texture2D(tex_0,c,q [ 0 ]);vec4 t=texture2D(tex_0,d,q [ 1 ]);vec4 u=texture2D(tex_0,e,q [ 2 ]);vec4 v=texture2D(tex_0,f,q [ 3 ]);vec4 A=texture2D(tex_0,h,o);vec4 B=texture2D(tex_0,i,q [ 3 ]);vec4 C=texture2D(tex_0,j,q [ 2 ]);vec4 D=texture2D(tex_0,k,q [ 1 ]);vec4 E=texture2D(tex_0,l,q [ 0 ]);if(n==0){vec4 F=s*0.000229+t*0.005977+u*0.060598+v*0.241732+A*0.382928+B*0.241732+C*0.060598+D*0.005977+E*0.000229;gl_FragColor=clamp(F,0.0,1.0);}else if(n==1){float F=s.a*0.000229+t.a*0.005977+u.a*0.060598+v.a*0.241732+A.a*0.382928+B.a*0.241732+C.a*0.060598+D.a*0.005977+E.a*0.000229;gl_FragColor=vec4(m.rgb,1.0)*m.a*F;}else if(n==2){float F=min(min(min(min(s.a,t.a),min(u.a,v.a)),min(min(A.a,B.a),min(C.a,D.a))),E.a);gl_FragColor=vec4(m.rgb,1.0)*m.a*F;}else if(n==3){float F=max(max(max(max(s.a,t.a),max(u.a,v.a)),max(max(A.a,B.a),max(C.a,D.a))),E.a);gl_FragColor=vec4(m.rgb,1.0)*m.a*F;}}",a:["a_v"],u:["ufrag_0","ufrag_2","ufrag_3","ufrag_4","u_0","u_1","u_2","u_3","u_4"],s:["tex_0"]},{v:"precision highp float;attribute vec2 a_v;varying vec2 c;void main(){vec2 v=a_v;gl_Position=vec4(v.x,-v.y,0.0,1.0);c=(vec2(v.x,v.y)/2.0)+vec2(0.5,0.5);}",f:"precision highp float;varying vec2 c;const int d=1,e=2,f=3,h=4,i=5,j=6,k=7,l=8,m=9,n=10,o=11,p=12;uniform int ufrag_0;uniform float ufrag_1;void main(){const float PI=3.141592653;const float q=0.707106781;int s=ufrag_0;float t=ufrag_1;float u=0.0,x=c.x,y=c.y;if(s==d)u=1.0-x*t;else if(s==e)u=max(abs(x*2.0-1.0),abs(y*2.0-1.0));else if(s==f)u=1.0-(x*t+floor(y*t)/2.0);else if(s==h)u=length(c*2.0-vec2(1.0,1.0))*q;else if(s==i)u=(abs(x*2.0-1.0)+abs(y*2.0-1.0))*0.5;else if(s==j)u=fract(sin(dot(c,vec2(12.9898,78.233)))*43758.5453);else if(s==k)u=min(abs(x*2.0-1.0),abs(y*2.0-1.0));else if(s==l)u=fract(sin(x*12.9898)*43758.5453);else if(s==m)u=abs(x*2.0-1.0);else if(s==n)u=1.0-(ceil(x*t)+ceil(y*t))/(2.0*t);else if(s==o)u=1.0-atan(abs(x-0.5),0.5-y)/PI;else if(s==p)u=1.0-atan(x-0.5,0.5-y)*t/(2.0*PI);gl_FragColor=vec4(mod(u,1.0),0.0,0.0,1.0);}",a:["a_v"],u:["ufrag_0","ufrag_1"],s:[]},{v:"precision highp float;attribute vec2 a_v;attribute vec4 a_0;attribute vec4 a_1;varying vec2 c;const int f=0,h=1,i=2,j=3;void main(){vec2 k=a_v;vec4 l=a_0,m=a_1;vec2 n=k*0.5+0.5;c=vec2(l [ f ]+(l [ i ]-l [ f ])*n.x,1.0-(l [ h ]+(l [ j ]-l [ h ])*n.y));gl_Position=vec4((m [ f ]+(m [ i ]-m [ f ])*n.x)*2.0-1.0,1.0-((m [ h ]+(m [ j ]-m [ h ])*n.y)*2.0),0.0,1.0);}",f:"precision highp float;uniform sampler2D t_0;uniform float ufrag_0;varying vec2 c;void main(){float d=ufrag_0;vec4 e=texture2D(t_0,c);e.rgb=(e.rgb-0.5)*d+0.5;gl_FragColor=e;}",a:["a_v","a_0","a_1"],u:["ufrag_0"],s:["t_0"]}],ti=[{attributeName:name,attributeSize:1,offset:0,divisor:0,index:-1}],ri={x:0,y:0,width:1,height:1},ii=[{attributeName:"",index:0,attributeSize:2,offset:0,divisor:0}],ni=function(){function e(e,t,r,i){this.m_shaderPrograms=new Array(6),this.m_isInitializeReady=!0,this.m_isInScope=!1,this.m_stateRestorer=i,this.m_wipeStateBetweenScopes=t,this.m_disableParallelShaderCompile=r,this.setWebGLContext(e)}return e.prototype.getBabylonEngine=function(){return this.m_engine},Object.defineProperty(e.prototype,"quadMesh",{get:function(){return this.m_quadMesh},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture",{get:function(){return this.m_emptyTexture},enumerable:!0,configurable:!0}),e.prototype.needPowerOf2TexturesForTilingOrMipMap=function(){return this.m_needPowerOf2TexturesForTilingOrMipMap},e.prototype.isCurrentWebGLContext=function(e){return this.m_gl==e},e.prototype.setWebGLContext=function(e){if(this.m_gl!=e){this.m_engine&&(this.m_emptyTexture&&this.m_engine._releaseTexture(this.m_emptyTexture),this.m_quadMesh&&this.m_quadMesh.discard()),this.m_gl=e;var t=e.canvas.width,r=e.canvas.height;this.m_canvasRenderSize=new w(t,r),this.m_engine=new Jr(e),this.m_engine.preventCacheWipeBetweenFrames=!0,this.m_engine.doNotHandleContextLost=!0,this.m_engine.setSize(t,r),this.m_engine.setViewport(ri);var i=this.m_engine.getCaps();this.m_parallelShaderCompilationExtension=i.parallelShaderCompile,i.parallelShaderCompile=void 0,this.m_renderToFilteredFloat=i.textureFloatRender&&i.textureFloatLinearFiltering,this.m_renderToFilteredHalfFloat=i.textureHalfFloatRender&&i.textureHalfFloatLinearFiltering,this.m_needPowerOf2TexturesForTilingOrMipMap=this.m_engine.needPOTTextures,this.m_uniqueGraphicsProcessorId=$r,$r++;for(var n=0;n<6;n++)this.m_shaderPrograms[n]=void 0}},e.prototype.updateViewportSize=function(){var e=this.m_gl.canvas.width,t=this.m_gl.canvas.height;this.m_canvasRenderSize=new w(e,t),this.m_engine.setSize(e,t),this.m_engine.setViewport(ri)},e.prototype.onWebGLContextLost=function(){for(var e=0;e<6;e++)this.m_shaderPrograms[e]=void 0},e.prototype.initializeProgramsAsync=function(){return y(this,void 0,void 0,(function(){var e,t,r,i;return b(this,(function(n){switch(n.label){case 0:if(this.m_isInitializeReady=!1,e=this.m_engine.getCaps(),this.m_disableParallelShaderCompile||(e.parallelShaderCompile=this.m_parallelShaderCompilationExtension),t=[],!this.beginRenderScopeInternal(!1))throw l.Error(592328457,"Failed to enter render scope.");for(r=0;r<6;r++)i=this.getProgramInWebGlScope(r),t.push(i.enureDoneAsync());return this.endRenderScopeInternal(!1),[4,Promise.all(t)];case 1:return n.sent(),this.m_isInitializeReady=!0,[2]}}))}))},e.prototype.isInRenderScope=function(){return this.m_isInScope},e.prototype.beginRenderScope=function(){if(!this.m_isInitializeReady)throw l.Error(592525269,"Please, wait for onDone to be called in initialize.");return this.beginRenderScopeInternal(!0)},e.prototype.endRenderScope=function(){this.endRenderScopeInternal(!0)},e.prototype.beginRenderScopeInternal=function(e){var t=this.m_gl.isContextLost();return this.m_isInScope&&l.Error(592525270,"already in glContext scope"),t&&l.Error(592525271,"Invalnew glContext context is lostid"),!this.m_gl||t?this.m_isInScope=!1:(this.m_isInScope=!0,e&&(this.m_stateRestorer?(this.m_stateRestorer.init(this.m_gl),this.m_stateRestorer.setDefaults(),this.m_engine.wipeCaches(!0)):this.m_wipeStateBetweenScopes&&this.m_engine.wipeCaches(!0)),this.ensureVertexBufferAndMaxTapeInitialized()),this.m_isInScope},e.prototype.endRenderScopeInternal=function(e){this.m_isInScope?this.m_gl.isContextLost()?l.Error(592525273,"leaving glContext context is lost"):this.m_stateRestorer&&e&&this.m_stateRestorer.restore():l.Error(592525272,"leaving glContext not in scope"),this.m_isInScope=!1},e.prototype.ensureVertexBufferAndMaxTapeInitialized=function(){this.m_emptyTexture||(this.m_emptyTexture=this.createTextureGraphicsResource(w.One,new Uint8Array([0,0,0,0]),!0,!1,!1,!1,4,!1)),this.m_quadMesh||(this.m_quadMesh=bt.CreateGridXY(this,new w(2,2),new P(-1,-1,1,1)))},e.prototype.getProgramInWebGlScope=function(e){var t=this.m_shaderPrograms[e];return t||(t=this.m_shaderPrograms[e]=new si(this,e)),t},e.prototype.createTextureGraphicsResourceFromExternalWebGLTexture=function(e,t,r){var i=t instanceof WebGLTexture?t:null;if(t instanceof Pr&&(i=t._webGLTexture),!i)throw l.Error(592525275,"wrong texture type");var n=new Pr(this.m_engine,0);return n._webGLTexture=i,r&&(n._framebuffer=r),n.width=e.x,n.height=e.y,n.baseWidth=e.x,n.baseHeight=e.y,n},e.prototype.createTextureGraphicsResource=function(e,t,r,i,n,s,o,a){if(t instanceof HTMLImageElement){var h,c=this.m_gl;if(h=c.createTexture())return c.bindTexture(c.TEXTURE_2D,h),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.bindTexture(c.TEXTURE_2D,null),this.createTextureGraphicsResourceFromExternalWebGLTexture(e,h,void 0)}var u,d=this.m_engine,f=0;i&&this.m_renderToFilteredHalfFloat?f=2:i&&this.m_renderToFilteredFloat&&(f=1);var p=r?5:4,g=a?2:1;if(n){u=d.createRenderTargetTexture({width:e.x,height:e.y},{generateDepthBuffer:!1,generateStencilBuffer:s,format:p,type:f,samplingMode:g,generateMipMaps:!1})}else{if(i)throw l.Error(592525276,"wrong texture format outside of renderTarget");var m=new Pr(d,vr.Unknown);m.updateSize(e.x,e.y),m.type=f,m.format=p,d.updateTextureSamplingMode(g,m),t instanceof Uint8Array&&d._uploadArrayBufferViewToTexture(m,t),u=m}return this.setWrapMode(u,o),u},e.prototype.setRenderTarget=function(e){e?(this.m_engine.bindFramebuffer(e),this.m_currentRenderTarget=e):(this.m_engine.restoreDefaultFramebuffer(),this.m_currentRenderTarget=void 0)},e.prototype.generateMipMap=function(e){this.m_engine.updateTextureSamplingMode(3,e,!0)},e.prototype.setWrapMode=function(e,t){var r=4==t?0:1==t||3==t?2:1,i=4==t?0:2==t||3==t?2:1;this.m_engine.updateTextureWrappingMode(e,r,i)},e.prototype.copyTexturePixelsToArray=function(e,t,r){var i=Math.floor(t.left),n=Math.floor(t.top),s=Math.floor(t.width),o=Math.floor(t.height);this.setRenderTarget(e);var a=this.m_engine.readPixels(i,n,s,o,r);return this.setRenderTarget(void 0),a},e.prototype.getCurrentViewportSize=function(){return this.m_currentRenderTarget?new w(this.m_currentRenderTarget.width,this.m_currentRenderTarget.height):this.m_canvasRenderSize},e.prototype.getUniqueGraphicsProcessorId=function(){return this.m_uniqueGraphicsProcessorId},e.prototype.isFloatTextureSupported=function(){return this.m_renderToFilteredFloat||this.m_renderToFilteredHalfFloat},e.prototype.activateShaderProgram=function(e){var t=this.getProgramInWebGlScope(e);return t.activate(),t},e.prototype.preCompileShaderAsync=function(e){this.beginRenderScopeInternal(!1)&&(this.getProgramInWebGlScope(e),this.endRenderScopeInternal(!1))},e.prototype.preLinkShaderAsync=function(e){this.preCompileShaderAsync(e)},e.prototype.tryPrepareProgramResourcesInWebGlScope=function(e){for(var t=0;t<2;t++)this.m_shaderPrograms[t]||this.getProgramInWebGlScope(t);return!0},e}(),si=function(){function e(e,t){this.graphicsProcessor=e,this.m_engine=e.getBabylonEngine(),this.programId=t,this.m_effect=this.createEffect()}return e.prototype.getBabylonEngine=function(){return this.m_engine},e.prototype.getBabylonEffect=function(){return this.m_effect},e.prototype.done=function(){return void 0!==this.effectErrors||this.m_effect.isReady()},e.prototype.enureDoneAsync=function(){var e=this;return new Promise((function(t,r){e.done()?t():(e.m_effect.onCompileObservable.add((function(){return t()})),e.m_effect.onErrorObservable.add(r))}))},e.prototype.createEffect=function(){var e=this;return l.Message(592525280,"Compiling shader "+this.programId),new Vr({vertexSource:ei[this.programId].v,fragmentSource:ei[this.programId].f,spectorName:this.programId},ei[this.programId].a,ei[this.programId].u,ei[this.programId].s,this.m_engine,void 0,void 0,void 0,(function(t,r){e.effectErrors=r}))},e.prototype.activate=function(){this.handleActivationErrors(),this.m_engine.enableEffect(this.m_effect),this.m_currentMesh=void 0,this.bindMesh(void 0)},e.prototype.bindMesh=function(e){var t=e||this.graphicsProcessor.quadMesh;t&&t.isValid(this.graphicsProcessor)?this.m_currentMesh!=t&&(t.vertexBuffer&&t.indexBuffer&&t.isValid(this.graphicsProcessor)&&(this.m_engine._bindIndexBufferWithCache(t.indexBuffer),ii[0].index=this.m_effect.getAttributeLocationByName("a_v"),this.m_engine.bindInstancesBuffer(t.vertexBuffer,ii,!1)),this.m_currentMesh=t):l.Error(592525281,"Invalid Mesh")},e.prototype.handleActivationErrors=function(){if(this.effectErrors||!this.m_effect.isReady()){var e="Program "+this.programId+" ";if(this.effectErrors){var t=this.m_effect.getPipelineContext();if(t.vertexCompilationError)throw l.Error(592525282,e+"V compile failed: "+t.vertexCompilationError);if(t.fragmentCompilationError)throw l.Error(592525283,e+"V compile failed: "+t.fragmentCompilationError);if(t.programLinkError)throw l.Error(592525312,e+"link failed: "+t.programLinkError);if(t.programValidationError)throw l.Error(592525313,e+"validation failed: "+t.programValidationError);throw l.Error(592525314,e+"preparation failed:"+this.effectErrors)}if(!this.m_effect.isReady())throw l.Error(592525315,e+"Effect not ready yet.")}},e.prototype.setTexture=function(e,t){var r=t||this.graphicsProcessor.emptyTexture;this.m_effect._bindTexture(e,r||null)},e.prototype.clearAndEnbaleDepthBuffer=function(){this.m_engine.depthCullingState.depthFunc=513,this.m_engine.depthCullingState.depthMask=!0,this.m_engine.depthCullingState.depthTest=!0,this.m_engine.clear(null,!1,!0,!1)},e.prototype.setDistanceFieldStencilSumIncrement=function(e){var t=e?34055:34056,r=this.m_engine;r.stencilState.stencilOpStencilFail=t,r.stencilState.stencilOpDepthFail=t,r.stencilState.stencilOpStencilDepthPass=t},e.prototype.setBlendingMode=function(e){var t=this.m_engine;t.alphaState.alphaBlend=!0,0==e?(t.alphaState.setAlphaBlendFunctionParameters(1,771,1,771),t.alphaState.setAlphaEquationParameters(32774,32774)):1==e?(t.alphaState.setAlphaBlendFunctionParameters(1,1,0,1),t.alphaState.setAlphaEquationParameters(32775,32774)):2==e?(t.alphaState.setAlphaBlendFunctionParameters(775,769,0,1),t.alphaState.setAlphaEquationParameters(32774,32774)):3==e?(t.alphaState.setAlphaBlendFunctionParameters(1,1,1,1),t.alphaState.setAlphaEquationParameters(32779,32779)):l.Error(592525318,"Wrong blending mode")},e.prototype.begin=function(e,t,r){var i=this.m_engine;this.graphicsProcessor.setRenderTarget(e),this.m_engine.setViewport(ri),t&&i.clear(t,!0,!1,!1),r?this.setBlendingMode(0):i.alphaState.alphaBlend=!1,i.depthCullingState.depthTest=!1,i.depthCullingState.depthMask=!0,i.stencilState.stencilTest=!1,i.stencilState.stencilMask=255,i.setColorWrite(!0)},e.prototype.end=function(){this.graphicsProcessor.setRenderTarget(void 0),this.m_engine.unbindInstanceAttributes(),this.m_engine.setViewport(ri)},e.prototype.drawQuads=function(e){this.bindMesh(void 0),this.m_engine.drawElementsType(0,0,6*e)},e.prototype.drawQuadInstances=function(e){this.bindMesh(void 0),this.m_engine.drawElementsType(0,0,6,e)},e.prototype.drawMesh=function(e){this.bindMesh(e),this.m_engine.drawElementsType(0,0,3*e.triangleCount)},e.prototype.setDummyPointerAttribute=function(e){if(this.graphicsProcessor.quadMesh&&this.graphicsProcessor.quadMesh.vertexBuffer){var t=this.graphicsProcessor.quadMesh.vertexBuffer,r=this.m_engine;ti[0].index=this.m_effect.getAttributeLocationByName(e),r.bindInstancesBuffer(t,ti,!1)}else l.Error(592525319,"Quad not initialized")},e.prototype.disableInstanceAttribute=function(e){this.m_engine.disableInstanceAttributeByName(e)},e}(),oi={itemHit:void 0,itemStack:void 0,textHit:void 0},ai=function(){function e(){this.cache=new pr}return e.prototype.releaseGeneratedResources=function(){this.cache.clear()},e}(),hi=function(){function e(){this.index=0}return Object.defineProperty(e.prototype,"color",{get:function(){var e=this.index%256,t=(this.index-e)/256%256,r=(this.index-e-256*t)/65536%256;return new Q(e/255,t/255,r/255,1)},enumerable:!0,configurable:!0}),e.prototype.next=function(){this.index++},e}(),ci=function(e,t,r,i){var n=e&&e.fade?e.fade:t.fade;if(n){if(this.fade=n.clone(),n.isDistributedByLength&&e&&e.drawDistribution&&i+1<e.drawDistribution.length){var s=e.drawDistribution[i],o=e.drawDistribution[i+1];this.fade.progress=(n.progress-s)/(o-s)}else n.isDistributedByLength&&e&&l.Error(592525086,"Unable to distribute by length"),this.fade.progress=n.progress;if(2==t.getType()&&n.isDistributedByLength){if(!r.cache.drawDistribution){var a=0,h=function(e){for(var t=0,r=e.paths||[];t<r.length;t++){var i=r[t];a+=i.measureLength(T.FromTransforms(i.transform,e.transform))}return!0};_e(t,h);var c=a,u=0,d=t;r.cache.drawDistribution=[];for(var f=0;f<d.items.length;f++)r.cache.drawDistribution.push(u/c),a=0,_e(d.items.getAt(f),h),u+=a;r.cache.drawDistribution.push(1)}this.drawDistribution=r.cache.drawDistribution}}},li=1,ui=function(){function e(e){this.m_babylonWipeStateBetweenScopes=!0,this.m_babylonDisableParallelShaderCompile=!1,this.m_currentFramePerformanceSummary=new ot,this.m_babylonWipeStateBetweenScopes=!!e.stateRestorer,this.m_babylonDisableParallelShaderCompile=1==e.babylonDisableParallelShaderCompile,this.m_stateRestorer=e.stateRestorer,this.m_morphPlayer=e.morphPlayer,this.m_debugStringProvider=e.debugStringProvider,this.m_perfSummary=new at,this.m_rendererId="🦆"+li++}return e.prototype.hasMorphPlayer=function(){return!!this.m_morphPlayer},e.prototype.setMorphPlayer=function(e){this.m_morphPlayer=e},e.prototype.hasDebugStringProvider=function(){return!!this.m_debugStringProvider},e.prototype.setDebugStringProvider=function(e){this.m_debugStringProvider=e},e.prototype.initializeAsync=function(e){return y(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:if(this.setWebGLContext(e),!this.m_graphicsProcessor)throw l.Error(592328459,"Failed to initialize graphics processor.");return[4,this.m_graphicsProcessor.initializeProgramsAsync()];case 1:return t.sent(),[2]}}))}))},e.prototype.setWebGLContext=function(e){this.m_graphicsProcessor&&!this.m_graphicsProcessor.isCurrentWebGLContext(e)&&this.onWebGLContextLost(),this.m_graphicsProcessor?this.m_graphicsProcessor.setWebGLContext(e):this.m_graphicsProcessor=new ni(e,this.m_babylonWipeStateBetweenScopes,this.m_babylonDisableParallelShaderCompile,this.m_stateRestorer)},e.prototype.onWebGLContextLost=function(){if(this.m_scratchBuffers){for(var e=0,t=this.m_scratchBuffers;e<t.length;e++){t[e].release()}this.m_scratchBuffers=void 0}zt={},Wt=[],Vt=void 0,this.m_graphicsProcessor&&(this.m_graphicsProcessor.onWebGLContextLost(),this.m_graphicsProcessor=void 0)},e.prototype.getGraphicsProcessor=function(){return this.m_graphicsProcessor},e.prototype.getPerformanceSummary=function(){var e=function(e){return Math.round(1e3*(e+100*Number.EPSILON))/1e3},t=function(t){if(t){var r=t;for(var i in r)i.endsWith("Ms")&&(r[i]=e(r[i]))}};return this.m_perfSummary.averageFrameCost&&(this.m_perfSummary.averageFrameCost=e(this.m_perfSummary.averageFrameCost)),t(this.m_perfSummary.perfInfoCurrentFrame),t(this.m_perfSummary.perfInfoFirstFrame),t(this.m_perfSummary.perfInfoSumOfAllFrames),this.m_perfSummary},e.prototype.resetPerformanceSummary=function(){this.m_perfSummary=new at},e.prototype.getCurrentFramePerformanceSummary=function(){return this.m_currentFramePerformanceSummary},e.prototype.getDebugStringProvider=function(){return this.m_debugStringProvider},e.prototype.ensureScratchBuffers=function(){if(!this.m_scratchBuffers){this.m_scratchBuffers=[];for(var e=0;e<2;e++)this.m_scratchBuffers.push(new gt(this,new w(2048,2048),!0))}return this.m_scratchBuffers},e.prototype.ensureRenderNode=function(e){var t=e.renderDataMap[this.m_rendererId];return t||(t=new ai,e.renderDataMap[this.m_rendererId]=t),t},e.prototype.ensurePathRenderData=function(e){var t=e.renderDataMap[this.m_rendererId];return t||(t=new ir,e.renderDataMap[this.m_rendererId]=t),t},e.prototype.ensureImageRenderData=function(e){var t=e.renderDataMap[this.m_rendererId];return t||(t=new sr,e.renderDataMap[this.m_rendererId]=t),t},e.prototype.ensureMorphKeyFrameRenderData=function(e){var t=e.renderDataMap[this.m_rendererId];return t||(t=new gr,e.renderDataMap[this.m_rendererId]=t),t},e.prototype.ensureMorphElementRenderData=function(e){var t=e.renderDataMap[this.m_rendererId];return t||(t=new gr,e.renderDataMap[this.m_rendererId]=t),t},e.prototype.attachTextureToImage=function(e,t){var r=this.ensureImageRenderData(e);e.changeTracker.replaceListener(r.texture,t),r.texture=t},e.prototype.getTextureFromImage=function(e){if(e)return this.ensureImageRenderData(e).texture},e.prototype.deleteAllTextures=function(e){e.releaseGeneratedResources()},e.prototype.tryGetImageDebugData=function(e){var t=this.ensureImageRenderData(e);return new nr(t.state,t.texture)},e.prototype.getDebugGlyphCacheInfo=function(e){return function(e){var t=Ut(e);if(t){var r=zt[t];if(r)return r.page}}(e)},e.prototype.generateTextureMemoryReport=function(e,t){for(var r={externalImages:0,managedImages:0,scratchBuffers:this.hasHitTestTexture()?4:0,glyphPages:0,shapeDistanceFields:0,textDistanceFields:0,otherBrushes:0,effects:0,rasterizedItems:0,fadeMasks:0,morphTextures:0,totalTarget:0,totalTargetExpected:lt,renderBuffers:0,renderBuffersExpected:ut},i=0,n=this.m_scratchBuffers||[];i<n.length;i++){var s=n[i];r.scratchBuffers+=s.getMemoryUsage()}for(var o=0,a=Vt||[];o<a.length;o++){var h=a[o];r.glyphPages+=h.getMemoryUsage()}for(var c=0,l=e;c<l.length;c++){gi(this,l[c],r)}for(var u=0,d=t||[];u<d.length;u++){mi(this,d[u],r)}return r.totalTarget=r.scratchBuffers+r.glyphPages+r.shapeDistanceFields+r.textDistanceFields+r.otherBrushes+r.effects+r.rasterizedItems+r.fadeMasks+r.morphTextures,r},e.prototype.initOutOfTime=function(){return this.m_initDeadline&&this.m_initDeadline<performance.now()},e.prototype.render=function(e,t,r){var i=this.m_graphicsProcessor;if(i){var n=performance.now();if(!i||i.beginRenderScope()){var s=new ot;s.glResetCostMs+=performance.now()-n,s.beginTime=(new Date).getTime(),this.m_currentFramePerformanceSummary=s,s.totalCostMs=-performance.now(),this.tryPrepareItemInWebGlScope(e,i,!0,void 0)||l.Error(592525120,"could not fully prepare scene"),s.shapeRenderCostMs=-performance.now(),this.renderItemInWebGLRenderScope(e,t,r);var o=r&&r.target instanceof gt?r&&r.target.size:i.getCurrentViewportSize();if(s.shapeRenderCostMs+=performance.now(),s.glRestoreCostMs=-performance.now(),i.endRenderScope(),s.glRestoreCostMs+=performance.now(),s.totalCostMs+=performance.now(),s.endTime=(new Date).getTime(),this.m_perfSummary.perfInfoCurrentFrame=s,this.m_perfSummary.perfInfoFirstFrame||(this.m_perfSummary.perfInfoFirstFrame=s),this.m_perfSummary.perfInfoSumOfAllFrames||(this.m_perfSummary.perfInfoSumOfAllFrames=new ot),this.m_perfSummary.perfInfoSumOfAllFrames.add(s),this.m_perfSummary.frameCount++,this.m_perfSummary.averageFrameCost=this.m_perfSummary.perfInfoSumOfAllFrames.totalCostMs/this.m_perfSummary.frameCount,this.m_perfSummary.viewWidth=o.x,this.m_perfSummary.viewHeight=o.y,this.m_perfSummary.frameCount>1){var a=(this.m_perfSummary.perfInfoSumOfAllFrames.totalCostMs-this.m_perfSummary.perfInfoFirstFrame.totalCostMs)/(this.m_perfSummary.frameCount-1);this.m_perfSummary.estimatedFps=Math.floor(Math.min(1e3/a,60))}else this.m_perfSummary.estimatedFps=Math.floor(Math.min(1e3/this.m_perfSummary.perfInfoCurrentFrame.shapeRenderCostMs,60));this.m_currentFramePerformanceSummary=new ot}}else l.Error(592525091,"glContext must be provided")},e.prototype.renderItemInWebGLRenderScope=function(e,t,r){var i=this.m_graphicsProcessor;if(i){i.updateViewportSize();var n=r?r.target:void 0,s=n?n.size:i.getCurrentViewportSize(),o=r?r.transform:void 0,a=i.activateShaderProgram(1);a.begin(n?n.babylonTexture:void 0,t,!0),this.drawItem(31,a,e,s,T.Identity,void 0,o?o.toMatrix3():T.Identity,0,void 0,!1,r),a.end()}else l.Error(592525121,"glContext must be provided")},e.prototype.renderMorph=function(e,t,r,i){if(!this.m_morphPlayer)throw l.Error(591667344,"Morph not available for this renderer");this.m_morphPlayer.renderMorph(this,e,t,r,i)},e.prototype.tryPrepareMorph=function(e,t){if(!this.m_morphPlayer)throw l.Error(591667345,"Morph not available for this renderer");return this.m_morphPlayer.tryPrepareMorph(this,e,t)},e.prototype.tryGetImageDebugDataForMorphKeyFrame=function(e){var t=this.ensureMorphKeyFrameRenderData(e);return t.texture?new nr(1,t.texture):void 0},e.prototype.renderLayers=function(e,t,r){var i=this.m_graphicsProcessor;if(i){if(!i||i.beginRenderScope()){var n=this.m_targetTexture?this.m_targetTexture.size:i.getCurrentViewportSize(),s=i.activateShaderProgram(1);s.begin(this.m_targetTexture?this.m_targetTexture.babylonTexture:void 0,t,!0);for(var o=0;o<e.length;o++){Ft(e[o],s,n,r?r.toMatrix3():void 0,void 0)}s.end(),i.endRenderScope()}}else l.Error(592525125,"glContext must be provided")},e.prototype.retrieveHitTestResult=function(e,t,r,i){if(t==r.index){var n={itemHit:e,itemStack:[e],textHit:void 0};if(e instanceof ge){var s=e.text;if(s){var o=i.transformPoint(T.FromTransforms(new x(e.transform.translation.negate(),e.transform.scale.inverse()),s.frameToShape.toInverseMatrix3(),s.layoutToFrame.toInverseMatrix3()));n.textHit=s.hitTest(o)?s.getSelectionFromLayoutPosition(o):void 0}}return n}if(e instanceof me)for(var a=0,h=e.items.elements;a<h.length;a++){var c=h[a];r.next();var l=this.retrieveHitTestResult(c,t,r,i.transformPoint(e.transform.toInverseMatrix3()));if(l&&l.itemStack)return l.itemStack.splice(0,0,e),l}},e.prototype.hitTestScene=function(e,t,r,i){var n=this.m_graphicsProcessor;if(!n)return l.Error(592525129,"glContext must be provided"),oi;if(2!=e.getType())return l.Error(592525130,"rootItem must be a group"),oi;var s=e;if(!n.beginRenderScope())return oi;this.tryPrepareItemInWebGlScope(e,n,!0,void 0)||l.Error(592525131,"could not fully prepare"),this.m_hitTestTexture&&this.m_hitTestTexture.isValid(this)||(this.m_hitTestTexture=new gt(this,w.One,!0,!1));var o=new hi,a=n.activateShaderProgram(1);a.begin(this.m_hitTestTexture.babylonTexture,Q.Transparent,!0);var h=w.One,c=r?r.toMatrix3().multiply(T.Translation2D(t.negate())):T.Translation2D(t.negate());this.drawItem(0,a,s,h,T.Identity,void 0,c,4,o,!1,{filter:i}),a.end();var u=this.m_hitTestTexture&&this.m_hitTestTexture.babylonTexture?n.copyTexturePixelsToArray(this.m_hitTestTexture.babylonTexture,new P(0,0,1,1),!0):void 0;if(n.endRenderScope(),!u||0==u[3])return oi;var d=u[0]+256*u[1]+65536*u[2];o=new hi;var f=r instanceof T?r.tryGetTransform(w.Zero):r,p=f?f.toInverseMatrix3():void 0,g=this.retrieveHitTestResult(s,d,o,p?t.transformPoint(p):t);if(g)return g;throw l.Error(592525132,"Unable to retrieve hit shape")},e.prototype.hasHitTestTexture=function(){return null!=this.m_hitTestTexture},e.prototype.tryInitTextures=function(e,t,r,i,n){if(t.isHidden)return!0;var s=this.ensureRenderNode(t);s.cache.checkIfUpdateNeeded(t,e);var o=new ci(i,t,s,n);if(1==t.getType()){var a=t;if(a.incrementalPath&&(s.cache.initTextureStage=dr.fromBegining),s.cache.initTextureStage<dr.distanceFieldsReady){if(a.incrementalPath)s.cache.distanceFields&&1==s.cache.distanceFields.length||(s.cache.distanceFields=[new Gt(this,void 0,0)]);else if(a.paths&&!s.cache.distanceFields&&!a.isSolidRect()){var h=-performance.now();if(s.cache.distanceFields=[],a.paths&&a.paths.length>0)for(var c=0,u=0,d=a.paths[0].fillMode,f=0;f<a.paths.length;f++){var p=f==a.paths.length-1,g=p?0:a.paths[f+1].fillMode;if(p||g!=d)a.style.hasLine&&(0!=a.style.pen.headEnd.end||0!=a.style.pen.tailEnd.end)?(0!=d&&null!=a.style.fillBrush&&s.cache.distanceFields.push(new Gt(this,Ee.FromFirstLast(c,u),d,a.mergeMode,1)),s.cache.distanceFields.push(new Gt(this,Ee.FromFirstLast(c,u),d,a.mergeMode,2))):s.cache.distanceFields.push(new Gt(this,Ee.FromFirstLast(c,u),d,a.mergeMode,0)),d=g,c=f+1;u=f+1}if(h+=performance.now(),3==a.role?this.m_currentFramePerformanceSummary.distanceFieldForTextCostMs+=h:this.m_currentFramePerformanceSummary.distanceFieldForShapeCostMs+=h,this.initOutOfTime())return!1}for(var m=0,_=s.cache.distanceFields||[];m<_.length;m++){var v=_[m],y=(h=-performance.now(),null!=a.incrementalPath),b=v.refresh(this,t,!0,y);if(!b&&y&&(b=v.refresh(this,t,!0,!1)),b||l.Error(592525133,"error in distanceField refresh"),h+=performance.now(),3==a.role?this.m_currentFramePerformanceSummary.distanceFieldForTextCostMs+=h:this.m_currentFramePerformanceSummary.distanceFieldForShapeCostMs+=h,this.initOutOfTime())return!1}s.cache.initTextureStage=dr.distanceFieldsReady}if(s.cache.initTextureStage<dr.brushTexturesReady){if(s.cache.initBrushTexture(this,t,0),this.initOutOfTime())return!1;if(s.cache.initBrushTexture(this,t,1),this.initOutOfTime())return!1;if(s.cache.initBrushTexture(this,t,2),this.initOutOfTime())return!1;s.cache.initTextureStage=dr.brushTexturesReady}if(a.text&&a.text.cache){for(var w=0,x=0,P=a.text.cache.textShapes||[];x<P.length;x++){var C=P[x];if(a.text.animationProps)if(C.textRange){var E=a.text.animationProps.getAt(C.textRange.start);C.fade=E.fade,C.animationTransform=E.animationTransform,C.isHidden=E.isHidden}else l.Error(592525134,"no range");else C.fade=void 0,C.animationTransform=T.Identity,C.isHidden=!1;if(!this.tryInitTextures(e,C,r,o,w))return!1;w++}for(var S=0,R=a.text.cache.selectionShapes||[];S<R.length;S++){var M=R[S];if(!this.tryInitTextures(e,M,r,o,0))return!1}}}else{if(2!=t.getType())throw l.Error(592525135,"Unknown Item type");if(s.cache.initTextureStage<dr.brushTexturesReady&&(s.cache.initBrushTexture(this,t,0),s.cache.initTextureStage=dr.brushTexturesReady),2==t.getType()){var I=t;for(f=0;f<I.items.length;f++){var A=I.items.getAt(f);if(A&&!this.tryInitTextures(e,A,r,o,f))return!1;if(this.initOutOfTime())return!1}}}var F=-performance.now();if(s.cache.fade=o.fade,s.cache.initFadeTexture(this,t,o.fade),F+=performance.now(),t.fade&&(this.m_currentFramePerformanceSummary.fadeTextureCostMs+=F),this.initOutOfTime())return!1;if(r&&s.cache.initTextureStage<dr.effectsReady){if(t.effects){if(t.effects.innerShadow&&t.effects.innerShadow.color.a>0&&(!s.cache.innerShadowTexture||s.cache.innerShadowTexture.isDirty)&&(s.cache.innerShadowTexture=this.initTextureRasterizedItem(t,0,s.cache.innerShadowTexture,Q.Black,t.effects.innerShadow.radius,8,2),this.initOutOfTime()))return!1;if(t.effects.softEdges&&t.effects.softEdges.radius>0&&(!s.cache.softEdgesTexture||s.cache.softEdgesTexture.isDirty)&&(s.cache.softEdgesTexture=this.initTextureRasterizedItem(t,0,s.cache.softEdgesTexture,Q.Black,t.effects.softEdges.radius,16,3),this.initOutOfTime()))return!1;if(t.effects.glow&&t.effects.glow.radius>0&&t.effects.glow.color.a>0&&(!s.cache.glowTexture||s.cache.glowTexture.isDirty)&&(s.cache.glowTexture=this.initTextureRasterizedItem(t,16,s.cache.glowTexture,t.effects.glow.color,t.effects.glow.radius?2*t.effects.glow.radius:0,1,3),this.initOutOfTime()))return!1;if(t.effects.shadow&&t.effects.shadow.color.a>0&&(!s.cache.shadowTexture||s.cache.shadowTexture.isDirty)&&(s.cache.shadowTexture=this.initTextureRasterizedItem(t,17,s.cache.shadowTexture,t.effects.shadow.color,t.effects.shadow.radius?t.effects.shadow.radius:0,2,3),this.initOutOfTime()))return!1;if(t.effects.reflection&&(!s.cache.reflectionTexture||s.cache.reflectionTexture.isDirty)&&(s.cache.reflectionTexture=this.initTextureRasterizedItem(t,27,s.cache.reflectionTexture,void 0,t.effects.reflection.radius,4,3),this.initOutOfTime()))return!1}s.cache.initTextureStage=dr.effectsReady}if(r)if(t.fade&&13!=t.fade.preset){if((!s.cache.spriteTexture||s.cache.spriteTexture.isDirty||this.hasAnimatedContentTexture(t))&&(s.cache.spriteTexture=this.initTextureRasterizedItem(t,31,s.cache.spriteTexture,void 0,0,0,1),this.initOutOfTime()))return!1}else s.cache.spriteTexture&&s.cache.spriteTexture.release(),s.cache.spriteTexture=void 0;return!0},e.prototype.tryPreparePaths=function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];if(this.ensurePathRenderData(i).refreshCachedTapeBuffers(i),this.initOutOfTime())return!1}return!0},e.prototype.tryPrepareGeneratedShapes=function(e){var t=this;return _e(e,(function(e){return!e.text||(e.text.cache||(e.text.cache=new He),e.text.cache.update(e.text),!t.initOutOfTime())}))},e.prototype.tryPrepareTapes=function(e){var t=this;return _e(e,(function(e){if(e.paths){if(!t.tryPreparePaths(e.paths))return!1;if(e.shapeBoundsCache.pathsBounds||e.style.hasLine||(e.shapeBoundsCache.pathsBounds=q(e.paths)),t.initOutOfTime())return!1}return!0}))},e.prototype.tryPrepareItemInWebGlScope=function(e,t,r,i){var n=performance.now();if(this.m_initDeadline=i?n+i:void 0,t&&!t.tryPrepareProgramResourcesInWebGlScope(this.m_initDeadline))return!1;if(!this.tryPrepareGeneratedShapes(e))return!1;if(!this.tryPrepareTapes(e))return!1;if(t){var s=!1;return er(this,e),this.initOutOfTime()||(s=this.tryInitTextures(t,e,r,void 0,0)),s}return!0},e.prototype.tryPrepareItem=function(e,t,r){var i=this.m_graphicsProcessor;if(!i)return l.Error(592525136,"glContext must be provided"),!1;if(!i.beginRenderScope())return!1;var n=this.tryPrepareItemInWebGlScope(e,i,t,r);return i.endRenderScope(),n},e.prototype.drawItem=function(e,t,r,i,n,s,o,a,h,c,l){void 0===c&&(c=!1);for(var u=0,d=r.instanceOffsets||[w.Zero];u<d.length;u++){var f=d[u];this.drawItemOnce(e,t,r,i,r.instanceOffsets?T.Translation2D(f).multiply(n):n,s,o,a,h,c,l)}},e.prototype.drawItemOnce=function(e,t,r,i,n,s,o,a,h,c,l){void 0===c&&(c=!1);var d=0==a||4==a,f=s||r.animationTransform,p=d&&f?n.multiply(f.multiply(o)):n.multiply(o);if(!(r.isHidden||l&&l.filter&&!l.filter(r))){var m,_=this.ensureRenderNode(r),v=_.cache?_.cache.fade:void 0,y=di(r);if(r instanceof ge&&r.clipBounds&&y&&(m=(m=(m=(m=r.getBounds())?m.transformedBounds(r.transform.toInverseMatrix3()):void 0)?r.clipBounds.clip(m):void 0)?m.translate(y.center.negate()):void 0),d&&_.cache.spriteTexture&&_.cache.spriteTexture.uvScale&&_.cache.spriteTexture.localBounds){y&&((L=new St(_.cache.spriteTexture,ft(y,r.transform))).fadeInfo=d&&v?{fade:v,fadeTexture:_.cache.fadeTexture}:void 0,L.localClipRect=m,Ft(L,t,i,p,h?h.color:void 0))}else{if(0!=e&&r.effects&&(r.effects.glow||r.effects.shadow||r.effects.reflection)&&0==g&&4!=a&&(!l||!l.textRange)&&y){var b=y.center.transformPoint(r.transform),P=void 0;if(4&e&&r.effects.reflection||2&e&&r.effects.shadow){var C=new x(b.negate(),w.One,r.effects.direction,b);P=r.effectsBoundsOverride?r.effectsBoundsOverride.transformedBounds(C):be(r,!1,0,1,C.toMatrix3())}var E=y?ft(y,r.transform):void 0,S=E?new x(w.Zero,w.Flip(E.flipX,E.flipY),E.rotation+r.effects.direction,E.center):void 0,R=S?S.toInverseMatrix3():void 0;if(4&e&&r.effects.reflection&&_.cache.reflectionTexture&&_.cache.reflectionTexture.uvScale&&_.cache.reflectionTexture.localBounds&&P&&y&&E&&S&&R){var M=r.effects.reflection,I=P.bottom+M.distance/2;r instanceof ge&&r.textEffectMetrics&&(I-=r.textEffectMetrics.descent);var A=T.Translation2D(new w(0,-I)).multiply(T.Scale2D(new w(1,-1))).multiply(T.Translation2D(new w(0,I))),F=new w(P.center.x,I),B=new w(P.center.x,I+P.height),D={opacity0:M.startAlpha,opacity1:M.endAlpha,pos0:w.InterpolateLinear(F,B,M.startPosition).transformPoint(R),pos1:w.InterpolateLinear(F,B,M.endPosition).transformPoint(R)};(L=new St(_.cache.reflectionTexture,E)).fadeInfo=d&&v?{fade:v,fadeTexture:_.cache.fadeTexture}:void 0,L.effectTransform=T.FromTransforms(S,A,R),L.localClipRect=m,L.reflectionGradient=D,Ft(L,t,i,p,h?h.color:void 0)}if(2&e&&r.effects.shadow&&_.cache.shadowTexture&&_.cache.shadowTexture.uvScale&&_.cache.shadowTexture.localBounds&&P&&y&&E&&S&&R){var L,O=Te(r.effects.shadow.alignment,P),k=xe(r.effects.shadow.angle,r.effects.shadow.distance,r.effects.shadow.scale,r.effects.shadow.skew,O);(L=new St(_.cache.shadowTexture,E)).fadeInfo=d&&v?{fade:v,fadeTexture:_.cache.fadeTexture}:void 0,L.effectTransform=T.FromTransforms(S,k,R),L.localClipRect=m,Ft(L,t,i,p,h?h.color:void 0)}if(1&e&&r.effects.glow&&_.cache.glowTexture&&_.cache.glowTexture.uvScale&&_.cache.glowTexture.localBounds&&y&&E&&S&&R)(L=new St(_.cache.glowTexture,E)).fadeInfo=d&&v?{fade:v,fadeTexture:_.cache.fadeTexture}:void 0,L.localClipRect=m,Ft(L,t,i,p,h?h.color:void 0)}if(1==r.getType()){var N=r;if(!l||!l.textRange)if(N.isSolidRect())_r(this,_.cache,void 0,e,t,N,i,p,a,h?h.color:void 0,m);else for(var G=0,U=_.cache.distanceFields||[];G<U.length;G++){var V=U[G];_r(this,_.cache,V,e,t,N,i,p,a,h?h.color:void 0,m)}if(N.text&&N.text.cache&&(!l||!l.noSubtree||l.textRange)){var z=new x(w.Zero,w.One,N.transform.rotation,N.transform.translation),W=u?z.toMatrix3().multiply(n):z.toMatrix3(),H=u&&!N.text.animationProps?f:void 0,j=u?o:N.text.hasAnimationProps()?n.multiply(o):p;if(h)for(var q=0,X=N.text.cache.hitTestLineShapes||[];q<X.length;q++){var K=X[q];(!l||!l.textRange||K.textRange&&l.textRange.includes(K.textRange.start))&&this.drawItem(31,t,K,i,W,H,j,a,h,c)}else{for(var Y=0,Q=N.text.cache.textShapes||[];Y<Q.length;Y++){var Z=Q[Y];(!l||!l.textRange||Z.textRange&&l.textRange.includes(Z.textRange.start))&&this.drawItem(31,t,Z,i,W,H,j,a,h,c)}if(0==a)for(var J=0,$=N.text.cache.selectionShapes||[];J<$.length;J++){var ee=$[J];this.drawItem(31,t,ee,i,W,H,j,a,h,c)}}}}else if(2==r.getType()&&(!l||!l.noSubtree&&!l.textRange)){var te=r;if(te)for(var re=0;re<te.items.length;re++){var ie=te.items.getAt(re);h&&h.next();var ne=u?te.transform.toMatrix3().multiply(n):T.Identity,se=u?f:void 0,oe=u?o:te.transform.toMatrix3().multiply(p);this.drawItem(31,t,ie,i,ne,se,oe,a,h,c,l)}}}}},e.prototype.renderToTexture=function(e,t,r,i,n,s,o){i&&i.size.equals(n)||(i=new gt(this,n,!0,!1));var a=e.activateShaderProgram(1);return a.begin(i.babylonTexture,Q.Transparent,!0),this.drawItemOnce(r,a,t,n,T.Identity,void 0,s.toMatrix3(),o,void 0),a.end(),i},e.prototype.drawTextureToTexture=function(e,t,r){var i=this.m_graphicsProcessor;if(!i)throw l.Error(592525137,"No Graphics Processor");var n=i.isInRenderScope();if(!n&&!i.beginRenderScope())throw l.Error(591541203,"Failed to begin RenderScope");var s=i.activateShaderProgram(1);s.begin(e.babylonTexture,Q.Transparent,!0),Ft(new St(t,{center:r.scale(.5),size:r,rotation:0,flipX:!1,flipY:!1}),s,r),s.end(),n||i.endRenderScope()},e.prototype.initTextureRasterizedItem=function(e,t,r,i,n,s,o){var a=this.m_graphicsProcessor;if(!a)throw l.Error(591541204,"No Graphics Processor");var h=performance.now(),c=n?ct*Math.min(1,4/Math.sqrt(n)):ct,u=!!(4&s),d=!!(24&s),f=!(2==e.getType()&&e.isDocumentShape),p=be(e,u||f&&!d,t,31,e.transform.toInverseMatrix3().multiply(T.Scale2D(e.transform.scale)));if(p){var g=(p=p.inflate(Math.max(2/c,n))).size,m=p.center.divide(e.transform.scale).transformPoint(e.transform);if(g&&m){var _=Math.min(c,2048/Math.max(g.x,g.y)),v=g.scale(_),y=n||i,b=new w(R(y?E(v.x):v.x,16,2048),R(y?E(v.y):v.y,16,2048)),P=Math.min(_,Math.min(b.x/g.x,b.y/g.y)),C=new x(m.negate(),new w(P,P),-e.transform.rotation,new w(b.x/2,b.y/2)),S=di(e);if(S){(r=this.renderToTexture(a,e,t,r,b,C,o))&&(r.uvScale=g.scale(P).divide(r.size),r.localBounds=p.multiply(e.transform.scale.inverse()),r.contentLocation={logicalCenter:S.center.transformPoint(e.transform).transformPoint(C),logicalSize:S.size.multiply(e.transform.scale).scale(P),physicalCenter:r.size.scale(.5),physicalSize:g.scale(P),rotation:0,flipX:!1,flipY:!1},y&&(r.generateMipMap(),function(e,t,r,i,n){var s=e.getGraphicsProcessor();if(s){var o=e.ensureScratchBuffers(),a=o[0],h=o[1],c=1==i?.12*r:16==i?.47*r:r,u=1==i?.3*r:r,d=1==i?3:16==i?2:n?1:0,f=n?1:0,p=1!=i&&16!=i;xt(s,h.size.divide(t.size),t,h,n?Q.Black:void 0,c,d,new w(1,0),p),xt(s,w.One,h,a,n?Q.Black:void 0,c,d,new w(0,1),p),xt(s,w.One,a,h,n?Q.Black:void 0,u,f,new w(1,0),!0),xt(s,t.size.divide(a.size),h,t,n,u,f,new w(0,1),!0)}else l.Error(592525249,"No GraphicsProcessor")}(this,r,n*P,s,i)));var M=performance.now()-h;return 3==o||2==o?this.m_currentFramePerformanceSummary.effectsCostMs+=M:1==o&&(this.m_currentFramePerformanceSummary.cacheToSpriteCostMs+=M),r&&(r.isDirty=!1),r}}}},e.prototype.hasAnimatedTextureContent=function(e){if(6==e.getType()){var t=this.getTextureFromImage(e.image);if(t)return t.animatedContent}return!1},e.prototype.hasAnimatedContentTexture=function(e){return e instanceof ge&&(e.style.fillBrush&&this.hasAnimatedTextureContent(e.style.fillBrush)||e.style.lineBrush&&this.hasAnimatedTextureContent(e.style.lineBrush)||e.style.pictureBrush&&this.hasAnimatedTextureContent(e.style.pictureBrush))},e.prototype.preCompileShaderAsync=function(e){this.m_graphicsProcessor?this.m_graphicsProcessor.preCompileShaderAsync(e):l.Error(592525138,"Graphics Processor not initoalized")},e.prototype.preLinkShaderAsync=function(e){this.m_graphicsProcessor?this.m_graphicsProcessor.preLinkShaderAsync(e):l.Error(592525139,"Graphics Processor not initoalized")},e.prototype.getDebugString=function(e){return this.m_debugStringProvider?e instanceof pe?this.m_debugStringProvider.getDebugStringForItem(e,this):e instanceof Ce?this.m_debugStringProvider.getDebugStringForMorph(e,this):"unsupported object":"no debug string provider"},e}();function di(e){return 1==e.getType()?ye(e,!1):be(e,!1,0,0,e.transform.toInverseMatrix3())}function fi(e,t){return e instanceof gt?(e.needsRenderBuffer&&(t.renderBuffers+=e.getRenderBufferMemoryUsage()),e.getMemoryUsage()):e?e.size.x*e.size.y*4:0}function pi(e,t){e&&(e instanceof gt&&e.tag?t.otherBrushes+=fi(e,t):e.ownsTexture?t.managedImages+=fi(e,t):t.externalImages+=fi(e,t))}function gi(e,t,r,i){void 0===i&&(i=!1);var n=e.ensureRenderNode(t);if(n.cache){for(var s=0,o=n.cache.distanceFields||[];s<o.length;s++){var a=o[s];i?r.textDistanceFields+=fi(a,r):r.shapeDistanceFields+=fi(a,r)}pi(n.cache.fillTexture,r),pi(n.cache.lineTexture,r),pi(n.cache.pictureTexture,r),r.effects+=fi(n.cache.innerShadowTexture,r),r.effects+=fi(n.cache.softEdgesTexture,r),r.effects+=fi(n.cache.glowTexture,r),r.effects+=fi(n.cache.shadowTexture,r),r.effects+=fi(n.cache.reflectionTexture,r),r.fadeMasks+=fi(n.cache.fadeTexture,r),r.rasterizedItems+=fi(n.cache.spriteTexture,r)}if(t instanceof ge&&t.text&&t.text.cache){var h=t.text.cache;h.textShapes.forEach((function(t){gi(e,t,r,!0)})),h.hitTestLineShapes.forEach((function(t){gi(e,t,r,!0)})),h.selectionShapes&&h.selectionShapes.forEach((function(t){gi(e,t,r,!0)}))}t instanceof me&&t.items.elements.forEach((function(t){gi(e,t,r)}))}function mi(e,t,r){for(var i=0,n=t.elements;i<n.length;i++)for(var s=0,o=n[i].keyFrames;s<o.length;s++){var a=o[s];if(a){var h=e.ensureMorphKeyFrameRenderData(a);h.texture&&(r.morphTextures+=fi(h.texture,r))}}}var _i=function(){function e(e){this.webGLRestoreToDefault=!1,this.old_VERTEX_ATTRIB_ARRAY_ENABLED=new Array(2),this.webGLRestoreToDefault=e}return e.prototype.init=function(e){if(this.gl&&l.Error(591663577,"Previous Init has not been Restored"),this.gl=e,this.old_VIEWPORT=e.getParameter(e.VIEWPORT),!this.webGLRestoreToDefault){this.old_ACTIVE_TEXTURE=e.getParameter(e.ACTIVE_TEXTURE),this.old_ARRAY_BUFFER_BINDING=e.getParameter(e.ARRAY_BUFFER_BINDING),this.old_BLEND=e.getParameter(e.BLEND),this.old_BLEND_COLOR=e.getParameter(e.BLEND_COLOR),this.old_BLEND_DST_ALPHA=e.getParameter(e.BLEND_DST_ALPHA),this.old_BLEND_DST_RGB=e.getParameter(e.BLEND_DST_RGB),this.old_BLEND_EQUATION_ALPHA=e.getParameter(e.BLEND_EQUATION_ALPHA),this.old_BLEND_EQUATION_RGB=e.getParameter(e.BLEND_EQUATION_RGB),this.old_BLEND_SRC_ALPHA=e.getParameter(e.BLEND_SRC_ALPHA),this.old_BLEND_SRC_RGB=e.getParameter(e.BLEND_SRC_RGB),this.old_COLOR_CLEAR_VALUE=e.getParameter(e.COLOR_CLEAR_VALUE),this.old_COLOR_WRITEMASK=e.getParameter(e.COLOR_WRITEMASK),this.old_CULL_FACE=e.getParameter(e.CULL_FACE),this.old_CULL_FACE_MODE=e.getParameter(e.CULL_FACE_MODE),this.old_CURRENT_PROGRAM=e.getParameter(e.CURRENT_PROGRAM),this.old_DEPTH_CLEAR_VALUE=e.getParameter(e.DEPTH_CLEAR_VALUE),this.old_DEPTH_FUNC=e.getParameter(e.DEPTH_FUNC),this.old_DEPTH_RANGE=e.getParameter(e.DEPTH_RANGE),this.old_DEPTH_TEST=e.getParameter(e.DEPTH_TEST),this.old_DEPTH_WRITEMASK=e.getParameter(e.DEPTH_WRITEMASK),this.old_DITHER=e.getParameter(e.DITHER),this.old_ELEMENT_ARRAY_BUFFER_BINDING=e.getParameter(e.ELEMENT_ARRAY_BUFFER_BINDING),this.old_FRAMEBUFFER_BINDING=e.getParameter(e.FRAMEBUFFER_BINDING),this.old_FRONT_FACE=e.getParameter(e.FRONT_FACE),this.old_GENERATE_MIPMAP_HINT=e.getParameter(e.GENERATE_MIPMAP_HINT),this.old_LINE_WIDTH=e.getParameter(e.LINE_WIDTH),this.old_PACK_ALIGNMENT=e.getParameter(e.PACK_ALIGNMENT),this.old_POLYGON_OFFSET_FACTOR=e.getParameter(e.POLYGON_OFFSET_FACTOR),this.old_POLYGON_OFFSET_FILL=e.getParameter(e.POLYGON_OFFSET_FILL),this.old_POLYGON_OFFSET_UNITS=e.getParameter(e.POLYGON_OFFSET_UNITS),this.old_RENDERBUFFER_BINDING=e.getParameter(e.RENDERBUFFER_BINDING),this.old_SAMPLE_COVERAGE_INVERT=e.getParameter(e.SAMPLE_COVERAGE_INVERT),this.old_SAMPLE_COVERAGE_VALUE=e.getParameter(e.SAMPLE_COVERAGE_VALUE),this.old_SCISSOR_BOX=e.getParameter(e.SCISSOR_BOX),this.old_SCISSOR_TEST=e.getParameter(e.SCISSOR_TEST),this.old_STENCIL_BACK_FAIL=e.getParameter(e.STENCIL_BACK_FAIL),this.old_STENCIL_BACK_FUNC=e.getParameter(e.STENCIL_BACK_FUNC),this.old_STENCIL_BACK_PASS_DEPTH_FAIL=e.getParameter(e.STENCIL_BACK_PASS_DEPTH_FAIL),this.old_STENCIL_BACK_PASS_DEPTH_PASS=e.getParameter(e.STENCIL_BACK_PASS_DEPTH_PASS),this.old_STENCIL_BACK_REF=e.getParameter(e.STENCIL_BACK_REF),this.old_STENCIL_BACK_VALUE_MASK=e.getParameter(e.STENCIL_BACK_VALUE_MASK),this.old_STENCIL_BACK_WRITEMASK=e.getParameter(e.STENCIL_BACK_WRITEMASK),this.old_STENCIL_CLEAR_VALUE=e.getParameter(e.STENCIL_CLEAR_VALUE),this.old_STENCIL_FAIL=e.getParameter(e.STENCIL_FAIL),this.old_STENCIL_FUNC=e.getParameter(e.STENCIL_FUNC),this.old_STENCIL_PASS_DEPTH_FAIL=e.getParameter(e.STENCIL_PASS_DEPTH_FAIL),this.old_STENCIL_PASS_DEPTH_PASS=e.getParameter(e.STENCIL_PASS_DEPTH_PASS),this.old_STENCIL_REF=e.getParameter(e.STENCIL_REF),this.old_STENCIL_TEST=e.getParameter(e.STENCIL_TEST),this.old_STENCIL_VALUE_MASK=e.getParameter(e.STENCIL_VALUE_MASK),this.old_STENCIL_WRITEMASK=e.getParameter(e.STENCIL_WRITEMASK),this.old_TEXTURE_BINDING_2D=e.getParameter(e.TEXTURE_BINDING_2D),this.old_TEXTURE_BINDING_CUBE_MAP=e.getParameter(e.TEXTURE_BINDING_CUBE_MAP),this.old_UNPACK_ALIGNMENT=e.getParameter(e.UNPACK_ALIGNMENT),this.old_UNPACK_COLORSPACE_CONVERSION_WEBGL=e.getParameter(e.UNPACK_COLORSPACE_CONVERSION_WEBGL),this.old_UNPACK_FLIP_Y_WEBGL=e.getParameter(e.UNPACK_FLIP_Y_WEBGL),this.old_UNPACK_PREMULTIPLY_ALPHA_WEBGL=e.getParameter(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL);for(var t=0;t<2;t++)this.old_VERTEX_ATTRIB_ARRAY_ENABLED[t]=e.getVertexAttrib(t,e.VERTEX_ATTRIB_ARRAY_ENABLED)}},e.prototype.setDefaults=function(){if(this.gl){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.disable(this.gl.BLEND),this.gl.blendColor(0,0,0,0),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ZERO),this.gl.clearColor(0,0,0,0),this.gl.colorMask(!0,!0,!0,!0),this.gl.disable(this.gl.CULL_FACE),this.gl.cullFace(this.gl.BACK),this.gl.useProgram(null),this.gl.clearDepth(1),this.gl.depthFunc(this.gl.LESS),this.gl.depthRange(0,1),this.gl.disable(this.gl.DEPTH_TEST),this.gl.depthMask(!0),this.gl.disable(this.gl.DITHER),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.frontFace(this.gl.CCW),this.gl.hint(this.gl.GENERATE_MIPMAP_HINT,this.gl.DONT_CARE),this.gl.lineWidth(1),this.gl.polygonOffset(0,0),this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.sampleCoverage(1,!1),this.gl.scissor(0,0,this.old_VIEWPORT[2],this.old_VIEWPORT[3]),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.stencilFunc(this.gl.ALWAYS,0,1),this.gl.stencilMask(255),this.gl.stencilOp(this.gl.KEEP,this.gl.KEEP,this.gl.KEEP),this.gl.clearStencil(0),this.gl.disable(this.gl.STENCIL_TEST),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,null),this.gl.pixelStorei(this.gl.PACK_ALIGNMENT,4),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,4),this.gl.pixelStorei(this.gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this.gl.BROWSER_DEFAULT_WEBGL),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,0),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.gl.viewport(this.old_VIEWPORT[0],this.old_VIEWPORT[1],this.old_VIEWPORT[2],this.old_VIEWPORT[3]);for(var e=0;e<2;e++)this.gl.disableVertexAttribArray(e)}else l.Error(591663578,"Trying to set default without Init")},e.prototype.restore=function(){if(this.gl){if(this.webGLRestoreToDefault)this.setDefaults();else{this.gl.activeTexture(this.old_ACTIVE_TEXTURE),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.old_ARRAY_BUFFER_BINDING),this.old_BLEND?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this.gl.blendColor(this.old_BLEND_COLOR[0],this.old_BLEND_COLOR[1],this.old_BLEND_COLOR[2],this.old_BLEND_COLOR[3]),this.gl.blendEquationSeparate(this.old_BLEND_EQUATION_RGB,this.old_BLEND_EQUATION_ALPHA),this.gl.blendFuncSeparate(this.old_BLEND_SRC_RGB,this.old_BLEND_DST_RGB,this.old_BLEND_SRC_ALPHA,this.old_BLEND_DST_ALPHA),this.gl.clearColor(this.old_COLOR_CLEAR_VALUE[0],this.old_COLOR_CLEAR_VALUE[1],this.old_COLOR_CLEAR_VALUE[2],this.old_COLOR_CLEAR_VALUE[3]),this.gl.colorMask(this.old_COLOR_WRITEMASK[0],this.old_COLOR_WRITEMASK[1],this.old_COLOR_WRITEMASK[2],this.old_COLOR_WRITEMASK[3]),this.old_CULL_FACE?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.gl.cullFace(this.old_CULL_FACE_MODE),this.gl.useProgram(this.old_CURRENT_PROGRAM),this.gl.clearDepth(this.old_DEPTH_CLEAR_VALUE),this.gl.depthFunc(this.old_DEPTH_FUNC),this.gl.depthRange(this.old_DEPTH_RANGE[0],this.old_DEPTH_RANGE[1]),this.old_DEPTH_TEST?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this.gl.depthMask(this.old_DEPTH_WRITEMASK),this.old_DITHER?this.gl.enable(this.gl.DITHER):this.gl.disable(this.gl.DITHER),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.old_ELEMENT_ARRAY_BUFFER_BINDING),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.old_FRAMEBUFFER_BINDING),this.gl.frontFace(this.old_FRONT_FACE),this.gl.hint(this.gl.GENERATE_MIPMAP_HINT,this.old_GENERATE_MIPMAP_HINT),this.gl.lineWidth(this.old_LINE_WIDTH),this.gl.pixelStorei(this.gl.PACK_ALIGNMENT,this.old_PACK_ALIGNMENT),this.gl.polygonOffset(this.old_POLYGON_OFFSET_FACTOR,this.old_POLYGON_OFFSET_UNITS),this.old_POLYGON_OFFSET_FILL?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.old_RENDERBUFFER_BINDING),this.gl.sampleCoverage(this.old_SAMPLE_COVERAGE_VALUE,this.old_SAMPLE_COVERAGE_INVERT),this.gl.scissor(this.old_SCISSOR_BOX[0],this.old_SCISSOR_BOX[1],this.old_SCISSOR_BOX[2],this.old_SCISSOR_BOX[3]),this.old_SCISSOR_TEST?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this.gl.stencilFuncSeparate(this.gl.FRONT,this.old_STENCIL_FUNC,this.old_STENCIL_REF,this.old_STENCIL_VALUE_MASK),this.gl.stencilFuncSeparate(this.gl.BACK,this.old_STENCIL_BACK_FUNC,this.old_STENCIL_BACK_REF,this.old_STENCIL_BACK_VALUE_MASK),this.gl.stencilMaskSeparate(this.gl.FRONT,this.old_STENCIL_WRITEMASK),this.gl.stencilMaskSeparate(this.gl.BACK,this.old_STENCIL_BACK_WRITEMASK),this.gl.stencilOpSeparate(this.gl.FRONT,this.old_STENCIL_FAIL,this.old_STENCIL_PASS_DEPTH_FAIL,this.old_STENCIL_PASS_DEPTH_PASS),this.gl.stencilOpSeparate(this.gl.BACK,this.old_STENCIL_BACK_FAIL,this.old_STENCIL_BACK_PASS_DEPTH_FAIL,this.old_STENCIL_BACK_PASS_DEPTH_PASS),this.gl.clearStencil(this.old_STENCIL_CLEAR_VALUE),this.old_STENCIL_TEST?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this.gl.bindTexture(this.gl.TEXTURE_2D,this.old_TEXTURE_BINDING_2D),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,this.old_TEXTURE_BINDING_CUBE_MAP),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.old_UNPACK_ALIGNMENT),this.gl.pixelStorei(this.gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this.old_UNPACK_COLORSPACE_CONVERSION_WEBGL),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.old_UNPACK_FLIP_Y_WEBGL),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.old_UNPACK_PREMULTIPLY_ALPHA_WEBGL),this.gl.viewport(this.old_VIEWPORT[0],this.old_VIEWPORT[1],this.old_VIEWPORT[2],this.old_VIEWPORT[3]);for(var e=0;e<2;e++)this.old_VERTEX_ATTRIB_ARRAY_ENABLED[e]?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e)}this.gl=void 0}else l.Error(591663579,"Trying to Restore without Init")},e}();function vi(){return void 0===(e={stateRestorer:new _i(!!t)})&&(e={}),new ui(e);var e,t}class yi{sendTraceTag(e,t,r,i){switch(r){case 10:o(""+e,bi(t),i);break;case 50:default:h(""+e,bi(t),i)}}shipAssertTag(e,t,r,i){r&&o(""+e,bi(t),i)}debugAssertTag(e,t,r,i){r&&o(""+e,bi(t),i)}}function bi(e){switch(e){case 306:default:return 2503}}var wi=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class Ti{constructor(e){var t;this._isRendererReady=!1,this._webGLContextRestoredStartTime=0,this._webGLContextLostStartTime=0,this.handleContextNotRestored=()=>{this._webGLContextLostStartTime>this._webGLContextRestoredStartTime&&o("0",2503,"webglcontext not restored after 3seconds")},h("0",2503,"ShapeBuilderContext ctor"),t=new yi,l.setLogger(t),this._shapeBuilderConfig=e,this._renderer=vi()}get webGLContext(){return this._webGLContext}setupWebGLContext(){return wi(this,void 0,void 0,(function*(){const e=this.shapeBuilderConfig.webGLCanvas,t={preserveDrawingBuffer:this.shapeBuilderConfig.preserveDrawingBuffer};let r=e.getContext("webgl",t);return r=void 0!==r?r:e.getContext("experimental-webgl",t),this._webGLContext=r,this._webGLContextRestoredStartTime=performance.now(),this.preloadShaders(r)}))}handleContextLost(){this._webGLContextLostStartTime=performance.now(),h("0",2503,"webgl context is lost."),this._isRendererReady=!1,this._renderer.onWebGLContextLost(),this._webGLContext=void 0,window.setTimeout(this.handleContextNotRestored,3e3),this._shapeBuilderConfig.webGLContextLostHandler.onWebGLContextLost()}handleContextRestored(){return wi(this,void 0,void 0,(function*(){this._webGLContextRestoredStartTime=performance.now();h("0",2503,`webgl context is being restored. ${this._webGLContextRestoredStartTime-this._webGLContextLostStartTime}MS`),yield this.setupWebGLContext(),void 0===this._webGLContext?o("0",2503,"unable to restore webGLContext"):this._shapeBuilderConfig.webGLContextLostHandler.onWebGLContextRestored();h("0",2503,`webglcontext restored successfully. ${performance.now()-this._webGLContextRestoredStartTime}MS`)}))}preloadShaders(e){return wi(this,void 0,void 0,(function*(){void 0===e&&o("0",2503,"webglcontext is undefined"),yield n(new c("ShapeBuilderContext.preloadShaders"),t=>wi(this,void 0,void 0,(function*(){const r=performance.now();try{yield this._renderer.initializeAsync(e),this._isRendererReady=!0}catch(e){o("0",2503,"exception in preloadshaders: "+e.message)}finally{const e=performance.now();t.setProp("shaderCompilationDurationMilliseconds",e-r)}})))}))}get shapeBuilderConfig(){return this._shapeBuilderConfig}get renderer(){return this._renderer}get isRendererReady(){return this._isRendererReady}get activeMultiplexRenderTarget(){return this._activeMultiplexRenderTarget}set activeMultiplexRenderTarget(e){if(void 0===e)throw new Error("Cannot set an undefined render target");this._activeMultiplexRenderTarget=e}}let xi={logStart(e){},logEnd(e){}};class Pi{constructor(e){this.pptLogger=e}logStart(e){if(0!==e.kpiNames.size)if(1===e.kpiMethodType)this.pptLogger.recordKpiUsageForAlertableKpi([...e.kpiNames][0],e.owningFeatureCrewAlias,e.extendedProperties);else{if(void 0===e.kpiType)return;const t=e.kpiNames,r=e.kpiType,i=e.owningFeatureCrewAlias,n=e.extendedProperties;switch(e.kpiMethodType){case 0:return void this.pptLogger.recordKpiUsage([...t][0],r,i,n);case 2:return void this.pptLogger.recordKpiUsageMultiple(t,r,i,n);default:return}}}logEnd(e){if(0===e.kpiNames.size)return;const t=e.kpiNames,r=e.additionalValues,i=e.errorName,n=e.isIntentional,s=e.isInternal;switch(e.kpiMethodType){case 3:return void this.pptLogger.recordKpiSuccess([...t][0],r);case 4:return void this.pptLogger.recordKpiSuccessMultiple(t,r);case 5:return void this.pptLogger.recordKpiFailure([...t][0],i,n,s,r);case 6:return void this.pptLogger.recordKpiFailureMultiple(t,i,n,s,r);default:return}}}function Ci(e,t){throw o("0",e,t),new Error(`Error: ${t}, Category: ${e}`)}function Ei(e){Ci(0,"Unreachable "+e)}class Si{constructor(e){this.pptLogger=e}logOperation(e){this.pptLogger.logTrace(0,2,2,function(e){const t={name:e.name,durationMs:e.durationMs.toString()};if(void 0!==e.props)for(const r of e.props)t[r[0]]=r[1];return JSON.stringify(t)}(e))}logTrace(e){this.pptLogger.logTrace(Number(e.id),function(e){switch(e){case 55002:return 0;case 55e3:return 1;case 55001:return 2;default:return 0}}(e.category),function(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;default:Ei(e)}}(e.level),e.message)}}class Ri{constructor(e){this.initializer=e}get value(){return void 0===this.instance&&(this.instance=this.initializer()),this.instance}get valid(){return void 0!==this.instance}}class Mi{constructor(){this.listeners=[]}on(e){this.listeners.push(e)}off(e){const t=this.listeners.indexOf(e);t>=0&&t<this.listeners.length&&this.listeners.splice(t,1)}emit(e){this.listeners.forEach(t=>{t(e)})}}function Ii(){const e=()=>new Mi;return{pointerdown:new Ri(e),pointermove:new Ri(e),pointerup:new Ri(e),pointercancel:new Ri(e),pointerenter:new Ri(e),pointerleave:new Ri(e),pointerover:new Ri(e),pointerout:new Ri(e)}}function Ai(e,t){return e.nodeType===t.nodeType&&e.nodeKey===t.nodeKey}function Fi(e){return JSON.stringify(e)}function Bi(e,t){void 0!==e.data&&t(e.data),void 0!==e.childNodes&&e.childNodes.forEach(e=>{t(e)})}class Di{constructor(e){this.type=0,this.pointerEventNotifiers=Ii(),this.cursorType=0,this.hitTestSlop=0,this.hitTestable=!0,this.nodeId=e}updateViewModel(e,t){0===e.length&&Ci(4,"Empty nodeIdPath");const[r,...i]=e;if(Ai(r,this.nodeId)||Ci(4,`Invalid root in path: ${Fi(e)}, expected root: ${this.nodeId}`),0===i.length)return this.data=t.data,void(this.childNodes=t.childNodes);void 0===this.childNodes&&Ci(4,"No child nodes for given path: "+Fi(e));const n=this.childNodes.find(e=>Ai(i[0],e.nodeId));void 0===n&&Ci(4,"Child node not found for "+Fi(e)),n.updateViewModel(i,t)}tryRemoveNode(e){if(0===e.length)return[!1,"Empty nodeIdPath"];const[t,...r]=e;if(!Ai(t,this.nodeId))return[!1,`Invalid root in path: ${Fi(e)}, expected root: ${this.nodeId}`];if(void 0===this.childNodes)return[!1,"No child nodes for given path: "+Fi(e)];if(1===r.length){const e=this.childNodes.findIndex(e=>Ai(e.nodeId,r[0]));return-1===e?[!1,"Child node not found for "+JSON.stringify(r[0])]:(Bi(this.childNodes[e],e=>{e.teardown()}),this.childNodes.splice(e,1),[!0])}const i=this.childNodes.find(e=>Ai(r[0],e.nodeId));return void 0===i?[!1,"Child node not found for "+Fi(e)]:i.tryRemoveNode(r)}teardown(){Bi(this,e=>{e.teardown()})}}function Li(e){return 0===e.type}class Oi{constructor(e,t){this.type=2,this.data=e,this.eventChainTracker=t}}const ki=Math.PI,Ni=2*Math.PI;Math.PI,Math.PI,Math.PI,Math.PI;function Gi(e){return e*ki/180}class Ui{constructor(e,t){this.x=e,this.y=t}normalize(){const e=Math.sqrt(this.x*this.x+this.y*this.y);this.x=this.x/e,this.y=this.y/e}multiply(e){const t=this.x*e.m11+this.y*e.m21+e.m31,r=this.x*e.m12+this.y*e.m22+e.m32;this.x=t,this.y=r}rotateAboutPoint(e,t){const r=Gi(e),i=Math.cos(r),n=Math.sin(r),s=this.x-t.x,o=this.y-t.y;this.x=s*i-o*n+t.x,this.y=s*n+o*i+t.y}}class Vi{constructor(e){this.type=5,this.eventChainTracker=e}}class zi{constructor(e,t,r){this.transformUpdated=new Mi,this.onAnchorTransformUpdated=e=>{this.transformUpdated.emit(e)},this.onContainerTransformChanged=()=>{this.transformUpdated.emit(new Vi)},this.parentAnchorPresenter=e,this.parentRelativePresenter=t,this.containerTransform=r,this.parentAnchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated),this.parentRelativePresenter.transformUpdated.on(this.onAnchorTransformUpdated),this.containerTransform.transformChanged.on(this.onContainerTransformChanged)}get transform(){const e=this.parentAnchorPresenter.transform,t=this.parentRelativePresenter.transform.clone(),r=e.pos,i=e.flip,n=e.rot;i.x===i.y?t.rot+=n:t.rot-=n,t.flip.x!==i.x&&(t.flip.x=!i.x),t.flip.y!==i.y&&(t.flip.y=!i.y);const s=new Ui(t.pos.x,t.pos.y);return s.rotateAboutPoint(n,new Ui(e.size.width/2-t.size.width/2,e.size.height/2-t.size.height/2)),t.pos.x=s.x+r.x,t.pos.y=s.y+r.y,t.multiply(this.containerTransform.transform),t}teardown(){this.parentAnchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.parentRelativePresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.containerTransform.transformChanged.off(this.onContainerTransformChanged),this.parentRelativePresenter.teardown()}}class Wi{constructor(){this.m11=0,this.m12=0,this.m21=0,this.m22=0,this.m31=0,this.m32=0}static identity(){const e=new Wi;return e.m11=1,e.m22=1,e}apply(e){const t=this.m11*e.m11+this.m12*e.m21,r=this.m11*e.m12+this.m12*e.m22,i=this.m21*e.m11+this.m22*e.m21,n=this.m21*e.m12+this.m22*e.m22,s=this.m31*e.m11+this.m32*e.m21+e.m31,o=this.m31*e.m12+this.m32*e.m22+e.m32;return this.m11=t,this.m12=r,this.m21=i,this.m22=n,this.m31=s,this.m32=o,this}translate(e,t){const r=new Wi;return r.m11=1,r.m22=1,r.m31=e,r.m32=t,this.apply(r)}scale(e,t){const r=new Wi;return r.m11=e,r.m22=t,this.apply(r)}rotate(e){const t=Math.cos(e),r=Math.sin(e),i=new Wi;return i.m11=t,i.m12=r,i.m21=-r,i.m22=t,this.apply(i)}rotateAboutPoint(e,t){return this.translate(-t.x,-t.y).rotate(e).translate(t.x,t.y)}}class Hi{constructor(){this.type=10}}class ji{constructor(){this.transformChanged=new Mi,this._transform=Wi.identity()}get transform(){return this._transform}set transform(e){this._transform=e,this.emitTransformChanged(!0)}emitTransformChanged(e){e&&this.transformChanged.emit(new Hi)}}class qi{constructor(e=[],t=[],r){this.type=5e3,this.addedGraphicIds=[],this.removedGraphicIds=[],this.changedGraphicIds=[],this.addedGraphicIds=e,this.removedGraphicIds=t,this.changedGraphicIds=r}}function Xi(e){return void 0!==e&&5e3===e.type}class Ki{constructor(){this.type=5001,this.graphicIds=[]}}function Yi(e){return{nodeType:e.rootNodeType}}function Qi(e,t){return{nodeType:e.graphicNodeType,nodeKey:t}}function Zi(e,t,r){const i=new Di(Qi(e,t));return i.data=r,i}class Ji{constructor(e,t,r,i,n,s,o){this.type=5e3,this.viewModelUpdated=new Mi,this.childPresenters=new Map,this.onGraphicCollectionChanged=e=>{const t=new Ki;Xi(e.data)&&(this.handleGraphicsRemoved(e.data.removedGraphicIds),this.handleGraphicsAdded(e.data.addedGraphicIds),this.handleGraphicsChanged(e.data.changedGraphicIds),t.graphicIds.push(...e.data.removedGraphicIds),t.graphicIds.push(...e.data.addedGraphicIds),t.graphicIds.push(...e.data.changedGraphicIds)),this.viewModelUpdated.emit(new Oi(t,e.eventChainTracker))},this.viewModelUpdatedListener=e=>t=>{const r=new Ki;r.graphicIds.push(e),this.viewModelUpdated.emit(new Oi(r,t.eventChainTracker))},this.graphicCollectionModel=e.model,this.presenterCreatorRegistry=t,this.site=r,this.renderDataPresenterCreatorRegistry=i.renderDataPresenterCreatorRegistry,this.presenterContext=i,this.editContext=o,this.anchorPresenterCreator=e=>new zi(i.anchorPresenter,n.createPresenter(e),null!=s?s:new ji),this.containerViewModel=function(e){return new Di(Yi(e))}(this.site),this.containerViewModel.childNodes=[];for(const e of this.graphicCollectionModel.readOnlyGraphicCollection){const t=this.createPresenterEntryForGraphic(e);this.childPresenters.set(e.contentId,t),this.containerViewModel.childNodes.push(Zi(this.site,e.contentId,t[0].viewModel))}this.viewModelUpdated.emit(new Oi),this.graphicCollectionModel.modelUpdated.on(this.onGraphicCollectionChanged)}get viewModel(){return this.containerViewModel}getPresenterById(e){const t=this.childPresenters.get(e);if(void 0!==t)return t[0]}teardown(){this.graphicCollectionModel.modelUpdated.off(this.onGraphicCollectionChanged),this.childPresenters.forEach(e=>{e[0].teardown(),e[1].teardown()})}createPresenterEntryForGraphic(e){const t=this.anchorPresenterCreator(e),r=this.presenterCreatorRegistry.createPresenter(e,{anchorPresenter:t,viewScale:this.presenterContext.viewScale,renderDataPresenterCreatorRegistry:this.renderDataPresenterCreatorRegistry},this.editContext);return r.viewModelUpdated.on(this.viewModelUpdatedListener(e.contentId)),[r,t]}handleGraphicsAdded(e=[]){const t=[];for(const r of e){const e=this.graphicCollectionModel.readOnlyGraphicCollection.getItemById(r);if(void 0===e)throw new Error(`Can't find graphic with id: ${r}.`);const i=this.createPresenterEntryForGraphic(e);this.childPresenters.set(r,i),t.push(Zi(this.site,r,i[0].viewModel))}void 0!==this.containerViewModel.childNodes?this.containerViewModel.childNodes.push(...t):this.containerViewModel.childNodes=t}handleGraphicsRemoved(e=[]){for(const t of e){const[e,r]=this.containerViewModel.tryRemoveNode([Yi(this.site),Qi(this.site,t)]);e||Ci(5e3,null!=r?r:"Error removing viewmodel node for graphic id "+t);const i=this.childPresenters.get(t);void 0!==i&&(i[0].teardown(),i[1].teardown()),this.childPresenters.delete(t)}}handleGraphicsChanged(e=[]){if(0!==e.length){this.containerViewModel.childNodes=[];for(const e of this.graphicCollectionModel.readOnlyGraphicCollection){const t=this.childPresenters.get(e.contentId);void 0!==t&&(this.childPresenters.set(e.contentId,t),this.containerViewModel.childNodes.push(Zi(this.site,e.contentId,t[0].viewModel)))}}}}function $i(e,t,r,i){return[5e3,(n,s,o)=>function(e,t,r,i,n,s,o){return new Ji(e,t,r,i,n,s,o)}(n,t,e,s,r,i,o)]}class en{constructor(e){this.ids=[],void 0!==e&&(this.ids=[...e])}addId(e){return!this.has(e)&&(this.ids.push(e),!0)}addIds(e){return e.reduce((e,t)=>this.addId(t)||e,!1)}removeId(e){const t=this.getIndexById(e);return t>-1&&(this.ids.splice(t,1),!0)}removeIds(e){return e.reduce((e,t)=>this.removeId(t)||e,!1)}setIds(e){return!this.sameIds(e)&&(this.ids=e,!0)}clone(){return new en(this.ids)}clear(){return 0!==this.ids.length&&(this.ids.length=0,!0)}has(e){return this.getIndexById(e)>-1}hasAll(e){return!e.some(e=>!this.has(e))}sameIds(e){return this.ids.length===e.length&&!e.some((e,t)=>e!==this.getIdByIndex(t))}get length(){return this.ids.length}getIdByIndex(e){if(e>=this.ids.length)throw new RangeError(`Invalid index: ${e}, len: ${this.ids.length}`);return this.ids[e]}getIndexById(e){return this.ids.findIndex(t=>e===t)}[Symbol.iterator](){let e=0;const t=this.ids;return{next(){if(e<t.length){const r={done:!1,value:t[e]};return e+=1,r}return{done:!0,value:void 0}}}}}class tn{constructor(e,t){this.idCollection=e,this.readOnlyItemCollection=t}get length(){return this.idCollection.length}addItems(e){return this.idCollection.addIds(this.getIds(e))}removeItems(e){return this.idCollection.removeIds(e.map(e=>e.contentId))}removeItemIds(e){return this.idCollection.removeIds(e)}setItems(e){return this.idCollection.setIds(this.getIds(e))}clear(){return this.idCollection.clear()}getItemById(e){if(this.idCollection.has(e))return this.readOnlyItemCollection.getItemById(e)}getItemByIndex(e){const t=this.idCollection.getIdByIndex(e);return this.readOnlyItemCollection.getItemById(t)}[Symbol.iterator](){const e=this.idCollection[Symbol.iterator]();return{next:()=>{const t=e.next();if(void 0!==t.done&&!t.done){const e=this.getItemById(t.value);if(void 0!==e)return{done:!1,value:e}}return{done:!0,value:void 0}}}}getIds(e){return e.map(e=>e.contentId).filter(e=>this.readOnlyItemCollection.getIndexById(e)>-1)}}class rn{constructor(){this.versionNumber=0}increment(){return this.versionNumber+=1,this}compare(e){const t=e;return this.versionNumber>t.versionNumber?1:this.versionNumber<t.versionNumber?2:0}clone(){const e=new rn;return e.versionNumber=this.versionNumber,e}}class nn{constructor(){this.type=4}}class sn{constructor(){this.type=5002}}class on{constructor(e,t){this.connectableUpdated=new Mi,this.version=new rn,this.onGraphicCollectionChanged=e=>{if(Xi(e.data)){this.filteredGraphicCollection.removeItemIds(e.data.removedGraphicIds)&&this.onConnectableChanged()}},this.graphicCollectionModel=e,this.filteredGraphicCollection=t,this.graphicCollectionModel.modelUpdated.on(this.onGraphicCollectionChanged)}get model(){return this.graphicCollectionModel}setGraphics(e){this.filteredGraphicCollection.setItems(e)&&this.onConnectableChanged()}clear(){this.filteredGraphicCollection.clear()&&this.onConnectableChanged()}get length(){return this.filteredGraphicCollection.length}getItemByIndex(e){return this.filteredGraphicCollection.getItemByIndex(e)}teardown(){this.graphicCollectionModel.modelUpdated.off(this.onGraphicCollectionChanged)}onConnectableChanged(){this.version.increment(),this.connectableUpdated.emit(new sn)}}class an{constructor(){this.type=5e3,this.data={items:[]}}serialize(){return JSON.stringify(this.data)}fromSelection(e){for(const t of e)this.data.items.push({modelType:t.model.type,graphicId:t.contentId});return void 0!==e.childSelection&&(this.savedChildSelection=e.childSelection.save()),this}toSelection(e){const t=e.graphicCollectionModel,r=[];this.data.items.forEach(e=>{const i=t.readOnlyGraphicCollection.getItemById(e.graphicId);void 0!==i&&i.model.type===e.modelType&&r.push(i)}),e.setGraphics(r),void 0!==this.savedChildSelection&&void 0!==e.childSelection&&e.childSelection.restore(this.savedChildSelection)}}class hn{constructor(e,t,r){this.type=5e3,this.iterableType=5e3,this.selectionUpdated=new Mi,this.version=new rn,this.childSelectionCollection=[],this.onGraphicCollectionChanged=e=>{if(Xi(e.data)){this.filteredGraphicCollection.removeItemIds(e.data.removedGraphicIds)&&this.onSelectionChanged()}},this.graphicCollectionModel=e,this.filteredGraphicCollection=t,this.selectionCreatorRegistry=r,this.graphicCollectionConnectable=function(e){const t=e,r=new en,i=new tn(r,t.readOnlyGraphicCollection);return new on(t,i)}(this.graphicCollectionModel),this.graphicCollectionModel.modelUpdated.on(this.onGraphicCollectionChanged)}get model(){return this.graphicCollectionModel}get childSelection(){return 1===this.childSelectionCollection.length?this.childSelectionCollection[0]:void 0}addGraphics(e){this.filteredGraphicCollection.addItems(e)&&this.onSelectionChanged()}removeGraphics(e){this.filteredGraphicCollection.removeItems(e)&&this.onSelectionChanged()}setGraphics(e){this.filteredGraphicCollection.setItems(e)&&this.onSelectionChanged()}clear(){this.filteredGraphicCollection.clear()&&this.onSelectionChanged()}get length(){return this.filteredGraphicCollection.length}getItemById(e){return this.filteredGraphicCollection.getItemById(e)}getItemByIndex(e){return this.filteredGraphicCollection.getItemByIndex(e)}hasItem(e){return void 0!==this.getItemById(e)}[Symbol.iterator](){return this.filteredGraphicCollection[Symbol.iterator]()}teardown(){this.graphicCollectionModel.modelUpdated.off(this.onGraphicCollectionChanged),this.removeChildSelection()}save(){return(new an).fromSelection(this)}restore(e){(function(e){return 5e3===e.type})(e)&&e.toSelection(this)}removeChildSelection(){this.childSelectionCollection.forEach(e=>{e.teardown()}),this.childSelectionCollection.splice(0)}onSelectionChanged(){this.updateChildSelection(),this.version.increment(),this.selectionUpdated.emit(new nn)}updateChildSelection(){this.removeChildSelection();for(const e of this.filteredGraphicCollection){const t=this.selectionCreatorRegistry.createSelection(e.model);void 0!==t&&this.childSelectionCollection.push(t)}}}function cn(e){return 5e3===e.type}const ln=[5e3,function(e,t){const r=e,i=new en,n=new tn(i,r.readOnlyGraphicCollection);return new hn(r,n,t)}];const un=[5e3,[[5e3,function(e){return e}]]];class dn{constructor(e,t,r,i,n=!1){this.actionType="modXfrmAct",this.posDiff=e,this.scaleDiff=t,this.rotationDiff=r,this.flipDiff=i,this.scaleFromCenter=n}isTranslation(){return void 0===this.scaleDiff&&void 0===this.rotationDiff&&void 0===this.flipDiff}}function fn(e,t){const r=e.clone();if(void 0!==t.posDiff&&(r.pos.x+=t.posDiff.x,r.pos.y+=t.posDiff.y),void 0!==t.scaleDiff&&(r.size.width*=t.scaleDiff.width,r.size.height*=t.scaleDiff.height,t.scaleFromCenter)){const t=e.size,i=r.size;t.height!==i.height?r.pos.y+=(t.height-i.height)/2:r.pos.x+=(t.width-i.width)/2}return void 0!==t.rotationDiff&&(r.rot+=t.rotationDiff),void 0!==t.flipDiff&&(t.flipDiff.x&&(r.flip.x=!r.flip.x),t.flipDiff.y&&(r.flip.y=!r.flip.y)),r}function pn(e){const t=e.currentTarget.getBoundingClientRect();return new Ui(e.clientX-t.left,e.clientY-t.top)}class gn{constructor(e,t){this.x=!1,this.y=!1,this.x=void 0!==e&&e,this.y=void 0!==t&&t}clone(){return new gn(this.x,this.y)}equals(e){return this.x===e.x&&this.y===e.y}}class mn{constructor(e,t){this.x=0,this.y=0,this.x=void 0!==e?e:0,this.y=void 0!==t?t:0}clone(){return new mn(this.x,this.y)}equals(e){return this.x===e.x&&this.y===e.y}multiply(e){const t=this.x*e.m11+this.y*e.m21+e.m31,r=this.x*e.m12+this.y*e.m22+e.m32;this.x=t,this.y=r}}class _n{constructor(e,t){this.width=0,this.height=0,this.width=void 0!==e?e:0,this.height=void 0!==t?t:0}clone(){return new _n(this.width,this.height)}equals(e){return this.width===e.width&&this.height===e.height}}class vn{constructor(e,t,r,i){this.pos=new mn,this.size=new _n,this.flip=new gn,this.rot=0,void 0!==e&&(this.pos=e),void 0!==t&&(this.size=t),void 0!==r&&(this.flip=r),void 0!==i&&(this.rot=i)}clone(){return new vn(this.pos.clone(),this.size.clone(),this.flip.clone(),this.rot)}equals(e){return this.pos.equals(e.pos)&&this.size.equals(e.size)&&this.flip.equals(e.flip)&&this.rot===e.rot}multiply(e){const t=new mn(this.pos.x+this.size.width,this.pos.y+this.size.height);this.pos.multiply(e),t.multiply(e),this.size.width=t.x-this.pos.x,this.size.height=t.y-this.pos.y}}class yn{constructor(e,t,r,i){this.left=e,this.top=t,this.right=r,this.bottom=i}width(){return this.right-this.left}height(){return this.bottom-this.top}isValid(){return this.width()>=0&&this.height()>=0}isEmpty(){return 0===this.width()||0===this.height()}center(){return this.isValid()||Ci(0,"Invalid Rect"),new Ui((this.left+this.right)/2,(this.top+this.bottom)/2)}union(e){this.isValid()||Ci(0,"Invalid Rect"),this.left=Math.min(this.left,e.left),this.top=Math.min(this.top,e.top),this.right=Math.max(this.right,e.right),this.bottom=Math.max(this.bottom,e.bottom)}inflate(e){this.isValid()||Ci(0,"Invalid Rect"),this.left-=e,this.top-=e,this.right+=e,this.bottom+=e}clone(){return new yn(this.left,this.top,this.right,this.bottom)}scalarMultiply(e){this.left*=e,this.top*=e,this.right*=e,this.bottom*=e}}const bn={0:{x:-1,y:-1},1:{x:0,y:-1},2:{x:1,y:-1},3:{x:1,y:0},4:{x:1,y:1},5:{x:0,y:1},6:{x:-1,y:1},7:{x:-1,y:0}};class wn{constructor(e,t,r,i){this.isDragging=!1,this.onPointerDown=e=>{this.isDragging=!0,this.dragStartPosition=pn(e.eventData);e.eventData.target.style.cursor="crosshair",void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.beginPreview(this.editPreviewInfo)},this.onPointerMove=e=>{if(!this.isDragging)return;if(e.eventData.target.style.cursor="crosshair",void 0!==this.dragStartPosition&&void 0!==this.editPreviewInfo){const t=this.handleTransformChange(pn(e.eventData));this.editPreviewInfo.dragEditPreviewManager.setTransformDiff(new vn(t.posDiff,t.scaleDiff,t.flipDiff))}},this.onPointerUp=e=>{if(this.isDragging){if(void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.endPreview(this.editPreviewInfo),void 0!==this.dragStartPosition){const t=this.handleTransformChange(pn(e.eventData));void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.setTransformDiff(new vn(t.posDiff,t.scaleDiff,t.flipDiff)),this.invokeAction.invoke(new dn(t.posDiff,t.scaleDiff,0,t.flipDiff))}this.isDragging=!1,this.dragStartPosition=void 0}},this.onPointerCancel=e=>{this.isDragging&&(void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.endPreview(this.editPreviewInfo),this.isDragging=!1,this.dragStartPosition=void 0)},this.transform=e,this.invokeAction=t,this.resizeHandleKind=r,this.editPreviewInfo=i}addEventListeners(e){e.pointerEventNotifiers.pointerdown.value.on(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.on(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.on(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.on(this.onPointerCancel)}removeEventListeners(e){e.pointerEventNotifiers.pointerdown.value.off(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.off(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.off(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.off(this.onPointerCancel)}handleTransformChange(e){const t=new mn(e.x,e.y);let r=this.handleResize(t),i=this.handleReposition(r);const n=r.width<0,s=r.height<0;if(n||s){const e=this.transform.pos.x+i.x,t=this.transform.pos.y+i.y,n=e+this.transform.size.width*r.width,s=t+this.transform.size.height*r.height,o=new yn(e<n?e:n,t<s?t:s,e<n?n:e,t<s?s:t);i=new mn(o.left-this.transform.pos.x,o.top-this.transform.pos.y),r=new _n(o.width()/this.transform.size.width,o.height()/this.transform.size.height)}return{posDiff:i,scaleDiff:r,flipDiff:new gn(n,s)}}handleResize(e){if(void 0===this.dragStartPosition)return new _n(1,1);const t=new mn(e.x-this.dragStartPosition.x,e.y-this.dragStartPosition.y),r=this.rotatePosition2D(t,-Gi(this.transform.rot)),i=this.transform.size.width,n=this.transform.size.height,s=i+r.x*bn[this.resizeHandleKind].x,o=n+r.y*bn[this.resizeHandleKind].y;return new _n((0===s?1:s)/i,(0===o?1:o)/n)}handleReposition(e){if(void 0===this.dragStartPosition)return new mn(0,0);const t=this.transform.size.width,r=this.transform.size.height,i=e.width*t,n=e.height*r,s=new mn((i-t)*bn[this.resizeHandleKind].x/2,(n-r)*bn[this.resizeHandleKind].y/2),o=new mn(this.transform.pos.x+this.transform.size.width/2,this.transform.pos.y+this.transform.size.height/2),a=this.rotatePosition2D(s,Gi(this.transform.rot)),h=new mn(o.x+a.x,o.y+a.y);return new mn(h.x-i/2-this.transform.pos.x,h.y-n/2-this.transform.pos.y)}rotatePosition2D(e,t){const r=new Ui(e.x,e.y),i=Wi.identity().rotate(t);return r.multiply(i),r}}class Tn{constructor(e){this.actionType="addGraphicsToSel",this.graphicIds=e}}class xn{constructor(e,t=!1){this.actionType="selGrphAct",this.ids=[],this.isFirstTimeSelect=!1,this.ids=[...e],this.clearExisting=t}}class Pn{constructor(e,t,r){this.isDragging=!1,this.editPreviewBegun=!1,this.onPointerDown=e=>{this.isDragging=!0,this.dragStartPosition=pn(e.eventData),e.eventData.ctrlKey?this.invokeAction.invoke(new Tn([this.graphicId])):this.invokeAction.invoke(new xn([this.graphicId])),this.editPreviewBegun=!1},this.onPointerMove=e=>{if(this.isDragging&&void 0!==this.dragStartPosition){const t=pn(e.eventData),r=new Ui(t.x-this.dragStartPosition.x,t.y-this.dragStartPosition.y);this.editPreviewBegun||Math.abs(r.x)>.5&&Math.abs(r.y)>.5&&(void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.beginPreview(this.editPreviewInfo),this.editPreviewBegun=!0),void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.setTransformDiff(new vn(new mn(r.x,r.y),new _n(1,1)))}},this.onPointerUp=e=>{if(this.isDragging){if(this.editPreviewBegun&&void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.endPreview(this.editPreviewInfo),void 0!==this.dragStartPosition){const t=pn(e.eventData),r=new mn(t.x-this.dragStartPosition.x,t.y-this.dragStartPosition.y);Math.abs(r.x)>.5&&Math.abs(r.y)>.5&&this.invokeAction.invoke(new dn(r))}this.isDragging=!1,this.dragStartPosition=void 0}},this.onPointerCancel=e=>{this.isDragging&&(this.editPreviewBegun&&void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.endPreview(this.editPreviewInfo),this.isDragging=!1,this.dragStartPosition=void 0)},this.graphicId=e,this.invokeAction=t,this.editPreviewInfo=r}addEventListeners(e){e.pointerEventNotifiers.pointerdown.value.on(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.on(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.on(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.on(this.onPointerCancel)}removeEventListeners(e){e.pointerEventNotifiers.pointerdown.value.off(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.off(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.off(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.off(this.onPointerCancel)}}class Cn{constructor(e,t,r){this.isDragging=!1,this.onPointerDown=e=>{this.isDragging=!0,this.dragStartPosition=pn(e.eventData);e.eventData.target.style.cursor="crosshair",void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.beginPreview(this.editPreviewInfo)},this.onPointerMove=e=>{if(!this.isDragging)return;if(e.eventData.target.style.cursor="crosshair",void 0!==this.dragStartPosition&&void 0!==this.editPreviewInfo){const t=this.handleRotationChange(pn(e.eventData));this.editPreviewInfo.dragEditPreviewManager.setTransformDiff(new vn(new mn(0,0),new _n(1,1),new gn(!1,!1),t))}},this.onPointerUp=e=>{if(this.isDragging){if(void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.endPreview(this.editPreviewInfo),void 0!==this.dragStartPosition){const t=this.handleRotationChange(pn(e.eventData));void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.setTransformDiff(new vn(new mn(0,0),new _n(1,1),new gn(!1,!1),t)),this.invokeAction.invoke(new dn(new mn(0,0),new _n(1,1),t,new gn(!1,!1)))}this.isDragging=!1,this.dragStartPosition=void 0}},this.onPointerCancel=e=>{this.isDragging&&(void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.endPreview(this.editPreviewInfo),this.isDragging=!1,this.dragStartPosition=void 0)},this.transform=e,this.invokeAction=t,this.editPreviewInfo=r}addEventListeners(e){e.pointerEventNotifiers.pointerdown.value.on(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.on(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.on(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.on(this.onPointerCancel)}removeEventListeners(e){e.pointerEventNotifiers.pointerdown.value.off(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.off(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.off(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.off(this.onPointerCancel)}handleRotationChange(e){const t=new mn(e.x,e.y),r=new mn(this.transform.pos.x+this.transform.size.width/2,this.transform.pos.y+this.transform.size.height/2),i=new Ui(t.x-r.x,t.y-r.y);i.normalize();const n=Math.acos(-i.y)*(i.x<0?-1:1)+(this.transform.flip.y?ki:0);return 180*n/ki-this.transform.rot}}function En(e){return Math.round(e)}function Sn(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n+=1)if(r=e[n],i=t[n],!r.equals(i))return!1;var r,i;return!0}function Rn(e){return e.map(e=>e)}class Mn{constructor(e,t,r,i,n=[]){this.type=0,this.r=e,this.g=t,this.b=r,this.a=i,this.transforms=n}clone(){return new Mn(this.r,this.g,this.b,this.a,Rn(this.transforms))}equals(e){return In(e)&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a&&Sn(this.transforms,e.transforms)}}function In(e){return 0===e.type}new Mn(0,0,0,1);function An(e){return 3===e.type}function Fn(e){return e/255}function Bn(e){return Q.FromRGBA({r:Fn(e.r),g:Fn(e.g),b:Fn(e.b),a:e.a})}function Dn(e,t){try{t(e)}finally{e.dispose()}}function Ln(e){if(!function(e){return 0!==e}(e))throw new Error("Check for Null style matrix index reference before calling to resolve position.");return e-1}function On(e){return 2===e.type}class kn{constructor(e){this.type=1,this.color=e}clone(){return new kn(this.color)}equals(e){return Nn(e)&&this.color.equals(e.color)}}function Nn(e){return 1===e.type}function Gn(e){return 2===e.type}function Un(e,t){if(Nn(e)){if(On(e.color)){const r=t.clone();return r.transforms.push(...Rn(e.color.transforms)),new kn(r)}}else if(Gn(e))throw new Error("Resolve style fillprops before making a call to replace placeholder color.");return e}function Vn(e){return 4===e.type}function zn(e){return e<0?0:e<=.798354?12.92*e:e<255?269.025*Math.pow(e/255,1/2.4)-14.025:255}function Wn(e){return new Mn(zn(e.r),zn(e.g),zn(e.b),e.a)}function Hn(e){const t=e.h,r=e.s,i=e.l,n=i<=.5?i*(r+1):i+r-i*r,s=2*i-n;return new Mn(255*jn(s,n,t+120),255*jn(s,n,t),255*jn(s,n,t-120),e.a)}function jn(e,t,r){const i=qn(r);return i<60?e+(t-e)*i/60:i<180?t:i<240?e+(t-e)*(240-i)/60:e}function qn(e){return e<0?e+360:e>=360?e-360:e}function Xn(e){if(e.transforms.length>0){return function(e){return new Mn(En(e.r),En(e.g),En(e.b),e.a)}(function(e){return Vn(e)?Hn(e):An(e)?Wn(e):e}(e.transforms.reduce((e,t)=>t.transform(e),e)))}return e}function Kn(e){return 1===e.type}function Yn(e,t){if(In(e))return Xn(e);if(Kn(e)){if(void 0===t)throw new Error("ThemeInfo should be provided to resolve SchemeColors.");return Xn(function(e,t){const r=e.theme.colorScheme.presets[e.schemeMapping[t.presetColorType]];return new Mn(r.r,r.g,r.b,r.a,[...t.transforms])}(t,e))}throw new Error(`Unsupported color type to resolve: ${e.type}.`)}function Qn(e,t,r){if(Nn(e)){const t=Yn(e.color,r);return new $(Bn(t))}if(Gn(e)){if(void 0===t||void 0===r)throw new Error("Error: Style reference and Theme definition needed to resolve StyleFillProps.");return Qn(function(e,t){const r=Ln(t.index),i=e.fillProps.length>r?e.fillProps[r]:void 0;if(void 0===i)throw new Error(`StyleMatrixReference index ${r} is out of bounds.`);return Un(i,t.color)}(r.theme.styles,t),t,r)}}function Zn(e){const t=new se(e.weight,1);return t.dashType=function(e){switch(e){case 0:return 0;case 1:return 5;case 2:return 6;case 3:return 7;case 4:return 8;case 5:return 9;case 6:return 10;default:Ei(e)}}(e.dashProps.dashType),t.headEnd=Jn(e.headEndProps),t.tailEnd=Jn(e.tailEndProps),t}function Jn(e){return new ne(0,function(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;default:Ei(e)}}(e.type),0,function(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;default:Ei(e)}}(e.width),function(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;default:Ei(e)}}(e.length))}function $n(e,t,r,i,n){if(void 0!==t&&(e.style.fillBrush=Qn(t,null==n?void 0:n.fillRef,i)),void 0!==r){let t;void 0!==i&&void 0!==n&&void 0!==n.lineRef?(t=r.clone(),t.resolveFrom(function(e,t){const r=Ln(t.index),i=e.lineProps.length>r?e.lineProps[r]:void 0;if(void 0===i)throw new Error(`StyleMatrixReference index ${r} is out of bounds.`);const n=i.clone();return n.fillProps=Un(i.fillProps,t.color),n}(i.theme.styles,n.lineRef))):t=r,e.style.lineBrush=Qn(t.fillProps,void 0,i),e.style.pen=Zn(t)}}class es{constructor(){this.type=2500,this.pointerEventNotifiers=Ii(),this.sourceAnchorBounds=new yn(0,0,0,0),this.scaleFactor=1/window.devicePixelRatio,this.transform=new vn,this.emuToSourceScale=1,this.cursorType=0,this.hitTestSlop=0,this.hitTestable=!0,this.isHitTestOnly=!1,this._scene=new me}get items(){return this._scene.items.elements}get bounds(){return function(e){if(void 0===e)return new yn(0,0,0,0);return new yn(e.left,e.top,e.right,e.bottom)}(this.scene.getBounds())}get scene(){return this._scene}addItem(e){this._scene.items.push(e)}addItems(e){e.forEach(e=>{this.addItem(e)})}removeItem(e){const t=this._scene.items.elements.indexOf(e);this._scene.items.elements.indexOf(e),t>=0&&t<this.items.length&&this._scene.items.removeAt(t)}setItems(e){e.length>0&&is(this._scene),this._scene.setItems(e)}translate(e){const t=this.items[0],r=t.transform;t.transform=new x(r.preTranslation,r.scale,r.rotation,new w(e.pos.x+e.size.width/2,e.pos.y+e.size.height/2))}updateShapeProps(e,t,r,i){$n(this.items[0],e,t,r,i)}clear(){this._scene.items.removeAll()}teardown(){is(this._scene)}}function ts(e){return 2500===e.type}function rs(e,t){e.register([2500,t])}function is(e){Dn(new c("ShapeBuilderViewModel.clearTextures"),t=>{t.setProp("renderDataMapSize",Object.keys(e.renderDataMap).length),t.setProp("sceneSize",e.items.length),e.releaseGeneratedResources()})}const ns=new $(Bn(new Mn(255,255,255,1))),ss=new $(Bn(new Mn(150,150,150,1))),os=new se(2,1),as=new Ri(()=>new ge([B.CreateFromRect(new P(0,0,100,1))],new oe(ss))),hs=new Ri(()=>new ge([B.CreateFromRect(new P(0,0,1,100))],new oe(ss))),cs=new Ri(()=>{const e=1.63*ki,t=new O;return t.moveTo(5.56,0),t.lineTo(7.56+2-8.31,0),t.lineTo(7.56,8.31-2),t.lineTo(5.56+8.31,0),t.lineTo(7.56+2,0),t.arcTo(7.56+2,7.56+2,0,-e),t.lineTo(5.56*Math.cos(e),-5.56*Math.sin(e)),t.arcTo(5.56,5.56,-e,e),t.close(),new ge([B.CreateFromFigure(t.createFigure())],new oe(ns,ss,os))}),ls=new Ri(()=>new ge([B.CreateFromRect(new P(0,0,1,25))],new oe(ss))),us=new Ri(()=>{const e=new O;return e.moveTo(4.72,0),e.arcTo(4.72,4.72,0,Ni),e.close(),new ge([B.CreateFromFigure(e.createFigure())],new oe(ns,ss,os))});function ds(e,t,r,i,n){const s=[],o=new Di({nodeType:"selGraphic",nodeKey:t}),a=new Di({nodeType:"selOutline"});a.data=function(e,t){const r=new es;r.addItem(function(e){const t=ps(e),r=Gi(e.rot),i=new me([as.value]);i.transform=new x(new w(-50,-e.size.height/2-.5),new w(e.size.width/100,1),r,new w(t.x,t.y));const n=new me([as.value]);n.transform=new x(new w(-50,e.size.height/2-.5),new w(e.size.width/100,1),r,new w(t.x,t.y));const s=new me([hs.value]);s.transform=new x(new w(-e.size.width/2-.5,-50),new w(1,e.size.height/100),r,new w(t.x,t.y));const o=new me([hs.value]);return o.transform=new x(new w(e.size.width/2-.5,-50),new w(1,e.size.height/100),r,new w(t.x,t.y)),new me([i,n,s,o])}(e)),r.hitTestSlop=6,void 0!==t&&t.addEventListeners(r);return r}(e,r),s.push(a);const h=new Di({nodeType:"selRotateHandleStem"});h.data=function(e){const t=new es;return t.addItem(function(e){const t=ps(e),r=new me([ls.value]);return r.transform=new x(new w(-.5,-e.size.height/2-25),new w(1,e.flip.y?-1:1),Gi(e.rot),new w(t.x,t.y)),r}(e)),t}(e),s.push(h);const c=new Di({nodeType:"selRotate"});return c.data=function(e,t){const r=new es;r.addItem(function(e){const t=ps(e),r=new me([cs.value]);return r.transform=new x(new w(0,-34-e.size.height/2),new w(e.flip.x?-1:1,e.flip.y?-1:1),Gi(e.rot),new w(t.x,t.y)),r}(e)),r.hitTestSlop=6,void 0!==t&&t.addEventListeners(r);return r}(e,n),s.push(c),function(e,t){const r=[];for(const i of[-1,0,1])for(const n of[-1,0,1])0===i&&0===n||r.push(fs(e,i,n,us.value,t));return r}(e,i).forEach(e=>{const t=new Di({nodeType:"selResizeHandle"});t.data=e,s.push(t)}),o.childNodes=s,{viewModel:o,editableElements:[]}}function fs(e,t,r,i,n){const s=new es;s.addItem(function(e,t,r,i){const n=ps(e),s=new me([i]);return s.transform=new x(new w(r*e.size.width/2,t*e.size.height/2),void 0,Gi(e.rot),new w(n.x,n.y)),s}(e,t,r,i));const o=function(e,t){switch(e){case-1:switch(t){case-1:return 0;case 0:return 1;case 1:return 2;default:Ei(t)}case 0:switch(t){case-1:return 7;case 0:throw new Error("Unrecognized ResizeHandleKind. Row=1, Col=1 is disallowed.");case 1:return 3;default:Ei(t)}case 1:switch(t){case-1:return 6;case 0:return 5;case 1:return 4;default:Ei(t)}default:Ei(e)}}(t,r);return s.cursorType=function(e,t){const r=function(e){const t=e>=0?e:e+2*ki;if(t<=ki/8||7*ki/8<t&&t<=9*ki/8||t>15*ki/8)return 0;if(1*ki/8<t&&t<=3*ki/8||9*ki/8<t&&t<=11*ki/8)return 1;if(3*ki/8<t&&t<=5*ki/8||11*ki/8<t&&t<=13*ki/8)return 2;return 3}(Gi(t.rot));switch(e){case 0:case 4:switch(r){case 0:return 4;case 1:return 1;case 2:return 3;case 3:default:return 2}case 1:case 5:switch(r){case 0:return 1;case 1:return 3;case 2:return 2;case 3:default:return 4}case 2:case 6:switch(r){case 0:return 3;case 1:return 2;case 2:return 4;case 3:default:return 1}case 7:case 3:switch(r){case 0:return 2;case 1:return 4;case 2:return 1;case 3:default:return 3}default:return 0}}(o,e),s.hitTestSlop=6,void 0!==n&&n(o).addEventListeners(s),s}function ps(e){return new Ui(e.pos.x+e.size.width/2,e.pos.y+e.size.height/2)}const gs=Q.FromRGBA({r:.3,g:.3,b:.3,a:.5}),ms=Q.FromRGBA({r:1,g:1,b:1,a:.5}),_s=new $(gs),vs=new $(ms),ys=new se(1,1),bs=new Ri((function(){const e=new O;e.moveTo(4,0),e.arcTo(4,4,0,Ni),e.close();const t=B.CreateFromFigure(e.createFigure()),r=new ge([t]);return r.style.fillBrush=_s,r.style.lineBrush=vs,r.style.pen=ys,r}));function ws(e){const t=new es;return t.addItem(function(e){const t=new me([bs.value]);return t.transform=new x(new w(e.x,e.y)),t}(e)),t}function Ts(e,t){const r={nodeType:"conGraphic",nodeKey:e.contentId},i=new Di(r),n=[];let s=0;return function(e){const t=[];return e.forEach(e=>{t.push(ws(e))}),t}(t).forEach(e=>{const t={nodeType:"conPoint",nodeKey:s.toString()},r=new Di(t);r.data=e,n.push(r),s+=1}),i.childNodes=n,i}class xs{constructor(e,t,r){this.type=5002,this.viewModelUpdated=new Mi,this.containerViewModel=new Di({nodeType:"grCollConnVRoot"}),this.onViewUpdated=e=>{this.updateViewModel()},this.onConnectableUpdated=()=>{this.updateViewModel()},this.connectable=e,this.modelPresenter=t,this.connectablePointsCreatorRegistry=r,this.updateViewModel(),this.connectable.connectableUpdated.on(this.onConnectableUpdated),this.modelPresenter.viewModelUpdated.on(this.onViewUpdated)}get viewModel(){return this.containerViewModel}teardown(){}updateViewModel(){this.containerViewModel.childNodes=[];for(let e=0;e<this.connectable.length;e+=1){const t=this.connectable.getItemByIndex(e);void 0!==t&&this.containerViewModel.childNodes.push(this.createConnectableViewForGraphic(t))}this.viewModelUpdated.emit(new Oi)}createConnectableViewForGraphic(e){const t=this.modelPresenter.anchorPresenterCreator(e).transform,r=this.connectablePointsCreatorRegistry.createConnectablePoints(e.model,t);return Ts(e,void 0!==r?r:[])}}class Ps{constructor(e,t,r,i,n,s,o,a,h){this.type=5001,this.viewModelUpdated=new Mi,this.onViewUpdated=e=>{var t;void 0!==(t=e.data)&&5001===t.type&&e.data.graphicIds.length>0?e.data.graphicIds.forEach(e=>{this.onChildGraphicUpdated(e)}):this.updateViewModel()},this.onSelectionUpdated=()=>{this.updateViewModel(),this.updateChildSelectionView(),this.updateViewModel()},this.onChildSelectionViewUpdated=()=>{this.updateChildSelectionViewModel(),this.viewModelUpdated.emit(new Oi)},this.selection=e,this.modelPresenter=t,this.selectionPresenterCreatorRegistry=r,this.selectionViewDataCreatorRegistry=i,this.connectablePointsCreatorRegistry=n,this.presenterContext=s,this.editContext=o,this.rootViewModelNodeType=a,this.suppressParentSelection=h,this.containerViewModel=function(e){return new Di({nodeType:e})}(this.rootViewModelNodeType),this.updateViewModel(),this.connectablePresenter=function(e,t,r){return new xs(e,t,r)}(this.selection.graphicCollectionConnectable,this.modelPresenter,this.connectablePointsCreatorRegistry),this.selection.selectionUpdated.on(this.onSelectionUpdated),this.modelPresenter.viewModelUpdated.on(this.onViewUpdated)}get viewModel(){return this.containerViewModel}teardown(){this.selection.selectionUpdated.off(this.onSelectionUpdated),this.modelPresenter.viewModelUpdated.off(this.onViewUpdated)}onChildGraphicUpdated(e){if(void 0===this.containerViewModel.data)return;const t={nodeType:"selGraphic",nodeKey:e},r=this.containerViewModel.data,i=[r.nodeId,t],n=this.selection.getItemById(e);void 0!==n?r.updateViewModel(i,this.createSelectionViewModelForGraphic(n)):r.tryRemoveNode(i)}updateChildSelectionView(){const e=this.getGraphicIdFromChildSelection();if(e===(void 0!==this.childSelectionPresenterEntry?this.childSelectionPresenterEntry.graphicId:void 0))return!1;let t;if(void 0!==e){const r=this.createChildSelectionPresenter(e);void 0!==r&&(t={graphicId:e,selectionPresenter:r})}return this.setChildSelectionPresenterEntry(t),!0}updateViewModel(){this.updateRootSelectionViewModel(),this.updateChildSelectionViewModel(),this.viewModelUpdated.emit(new Oi)}updateRootSelectionViewModel(){void 0!==this.suppressParentSelection&&this.suppressParentSelection||(this.containerViewModel.data=this.createRootSelectionViewModelData())}updateChildSelectionViewModel(){const e=[];if(void 0!==this.childSelectionPresenterEntry){const t=function(e,t){const r=new Di({nodeType:"grCollSelVChild",nodeKey:e});return r.data=t,r}(this.childSelectionPresenterEntry.graphicId,this.childSelectionPresenterEntry.selectionPresenter.viewModel);e.push(t)}this.containerViewModel.childNodes=e}getGraphicIdFromChildSelection(){if(void 0===this.selection.childSelection)return;if(1!==this.selection.length)throw new Error("There should be exactly one selected Graphic");const e=this.selection.getItemByIndex(0);if(void 0===e)throw new Error("There should be exactly one selected Graphic");return e.contentId}setChildSelectionPresenterEntry(e){void 0!==this.childSelectionPresenterEntry&&(this.childSelectionPresenterEntry.selectionPresenter.viewModelUpdated.off(this.onChildSelectionViewUpdated),this.childSelectionPresenterEntry.selectionPresenter.teardown()),this.childSelectionPresenterEntry=e,void 0!==this.childSelectionPresenterEntry&&this.childSelectionPresenterEntry.selectionPresenter.viewModelUpdated.on(this.onChildSelectionViewUpdated)}createChildSelectionPresenter(e){if(void 0===this.selection.childSelection)return;const t=this.modelPresenter.getPresenterById(e);if(void 0===t)return;const r=this.selection.getItemById(e),i=void 0!==r?{anchorPresenter:new zi(this.presenterContext.anchorPresenter,this.modelPresenter.anchorPresenterCreator(r),new ji),viewScale:this.presenterContext.viewScale,renderDataPresenterCreatorRegistry:this.presenterContext.renderDataPresenterCreatorRegistry}:this.presenterContext;return this.selectionPresenterCreatorRegistry.createSelectionPresenter(this.selection.childSelection,t,this.selectionViewDataCreatorRegistry,i,this.editContext)}createRootSelectionViewModelData(){const e=new Di({nodeType:"selRoot"});e.childNodes=[];for(let t=0;t<this.selection.length;t+=1){const r=this.selection.getItemByIndex(t);void 0!==r&&e.childNodes.push(this.createSelectionViewModelForGraphic(r))}return e}createSelectionViewModelForGraphic(e){return this.createSelectionViewDataForGraphic(e).viewModel}createSelectionViewDataForGraphic(e){const t=this.modelPresenter.anchorPresenterCreator(e).transform,r=this.selectionViewDataCreatorRegistry.createSelectionViewData(e,t,this.editContext);return void 0===r?function(e,t,r){const i=new Pn(e.contentId,r.actionInvoker,r.previewInfo),n=new Cn(t,r.actionInvoker,r.previewInfo);return ds(t,e.contentId,i,e=>new wn(t,r.actionInvoker,e,r.previewInfo),n)}(e,t,this.editContext):r}}function Cs(e,t,r){return(i,n,s,o,a,h)=>new Ps(i,n,s,o,e,a,h,t,r)}var Es;function Ss(e,t){return e.getEntry(t.key,function(e){let t=Es.None;return e.altKey&&(t|=Es.Alt),e.ctrlKey&&(t|=Es.Ctrl),e.shiftKey&&(t|=Es.Shift),t}(t))}!function(e){e[e.None=0]="None",e[e.Alt=1]="Alt",e[e.Ctrl=2]="Ctrl",e[e.Shift=4]="Shift"}(Es||(Es={}));class Rs{constructor(e){this.editOps=[],this.performed=e}}function Ms(e,t){const r=t.createSelectionIterable(e,5e3);if(void 0===r)throw new Error("Cannot get IGraphicCollectionSelection");return r}class Is{constructor(e){this.registry=new Map(e)}register(e){this.registry.set(e[0],e[1])}get(e){return this.registry.get(e)}forEach(e){this.registry.forEach(e)}}class As extends Is{constructor(){super(...arguments),this.check=(e,t,r)=>{const i=this.get(e.actionType);return void 0===i?{isEnabled:!1,isVisible:!1}:i.check(e,t,r)},this.perform=(e,t,r)=>{const i=this.get(e.actionType);return void 0===i?new Rs(!1):i.perform(e,t,r)}}}class Fs{constructor(){this.actionType="removeGraphics"}}class Bs{perform(){return{undoOp:new Bs}}serialize(){return""}}class Ds{constructor(e,t,r){this.graphicCollection=e,this.graphicId=t,this.index=r}perform(){const e=this.graphicCollection.readOnlyGraphicCollection.getIndexById(this.graphicId);return-1===e?{undoOp:new Bs}:(this.graphicCollection.setGraphicOrder(this.graphicId,this.index),{undoOp:new Ds(this.graphicCollection,this.graphicId,e)})}serialize(){return""}}class Ls{constructor(e,t,r){this.graphicCollection=e,this.graphicId=t,this.changeOrderType=r}perform(){const e=this.graphicCollection.readOnlyGraphicCollection.getIndexById(this.graphicId);return-1===e?{undoOp:new Bs}:(this.graphicCollection.changeGraphicOrder(this.graphicId,this.changeOrderType),{undoOp:new Ds(this.graphicCollection,this.graphicId,e)})}serialize(){return""}}class Os{constructor(e,t,r){this.graphicCollection=e,this.graphic=t,this.index=r}perform(){return void 0!==this.index?this.graphicCollection.addGraphicAt(this.graphic,this.index):this.graphicCollection.addGraphic(this.graphic),{undoOp:new ks(this.graphicCollection,this.graphic)}}serialize(){return""}}class ks{constructor(e,t){this.graphicCollection=e,this.graphic=t}perform(){const e=this.graphicCollection.readOnlyGraphicCollection.getIndexById(this.graphic.contentId);if(-1===e)return{undoOp:new Bs};const t=new Os(this.graphicCollection,this.graphic,e);return this.graphicCollection.removeGraphic(this.graphic),{undoOp:t}}serialize(){return""}}function Ns(){return{isEnabled:!0,isVisible:!0}}function Gs(e){return(t,r,i)=>{const n=Ms(r,i.selectionIterableCreatorRegistry);return e(t,n,i),new Rs(!0)}}function Us(e){return(t,r,i)=>{const n=Ms(r,i.selectionIterableCreatorRegistry),s=e(t,n,i),o=new Rs(!0);return o.editOps.push(...s),o}}const Vs=new As([["addGraphicsToSel",{check:Ns,perform:Gs((function(e,t){const r=e.graphicIds.map(e=>t.graphicCollectionModel.readOnlyGraphicCollection.getItemById(e));t.addGraphics(r)}))}],["clrConnViewAct",{check:Ns,perform:Gs((function(e,t){t.graphicCollectionConnectable.clear()}))}],["selectAllGraphics",{check:Ns,perform:Gs((function(e,t){const r=[];for(const e of t.graphicCollectionModel.readOnlyGraphicCollection)r.push(e);t.setGraphics(r)}))}],["selGrphAct",{check:Ns,perform:Gs((function(e,t,r){const i=[];let n=e.clearExisting;e.ids.forEach(e=>{const r=t.graphicCollectionModel.readOnlyGraphicCollection.getItemById(e);if(void 0===r)throw new Error(`Graphic with id ${e} not found in the current collection. Cannot select.`);i.push(r),n=n||!t.hasItem(e)}),n&&(t.setGraphics(i),e.isFirstTimeSelect=!0,r.actionInvoker.invoke(e))}))}],["showConnViewAct",{check:Ns,perform:Gs((function(e,t){const r=e.ids.map(e=>t.graphicCollectionConnectable.graphicCollectionModel.readOnlyGraphicCollection.getItemById(e));t.graphicCollectionConnectable.setGraphics(r)}))}],["removeGraphics",{check:Ns,perform:Us((function(e,t){const r=[];for(const e of t)r.push(new ks(t.graphicCollectionModel,e));return r}))}],["changeZOrder",{check:Ns,perform:Us((function(e,t){const r=[],i=e.changeOrderType,n=[];for(const e of t)n.push(e);switch(i){case 0:case 3:n.reverse().forEach(e=>{r.push(new Ls(t.graphicCollectionModel,e.contentId,i))});break;case 1:case 2:n.forEach(e=>{r.push(new Ls(t.graphicCollectionModel,e.contentId,i))});break;default:Ei(i)}return r}))}]]);class zs{constructor(e){this.keyMapEntries=new Map,this.registerEntries(e)}registerEntries(e){e.forEach(e=>{this.registerEntry(e)})}registerEntry(e){const t=this.keyMapEntries.get(e.key);void 0!==t?t[e.modifiers]=e.entry:this.keyMapEntries.set(e.key,{[e.modifiers]:e.entry})}getEntry(e,t){const r=this.keyMapEntries.get(e);if(void 0!==r)return r[t]}}function Ws(e,t,r){return function(e,t){let r=new _n(1,1),i=new mn,n=0;const s=window.navigator.userAgent.indexOf("Macintosh")>=0?e.metaKey:e.ctrlKey;if("keydown"===e.type)switch(e.key){case"ArrowUp":r=new _n(1,s?1.01:1.1),i=new mn(0,-1);break;case"ArrowDown":r=new _n(1,s?1/1.01:1/1.1),i=new mn(0,1);break;case"ArrowLeft":r=new _n(s?1/1.01:1/1.1,1),n=s?-1:-15,i=new mn(-1,0);break;case"ArrowRight":r=new _n(s?1.01:1.1,1),n=s?1:15,i=new mn(1,0);break;default:return{isHandled:!1,removeSelection:!1}}if(e.shiftKey)t.actionInvoker.invoke(function(e){return new dn(void 0,e,void 0,void 0,!0)}(r));else if(e.altKey){if(0===n)return{isHandled:!1,removeSelection:!1};t.actionInvoker.invoke(new dn(void 0,void 0,n))}else t.actionInvoker.invoke(new dn(i));return{isHandled:!0,removeSelection:!1}}(e,r)}function Hs(e,t,r){return r.actionInvoker.invoke(new Fs),{isHandled:!0,removeSelection:!1}}new zs([{key:"Delete",modifiers:Es.None,entry:Hs},{key:"Backspace",modifiers:Es.None,entry:Hs},{key:"Arrow",modifiers:Es.None,entry:Ws},{key:"Tab",modifiers:Es.None,entry:function(e,t,r){const i=Ms(t,r.selectionIterableCreatorRegistry),n=e.shiftKey?1:0;return function(e,t,r){const i=function(e,t,r){if(0===t.length)return-1;const i=0===r?0:t.length-1;if(0===e.length)return i;const n=e.getItemByIndex(e.length-1);if(void 0===n)return i;const s=t.getIndexById(n.contentId);return-1===s?i:(s+(1===r?-1:1)+t.length)%t.length}(e,t,r);if(-1===i)return!1;const n=t.getItemByIndex(i);void 0!==n&&e.setGraphics([n])}(i,i.graphicCollectionModel.readOnlyGraphicCollection,n),{isHandled:!0,removeSelection:!1}}},{key:"ArrowUp",modifiers:Es.None,entry:Ws},{key:"ArrowDown",modifiers:Es.None,entry:Ws},{key:"ArrowLeft",modifiers:Es.None,entry:Ws},{key:"ArrowRight",modifiers:Es.None,entry:Ws}]);function js(e){const t=[];for(const r of e)t.push(r.perform().undoOp);return t.reverse()}class qs{constructor(e,t){this.type=5e3,this.id=e,this.mergePolicy=t}shouldMergeWithPrevious(e){return 5e3===e.type&&e.id===this.id&&this.mergePolicy.shouldMergeWithPrevious(e.mergePolicy)}}class Xs{constructor(e,t=[]){this.editOps=[],this.id=e,this.editOps=t}perform(){return{undoOp:new Xs(this.id,js(this.editOps))}}serialize(){return JSON.stringify((e=this.id,t=this.editOps,{id:e,ops:t.map(e=>e.serialize())}));var e,t}get mergePolicy(){var e;return void 0!==(null===(e=this.editOps[0])||void 0===e?void 0:e.mergePolicy)?new qs(this.id,this.editOps[0].mergePolicy):void 0}}function Ks(e,t,r,i){const n=Ms(t,r.selectionIterableCreatorRegistry);if(void 0!==n.childSelection){const t=r.editorRegistry.processKeyboardEvent(e,n.childSelection,r);if(t.isHandled)return t}if("keydown"===e.type){const n=void 0!==i?Ss(i,e):void 0;if(void 0!==n)return n(e,t,r)}return{isHandled:!1,removeSelection:!0}}const Ys=()=>({isHandled:!1,removeSelection:!0}),Qs=()=>({isEnabled:!1,isVisible:!0}),Zs=(e,t,r)=>{let i=new Rs(!1);const n=Ms(t,r.selectionIterableCreatorRegistry);if(n.childSelectionCollection.length>0){let t=!1;const s=[];n.childSelectionCollection.forEach((i,o)=>{const a=r.editorRegistry.performAction(e,i,r);a.performed&&(t=!0,a.editOps.length>0&&s.push(new Xs(n.getItemByIndex(o).contentId,a.editOps)))}),t&&(i=new Rs(!0),s.forEach(e=>i.editOps.push(e)))}return i.performed||void 0===Vs.get(e.actionType)?i:Vs.perform(e,n,r)};class Js{constructor(){this.rootNodeType="grCollR",this.graphicNodeType="grCollCh"}}class $s{constructor(){this.itemsMap=new Map,this.idArray=[]}addItem(e,t){this.itemsMap.has(e.contentId)||(this.itemsMap.set(e.contentId,e),this.idArray.splice(null!=t?t:this.idArray.length,0,e.contentId))}addItems(e){for(const t of e)this.addItem(t)}removeItem(e){this.removeItemById(e.contentId)}removeItems(e){for(const t of e)this.removeItem(t)}removeItemById(e){this.itemsMap.delete(e);const t=this.getIndexById(e);-1!==t&&this.idArray.splice(t,1)}removeItemsByIds(e){for(const t of e)this.removeItemById(t)}get length(){return this.itemsMap.size}getItemById(e){return this.itemsMap.get(e)}getItemByIndex(e){if(!(e<0||e>=this.idArray.length))return this.itemsMap.get(this.idArray[e])}getItemByCondition(e){for(const[,t]of this.itemsMap)if(e(t))return t}getIndexById(e){return this.idArray.indexOf(e)}changeItemIndex(e,t){if(t>=this.idArray.length||t<0)return!1;const r=this.getIndexById(e);return-1!==r&&r!==t&&(this.idArray.splice(r,1),this.idArray.splice(t,0,e),!0)}[Symbol.iterator](){let e=0;return{next:()=>{if(e>=this.idArray.length)return{done:!0,value:void 0};const t=this.idArray[e];e+=1;const r=this.getItemById(t);if(void 0===r)throw new Error("Invalid item ID "+t);return{done:!1,value:r}}}}}class eo{constructor(e,t){this.type=1,this.data=e,this.eventChainTracker=t}}function to(e){const t=[];for(const r of e)t.push(r.contentId);return t}class ro{constructor(e){this.type=5e3,this.version=new rn,this.modelUpdated=new Mi,this.graphicCollection=new $s,this.hostContext=e}addGraphic(e){this.graphicCollection.addItem(e),this.onGraphicCollectionChanged([e.contentId])}addGraphicAt(e,t){this.graphicCollection.addItem(e,t),this.onGraphicCollectionChanged([e.contentId])}addGraphics(e){this.graphicCollection.addItems(e),this.onGraphicCollectionChanged(to(e))}removeGraphic(e){this.graphicCollection.removeItem(e),this.onGraphicCollectionChanged([],[e.contentId])}removeGraphics(e){const t=to(e);this.graphicCollection.removeItems(e),this.onGraphicCollectionChanged([],t)}removeGraphicById(e){this.graphicCollection.removeItemById(e),this.onGraphicCollectionChanged([],[e])}removeGraphicsByIds(e){this.graphicCollection.removeItemsByIds(e),this.onGraphicCollectionChanged([],[...e])}changeGraphicOrder(e,t){const r=this.graphicCollection.getIndexById(e);let i=!1;switch(t){case 0:i=this.graphicCollection.changeItemIndex(e,r+1);break;case 1:i=this.graphicCollection.changeItemIndex(e,this.graphicCollection.length-1);break;case 2:i=this.graphicCollection.changeItemIndex(e,r-1);break;case 3:i=this.graphicCollection.changeItemIndex(e,0);break;default:Ei(t)}i&&this.onGraphicCollectionChanged([],[],[e])}setGraphicOrder(e,t){this.graphicCollection.changeItemIndex(e,t)&&this.onGraphicCollectionChanged([],[],[e])}get readOnlyGraphicCollection(){return this.graphicCollection}onGraphicCollectionChanged(e=[],t=[],r=[]){this.version.increment();const i=new qi(e,t,r);this.modelUpdated.emit(new eo(i))}}function io(e){return new yn(e.pos.x,e.pos.y,e.pos.x+e.size.width,e.pos.y+e.size.height)}function no(e,t){return function(e,t){const r=io(e),i=new Ui(r.left+r.width()/2,r.top+r.height()/2),n=Gi(e.rot),s=Wi.identity().translate(-i.x,-i.y).scale(e.flip.x?-1:1,e.flip.y?-1:1).rotate(n).translate(i.x,i.y);return t.multiply(s),t}(e,function(e,t){switch(t){case 0:return new Ui(e.pos.x,e.pos.y);case 1:return new Ui(e.pos.x+e.size.width/2,e.pos.y);case 2:return new Ui(e.pos.x+e.size.width,e.pos.y);case 3:return new Ui(e.pos.x,e.pos.y+e.size.height/2);case 4:return new Ui(e.pos.x+e.size.width/2,e.pos.y+e.size.height/2);case 5:return new Ui(e.pos.x+e.size.width,e.pos.y+e.size.height/2);case 6:return new Ui(e.pos.x,e.pos.y+e.size.height);case 7:return new Ui(e.pos.x+e.size.width/2,e.pos.y+e.size.height);case 8:return new Ui(e.pos.x+e.size.width,e.pos.y+e.size.height);default:Ei(t)}}(e,t))}function so(e,t){let r=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y);r=0===r?1:r,i=0===i?1:i;const n=(e.x+t.x)/2,s=(e.y+t.y)/2,o=e.x>t.x,a=e.y>t.y;return i>r?new vn(new mn(n-i/2,s-r/2),new _n(i,r),new gn(a,!o),90):new vn(new mn(n-r/2,s-i/2),new _n(r,i),new gn(o,a))}class oo{constructor(e,t){this.transformUpdated=new Mi,this.originalTransform=e.clone(),this.originalTransform.multiply(t.transform),this._currentTransform=this.originalTransform}get transform(){return this._currentTransform}setTransformDiff(e,t,r,i){const n=this.originalTransform.clone();void 0!==e&&(n.pos.x+=e.x,n.pos.y+=e.y),void 0!==t&&(n.size.width*=t.width,n.size.height*=t.height),void 0!==r&&(n.rot+=r),void 0!==i&&(n.flip.x=i.x?!n.flip.x:n.flip.x,n.flip.y=i.y?!n.flip.y:n.flip.y),this._currentTransform=n,this.transformUpdated.emit(new Vi)}teardown(){}reset(){this._currentTransform=this.originalTransform}}function ao(e,t,r,i){let n;return void 0!==e.model.fallbackRenderData?(n=t.renderDataPresenterCreatorRegistry.createPresenter(e,{anchorPresenter:r,renderDataPresenterCreatorRegistry:t.renderDataPresenterCreatorRegistry,viewScale:i}),n.init()):n=t.editPreviewPresenterCreatorRegistry.createPresenter(e,{anchorPresenter:r,renderDataPresenterCreatorRegistry:t.renderDataPresenterCreatorRegistry,viewScale:i}),n}function ho(e,t){return new yn(Math.min(e.x,t.x),Math.min(e.y,t.y),Math.max(e.x,t.x),Math.max(e.y,t.y))}function co(e){return new vn(new mn(e.left,e.top),new _n(e.width(),e.height()))}const lo=Q.FromRGBA({r:.3,g:.3,b:.3,a:.5}),uo=Q.FromRGBA({r:.3,g:.3,b:.3,a:.5}),fo=new $(lo),po=new $(uo),go=new se(1,1),mo=new Ri((function(){const e=new O;return e.moveTo(0,0),e.lineTo(1,0),e.lineTo(1,1),e.lineTo(0,1),e.close(),new ge([B.CreateFromFigure(e.createFigure())],new oe(fo,po,go))}));function _o(e){const t=new es;return t.addItem(function(e){const t=new me([mo.value]);return t.transform=new x(new w(0,0),new w(e.size.width,e.size.height),0,new w(e.pos.x,e.pos.y)),t}(e)),t.hitTestable=!1,t}class vo{constructor(e){this.type=2502,this.viewModelUpdated=new Mi,this.containerViewModel=new Di({nodeType:"marSelRoot"}),this.startPos=e,this.endPos=new Ui(e.x+1,e.y+1),this.updateViewModel()}get viewModel(){return this.containerViewModel}updatePosition(e){this.startPos.x!==e.x&&this.startPos.y!==e.y&&(this.endPos=e,this.updateViewModel())}updateViewModel(){const e=ho(new Ui(this.startPos.x,this.startPos.y),new Ui(this.endPos.x,this.endPos.y));this.containerViewModel.data=_o(co(e)),this.viewModelUpdated.emit(new Oi)}teardown(){}}class yo{constructor(e,t,r,i,n,s){this.graphicMap=new Map,this.editPreviewMap=new Map,this.connectorMap=new Map,this.originalConnectorTransforms=new Map,this.editPreviewPresenters=[],this.selection=e,this.selectionPresenter=t,this.anchorPresenterCreatorRegistry=r,this.viewScale=i,this.graphicCollectionPresenterSite=n,this.graphicCollectionTransform=null!=s?s:new ji}beginPreview(e){const t=[];for(const r of this.selection.graphicCollectionModel.readOnlyGraphicCollection){const i=new oo(this.anchorPresenterCreatorRegistry.createPresenter(r).transform,this.graphicCollectionTransform);this.selection.hasItem(r.contentId)&&this.editPreviewMap.set(r,i);const n=ao(r,e,i,this.viewScale),s=n.viewModel;this.selection.hasItem(r.contentId)?this.editPreviewPresenters.push(n):this.addViewModelToGraphicMap(s,r),15e3===r.model.type&&(this.connectorMap.set(r,i),this.originalConnectorTransforms.set(r.contentId,i.transform)),this.setHitTestableForPresenters(!1),t.push({id:{nodeType:this.graphicCollectionPresenterSite.graphicNodeType,nodeKey:r.contentId},presenter:n})}t.push({id:{nodeType:"grCollConnVRoot"},presenter:this.selectionPresenter.connectablePresenter}),e.presenter.beginPreview(t)}endPreview(e){this.setHitTestableForPresenters(!0),e.presenter.endPreview(),this.editPreviewPresenters=[],this.editPreviewMap.clear(),this.graphicMap.clear()}beginMarqueeSelection(e,t){const r=[];for(const t of this.selection.graphicCollectionModel.readOnlyGraphicCollection){const i=ao(t,e,new oo(this.anchorPresenterCreatorRegistry.createPresenter(t).transform,this.graphicCollectionTransform),this.viewScale);this.editPreviewPresenters.push(i),this.setHitTestableForPresenters(!1),r.push({id:{nodeType:this.graphicCollectionPresenterSite.graphicNodeType,nodeKey:t.contentId},presenter:i})}this.marqueeSelectionStartPosition=t,this.marqueeSelectionPresenter=new vo(t),r.push({id:{nodeType:"marqueeSelection"},presenter:this.marqueeSelectionPresenter}),e.presenter.beginPreview(r)}updateMarqueeSelection(e){var t;this.marqueeSelectionEndPosition=e,void 0!==this.marqueeSelectionStartPosition&&(null===(t=this.marqueeSelectionPresenter)||void 0===t||t.updatePosition(e))}endMarqueeSelection(e){e.presenter.endPreview();const t=[];if(void 0!==this.marqueeSelectionStartPosition&&void 0!==this.marqueeSelectionEndPosition){const e=ho(new Ui(this.marqueeSelectionStartPosition.x,this.marqueeSelectionStartPosition.y),new Ui(this.marqueeSelectionEndPosition.x,this.marqueeSelectionEndPosition.y));for(const r of this.selection.graphicCollectionModel.readOnlyGraphicCollection){const i=this.anchorPresenterCreatorRegistry.createPresenter(r).transform,n=new Ui(i.pos.x,i.pos.y),s=new Ui(n.x+i.size.width,n.y+i.size.height);e.left<n.x&&s.x<e.right&&e.top<n.y&&s.y<e.bottom&&t.push(r.contentId)}}return this.marqueeSelectionStartPosition=void 0,this.marqueeSelectionEndPosition=void 0,this.marqueeSelectionPresenter=void 0,this.editPreviewPresenters=[],t}setTransformDiff(e){this.editPreviewMap.forEach(t=>{t.setTransformDiff(new Ui(e.pos.x,e.pos.y),e.size,e.rot,e.flip)}),this.updateConnectors(e)}hitTestGraphics(e,t){let r;if(t.renderTargetRegistry.forEach(t=>{const i=t.hitTest(e);void 0!==i&&(r=i)}),void 0===r)return;const i=function(e){const t=new Map,r=e.childNodes;if(void 0!==r&&1===r.length){const e=r[0],i=e.nodeId.nodeKey;if(void 0!==e.childNodes)for(const r of e.childNodes)if(void 0!==r.data){const e=r.data;t.set(e,{graphicId:i,connectionPoint:+r.nodeId.nodeKey})}}return t}(this.selectionPresenter.connectablePresenter.viewModel);for(const e of i.keys())if(e===r)return i.get(e);for(const e of this.graphicMap.keys())if(e===r){return{graphicId:this.graphicMap.get(e).contentId,connectionPoint:-1}}}getConnectablePoint(e){const t=this.selection.graphicCollectionModel.readOnlyGraphicCollection.getItemById(e.graphicId);if(void 0===t)return;const r=this.selectionPresenter.modelPresenter.anchorPresenterCreator(t).transform,i=this.selectionPresenter.connectablePresenter.connectablePointsCreatorRegistry.createConnectablePoints(t.model,r);return void 0!==i?i[e.connectionPoint]:void 0}updateConnectors(e){const t=new Map;this.editPreviewMap.forEach((e,r)=>{const i=this.selectionPresenter.connectablePresenter.connectablePointsCreatorRegistry.createConnectablePoints(r.model,e.transform);t.set(r.contentId,null!=i?i:[])}),this.connectorMap.forEach((r,i)=>{const n=this.originalConnectorTransforms.get(i.contentId),s=function(e,t,r,i){const n=e.model,s=e.contentId,o=n.connectorData.head,a=n.connectorData.tail,h=r.has(s),c=o.connected&&r.has(o.connectableId),l=a.connected&&r.has(a.connectableId);if(!h){if((c&&!a.connected||l&&!o.connected)&&i.isTranslation())return{transform:fn(t,i)};let e,n;if(c){e=r.get(o.connectableId)[o.connectionIndex]}else e=no(t,0);if(l){n=r.get(a.connectableId)[a.connectionIndex]}else n=no(t,8);return{transform:so(e,n)}}return 1!==r.size||i.isTranslation()?{transform:t,disconnectHead:o.connected&&!c,disconnectTail:a.connected&&!l}:{transform:t}}(i,n,t,new dn(e.pos,e.size.equals(new _n(1,1))?void 0:e.size,0===e.rot?void 0:e.rot,e.flip.equals(new gn(!1,!1))?void 0:e.flip)).transform;n.equals(s)||r.setTransformDiff(new Ui(s.pos.x-n.pos.x,s.pos.y-n.pos.y),new _n(s.size.width/n.size.width,s.size.height/n.size.height),s.rot-n.rot,new gn(n.flip.x!==s.flip.x,n.flip.y!==s.flip.y))})}addViewModelToGraphicMap(e,t){const r=e=>{Li(e)?Bi(e,r):this.graphicMap.set(e,t)};r(e)}setHitTestableForPresenters(e){this.editPreviewPresenters.forEach(t=>{const r=t.viewModel,i=t=>{Li(t)?Bi(t,i):t.hitTestable=e};i(r)})}}class bo{constructor(e){this.type=100,this.updates=e}}class wo{constructor(e){this.modelHostContextUpdated=new Mi,this.themeInfo=e}get themeInfo(){return this._themeInfo}set themeInfo(e){this._themeInfo=e,this.modelHostContextUpdated.emit(new bo([0]))}}class To extends Is{createPresenter(e,t,r){const i=this.get(e.model.type);return void 0===i&&Ci(3,"No PresenterCreator for modeltype: "+e.model.type),i(e,t,r)}}class xo extends Is{createPresenter(e){const t=this.get(e.anchor.type);return void 0===t&&Ci(3,"No AnchorPresenterCreator for AnchorType: "+e.anchor.type),t(e)}}class Po extends Is{beginRender(){this.forEach(e=>{e.beginRender()})}endRender(){this.forEach(e=>{e.endRender()})}addViewModel(e){var t;if(null===(t=this.filter)||void 0===t?void 0:t.filter(e))return;const r=this.get(e.type);void 0===r&&Ci(3,"No registered RenderTarget for ViewModel type: "+e.type),r.addViewModel(e)}}class Co extends Is{createSelection(e){const t=this.get(e.type);if(void 0!==t)return t(e,this)}}class Eo{constructor(e){this.creatorMap=new Map,this.register(e)}register(e){for(const t of e){let e=this.creatorMap.get(t[0]);void 0===e&&(e=new Map);for(const r of t[1])e.set(r[0],r[1]);this.creatorMap.has(t[0])||this.creatorMap.set(t[0],e)}}createSelectionIterable(e,t){const r=this.creatorMap.get(e.model.type);if(void 0===r)return;const i=r.get(t);return void 0!==i?i(e):void 0}}class So extends Is{createSelectionPresenter(e,t,r,i,n){const s=this.get(e.model.type);if(void 0!==s)return s(e,t,this,r,i,n)}}class Ro extends Is{createSelectionViewData(e,t,r){const i=this.get(e.model.type);if(void 0!==i)return i(e,t,r)}}class Mo extends Is{processKeyboardEvent(e,t,r){const i=this.getEditorEntry(t);return void 0!==i&&void 0!==i.keyboardEventProcessor?i.keyboardEventProcessor(e,t,r):{isHandled:!1,removeSelection:!0}}processPointerEvent(e,t,r){const i=this.getEditorEntry(t);return void 0!==i&&void 0!==i.pointerEventProcessor&&i.pointerEventProcessor(e,t,r),{isHandled:!1,removeSelection:!0}}queryActionState(e,t,r){const i=this.getEditorEntry(t);return void 0!==i&&void 0!==i.actionStateQuery?i.actionStateQuery(e,t,r):{isEnabled:!1,isVisible:!1}}performAction(e,t,r){const i=this.getEditorEntry(t);return void 0!==i&&void 0!==i.actionPerformer?i.actionPerformer(e,t,r):new Rs(!1)}getEditorEntry(e){return this.get(e.model.type)}}class Io extends Is{createPresenter(e,t,r){void 0===e.model.fallbackRenderData&&Ci(3,"Trying to create RenderDataPresenter without fallback RenderData.");const i=this.get(e.model.fallbackRenderData.type);return void 0===i&&Ci(3,"No RenderDataPresenterCreator for render data type: "+e.model.fallbackRenderData.type),i(e,t,r)}}class Ao extends Is{createEventHandler(e,t){const r=this.get(e);if(void 0!==r)return r(t)}}class Fo{constructor(){this.type=7}}class Bo{constructor(e){this.type=11,this.eventChainTracker=e}}class Do{constructor(){this.combinedScaleChanged=new Mi,this.viewTransformChanged=new Mi,this._zoomFactor=1,this._lastCombinedScale=1,this._lastViewTransform=new vn}set zoomFactor(e){const t=e*this.deviceScaleFactor;this._zoomFactor=e,this._lastCombinedScale!==t&&(this._lastCombinedScale=t,this.combinedScaleChanged.emit(new Fo))}get zoomFactor(){return this._zoomFactor}get combinedScale(){return this.zoomFactor*this.deviceScaleFactor}get deviceScaleFactor(){return 1/window.devicePixelRatio}get viewTransform(){return this._lastViewTransform}set viewTransform(e){this._lastViewTransform.equals(e)||(this._lastViewTransform=e.clone(),this.viewTransformChanged.emit(new Bo))}}class Lo{constructor(e){this.type=8,this.eventChainTrackersList=e}}class Oo{constructor(e,t,r){this.durationMs=0,this.startTimeMs=0,this.endTimeMs=0,this.causationType=e,this.eventType=t,this.eventChainTrackerList=void 0===r?[]:r instanceof Array?r:[r],this.start()}dispose(){this.end(),void 0!==this.eventChainTrackerList&&this.eventChainTrackerList.forEach(e=>{void 0!==e&&e.addEventContext(this)})}start(){this.startTimeMs=performance.now()}end(){this.endTimeMs=performance.now(),this.endTimeMs>=this.startTimeMs&&(this.durationMs=this.endTimeMs-this.startTimeMs)}}class ko{constructor(){this.renderRequestId=-1}start(e){this.renderRequestId=window.requestAnimationFrame(e)}runOnce(e){this.renderRequestId=window.requestAnimationFrame(this.getRenderFunc(e))}stop(){window.cancelAnimationFrame(this.renderRequestId),this.renderRequestId=-1}getRenderFunc(e){return()=>{e(),this.renderRequestId=-1}}}class No{constructor(e,t,r){this.onModelHostContextUpdated=e=>{e.updates.forEach(e=>{0===e&&this.model.modelUpdated.emit(new eo)})},this.contentId=e,this.model=t,this.anchor=r,this.model.hostContext.modelHostContextUpdated.on(this.onModelHostContextUpdated)}teardown(){this.model.hostContext.modelHostContextUpdated.off(this.onModelHostContextUpdated)}}class Go{constructor(e,t,r,i,n,s,o,a,h){this.frameRendered=new Mi,this.eventChainTrackersList=[],this.viewScale=new Do,this.renderLoop=new ko,this.viewModelUpdatedListener=e=>{this.invalidate(()=>{this.render()},e.eventChainTracker)},this.model=e,this.renderTargetRegistry=s,this.viewScale=o,this.registerViewModelUpdatedListener=a,this.rootGraphic=new No("root",e,t),this.rootAnchorPresenter=n.createPresenter(this.rootGraphic);const c={anchorPresenter:this.rootAnchorPresenter,viewScale:this.viewScale,renderDataPresenterCreatorRegistry:i};this.rootPresenter=r.createPresenter(this.rootGraphic,c,h),this.registerViewModelUpdatedListener&&this.rootPresenter.viewModelUpdated.on(this.viewModelUpdatedListener)}start(){this.renderLoop.runOnce(()=>{this.render()})}teardown(){this.renderLoop.stop(),this.registerViewModelUpdatedListener&&this.rootPresenter.viewModelUpdated.off(this.viewModelUpdatedListener),this.rootPresenter.teardown(),this.rootAnchorPresenter.teardown(),this.clear()}render(e){void 0!==e&&this.eventChainTrackersList.push(e),this.renderViewModels(()=>{const e=this.rootPresenter.viewModel;this.renderTargetRegistry.addViewModel(e)})}clear(){this.renderViewModels(()=>{})}invalidate(e,t){this.renderLoop.stop(),this.renderLoop.runOnce(e),void 0!==t&&this.eventChainTrackersList.push(t)}renderViewModels(e){Dn(new c("View.Render"),t=>{const r=new Lo;Dn(new Oo("ViewController",r.type,this.eventChainTrackersList),t=>{try{this.renderTargetRegistry.beginRender(),e(),this.renderTargetRegistry.endRender()}catch(e){throw o("ViewController",5e4,"Exception: "+e.message),e}}),this.frameRendered.emit(new Lo(this.eventChainTrackersList.slice())),this.eventChainTrackersList.splice(0)})}}class Uo{constructor(){this.viewModels=[]}filter(e){return-1!==this.viewModels.indexOf(e)}}class Vo{constructor(e,t,r,i,n,s,o,a,h,c){this.renderLoop=new ko,this.viewModelUpdatedListener=e=>{this.viewController.invalidate(()=>{this.render()},e.eventChainTracker)},this.onEditPreviewEvent=e=>{if(0===e.eventKind){const e=[this.viewController.rootPresenter.viewModel];this.editPreviewFilter.viewModels.push(this.selectionPresenter.viewModel),this.editPreviewFilter.viewModels.push(...e);const t=()=>{this.render(),this.renderLoop.start(t)};this.renderLoop.start(t)}else this.editPreviewFilter.viewModels.splice(0),this.renderLoop.stop(),this.renderLoop.runOnce(()=>{this.render()})},this.viewController=new Go(e,t,r,i,n,s,o,!1,a.editContext),this.viewController.rootPresenter.viewModelUpdated.on(this.viewModelUpdatedListener),this.editController=a,this.editPreviewFilter=new Uo,this.viewController.renderTargetRegistry.filter=this.editPreviewFilter,this.selectionViewDataCreatorRegistry=c;const l=h.createSelectionPresenter(this.editController.selection,this.viewController.rootPresenter,this.selectionViewDataCreatorRegistry,{anchorPresenter:n.createPresenter(this.viewController.rootGraphic),viewScale:this.viewController.viewScale,renderDataPresenterCreatorRegistry:i},this.editController.editContext);if(void 0===l)throw new Error("Cannot create selection presenter");this.selectionPresenter=l,this.selectionPresenter.viewModelUpdated.on(this.viewModelUpdatedListener),void 0!==this.editController.editContext.previewInfo?(this.editController.editContext.previewInfo.presenter.notifier.on(this.onEditPreviewEvent),this.editPreviewRenderTargetRegistry=this.editController.editContext.previewInfo.renderTargetRegistry):this.editPreviewRenderTargetRegistry=new Po([])}get viewScale(){return this.viewController.viewScale}get frameRendered(){return this.viewController.frameRendered}start(){this.renderLoop.runOnce(()=>{this.render()})}teardown(){this.viewController.rootPresenter.viewModelUpdated.off(this.viewModelUpdatedListener),this.selectionPresenter.viewModelUpdated.off(this.viewModelUpdatedListener),this.selectionPresenter.teardown(),void 0!==this.editController.editContext.previewInfo&&this.editController.editContext.previewInfo.presenter.notifier.off(this.onEditPreviewEvent),this.viewController.renderTargetRegistry.filter=void 0,this.renderLoop.stop(),this.viewController.teardown(),this.clear(),this.editController.teardown()}render(e){void 0!==e&&this.viewController.eventChainTrackersList.push(e),this.renderViewModels(()=>{var e,t;const r=this.viewController.rootPresenter.viewModel;this.viewController.renderTargetRegistry.addViewModel(r);const i=this.selectionPresenter.viewModel;this.viewController.renderTargetRegistry.addViewModel(i);const n=null===(t=null===(e=this.editController)||void 0===e?void 0:e.editContext.previewInfo)||void 0===t?void 0:t.presenter.viewModel;void 0!==n&&this.editPreviewRenderTargetRegistry.addViewModel(n)})}renderViewModels(e){Dn(new c("View.Render"),t=>{const r=new Lo;Dn(new Oo("ViewController",r.type,this.viewController.eventChainTrackersList),t=>{try{this.viewController.renderTargetRegistry.beginRender(),this.editPreviewRenderTargetRegistry.beginRender(),e(),this.viewController.renderTargetRegistry.endRender(),this.editPreviewRenderTargetRegistry.endRender()}catch(e){throw o("ViewController",5e4,"Exception: "+e.message),e}}),this.frameRendered.emit(new Lo(this.viewController.eventChainTrackersList.slice())),this.viewController.eventChainTrackersList.splice(0)})}clear(){this.renderViewModels(()=>{})}}class zo{constructor(e,t){this.actionInvoker=e,this.editPreviewInfo=t}createMoveElement(e){return new Pn(e,this.actionInvoker,this.editPreviewInfo)}}class Wo{constructor(){this.type=0}serialize(){return""}}class Ho{constructor(e,t,r,i,n,s,o,a,h){this.onKeyboardEvent=e=>{let t=this.editContext.editorRegistry.processKeyboardEvent(e.eventData,this.selection,this.editContext);t.isHandled||void 0===this.keyboardEventProcessor||(t=this.keyboardEventProcessor(e.eventData,this.selection,this.editContext)),e.eventProcessResult.isHandled=t.isHandled,t.isHandled&&(e.eventData.preventDefault(),e.eventData.stopPropagation())},this.model=e,this.keyboardEventProcessor=h,this.keyboardEventNotifiers=s,this.editContext={selectionIterableCreatorRegistry:r,editorRegistry:i,actionInvoker:n,editableElementCreator:new zo(n,o),previewInfo:o,renderDataEventHandlerCreatorRegistry:a},this.keyboardEventNotifiers.keydown.value.on(this.onKeyboardEvent),this.keyboardEventNotifiers.keypress.value.on(this.onKeyboardEvent),this.keyboardEventNotifiers.keyup.value.on(this.onKeyboardEvent);const c=t.createSelection(e);if(void 0===c)throw new Error("Could not create selection for model with type "+e.type);this.selection=c}teardown(){this.selection.teardown(),this.keyboardEventNotifiers.keydown.value.off(this.onKeyboardEvent),this.keyboardEventNotifiers.keypress.value.off(this.onKeyboardEvent),this.keyboardEventNotifiers.keyup.value.off(this.onKeyboardEvent)}performAction(e){return function(e,t,r,i){var n;const s=t.save(),o=i(e,t,r).editOps,a=js(o),h=t.save();return{editOps:a,savedSelectionBefore:null!=s?s:new Wo,savedSelectionAfter:null!=h?h:new Wo,mergePolicy:null===(n=o[0])||void 0===n?void 0:n.mergePolicy}}(e,this.selection,this.editContext,this.editContext.editorRegistry.performAction.bind(this.editContext.editorRegistry))}performUndoEntry(e){const t={editOps:js(e.editOps),savedSelectionBefore:e.savedSelectionAfter,savedSelectionAfter:e.savedSelectionBefore};return this.selection.restore(e.savedSelectionBefore),t}}class jo{constructor(e){var t;this.presenterCreatorRegistry=new To(e.presenterCreatorEntries),this.anchorPresenterCreatorRegistry=new xo(e.anchorPresenterCreatorEntries),this.renderTargetRegistry=new Po(e.renderTargetEntries),this.editPreviewInfo=e.editPreviewInfo,this.actionInvoker=e.actionInvoker,this.selectionCreatorRegistry=new Co(e.selectionCreatorEntries),this.selectionIterableCreatorRegistry=new Eo(e.selectionIterableCreatorRegistryEntries),this.selectionPresenterCreatorRegistry=new So(e.selectionPresenterCreatorEntries),this.selectionViewDataCreatorRegistry=new Ro(e.selectionViewDataCreatorEntries),this.editorRegistry=new Mo(e.editorRegistryEntries),this.renderDataPresenterCreatorRegistry=new Io(null!==(t=e.renderDataPresenterCreatorEntries)&&void 0!==t?t:[]),void 0!==e.renderDataEventHandlerCreatorRegistryEntries&&(this.renderDataEventHandlerCreatorRegistry=new Ao(e.renderDataEventHandlerCreatorRegistryEntries)),this.keyboardEventNotifiers=e.keyboardEventNotifiers,this.keyboardEventProcessor=e.keyboardEventProcessor}get viewController(){return this.docViewController}get editController(){return this.docEditController}createViewController(e,t){const r=new Do;this.docEditController=new Ho(e,this.selectionCreatorRegistry,this.selectionIterableCreatorRegistry,this.editorRegistry,this.actionInvoker,this.keyboardEventNotifiers,this.editPreviewInfo,this.renderDataEventHandlerCreatorRegistry,this.keyboardEventProcessor),this.docViewController=new Vo(e,t,this.presenterCreatorRegistry,this.renderDataPresenterCreatorRegistry,this.anchorPresenterCreatorRegistry,this.renderTargetRegistry,r,this.docEditController,this.selectionPresenterCreatorRegistry,this.selectionViewDataCreatorRegistry)}}class qo{constructor(e){this.type=3,this.eventChainTracker=e}}class Xo{constructor(e=new vn){this.type=5e4,this.anchorUpdated=new Mi,this._transform=e}get transform(){return this._transform}set transform(e){this._transform=e,this.anchorUpdated.emit(new qo)}setTransform(e,t){this._transform=e,this.anchorUpdated.emit(new qo(t))}}class Ko{constructor(e){this.transformUpdated=new Mi,this.onAnchorUpdated=e=>{this.transformUpdated.emit(new Vi(e.eventChainTracker))},function(e){(function(e){return 5e4===e.type})(e)||Ci(5e4,`anchor of type ${e.type} is not a Transform2DAnchor`)}(e),this.anchor=e,this.anchor.anchorUpdated.on(this.onAnchorUpdated)}get transform(){return this.anchor.transform}teardown(){this.anchor.anchorUpdated.off(this.onAnchorUpdated)}}function Yo(e){return new Ko(e.anchor)}class Qo extends class{constructor(e,t,r){this.data=e,this.sourceAnchorBounds=t,this.targetBounds=r}}{constructor(e,t,r){super(e,t,r),this.type=0}}function Zo(e){if(!function(e){return 0===e.type}(e))throw new Error("Invalid renderData type: "+e.type)}class Jo{constructor(e){this.type=9,this.kinds=e}}var $o=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class ea extends class{constructor(e,t,r,i,n,s){this.viewModelUpdated=new Mi,this.onModelUpdated=e=>{this.refreshViewModel(1,e.eventChainTracker).catch(e=>{this.logCatchReason("onModelUpdated",e)})},this.onAnchorTransformUpdated=e=>{this.refreshViewModel(2,e.eventChainTracker).catch(e=>{this.logCatchReason("onAnchorTransformUpdated",e)})},this.onViewTransformUpdated=e=>{this.refreshViewModel(8,e.eventChainTracker).catch(e=>{this.logCatchReason("onViewTransformChanged",e)})},this.onCombinedScaleChanged=()=>{this.refreshViewModel(4).catch(e=>{this.logCatchReason("onCombinedScaleChanged",e)})},this.graphic=e,this.context=t,this.viewModel=r(),this.editContext=s,this.imageTypeChecker=i,this.presenterTraceCategory=n,void 0!==(null==s?void 0:s.renderDataEventHandlerCreatorRegistry)&&(this.renderDataEventHandler=s.renderDataEventHandlerCreatorRegistry.createEventHandler(e.model.type,e.model)),this.graphic.model.modelUpdated.on(this.onModelUpdated),this.context.anchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.on(this.onViewTransformUpdated),this.context.viewScale.combinedScaleChanged.on(this.onCombinedScaleChanged),this.createEditableElement()}init(e,t){void 0!==e&&this.viewModelUpdated.on(e),this.updateViewModelProperties(15,t).catch(e=>{this.logCatchReason("constructor",e)})}teardown(){this.unregisterViewModelPointerEventHandler(),this.context.anchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.off(this.onViewTransformUpdated),this.graphic.model.modelUpdated.off(this.onModelUpdated)}updateViewModelProperties(e,t){return $o(this,void 0,void 0,(function*(){const r=new Oi(void 0,t);let i=!1;yield n(new Oo(this.presenterClassName,r.type,t),t=>$o(this,void 0,void 0,(function*(){try{0!=(8&e)&&(i=this.updateViewModelViewTransform()||i),0!=(2&e)&&(i=this.updateViewModelAnchorTransform()||i),0!=(4&e)&&(i=this.updateViewModelScaleFactor()||i),0!=(1&e)&&(i=(yield this.updateViewModelRenderData())||i),void 0!==this.renderDataEventHandler&&this.renderDataEventHandler.addEventListeners(this.viewModel),void 0!==this.editableElement&&this.editableElement.addEventListeners(this.viewModel)}catch(e){throw o(this.presenterClassName,this.presenterTraceCategory,"Exception: "+e.message),e}}))),i&&(this.viewModelUpdated.emit(r),this.viewModel.imageViewModelUpdated.emit(new Jo(function(e){const t=[];return 0!=(1&e)&&t.push(0),0!=(6&e)&&t.push(1),t}(e))))}))}updateViewModelRenderData(){return $o(this,void 0,void 0,(function*(){const e=this.graphic.model.fallbackRenderData;return void 0!==e&&(this.imageTypeChecker(e),this.viewModel.sourceAnchorBounds=e.sourceAnchorBounds.clone(),this.viewModel.bounds=e.targetBounds.clone(),yield this.viewModel.setImageData(e.data),!0)}))}updateViewModelAnchorTransform(){return 0!==this.context.viewScale.viewTransform.size.width||0!==this.context.viewScale.viewTransform.size.height?this.updateViewModelViewTransform():!this.viewModel.transform.equals(this.context.anchorPresenter.transform)&&(this.viewModel.transform=this.context.anchorPresenter.transform.clone(),!0)}updateViewModelViewTransform(){return!this.viewModel.transform.equals(this.context.viewScale.viewTransform)&&(this.viewModel.transform=this.context.viewScale.viewTransform.clone(),!0)}updateViewModelScaleFactor(){return this.viewModel.scaleFactor!==this.context.viewScale.zoomFactor&&(this.viewModel.scaleFactor=this.context.viewScale.zoomFactor,!0)}logCatchReason(e,t){o(`${this.presenterClassName}.${e}`,this.presenterTraceCategory,""+t)}createEditableElement(){void 0!==this.editContext&&(this.editableElement=this.editContext.editableElementCreator.createMoveElement(this.graphic.contentId))}refreshViewModel(e,t){return $o(this,void 0,void 0,(function*(){return this.unregisterViewModelPointerEventHandler(),function(e){return 0!=(6&e)}(e)&&this.createEditableElement(),this.updateViewModelProperties(e,t)}))}unregisterViewModelPointerEventHandler(){void 0!==this.editableElement&&this.editableElement.removeEventListeners(this.viewModel),void 0!==this.renderDataEventHandler&&this.renderDataEventHandler.removeEventListeners(this.viewModel)}}{constructor(e,t,r,i){super(e,t,r,Zo,1,i),this.type=0,this.renderDataType=0,this.presenterClassName="Base64ImagePresenter"}}function ta(e){return(t,r,i)=>new ea(t,r,e,i)}var ra=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};function ia(e,t){return ra(this,void 0,void 0,(function*(){return new Promise((r,i)=>{e.onload=r,e.onerror=()=>{i("image.onerror")},e.src=t})}))}var na=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class sa{constructor(e){this.type=3,this.imageViewModelUpdated=new Mi,this.pointerEventNotifiers=Ii(),this.sourceAnchorBounds=new yn(0,0,0,0),this.bounds=new yn(0,0,0,0),this.scaleFactor=1/window.devicePixelRatio,this.transform=new vn,this.cursorType=0,this.hitTestSlop=0,this.hitTestable=!0,this._imageData="",this.canvasImageSource=e}get imageData(){return this._imageData}setImageData(e){return na(this,void 0,void 0,(function*(){if(this._imageData=e,this.canvasImageSource instanceof HTMLImageElement)return ia(this.canvasImageSource,e);Ci(4,"Not yet supported")}))}teardown(){}}class oa{constructor(e){this.pointerEventNotifiers=Ii(),this.renderScope=0,this.inBeginRender=!1,this.inEndRender=!1,this.renderTargetRegistry=e}beginRender(){this.inBeginRender||Dn({dispose:()=>{this.inBeginRender=!1}},()=>{this.inBeginRender=!0,0===this.renderScope&&this.renderTargetRegistry.beginRender(),this.renderScope+=1})}endRender(){this.inEndRender||Dn({dispose:()=>{this.inEndRender=!1}},()=>{this.inEndRender=!0,this.renderScope-=1,0===this.renderScope&&this.renderTargetRegistry.endRender()})}hitTest(e){}addViewModel(e){Li(e)&&Bi(e,e=>{this.renderTargetRegistry.addViewModel(e)})}}class aa{constructor(e,t){this.pointerEventNotifiers=Ii(),this.canvasElement=e,this.renderer=t;const r=this.canvasElement.getContext("2d");null===r&&Ci(4,"No 2D context"),this.renderingContext=r}beginRender(){this.renderingContext.clearRect(0,0,this.canvasElement.width,this.canvasElement.height)}addViewModel(e){this.renderer.renderViewModel(e,this)}endRender(){}hitTest(e){}}function ha(e,t,r,i,n){const s=r.size.width/e.width(),o=r.size.height/e.height(),a=t.width()*s*i,h=t.height()*o*i,c=(t.left-e.left)*s,l=(t.top-e.top)*o,u=(c+r.pos.x)*i,d=(l+r.pos.y)*i;return void 0!==n&&(n.setProp("left",u),n.setProp("top",d),n.setProp("width",a),n.setProp("height",h),n.setProp("scaleFactor",i),n.setProp("scaleX",s),n.setProp("scaleY",o)),new yn(u,d,u+a,d+h)}function ca(e,t,r){const i=t.getContext("2d");null===i&&Ci(4,"No 2D context"),t.width=la(e.width),t.height=la(e.height),t.style.position="relative";let n="",s="",o="",a="";if(void 0!==r)n=r.width()+"px",s=r.height()+"px",o=r.left+"px",a=r.top+"px";else{const t=e;n=t.style.width,s=t.style.height,o=t.style.left,a=t.style.top}t.style.width=n,t.style.height=s,t.style.left=o,t.style.top=a,0!==t.width&&0!==t.height&&i.drawImage(e,0,0)}function la(e){if("number"==typeof e)return e;Ci(4,"SVGAnimatedLength not supported")}class ua{renderViewModel(e,t){Dn(new c("ImageCanvas2DRenderer.renderViewModel"),r=>{!function(e){3!==e.type&&Ci(4,"Invalid viewModel type "+e.type)}(e);const i=ha(e.sourceAnchorBounds,e.bounds,e.transform,e.scaleFactor,r);ca(e.canvasImageSource,t.canvasElement,i)})}hitTest(e,t){}}class da{constructor(e){this.type=12,this.eventProcessResult={isHandled:!1,removeSelection:!1},this.eventData=e}}function fa(){const e=()=>new Mi;return{keyup:new Ri(e),keydown:new Ri(e),keypress:new Ri(e)}}function pa(e){const t={};return e.forEach((e,r)=>{t[r]=e}),JSON.stringify(t)}class ga{constructor(e){this.type=6,this.eventKind=e}}class ma{constructor(){this.type=3,this.notifier=new Mi,this.viewModelUpdated=new Mi,this.presenters=[],this.containerViewModel=new Di({nodeType:"editpreviewroot"}),this.previewActive=!1,this.renderCallback=()=>{this.viewModelUpdated.emit(new Oi),this.previewActive&&window.requestAnimationFrame(this.renderCallback)}}get viewModel(){return this.updateViewModel(),this.containerViewModel}beginPreview(e){this.presenters.push(...e),this.previewActive=!0,window.requestAnimationFrame(this.renderCallback),this.notifier.emit(new ga(0))}endPreview(){this.teardownPresenters(),this.previewActive=!1,this.notifier.emit(new ga(1))}teardown(){this.teardownPresenters()}teardownPresenters(){this.presenters.forEach(e=>{e.presenter.teardown()}),this.presenters=[]}updateViewModel(){this.containerViewModel.childNodes=[],this.presenters.forEach(e=>{this.addViewModelToContainer(e)})}addViewModelToContainer(e){var t;const r=new Di(e.id);r.data=e.presenter.viewModel,null===(t=this.containerViewModel.childNodes)||void 0===t||t.push(r)}}class _a{constructor(e){this.eventChainName="",this.startTimeMs=0,this.endTimeMs=0,this.durationMs=0,this.eventContextHistoryMap=new Map,this.eventChainName=e}start(){this.startTimeMs=performance.now()}end(){this.endTimeMs=performance.now(),this.endTimeMs>=this.startTimeMs&&(this.durationMs=this.endTimeMs-this.startTimeMs)}addEventContext(e){this.eventContextHistoryMap.set(`${e.causationType}_${e.eventType}`,e.durationMs)}getEventDurationStringsMap(e){const t=new Map;return this.eventContextHistoryMap.set(this.eventChainName+"DurationMs",this.durationMs),this.eventContextHistoryMap.forEach((r,i)=>{t.set(i,r.toFixed(e))}),t}}class va{constructor(e){this.eventProcessResult={isHandled:!1,removeSelection:!0},this.type=0,this.eventData=e}}function ya(e){try{if("image/svg+xml"!==function(e){if(!e.startsWith("data:"))return;const t=e.indexOf(",","data:".length);if(-1===t)return;const r=e.substring("data:".length,t);if(r.length<=0)return"text/plain";const i=r.indexOf(";"),n=-1===i?r:r.substring(0,i);return n.length<=0?"text/plain":n.toLowerCase()}(e))return;const t=e.indexOf(",","data:".length);if(-1===t)return;const r=e.substring(t+1);if(0===r.length)return;const i=decodeURIComponent(r),n=(new DOMParser).parseFromString(i,"image/svg+xml").documentElement,s=n.width.baseVal,o=function(e,t){if(e.unitType!==t.unitType)return;return e.value/t.value}(s,n.height.baseVal);return void 0===o?new _n(300,150):isFinite(o)?new _n(150*o,150):new _n(300,0)}catch(e){return}}var ba;!function(e){function t(t,n){if(!t)return x.Identity;var s=t.pt?r(t.pt).scale(n):void 0,o=t.s?i(t.s):new w(1,1),a=t.rSpecified?t.r*e.c_internalAngleToRadianFactor:void 0,h=t.t?r(t.t).scale(n):void 0;return new x(s,o,a,h)}function r(e){return new w(e.x,e.y)}function i(e,t){return void 0===t&&(t=0),new w(e.x||t,e.y||t)}function n(e){return new Q(e[0]/255,e[1]/255,e[2]/255,e[3]/255)}function s(e){return new P(e.l,e.t,e.r,e.b)}function o(e){for(var t=[],r=0,i=e;r<i.length;r++){var s=i[r],o=s.pos,a=n(s.clr);t.push(new ee(o,a))}return t.sort((function(e,t){return e.position-t.position})),t}function a(e,t){if(e.gradientStops=t,e.isGammaCorrected=!1,2==t.length||3==t.length){var r=t[0],i=t[t.length-1];if(0==Math.min(r.position,i.position)&&1==Math.max(r.position,i.position))if(2==t.length)e.isGammaCorrected=!0,e.blendBellShape=w.One;else if(3==t.length&&r.color.equals(i.color)){var n=t[1];e.gradientStops=[new ee(0,r.color),new ee(1,n.color)],e.isGammaCorrected=!0,e.blendBellShape=new w(n.position,1)}}}function h(t,r,i){switch(t.bt){case 0:return new $(Q.Transparent);case 1:var h=n(t.Item.clr);return new $(h);case 2:var l=t.Item;if((f=new te(2)).isStretched=l.isStretched,f.rotateWithShape=l.rtSp,f.angle=l.ang*e.c_internalAngleToRadianFactor,l.ftrct&&(f.fillToRect=s(l.ftrct)),l.ffrct&&(f.fillFromRect=s(l.ffrct)),l.stops)a(f,o(l.stops));return f;case 3:var u=t.Item;if((f=new te(3)).isStretched=u.isStretched,f.rotateWithShape=u.rtSp,f.angle=u.ang*e.c_internalAngleToRadianFactor,u.ftrct&&(f.fillToRect=s(u.ftrct)),u.ffrct&&(f.fillFromRect=s(u.ffrct)),u.stops)a(f,o(u.stops));return f;case 4:var d=t.Item;if((f=new te(4)).isStretched=d.isStretched,f.rotateWithShape=d.rtSp,f.angle=d.ang*e.c_internalAngleToRadianFactor,d.ftrct&&(f.fillToRect=s(d.ftrct)),d.ffrct&&(f.fillFromRect=s(d.ffrct)),d.stops)a(f,o(d.stops));return f;case 5:var f,p=t.Item;if((f=new te(5)).isStretched=p.isStretched,f.rotateWithShape=p.rtSp,f.angle=p.ang*e.c_internalAngleToRadianFactor,p.ftrct&&(f.fillToRect=s(p.ftrct)),p.ffrct&&(f.fillFromRect=s(p.ffrct)),p.stops)a(f,o(p.stops));return f;case 7:var g=t.Item;return new ie(g.type,n(g.clrFg),n(g.clrBg));case 6:return c(t.Item,r);case 8:case 9:i.Message(39084627,"unsupported Brush "+JSON.stringify(t))}return new $(Q.Transparent)}function c(e,t){if(e.id){var r=new Z;r.id=e.id;var i=new re(r);return i.wrapMode=e.wrpmd,i.alignment=e.algn,i.isStretched=e.isStretched,i.offset=new w(e.off.x,e.off.y),i.scale=new w(e.scale.x,e.scale.y),i.opacity=e.opcty,i.rotateWithShape=e.rotWShp,i.isStretched||(i.scale=i.scale.divide(new w(e.dpi.x,e.dpi.y)).scale(914400*t),i.offset=i.offset.scale(t)),i}}function l(e){return{cap:e.capType,end:e.type,length:e.len,width:e.width,widthMin:e.widthMin}}function u(e,t,r){if(!e)return new oe;var i,n;e.fillBrsh&&(i=h(e.fillBrsh,t,r)),e.outlnBrsh&&(n=h(e.outlnBrsh,t,r));var s=function(e,t,r,i){var n=new se(t*i);return n.lineHeight=r*i,e?(e.dtSpecified&&(n.dashType=e.dt),e.jtSpecified&&(n.lineJoin=e.jt),e.mlSpecified&&(n.miterLimit=e.ml),e.ctSpecified&&(n.compoundType=e.ct),e.atSpecified&&(n.alignment=e.at),e.doffSpecified&&(n.dashOffset=e.doff),e.dctSpecified&&(n.useRoundDash=1==e.dct),e.headEnd&&(n.headEnd=l(e.headEnd)),e.tailEnd&&(n.tailEnd=l(e.tailEnd)),e.tip&&(n.tipType=e.tip),n):n}(e.pen,e.lnWdth,e.lnHgth,t),o=new oe(i,n,s);return e.pctBrush&&(o.pictureBrush=c(e.pctBrush,t)),e.blend&&(o.blendingMode=e.blend),o}function d(t,r,i){var s,o,a,h,c;if(t.glw){var l=t.glw.blrRd*r,u=n(t.glw.clr);s=new he(u,l)}if(t.otrSdw){var d=t.otrSdw;(o=new ce(n(d.clr),d.blrRd*r,d.ang*e.c_internalAngleToRadianFactor,d.dst*r,new w(d.sx*i,d.sy*i),new w(d.kx,d.ky))).alignment=d.algn,o.shadowType=d.tp}if(t.inrSdw){var f=t.inrSdw;a=new le(n(f.clr),f.blrRd*r,f.ang*e.c_internalAngleToRadianFactor,f.dst*r)}if(t.rflctn){var p=t.rflctn;h=new ue(p.blrRd*r,p.sAlph,p.sPos,p.eAlph,p.ePos,p.dst*r)}return t.sftEdg&&(c=new de(t.sftEdg.blrRd*r)),new fe(s,o,a,h,c)}function f(e,r){var i=e.pts;if(i){var n,s,o=null==(n=e.f)?1:0==n?0:2==n?2:3==n?3:4==n?4:5==n?5:1;if(e.h>0){var a=JSON.parse("["+i+"]");s={figures:[new L(a,!1,e.h)]}}else s={figures:k(i)};return s.fillMode=o,s.lineEnabled=e.s,e.xfrm?s.transform=t(e.xfrm,r):s.transform=x.Identity,s.transform=s.transform.applyScaleAndTranslationBefore(new w(r,r),w.Zero),s}}function p(e,r,n){for(var s=[],o=e.xfrm?t(e.xfrm,r):x.Identity,a=e.fontInfo,h=0,c=e.glyphInstance;h<c.length;h++){var l=c[h];if(l.glyph&&n){var u=n.getGlyph(a,l.glyph);if(!u)continue;if(!u.clientData){var d=f(u.p,1);d&&(d.lineEnabled=!0,d.fillMode=1,d.glyphCacheId={fontId:a,glyphId:l.glyph},u.clientData=new B(d))}if(!u.clientData)continue;var p=i(l.scale,1).scale(r);p=p.scale(1/4096);var g=i(l.off).scale(r),m=new B(u.clientData,o.applyScaleAndTranslationBefore(p,g));s.push(m)}}return s}function g(e){return new Ee(e.cp,e.len)}function m(e,t){var r=f(e,t);if(r){var i=r.figures.length?r.figures[0]:void 0;if(i)return i instanceof L?i:i.createFigure()}}function _(e,t){if(!e)return 0;switch(e){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;case 7:return 7;case 8:return 8;case 9:return 9;case 10:return 10;case 11:return 11;case 12:return 12;case 13:return 13;case 14:return 14;case 15:return 15;case 16:return 16}return t.Error(595637021,"Incorrect ShapeBuilder.TextStrokeType"),1}function v(e,t,r){for(var i=new A,n=0,s=e;n<s.length;n++){var o=s[n],a=u(o.style,t,r);i.push(new Me(_(o.type,r),o.verticalCenter,o.thickness,a))}return i}function y(e,t){return e.wenv?function(e,t){var r=m(e.tpp,t),i=m(e.btp,t);if(r&&i)return new De(s(e.rct),r,i,e.vrt)}(e.wenv,t):e.plin?function(e,t){var r=m(e.pth,t);if(r){var i=0==e.algn?0:2==e.algn?1:.5;return new Fe(s(e.rct),r,i,e.s,e.pvt,e.vrt)}}(e.plin,t):void 0}function b(e,t,r,i,n,s){var o=s.getGlyph(n,e);if(o){if(!o.clientData){var a=f(o.p,1);a&&(a.lineEnabled=!0,a.fillMode=1,a.glyphCacheId={fontId:n,glyphId:e},o.clientData=new B(a))}if(o.clientData)return new B(o.clientData,new x(w.Zero,t,i,r))}}function T(t,r,n,s,o,a){for(var h=[],c=t.fi?t.fi.v:r,l=0,u=t.gi||[];l<u.length;l++){var d=u[l];if(d.g&&o){var f=d.s?i(d.s,1).scale(s/4096):n||w.Zero;f.equals(w.Zero)&&a.Error(0,"No glyph scale");var p=i(d.o).scale(s),g=d.r?d.r.v*e.c_internalAngleToRadianFactor:0,m=b(d.g,f,p,g,c,o);m&&h.push(m)}}return h}function E(e,t,r,i,n,o,a){for(var h=[],l=0,u=e.g||[];l<u.length;l++){var d=u[l];h=h.concat(T(d,t,r,i,n,a))}for(var p=0,g=e.p||[];p<g.length;p++){var m=f(g[p],i);m&&h.push(new B(m))}var _,v=s(e.lb);if(e.i){var y=c(e.i.i,i),b=s(e.i.b);y&&y.image&&b&&(_=new Le(y.image,b,o))}return new Oe(v,h,e.f?e.f.v:void 0,e.w?e.w.v:void 0,_)}function S(e,t,r,i,n,o,a){var h=g(e.rng),c=s(e.lbnd),l=new Ge(h,c),u=[];if(e.c)for(var d=0;d<e.c.length;d++){var f=E(e.c[d],t.getAt(l.localRange.start+d),r.getAt(l.localRange.start+d),i,n,o,a);f&&u.push(f)}else e.s&&e.s.v&&(u=function(e,t,r,i,n,s,o){for(var a=[],h=e.split(";"),c=0;c<h.length;c++){for(var l=h[c].split(/([A-VXYZ])/),u=l.length>0?l[0]:void 0,d=void 0,f=void 0,p=1;p<l.length-1;p+=2){var g=l[p];"L"==g&&(d=l[p+1]),"R"==g&&(f=l[p+1])}if(u&&d&&f){var m=parseFloat(d),_=parseFloat(f),v="W"==u,y=void 0;if(!v){var T=b(parseInt(u),n.getAt(s+c),new w(m,0),0,i.getAt(s+c),r);T&&(y=[T])}var x=new P(m,t.top,_,t.bottom);a.push(new Oe(x,y,!1,v))}else o.Error(0,"Wrong SimplifiedCharacterString: 0:"+u+", L:"+d+", R:"+f)}return a}(e.s.v,c,n,t,r,l.localRange.start,a));return l.characters=u,e.b&&(l.bender=y(e.b,i)),e.o&&(l.offset=new w(e.o.x,e.o.y)),l.fillBounds=s(e.fb),l.textEffectMetrics=new Ne(e.ea,e.ed,e.eh),l}function R(e,t,r,n,s){var o=new Ue(g(e.gr),new oe(new ie(27,Q.Blue,Q.Yellow)));e.o&&(o.offset=new w(e.o.x,e.o.y));for(var a=new Se(""),h=0,c=e.fipr||[];h<c.length;h++){var l=c[h];a.set(l.fontInfo,g(l.range))}for(var f=new Se(w.Zero),p=0,m=e.gspr||[];p<m.length;p++){var _=m[p];f.set(i(_.s,1).scale(r/4096),g(_.rng))}e.blt&&(o.bullet=function(e,t,r,i,n,s){if(e.c){var o=E(e.c,t,void 0,r,i,n,s),a=u(e.style,r,s),h=e.fx?d(e.fx,r,1):void 0,c=e.stks&&e.stks.length>0?v(e.stks,r,s):void 0;return new ke(o,a,h,c)}}(e.blt,e.blt.fi,r,t,n,s));for(var y=new Array,b=0,T=e.l||[];b<T.length;b++){var x=S(T[b],a,f,r,t,n,s);x&&y.push(x)}for(var P=0,C=e.spr||[];P<C.length;P++){var R=C[P],M=u(R.style,r,s);o.stylePerLocalRange.set(M,g(R.range))}for(var I=0,A=e.stkspr||[];I<A.length;I++){var F=A[I],B=v(F.textStrokeList,r,s);B?o.strokesPerLocalRange.set(B,g(F.range)):s.Error(39084627,"Unable to convert stroke")}for(var D=0,L=e.lwrng||[];D<L.length;D++){var O=L[D];o.addLocalWordRange(g(O))}for(var k=0,N=e.fxpr||[];k<N.length;k++){var G=N[k];o.effectsPerLocalRange.set(d(G.fx,r,1),g(G.range))}return o.lines=y,o}function M(e,r,i,n,s){var o,a=new Ve,h=new x(n.translation.negate(),w.One,-n.rotation,w.Zero);return a.paragraphs=function(e,t,r,i,n){for(var s=[],o=0,a=e||[];o<a.length;o++){var h=a[o];s.push(R(h,t,r,i,n))}return s}(e.p,r,i,h,s),a.layoutToFrame=t(e.ltfxfrm,i),a.frameToShape=t(e.ftsxfrm,i),a.clipBounds=(o=e.c)?new C(o.l?o.l.v:void 0,o.t?o.t.v:void 0,o.r?o.r.v:void 0,o.b?o.b.v:void 0):void 0,a}function I(e,r,i,n,s){try{if(!e)return;var o=[],a=t(e.xfrm,n),h=new Array;if(r)for(var c=0,l=r;c<l.length;c++){var g=l[c];if(g){var m=f(g,n);m&&h.push(new B(m))}}e.tx&&function(e,r,i,n,s,o){for(var a=0,h=e;a<h.length;a++){var c=h[a];if(c.primitives){for(var l=new Array,d=0,g=c.primitives;d<g.length;d++){var m=g[d];if(m.p&&m.p.pts&&m.p.pts.length){var _=f(m.p,n);if(!_)continue;_.lineEnabled=!0,_.fillMode=1,l.push(new B(_))}else if(m.r){var v=p(m.r,n,i);l.push.apply(l,v)}}var y=u(c.style,1,o),b=t(c.xfrm,n),w=new ge(l,y,void 0,b);w.overlapMode=1,w.mergeMode=c.union?1:0,w.role=3,s.push(w)}}}(e.tx,0,i,n,o,s);var _=u(e.style,n,s),v=e.fx?d(e.fx,n,.01):void 0;if(e.tx){var y=v?new fe(void 0,void 0,v.innerShadow,void 0,v.softEdges):void 0,b=v?new fe(v.glow,v.shadow,void 0,v.reflection,void 0):void 0,T=new ge(h,_,y,a);return e.tl&&(T.text=M(e.tl,i,n,a,s)),new me(function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),n=0;for(t=0;t<r;t++)for(var s=arguments[t],o=0,a=s.length;o<a;o++,n++)i[n]=s[o];return i}([T],o),b)}var x=new ge(h,_,v,a);if(e.tl&&(x.text=M(e.tl,i,n,a,s)),void 0!==e.ioff){for(var P=[],C=0,E=e.ioff;C<E.length;C++){var S=E[C],R=new w(S.x*n,S.y*n);P.push(R)}P.length>0&&(x.instanceOffsets=P)}return x}catch(e){s.Error(595637020,"Unexpected exception parsing shape")}}function F(e){return e.clientData||(e.clientData={}),e.clientData}function D(e,t){for(var r=F(e),i=0,n=Object.keys(t);i<n.length;i++){var s=n[i];r[s]=t[s]}}e.c_internalAngleToRadianFactor=2*Math.PI/216e5,e.getPresWidthAndHeightJson=function(e){return new w(e.w,e.h)},e.convertDocShapeOrGroup=function e(t,r,i,n,s){if(t){var o=t.bapi&&t.bapi.v||"";if(t.Items){for(var a=[],h=0,c=t.Items;h<c.length;h++){var l=e(c[h],r,i,n,s);l&&a.push(l)}var u,f=t.fx?d(t.fx,i,.01):void 0;return F(u=new me(a,f)).partId=o,F(u).renderDataId=t.id,s&&s.defaultClientData&&D(u,s.defaultClientData),u}return(u=I(t,t.pthLst||[],r,i,n))&&(F(u).partId=o,F(u).renderDataId=t.id,s&&s.defaultClientData&&D(u,s.defaultClientData)),u}}}(ba||(ba={}));class wa{constructor(e,t,r,i){this.type=2500,this.shapeBuilderRenderData=e,this.sourceAnchorBounds=t,this.targetBounds=r,this.embeddedImageList=i}}function Ta(e){return 2500===e.type}const xa=new class{Error(e,t){o(""+e,2504,t)}Message(e,t){h(""+e,2504,t)}};var Pa=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};function Ca(e,t){let r=0;return 0!==t&&(r=e/t),r}var Ea;!function(e){e[e.SetImageListIntoShapeBuilderData=0]="SetImageListIntoShapeBuilderData",e[e.LoadImage=1]="LoadImage"}(Ea||(Ea={}));class Sa{constructor(e,t,r,i,n){this.type=2501,this.renderDataType=2500,this.viewModel=new Di({nodeType:"root"}),this.childViewModels=new Map,this.viewModelUpdated=new Mi,this.childEditableElements=new Map,this.sbViewModel=new es,this.onModelUpdated=e=>{this.refreshViewModel(1,e.eventChainTracker).catch(e=>{this.logCatchReason("onModelUpdated",e)})},this.onAnchorTransformUpdated=e=>{this.refreshViewModel(2,e.eventChainTracker).catch(e=>{this.logCatchReason("onAnchorTransformUpdated",e)})},this.onViewTransformUpdated=e=>{this.refreshViewModel(8,e.eventChainTracker).catch(e=>{this.logCatchReason("onViewTransformUpdated",e)})},this.onCombinedScaleChanged=()=>{this.refreshViewModel(4).catch(e=>{this.logCatchReason("onCombinedScaleChanged",e)})},this.graphic=e,this.glyphStore=t,this.context=r,this.shapeBuilderContext=i,this.editContext=n,this.viewModel.data=this.sbViewModel,this.graphic.model.modelUpdated.on(this.onModelUpdated),this.context.anchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.on(this.onViewTransformUpdated),this.context.viewScale.combinedScaleChanged.on(this.onCombinedScaleChanged),this.createEditableElement()}init(e,t){void 0!==e&&this.viewModelUpdated.on(e),this.updateViewModelProperties(15,t).catch(e=>{this.logCatchReason("constructor",e)})}teardown(){this.unregisterViewModelPointerEventHandler(),this.context.anchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.context.viewScale.viewTransformChanged.off(this.onViewTransformUpdated),this.graphic.model.modelUpdated.off(this.onModelUpdated)}updateViewModelProperties(e,t){return Pa(this,void 0,void 0,(function*(){let r=!1;const i=new Oi(void 0,t);yield n(new Oo("ShapeBuilderRenderDataPresenter",i.type,t),i=>Pa(this,void 0,void 0,(function*(){try{0!=(8&e)&&(r=this.updateViewModelViewTransform()||r),0!=(2&e)&&(r=this.updateViewModelAnchorTransform()||r),0!=(4&e)&&(r=this.updateViewModelZoomFactor()||r),0!=(1&e)&&(r=(yield this.updateViewModelRenderData(t))||r),void 0!==this.editableElement&&this.editableElement.addEventListeners(this.viewModel)}catch(e){throw o("ShapeBuilderRenderDataPresenter",2505,"Exception: "+e.message),e}}))),r&&this.viewModelUpdated.emit(i)}))}updateViewModelRenderData(e){return Pa(this,void 0,void 0,(function*(){const t=this.graphic.model.fallbackRenderData;if(void 0===t)return!1;!function(e){if(!Ta(e))throw new Error("Invalid renderData type: "+e.type)}(t);let r=1,i=1;r=0!==this.context.viewScale.viewTransform.size.width?Ca(this.context.viewScale.viewTransform.size.width,t.sourceAnchorBounds.width()):Ca(this.context.anchorPresenter.transform.size.width,t.sourceAnchorBounds.width()),i=0!==this.context.viewScale.viewTransform.size.height?Ca(this.context.viewScale.viewTransform.size.height,t.sourceAnchorBounds.height()):Ca(this.context.anchorPresenter.transform.size.height,t.sourceAnchorBounds.height());const s=Math.max(r,i),o=t.sourceAnchorBounds.clone();if(o.scalarMultiply(s),o.isEmpty())return this.sbViewModel.setItems([]),!0;const a=ba.convertDocShapeOrGroup(t.shapeBuilderRenderData,this.glyphStore,s,xa);return void 0===a?this.sbViewModel.setItems([]):(this.createViewModelsForChild(a,o,s),yield n(new Oo("ShapeBuilderRenderDataPresenter",Ea.SetImageListIntoShapeBuilderData,e),()=>Pa(this,void 0,void 0,(function*(){yield this.setImageListIntoShapeBuilderDataAsync(t.embeddedImageList,a)}))),this.sbViewModel.setItems([a])),this.sbViewModel.sourceAnchorBounds=o,this.sbViewModel.emuToSourceScale=s,!0}))}createViewModelsForChild(e,t,r){if(this.childViewModels.clear(),2===e.getType()){const i=e;if(void 0!==i.clientData.renderDataId){const e=i.items;if(e.length>0&&2===e.elements[0].getType()){e.elements[0].items.elements.forEach(e=>{const i=new es;i.setItems([e]),i.isHitTestOnly=!0,i.sourceAnchorBounds=t,i.emuToSourceScale=r;const n=e.clientData.renderDataId,s=this.getRenderDataIdForItemWithKey(n,"creation"),o=this.getRenderDataIdForItemWithKey(n,"type"),a=new Di({nodeType:o,nodeKey:s});a.data=i,this.childViewModels.set(s,a)}),void 0!==this.editContext&&this.createChildEditableElements(),this.viewModel.childNodes=Array.from(this.childViewModels.values())}}}}getRenderDataIdForItemWithKey(e,t){let r="";return e.forEach(e=>{e.k===t&&(r=e.v)}),r}setImageListIntoShapeBuilderDataAsync(e,t){return Pa(this,void 0,void 0,(function*(){if(void 0===e||0===e.length)return;const r=this.attachTexturesForImagesAsync(e,t);0===this.sbViewModel.items.length?r.then(()=>{this.viewModelUpdated.emit(new Oi)}).catch(e=>{this.logCatchReason("attachTexturesForImagesAsync continuation",e)}):yield r}))}attachTexturesForImagesAsync(e,t){return Pa(this,void 0,void 0,(function*(){const r=[];t.getBrushImages(r);const i=[];for(const t of e)for(const e of r)t.imageIdField.toString()===e.id&&i.push(this.attachTextureForImageAsync(t.imageDataField,e));yield Promise.all(i)}))}attachTextureForImageAsync(e,t){return Pa(this,void 0,void 0,(function*(){const r=new window.Image;yield ia(r,e),function(e){if(0!==e.width||0!==e.height)return;const t=ya(e.src);void 0!==t&&(e.width=t.width,e.height=t.height)}(r);const i=this.shapeBuilderContext.renderer,n=new pt(i,null,w.Zero,0,!1);n.copyFromHTMLImageElement(i,r),i.attachTextureToImage(t,n)}))}updateViewModelAnchorTransform(){return 0!==this.context.viewScale.viewTransform.size.width||0!==this.context.viewScale.viewTransform.size.height?this.updateViewModelViewTransform():!this.sbViewModel.transform.equals(this.context.anchorPresenter.transform)&&(this.sbViewModel.transform=this.context.anchorPresenter.transform.clone(),!0)}updateViewModelViewTransform(){return!this.sbViewModel.transform.equals(this.context.viewScale.viewTransform)&&(this.sbViewModel.transform=this.context.viewScale.viewTransform.clone(),!0)}updateViewModelZoomFactor(){return this.sbViewModel.scaleFactor!==this.context.viewScale.zoomFactor&&(this.sbViewModel.scaleFactor=this.context.viewScale.zoomFactor,!0)}logCatchReason(e,t){o("0",2505,`ShapeBuilderRenderDataPresenter.${e}: ${t}`)}createEditableElement(){void 0!==this.editContext&&(this.editableElement=this.editContext.editableElementCreator.createMoveElement(this.graphic.contentId),this.createChildEditableElements())}createChildEditableElements(){this.childEditableElements.clear(),this.childViewModels.forEach(e=>{if(void 0!==e.nodeId.nodeKey&&void 0!==e.data&&void 0!==this.editContext){const t=this.editContext.editableElementCreator.createMoveElement(e.nodeId.nodeKey);t.addEventListeners(e.data),this.childEditableElements.set(e.nodeId.nodeKey,t)}})}refreshViewModel(e,t){return Pa(this,void 0,void 0,(function*(){return this.unregisterViewModelPointerEventHandler(),function(e){return 0!=(6&e)}(e)&&this.createEditableElement(),this.updateViewModelProperties(e,t)}))}unregisterViewModelPointerEventHandler(){void 0!==this.editableElement&&(this.editableElement.removeEventListeners(this.viewModel),this.unregisterChildViewModelPointerEventHandler())}unregisterChildViewModelPointerEventHandler(){this.childEditableElements.forEach((e,t)=>{const r=this.childViewModels.get(t);if(void 0!==r){const t=r.data;void 0!==t&&e.removeEventListeners(t)}})}}function Ra(e,t){return(r,i,n)=>new Sa(r,e,i,t,n)}const Ma=Q.FromRGBA({r:.75,g:.75,b:.75,a:1}),Ia=Q.FromRGBA({r:.5,g:.5,b:.5,a:.2});class Aa{constructor(e){this.type=2500,this.viewModelUpdated=new Mi,this._viewModel=new es,this.onAnchorTransformUpdated=()=>{this.updateViewModel()},this.context=e,this.updateViewModel(),this.context.anchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated)}get viewModel(){return this._viewModel}teardown(){this.context.anchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated)}updateViewModel(){this._viewModel.clear();const e=this.context.anchorPresenter.transform,t=new ge([B.CreateFromRect(new P(e.pos.x,e.pos.y,e.pos.x+e.size.width,e.pos.y+e.size.height))]);t.style.fillBrush=new $(Ia),t.style.lineBrush=new $(Ma),t.style.pen=new se(3,1),this._viewModel.addItem(t),this.viewModelUpdated.emit(new Oi)}}function Fa(e,t){return new Aa(t)}function Ba(e,t){var r,i;r=function(e){const t=0===e.x?1:1/e.x,r=0===e.y?1:1/e.y;return Math.max(t,r)}(t),i=function(e){return 25400*e}(e),d=r,f=i}function Da(e,t=2073600,r=2){!function(e){ht=ct=e}(function(e,t=2073600,r=2){if(0===e)return 1;let i=Math.sqrt(t/e);return e>t&&(i=Math.sqrt(i)),i=Math.min(i,r),0!==window.devicePixelRatio&&(i*=window.devicePixelRatio),i}(e,t,r))}function La(e,t,r,i,n,s){let o=e.transform.size.width/e.sourceAnchorBounds.width();o=isNaN(o)?1:o;let a=e.transform.size.height/e.sourceAnchorBounds.height();a=isNaN(a)?1:a;const h=new w(o,a).scale(e.scaleFactor*window.devicePixelRatio),c=t.size.multiply(h),l=new w(Math.min(c.x,r),Math.min(c.y,r)),u=h.multiply(new w(l.x/c.x,l.y/c.y));i.width=Math.ceil(l.x),i.height=Math.ceil(l.y);const d=new x(t.center.negate(),u,void 0,l.divide(new w(2,2))),f=window.screen.width*devicePixelRatio*window.screen.height*devicePixelRatio;return Da(f),Ba(e.emuToSourceScale,u),n.render(e.scene,Q.Transparent,{transform:d}),function(e,t,r,i,n,s,o,a,h,c,l,u){if(void 0===u)return;u.setProp("anchorScaleX",e),u.setProp("anchorScaleY",t),u.setProp("scaleFactor",r),u.setProp("devicePixelRatio",window.devicePixelRatio),u.setProp("sceneWidth",n.x),u.setProp("sceneHeight",n.y),u.setProp("maxCanvasDimensionPhyPx",i),u.setProp("cappedSceneWidth",s.x),u.setProp("cappedSceneHeight",s.y),u.setProp("combinedScaleX",o.x),u.setProp("combinedScaleY",o.y),u.setProp("cappedCombinedScaleX",a.x),u.setProp("cappedCombinedScaleY",a.y),u.setProp("totalPhysicalPixels",h),u.setProp("emuToSourceScale",c),u.setProp("renderTransformPreTranslationX",l.preTranslation.x),u.setProp("renderTransformPreTranslationY",l.preTranslation.y),u.setProp("renderTransformRotation",l.rotation),u.setProp("renderTransformScaleX",l.scale.x),u.setProp("renderTransformScaleY",l.scale.y),u.setProp("renderTransformTranslationX",l.translation.x),u.setProp("renderTransformTranslationY",l.translation.y)}(o,a,e.scaleFactor,r,c,l,h,u,f,e.emuToSourceScale,d,s),new w(Math.ceil(c.x)/window.devicePixelRatio,Math.ceil(c.y)/window.devicePixelRatio)}class Oa{constructor(){this.svgElementViewModelMap=new Map}addViewModelMapping(e,t){this.svgElementViewModelMap.set(e,t)}getViewModelMapping(e){return this.svgElementViewModelMap.get(e)}clearAllMappings(){this.svgElementViewModelMap.clear()}}function ka(e){let t=e.getContext("webgl2");if(null!==t)return t;if(t=e.getContext("webgl"),null===t)throw new Error("No WebGL Rendering Context");return t}function Na(e){switch(e){case 4:return"nwse-resize";case 1:return"ns-resize";case 3:return"nesw-resize";case 2:return"ew-resize";case 0:return"move";case 5:return"crosshair";case 6:return"default";default:Ei(e)}}class Ga{constructor(e,t){this.onPointerDown=e=>{if(void 0!==this.inDragViewModel)return;const t=this.viewModelHitTester.hitTest(e.eventData);void 0!==t?t.pointerEventNotifiers.pointerdown.valid&&(this.inDragViewModel=t,this.inDragViewModel.pointerEventNotifiers.pointerdown.value.emit(e)):void 0!==this.defaultHitTestPointerEventNotifiers&&this.defaultHitTestPointerEventNotifiers.pointerdown.valid&&this.defaultHitTestPointerEventNotifiers.pointerdown.value.emit(e)},this.onPointerMove=e=>{const t=e.eventData.target,r=void 0!==this.inDragViewModel?this.inDragViewModel:this.viewModelHitTester.hitTest(e.eventData);void 0!==r?(t.style.cursor=Na(r.cursorType),r.pointerEventNotifiers.pointermove.valid&&r.pointerEventNotifiers.pointermove.value.emit(e)):(t.style.cursor="auto",void 0!==this.defaultHitTestPointerEventNotifiers&&this.defaultHitTestPointerEventNotifiers.pointermove.valid&&this.defaultHitTestPointerEventNotifiers.pointermove.value.emit(e))},this.onPointerUp=e=>{const t=e.eventData.target,r=void 0!==this.inDragViewModel?this.inDragViewModel:this.viewModelHitTester.hitTest(e.eventData);void 0!==r?(t.style.cursor=Na(r.cursorType),r.pointerEventNotifiers.pointerup.valid&&r.pointerEventNotifiers.pointerup.value.emit(e)):void 0!==this.defaultHitTestPointerEventNotifiers&&this.defaultHitTestPointerEventNotifiers.pointerup.valid&&this.defaultHitTestPointerEventNotifiers.pointerup.value.emit(e),this.inDragViewModel=void 0},this.onPointerCancel=e=>{const t=e.eventData.target,r=void 0!==this.inDragViewModel?this.inDragViewModel:this.viewModelHitTester.hitTest(e.eventData);void 0!==r?(t.style.cursor=Na(r.cursorType),r.pointerEventNotifiers.pointercancel.valid&&r.pointerEventNotifiers.pointercancel.value.emit(e)):void 0!==this.defaultHitTestPointerEventNotifiers&&this.defaultHitTestPointerEventNotifiers.pointercancel.valid&&this.defaultHitTestPointerEventNotifiers.pointercancel.value.emit(e),this.inDragViewModel=void 0},this.viewModelHitTester=e,this.defaultHitTestPointerEventNotifiers=t}addEventListeners(e){e.pointerdown.value.on(this.onPointerDown),e.pointermove.value.on(this.onPointerMove),e.pointerup.value.on(this.onPointerUp),e.pointercancel.value.on(this.onPointerCancel)}removeEventListeners(e){e.pointerdown.value.off(this.onPointerDown),e.pointermove.value.off(this.onPointerMove),e.pointerup.value.off(this.onPointerUp),e.pointercancel.value.off(this.onPointerCancel)}}var Ua=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class Va{constructor(e,t,r,i){this.pointerEventNotifiers=Ii(),this.hitTestMap=new Oa,this.shapeBuilderVM=new es,this.renderScope=0,this.hitTestViewModel=e=>this.shapeBuilderRenderer.hitTest(e,this),this.canvas=e,this.shapeBuilderRenderer=t,this.webglRenderingContext=ka(e),this.scene=new me,this.pointerEventNotifiers=r;new Ga({hitTest:this.hitTestViewModel},i).addEventListeners(this.pointerEventNotifiers)}beginRender(){0===this.renderScope&&(this.shapeBuilderVM.clear(),this.hitTestMap.clearAllMappings()),this.renderScope+=1}addViewModel(e){if(ts(e)){const t=new me;e.isHitTestOnly?e.items.forEach(t=>{this.hitTestMap.addViewModelMapping(t,e)}):(e.items.forEach(r=>{this.hitTestMap.addViewModelMapping(r,e),t.items.push(r)}),t.transform=function(e){const t=e.sourceAnchorBounds.center(),r=new w(-t.x,-t.y);let i=1,n=0;0!==e.sourceAnchorBounds.width()&&(i=e.transform.size.width/e.sourceAnchorBounds.width(),n=e.transform.size.width/2);let s=1,o=0;return 0!==e.sourceAnchorBounds.height()&&(s=e.transform.size.height/e.sourceAnchorBounds.height(),o=e.transform.size.height/2),new x(r,new w(i,s),void 0,new w(n,o))}(e),this.shapeBuilderVM.addItem(t),this.shapeBuilderVM.transform=e.transform,this.shapeBuilderVM.sourceAnchorBounds=new yn(0,0,e.transform.size.width,e.transform.size.height),this.shapeBuilderVM.scaleFactor=e.scaleFactor,0!==e.emuToSourceScale&&(this.shapeBuilderVM.emuToSourceScale=e.emuToSourceScale))}else if(e instanceof class{constructor(){this.pointerEventNotifiers=Ii(),this.imageViewModelUpdated=new Mi,this.cursorType=0,this.hitTestSlop=0,this.hitTestable=!0,this.bounds=new yn(0,0,0,0),this.sourceAnchorBounds=new yn(0,0,0,0),this.scaleFactor=1/window.devicePixelRatio,this.transform=new vn,this._data=""}get imageData(){return this._data}setImageData(e){return Ua(this,void 0,void 0,(function*(){this._data=e}))}teardown(){}}){const t=io(e.transform),r=ge.CreateRectangle(new P(t.left,t.top,t.right,t.bottom));this.shapeBuilderRenderer.attachImageViewModelTextureToItem(e,r),this.hitTestMap.addViewModelMapping(r,e),this.shapeBuilderVM.addItem(r)}}endRender(){this.renderScope-=1,0===this.renderScope&&Dn(new c("ShapeBuilderRenderTarget.Render"),()=>{this.shapeBuilderRenderer.renderViewModel(this.shapeBuilderVM,this)})}hitTest(e){return this.shapeBuilderRenderer.hitTest(e,this)}getScene(){return this.scene}getWebGLContext(){return this.webglRenderingContext}}class za{constructor(e){this.shapeBuilderContext=e}get webGLCanvas(){return this.shapeBuilderContext.shapeBuilderConfig.webGLCanvas}renderViewModel(e,t){Dn(new c("ShapeBuilderCanvas2DRenderer.renderViewModel"),r=>{var i;if(r.setProp("isRendererReady",""+this.shapeBuilderContext.isRendererReady),!this.shapeBuilderContext.isRendererReady)return;!function(e){if(!ts(e))throw new Error("Expected ShapeBuilderViewModel but received type:"+e.type)}(e);const n=e.scene.getBounds();if(void 0===n||n.isEmpty())return;if(t instanceof Va){t.getScene().setItems(e.items)}const s=null!==(i=this.shapeBuilderContext.shapeBuilderConfig.maxWebGLCanvasDimensionPhyPx)&&void 0!==i?i:4096,o=La(e,n,s,this.webGLCanvas,this.shapeBuilderContext.renderer,r),a=function(e,t,r){const i=ha(e.sourceAnchorBounds,e.bounds,e.transform,e.scaleFactor,r);return i.right=i.left+t.width/window.devicePixelRatio,i.bottom=i.top+t.height/window.devicePixelRatio,i}(e,this.webGLCanvas,r);a.right=a.left+o.x,a.bottom=a.top+o.y,this.webGLCanvas.style.position="relative",this.webGLCanvas.style.width=a.width()+"px",this.webGLCanvas.style.height=a.height()+"px",this.webGLCanvas.style.left=a.left+"px",this.webGLCanvas.style.top=a.top+"px",t instanceof aa&&ca(this.webGLCanvas,t.canvasElement,a)})}hitTest(e,t){if(t instanceof Va){const r=new w(e.offsetX,e.offsetY),i=this.shapeBuilderContext.renderer.hitTestScene(t.getScene(),r);if(void 0===i.itemHit)return;let n=t.hitTestMap.getViewModelMapping(i.itemHit);if(void 0===n&&void 0!==i.itemStack)for(const e of i.itemStack.reverse())if(n=t.hitTestMap.getViewModelMapping(e),void 0!==n)break;return n}}attachImageViewModelTextureToItem(e,t){}}class Wa{constructor(e,t,r,i,n,s){this._renderTargetMode=0,this._skipPrepareWebGLCanvas=!0,this.shouldInvokeRenderTargetChangedCallback=!0,this.modeToRenderTargetMap=new Map,this.shapeBuilderContext=e,this.viewCanvas2D=i,this.pointerEventNotifiers=n,this.viewDiv=t,this.editDiv=r,this.shapeBuilderCanvas2DRenderer=new za(e),this.modeToRenderTargetMap.set(0,new aa(this.viewCanvas2D,this.shapeBuilderCanvas2DRenderer)),this.modeToRenderTargetMap.set(1,new Va(this.shapeBuilderContext.shapeBuilderConfig.webGLCanvas,this.shapeBuilderCanvas2DRenderer,this.pointerEventNotifiers,s))}get renderTargetMode(){return this._renderTargetMode}set renderTargetMode(e){this._renderTargetMode!==e&&(this._renderTargetMode=e,this.shouldInvokeRenderTargetChangedCallback=!0)}get skipPrepareWebGLCanvas(){return this._skipPrepareWebGLCanvas}set skipPrepareWebGLCanvas(e){this._skipPrepareWebGLCanvas!==e&&(this._skipPrepareWebGLCanvas=e)}beginRender(){this.prepareWebGLCanvas();const e=this.modeToRenderTargetMap.get(this.renderTargetMode);void 0!==e&&e.beginRender()}addViewModel(e){if(!ts(e))return;const t=this.modeToRenderTargetMap.get(this.renderTargetMode);void 0!==t&&t.addViewModel(e)}endRender(){const e=this.modeToRenderTargetMap.get(this.renderTargetMode);void 0!==e&&e.endRender(),this.renderTargetChangedCallback()}hitTest(e){}renderTargetChangedCallback(){var e;this.shouldInvokeRenderTargetChangedCallback&&(0===this.renderTargetMode?this.showViewDivOnly():1===this.renderTargetMode&&(this.editDiv.appendChild(null===(e=this.shapeBuilderContext)||void 0===e?void 0:e.shapeBuilderConfig.webGLCanvas),this.showEditDivOnly(),this.shapeBuilderContext.activeMultiplexRenderTarget=this),this.shouldInvokeRenderTargetChangedCallback=!1)}getEditDivGraphicIdAttribute(){return this.editDiv.getAttribute("graphicId")}prepareWebGLCanvas(){if(this.skipPrepareWebGLCanvas)return;this.renderTargetMode=1;const e=this.shapeBuilderContext.activeMultiplexRenderTarget;void 0!==e&&e!==this&&e.tryChangeToCanvas2DRenderTargetMode(this.getEditDivGraphicIdAttribute())}tryChangeToCanvas2DRenderTargetMode(e){0!==this.renderTargetMode&&Dn(new c("ShapeBuilderMultiplexRenderTarget.tryChangeToCanvas2DRenderTargetMode"),t=>{null!==e&&t.setProp("pendingEditDivGraphicId",e);const r=this.getEditDivGraphicIdAttribute();null!==r&&t.setProp("editDivGraphicId",r);const i=this.modeToRenderTargetMap.get(1),n=this.modeToRenderTargetMap.get(0);i instanceof Va&&n instanceof aa&&(this.renderTargetMode=0,ca(i.canvas,n.canvasElement),this.renderTargetChangedCallback())})}showViewDivOnly(){this.viewDiv.style.display="inherit",this.editDiv.style.display="none"}showEditDivOnly(){this.editDiv.style.display="inherit",this.viewDiv.style.display="none"}}class Ha{constructor(){this.extendedProperties=new Map}}class ja{constructor(e,t,r,i){this.type=1,this.viewModelUpdated=new Mi,this.isFallbackRenderDataPresenter=!1,this.containerViewModel=new Di({nodeType:"o"}),this.onModelUpdated=e=>{this.updateViewModel(e.eventChainTracker,!1)},this.onViewModelUpdated=e=>{this.updateViewModel(e.eventChainTracker,!0)},this.graphic=e,this.context=t,this.editContext=i,this.modelPresenterCreator=r,this.graphic.model.modelUpdated.on(this.onModelUpdated),this.updateViewModel()}get viewModel(){return this.containerViewModel}teardown(){this.graphic.model.modelUpdated.off(this.onModelUpdated),this.teardownCurrentPresenter()}teardownCurrentPresenter(){void 0!==this.currentPresenter&&(this.currentPresenter.viewModelUpdated.off(this.onViewModelUpdated),this.currentPresenter.teardown(),this.currentPresenter=void 0)}updateViewModel(e,t){this.ensureCurrentPresenter(e),this.viewModelUpdated.emit(new Oi(void 0,t?e:void 0))}ensureCurrentPresenter(e){(void 0===this.currentPresenter||void 0===this.graphic.model.fallbackRenderData&&this.isFallbackRenderDataPresenter||void 0!==this.graphic.model.fallbackRenderData&&!this.isFallbackRenderDataPresenter||void 0!==this.graphic.model.fallbackRenderData&&this.isFallbackRenderDataPresenter&&this.currentPresenter.renderDataType!==this.graphic.model.fallbackRenderData.type)&&(this.teardownCurrentPresenter(),this.recreatePresenter(e))}recreatePresenter(e){if(void 0!==this.graphic.model.fallbackRenderData){const t=this.context.renderDataPresenterCreatorRegistry.createPresenter(this.graphic,this.context,this.editContext);this.currentPresenter=t,this.isFallbackRenderDataPresenter=!0,t.init(this.onViewModelUpdated,e)}else this.currentPresenter=this.modelPresenterCreator(this.graphic,this.context,this.editContext),this.isFallbackRenderDataPresenter=!1,this.currentPresenter.viewModelUpdated.on(this.onViewModelUpdated);this.containerViewModel.data=this.currentPresenter.viewModel}}class qa{constructor(e){this.actionType="setElementsToSel",this.elementIds=e}}class Xa{constructor(e){this.actionType="toggleElementsInSel",this.elementIds=e}}class Ka{constructor(e,t,r){this.isDragging=!1,this.editPreviewBegun=!1,this.onPointerDown=e=>{this.isDragging=!0,this.dragStartPosition=pn(e.eventData),e.eventData.ctrlKey||e.eventData.shiftKey?this.invokeAction.invoke(new Xa([this.elementModelId])):this.invokeAction.invoke(new qa([this.elementModelId])),this.editPreviewBegun=!1,e.eventProcessResult={isHandled:!0,removeSelection:!1}},this.onPointerMove=e=>{if(this.isDragging){if(void 0!==this.dragStartPosition){const t=pn(e.eventData),r=new Ui(t.x-this.dragStartPosition.x,t.y-this.dragStartPosition.y);this.editPreviewBegun||Math.abs(r.x)>.5&&Math.abs(r.y)>.5&&(void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.beginPreview(this.editPreviewInfo),this.editPreviewBegun=!0),void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.setTransformDiff(new vn(new mn(r.x,r.y),new _n(1,1)))}e.eventProcessResult={isHandled:!0,removeSelection:!1}}else e.eventProcessResult={isHandled:!1,removeSelection:!1}},this.onPointerUp=e=>{if(this.isDragging){if(this.editPreviewBegun&&void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.endPreview(this.editPreviewInfo),void 0!==this.dragStartPosition){const t=pn(e.eventData),r=new mn(t.x-this.dragStartPosition.x,t.y-this.dragStartPosition.y);Math.abs(r.x)>.5&&Math.abs(r.y)>.5&&this.invokeAction.invoke(new dn(r))}this.isDragging=!1,this.dragStartPosition=void 0,e.eventProcessResult={isHandled:!0,removeSelection:!1}}else e.eventProcessResult={isHandled:!1,removeSelection:!1}},this.onPointerCancel=e=>{this.isDragging?(this.editPreviewBegun&&void 0!==this.editPreviewInfo&&this.editPreviewInfo.dragEditPreviewManager.endPreview(this.editPreviewInfo),this.isDragging=!1,this.dragStartPosition=void 0,e.eventProcessResult={isHandled:!0,removeSelection:!1}):e.eventProcessResult={isHandled:!1,removeSelection:!1}},this.elementModelId=e,this.invokeAction=t,this.editPreviewInfo=r}addEventListeners(e){e.pointerEventNotifiers.pointerdown.value.on(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.on(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.on(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.on(this.onPointerCancel)}removeEventListeners(e){e.pointerEventNotifiers.pointerdown.value.off(this.onPointerDown),e.pointerEventNotifiers.pointermove.value.off(this.onPointerMove),e.pointerEventNotifiers.pointerup.value.off(this.onPointerUp),e.pointerEventNotifiers.pointercancel.value.off(this.onPointerCancel)}}class Ya{constructor(e,t,r,i){this.graphicId=e,this.actionInvoker=t,this.editPreviewInfo=r,this.selection=i}createMoveElement(e){return void 0===this.selection?new Pn(this.graphicId,this.actionInvoker,this.editPreviewInfo):new Ka(e,this.actionInvoker,this.editPreviewInfo)}}var Qa=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};const Za={nodeType:"root"};class Ja{constructor(e){this.selectionIterableCreatorRegistry=e.selectionIterableCreatorRegistry,this.editorRegistry=e.editorRegistry,this.actionInvoker=e.actionInvoker,this.editableElementCreator=e.editableElementCreator,this.previewInfo=e.previewInfo}}class $a{constructor(e,t,r,i){this.type=8e3,this.smartArtModelPresenterCreator=(e,t,r)=>this.smartArtInnerPresenter,this.graphic=e,void 0!==i&&(this.editContext=new Ja(i),this._editableElementCreator=new Ya(this.graphic.contentId,i.actionInvoker,i.previewInfo),this.updateEditContext()),this.smartArtInnerPresenter=new eh(this.graphic,t,r),this.smartArtRenderDataPresenter=new ja(this.graphic,t,this.smartArtModelPresenterCreator,this.editContext),this.updateChildTransforms()}get anchorPresenter(){return this.smartArtInnerPresenter.anchorPresenter}get viewModel(){return this.smartArtRenderDataPresenter.viewModel}get viewModelUpdated(){return this.smartArtRenderDataPresenter.viewModelUpdated}set editableElementCreator(e){this._editableElementCreator=e,this.updateEditContext(),this.graphic.model.modelUpdated.emit(new eo)}get childViewModels(){return this.viewModel.childNodes}updateChildTransforms(){var e;const t=null===(e=this.graphic.model.layout)||void 0===e?void 0:e.shapes;void 0!==this.childViewModels&&void 0!==t&&this.childViewModels.forEach(e=>{let r=e;for(;void 0!==r&&!ts(r);)r=e.data;if(void 0!==e.nodeId.nodeKey){const i=t.find(t=>t.modelId===e.nodeId.nodeKey);void 0!==r&&void 0!==i&&(r.transform=i.shapeProps.transform)}})}teardown(){this.smartArtRenderDataPresenter.teardown(),this.smartArtInnerPresenter.teardown()}updateEditContext(){void 0!==this._editableElementCreator&&void 0!==this.editContext&&this.editContext.editableElementCreator!==this._editableElementCreator&&(this.editContext.editableElementCreator=this._editableElementCreator)}}class eh{constructor(e,t,r){this.type=8e3,this.viewModelUpdated=new Mi,this.containerViewModel=new Di(Za),this.onLayoutUpdated=e=>{this.updateViewModel().catch(()=>{})},this.onAnchorTransformUpdated=()=>{this.smartArt.modelUpdated.emit(new eo)},this.graphic=e,this.smartArt=this.graphic.model,this.anchorPresenter=t.anchorPresenter,this.presenterSite=r,this.smartArt.layoutUpdated.on(this.onLayoutUpdated),this.anchorPresenter.transformUpdated.on(this.onAnchorTransformUpdated)}get viewModel(){return this.containerViewModel}teardown(){this.anchorPresenter.transformUpdated.off(this.onAnchorTransformUpdated),this.smartArt.layoutUpdated.off(this.onLayoutUpdated)}updateViewModel(){return Qa(this,void 0,void 0,(function*(){const e=[Za];yield this.updateViewModelSubTree(e)}))}updateViewModelSubTree(e){return Qa(this,void 0,void 0,(function*(){const t=yield this.presenterSite.getViewModel(e);this.containerViewModel.updateViewModel(e,t),this.viewModelUpdated.emit(new Oi)}))}}class th{constructor(e){this.elementList=e}get length(){return this.elementList.elementCount}getItemById(e){return this.elementList.getElementById(e)}getIndexById(e){return this.elementList.getIndexById(e)}getItemByIndex(e){return this.elementList.getElementByIndex(e)}[Symbol.iterator](){return this.elementList[Symbol.iterator]()}}function rh(e){return new th(e)}class ih{constructor(e,t){this.type=8e3,this.iterableType=8e3,this.selectionUpdated=new Mi,this.smartArtModel=e,this.filteredElementCollection=t}get model(){return this.smartArtModel}addElements(e){this.filteredElementCollection.addItems(e)&&this.onSelectionChanged()}removeElements(e){this.filteredElementCollection.removeItems(e)&&this.onSelectionChanged()}setElements(e){this.filteredElementCollection.setItems(e)&&this.onSelectionChanged()}clear(){this.filteredElementCollection.clear()&&this.onSelectionChanged()}get length(){return this.filteredElementCollection.length}getElementById(e){return this.filteredElementCollection.getItemById(e)}getElementByIndex(e){return this.filteredElementCollection.getItemByIndex(e)}[Symbol.iterator](){return this.filteredElementCollection[Symbol.iterator]()}teardown(){}save(){}restore(e){}onSelectionChanged(){this.selectionUpdated.emit(new nn)}}const nh=[8e3,function(e,t){const r=function(e){if(8e3===e.type)return e;throw new Error("Model is not SmartArt Model")}(e),i=new en,n=new tn(i,rh(r.smartArtData.elementList));return new ih(r,n)}];const sh=[8e3,[[8e3,function(e){return e}]]];class oh{constructor(e,t,r,i,n,s){this.type=8001,this.viewModelUpdated=new Mi,this.refreshSelectionViewModel=()=>{this.viewModel=this.createSelectionViewModel(),this.viewModelUpdated.emit(new Oi)},this.selection=e,this.modelPresenter=t,this.presenterContext=n,this.editContext=s,this.refreshSelectionViewModel(),this.modelPresenter.editableElementCreator=new Ya(this.modelPresenter.graphic.contentId,s.actionInvoker,s.previewInfo,e),this.selection.selectionUpdated.on(this.refreshSelectionViewModel),this.modelPresenter.viewModelUpdated.on(this.refreshSelectionViewModel)}teardown(){this.modelPresenter.editableElementCreator=new Ya(this.modelPresenter.graphic.contentId,this.editContext.actionInvoker,this.editContext.previewInfo),this.modelPresenter.viewModelUpdated.off(this.refreshSelectionViewModel),this.selection.selectionUpdated.off(this.refreshSelectionViewModel)}createSelectionViewModel(){const e=this.modelPresenter.anchorPresenter.transform,t=this.presenterContext.viewScale.viewTransform;let r=1,i=1;0!==t.size.width&&(r=t.size.width/e.size.width),0!==t.size.height&&(i=t.size.height/e.size.height);const n=[],s=this.selection.smartArtModel.fallbackRenderData;if(void 0!==this.selection.smartArtModel.layout&&void 0!==s&&Ta(s))for(const t of this.selection){const o=this.selection.smartArtModel.layout.shapes.find(e=>e.modelId===t.modelId);if(void 0!==o){const t=o.shapeProps.transform.clone();t.size.width*=r,t.size.height*=i,t.pos.x=(t.pos.x+e.pos.x-s.sourceAnchorBounds.left)*r,t.pos.y=(t.pos.y+e.pos.y-s.sourceAnchorBounds.top)*i,n.push(t)}}const o=new Di({nodeType:"smartartSelRoot"});return n.forEach((e,r)=>{void 0===o.childNodes&&(o.childNodes=[]);const i=ds(e,""+r).viewModel,n=i.childNodes;void 0!==n&&n.forEach(e=>{if(void 0!==e.data&&ts(e.data)){const r=e.data;r.emuToSourceScale=0,r.scaleFactor=this.presenterContext.viewScale.zoomFactor,r.transform=t,r.sourceAnchorBounds=new yn(0,0,t.size.width,t.size.height)}}),o.childNodes.push(i)}),o}}const ah=[8e3,function(e,t,r,i,n,s){return new oh(e,t,r,i,n,s)}];class hh{constructor(){this.actionType="clrSel"}}function ch(e,t){const r=t.createSelectionIterable(e,8e3);if(void 0===r)throw new Error("Cannot get ISmartArtSelection");return r}const lh=["clrSel",{check:function(e,t,r){return{isEnabled:ch(t,r.selectionIterableCreatorRegistry).length>0,isVisible:!0}},perform:function(e,t,r){if(!(e instanceof hh))throw new Error("Invalid action");return ch(t,r.selectionIterableCreatorRegistry).clear(),new Rs(!0)}}];const uh=["setElementsToSel",{check:function(){return{isEnabled:!0,isVisible:!0}},perform:function(e,t,r){if(!(e instanceof qa))throw new Error("Invalid action");const i=ch(t,r.selectionIterableCreatorRegistry),n=[];return e.elementIds.forEach(e=>{const t=i.smartArtModel.smartArtData.elementList.getElementById(e);void 0!==t&&n.push(t)}),i.setElements(n),new Rs(!0)}}];class dh{constructor(e=0){this.actionType="tabSel",this.tabOrder=0,this.tabOrder=e}}const fh=new As([lh,uh,["tabSel",{check:function(e,t,r){return{isEnabled:ch(t,r.selectionIterableCreatorRegistry).length>0,isVisible:!0}},perform:function(e,t,r){if(!(e instanceof dh))throw new Error("Invalid action");const i=ch(t,r.selectionIterableCreatorRegistry),n=function(e,t,r){if(0===e.length)return!1;const i=function(e,t,r){if(0===t.length)return-1;const i=0===r?0:t.length-1;if(0===e.length)return i;const n=e.getElementByIndex(e.length-1);if(void 0===n)return i;let s=t.getIndexById(n.contentId);return-1===s?i:(0===r?(s+=1,s>=t.length&&(s=0)):(s-=1,s<0&&(s=t.length-1)),s)}(e,t,r);if(-1===i)return!1;const n=t.getItemByIndex(i);return void 0!==n&&(e.setElements([n]),!0)}(i,rh(i.smartArtModel.smartArtData.elementList),e.tabOrder);return new Rs(n)}}],["toggleElementsInSel",{check:function(){return{isEnabled:!0,isVisible:!0}},perform:function(e,t,r){if(!(e instanceof Xa))throw new Error("Invalid action");const i=ch(t,r.selectionIterableCreatorRegistry),n=[],s=[];return e.elementIds.forEach(e=>{const t=i.smartArtModel.smartArtData.elementList.getElementById(e);void 0!==t&&(void 0!==i.getElementById(e)?s.push(t):n.push(t))}),s.length>0&&i.removeElements(s),n.length>0&&i.addElements(n),new Rs(!0)}}]]);const ph=(gh=fh,(e,t,r)=>gh.perform(e,t,r));var gh;const mh=function(e){return(t,r,i)=>e.check(t,r,i)}(fh);function _h(e,t,r){if(r.editorRegistry.queryActionState(e,t,r).isEnabled)return r.editorRegistry.performAction(e,t,r)}function vh(e,t,r){const i=e.shiftKey?1:0,n=_h(new dh(i),t,r);return{isHandled:void 0!==n&&n.performed,removeSelection:!1}}const yh=new zs([{key:"Enter",modifiers:Es.None,entry:function(e,t,r){let i=!1;if(0===t.length){const e=t.smartArtModel.smartArtData.elementList.getElementByIndex(0);void 0!==e&&(t.setElements([e]),i=!0)}return{isHandled:i,removeSelection:!1}}},{key:"Escape",modifiers:Es.None,entry:function(e,t,r){const i=_h(new hh,t,r);return{isHandled:void 0!==i&&i.performed,removeSelection:!1}}},{key:"Tab",modifiers:Es.None,entry:vh},{key:"Tab",modifiers:Es.Shift,entry:vh}]),bh=[8e3,{keyboardEventProcessor:(e,t,r)=>function(e,t,r,i){const n=ch(t,r.selectionIterableCreatorRegistry);if("keydown"===e.type){const t=Ss(i,e);if(void 0!==t)return t(e,n,r)}else if("keypress"===e.type){const t=n.getElementByIndex(0);if(void 0===t)return{isHandled:!1,removeSelection:!1};let r="";return r="Enter"===e.key?"\r":e.key,t.replaceText(t.text.length,t.text.length,r),{isHandled:!0,removeSelection:!1}}return{isHandled:!1,removeSelection:!1}}(e,t,r,yh),pointerEventProcessor:(e,t,r)=>({isHandled:!1,removeSelection:!0}),actionStateQuery:mh,actionPerformer:ph}];function wh(e){return new yn(e.pos.x,e.pos.y,e.pos.x+e.size.width,e.pos.y+e.size.height)}class Th{constructor(){this.type=8e3}}var xh=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class Ph{constructor(e,t,r){this.type=8e3,this.version=new rn,this.layoutUpdated=new Mi,this.onModelUpdated=()=>{this.updateLayout().catch(()=>{})},this.hostContext=e,this.smartArtData=t,this.smartArtLayoutCreator=r,this.modelUpdated=this.smartArtData.modelUpdated,this.updateLayout().catch(()=>{}),this.modelUpdated.on(this.onModelUpdated)}teardown(){this.modelUpdated.off(this.onModelUpdated)}get layout(){return this.smartArtLayout}setLayout(e){this.smartArtLayout=e,this.layoutUpdated.emit(new Th)}updateLayout(){return xh(this,void 0,void 0,(function*(){return this.smartArtLayoutCreator(this.smartArtData).then(e=>{this.setLayout(e)})}))}}class Ch{constructor(){this.diagramType="",this.diagramCategory="",this.styleType="",this.styleCategory="",this.colorTransformType="",this.colorTransformCategory="",this.typographicalEmphasis="",this.isPlaceholder=!1}}class Eh{constructor(e){this.text="",this.elementType=2,this.elementProps=new Ch,this._modelId=e}get modelId(){return this._modelId}get contentId(){return this._modelId}replaceText(e,t,r){if(e<0||e>this.text.length||t<0||t>this.text.length||e>t)throw new Error(`Invalid range [${e}, ${t}], len: ${this.text.length}`);this.text=`${this.text.substr(0,e)}${r}${this.text.substr(t)}`}}var Sh=r(5);class Rh{constructor(e){this._elementProps=new Ch,this._text="",this._smartArtElement=e}get modelId(){return Object(Sh.a)(this._smartArtElement.get_smartArtModelId())}get contentId(){return this.modelId}get elementType(){return this._smartArtElement.get_smartArtElementType()}get elementProps(){return this._elementProps}get text(){return this._text}replaceText(e,t,r){}}class Mh{constructor(e){this.documentElement=new Eh(""),this._elementCollection=e}get elements(){const e=new $s;return this._elementCollection.get_items().map(t=>{e.addItem(new Rh(t))}),e}get elementCount(){return this.elements.length}getElements(e,t){const r=[];for(let i=e;i<(null!=t?t:this.elementCount);i+=1)r.push(this.getElementByIndex(i));return r}getElementById(e){return this.elements.getItemById(e)}getElementByIndex(e){return this.elements.getItemByIndex(e)}getIndexById(e){return this.elements.getIndexById(e)}[Symbol.iterator](){return this.elements[Symbol.iterator]()}addElement(e){return new Eh("")}addElementWithModelId(e,t){return new Eh(t)}deleteElement(e){}}class Ih{constructor(e){this.modelUpdated=new Mi,this._elementList=new Mh(e.get_elementCollection())}get elementList(){return this._elementList}}class Ah{constructor(e){this._transform=e}get transform(){return this._transform}set transform(e){this._transform=e}}class Fh{constructor(e,t){this._pptSmartArtElement=e,this._parentSmartArt=t}get modelId(){return Object(Sh.a)(this._pptSmartArtElement.get_smartArtModelId())}get shapeProps(){return new Ah(this.createSmartArtShapeTransform())}get semanticModelId(){return this._semanticModelId}createSmartArtShapeTransform(){const e=this._pptSmartArtElement.get_xPersisted()-this._parentSmartArt.get_xPersisted(),t=this._pptSmartArtElement.get_yPersisted()-this._parentSmartArt.get_yPersisted(),r=new mn(e,t),i=new _n(this._pptSmartArtElement.get_widthPersisted(),this._pptSmartArtElement.get_heightPersisted()),n=new gn(this._pptSmartArtElement.get_isHorizontallyFlipped(),this._pptSmartArtElement.get_isVerticallyFlipped());return new vn(r,i,n,this._pptSmartArtElement.get_shapeRotation())}}class Bh{constructor(e){this._parentSmartArt=e}get shapes(){return this._parentSmartArt.ensureModelData().get_elementCollection().get_items().map(e=>new Fh(e,this._parentSmartArt))}}class Dh{constructor(e){this.anchorUpdated=new Mi,this.type=55e3,this.graphicElement=e}get transform(){return this.getTransformInformation()}getTransformInformation(){const e=new mn(this.graphicElement.get_xPersisted(),this.graphicElement.get_yPersisted()),t=new _n(this.graphicElement.get_widthPersisted(),this.graphicElement.get_heightPersisted()),r=new gn(this.graphicElement.get_isHorizontallyFlipped(),this.graphicElement.get_isVerticallyFlipped());return new vn(e,t,r,this.graphicElement.get_shapeRotation())}}var Lh=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class Oh{constructor(e){this._eventProcessResult=e}get_isHandled(){return this._eventProcessResult.isHandled}get_removeSelection(){return this._eventProcessResult.removeSelection}}function kh(e){switch(e){case 0:return"SmartArt";default:return"Unknown"}}class Nh{constructor(e){this.transformUpdated=new Mi,this.onAnchorUpdated=e=>{this.transformUpdated.emit(new Vi(e.eventChainTracker))},function(e){(function(e){return 55e3===e.type})(e)||Ci(55e3,`anchor of type ${e.type} is not a PowerPointSmartArtAnchor`)}(e),this.anchor=e,this.anchor.anchorUpdated.on(this.onAnchorUpdated)}get transform(){return this.anchor.transform}teardown(){this.anchor.anchorUpdated.off(this.onAnchorUpdated)}}function Gh(e){return new Nh(e.anchor)}var Uh=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class Vh{constructor(e,t){this.containerViewModel=new Di({nodeType:"root"})}getViewModel(e){return Uh(this,void 0,void 0,(function*(){return this.containerViewModel}))}}const zh=[(Wh=function(e,t){return new Vh(e,t)},[8e3,(e,t,r)=>function(e,t,r,i){const n=e.model;return new $a(e,t,r(n,t.anchorPresenter),i)}(e,t,Wh,r)])];var Wh;function Hh(e,t){const r=[(i=()=>new sa(document.createElement("img")),[0,ta(i)])];var i;return void 0!==e&&void 0!==t&&r.push(function(e,t){return[2500,Ra(e,t)]}(e,t)),r}const jh=[],qh=[(Xh=Fa,[5e3,Xh]),function(e){return[8e3,e]}(Fa)];var Xh;const Kh=[ln,nh],Yh=[un,sh],Qh=[(Zh=new class extends Is{createConnectablePoints(e,t){const r=this.get(e.type);if(void 0!==r)return r(e,t)}}([]),Jh="grCollSelRoot",$h=!0,[5e3,Cs(Zh,Jh,$h)]),ah];var Zh,Jh,$h;const ec=new zs([]);const tc=[[5e3,{keyboardEventProcessor:(e,t,r)=>Ks(e,t,r,ec),pointerEventProcessor:Ys,actionStateQuery:Qs,actionPerformer:Zs}],bh],rc=[[0,function(e,t){const r=e.getId(),i=e.getGraphicElement();h("0",55e3,`PptGraphicElement info: sid=${i.get_sid()}, cid=${i.get_cid()}, shapeId=${i.get_shapeId()}}`);const n=i,s=new Ih(n.ensureModelData()),o=new Ph(t,s,function(e){return t=>Lh(this,void 0,void 0,(function*(){return Promise.resolve(new Bh(e))}))}(n));return new No(r,o,new Dh(i))}]],ic=new class extends Is{createGraphic(e,t){const r=this.get(e.getGraphicType());if(void 0!==r)return r(e,t)}}(rc);const nc=new class extends Is{createFallbackRenderData(e,t){const r=this.get(e.renderDataType);if(void 0!==r)return r(e,t)}}([[0,function(e,t){return function(e){if(0!==e.renderDataType)throw new Error("Not IImageRenderData: type: "+e.renderDataType)}(e),new Qo(e.base64Data,wh(t),wh(e.targetBounds))}],[1,function(e,t){!function(e){if(1!==e.renderDataType)throw new Error("Not IShapeBuilderRenderData: type: "+e.renderDataType)}(e);const r=function(e){let t=e;const r=t.indexOf("{");return r>0&&(t=t.substring(r)),JSON.parse(t)}(e.shapeBuilderJson);return function(e){return void 0!==e.shapeRenderData}(r)?new wa(r.shapeRenderData,wh(t),wh(e.targetBounds),r.imageList):new wa(r,wh(t),wh(e.targetBounds),void 0)}]]);function sc(e){switch(e){case 0:default:return"gc2smartart"}}function oc(e,t,r,i,n,s){if(void 0===t.viewDiv)throw new Error("No viewDiv");const o=document.createElement("canvas");t.viewDiv.appendChild(o),function(e,t){const r=new ua,i=new aa(e,r);!function(e,t){e.register([3,t])}(t,i)}(o,e),void 0!==r&&(n?function(e,t,r,i,n,s){if(void 0===i.viewDiv)throw new Error("No viewDiv");if(void 0===i.editDiv)throw new Error("No editDiv");const o=Ii();o.pointerdown.value.on(s);const a=new Wa(r,i.viewDiv,i.editDiv,e,n,o);rs(t,a)}(o,e,r,t,i,s):function(e,t,r){const i=new za(t),n=new aa(e,i);rs(r,n)}(o,r,e)),function(e){e.register([0,new oa(e)])}(e)}class ac{constructor(e,t,r){this.presenter=e,this.editPreviewPresenterCreatorRegistry=t,this.renderDataPresenterCreatorRegistry=r}}class hc{constructor(e,t){if(this.keyboardEventNotifierMap=fa(),this.pointerEventNotifierMap=Ii(),this.hostContext=new wo,this.eventChainTrackerToAppInfoMap=new Map,this.graphicCollectionPresenterSite=new Js,this.onFrameRendered=e=>{const t=e.eventChainTrackersList;if(void 0!==t&&0!==t.length)try{const e=3;t.forEach(t=>{const r=this.eventChainTrackerToAppInfoMap.get(t);if(void 0!==r&&r.size>0){this.eventChainTrackerToAppInfoMap.delete(t),t.end(),r.forEach((i,n)=>{if(n.toLowerCase().indexOf("starttime")>0){const s=n.replace(/starttime.*/gi,"DurationMs"),o=parseFloat(i),a=!isNaN(o)&&o>=0?(t.endTimeMs-o).toFixed(e):"";""!==a&&r.set(s,a),r.delete(n)}});const n=new Map([...r.entries(),...t.getEventDurationStringsMap(e).entries()]),s=new Ha;s.extendedProperties=this.createKpiExtendedProperties(n),i={kpiMethodType:3,kpiNames:new Set([t.eventChainName]),additionalValues:s},xi.logEnd(i),h(`${hc}.${this.onFrameRendered.name}`,55e3,""+pa(n))}var i})}catch(e){a(`${hc}.${this.onFrameRendered.name}`,55e3,"Exception: "+e.message)}},this.defaultHitTestPointerDownEventHandler=e=>{this.clearChildSelection()},this.invokeActionCallback=e=>{this.host.editController.performAction(e)},this.config=e,void 0===this.config.domRenderTarget.viewDiv)throw new Error("No viewDiv to render to");if(this.graphic=ic.createGraphic(e.graphicData,this.hostContext),this.pptGraphicType=e.graphicData.getGraphicType(),void 0===this.graphic)throw new Error("Cannot create Graphic for given IGraphicData");void 0!==this.config.domRenderTarget.editDiv&&(this.editDiv=this.config.domRenderTarget.editDiv,this.editDiv.setAttribute("graphicID",this.graphic.contentId)),this.graphicCollectionModel=new ro(this.hostContext),this.graphicCollectionModel.addGraphic(this.graphic);const r=Hh(null==t?void 0:t.shapeBuilderConfig.glyphStore,t);this.editPreviewInfo=new ac(new ma,new To(qh),new Io(r)),this.host=this.createHost(this.config,this.graphicCollectionModel,t,this.keyboardEventNotifierMap,this.pointerEventNotifierMap,this.config.brsConfig.isGC2WebGLRenderTargetEnabled,this.editPreviewInfo,r);const i=this.host.renderTargetRegistry.get(2500);i instanceof Wa&&(this.shapeBuilderMultiplexRenderTarget=i),this.host.viewController.frameRendered.on(this.onFrameRendered),this.host.viewController.start();const n=this.getGraphicCollectionSelection();void 0!==n&&5001===this.host.viewController.selectionPresenter.type&&(this.editPreviewInfo.dragEditPreviewManager=new yo(n,this.host.viewController.selectionPresenter,this.host.anchorPresenterCreatorRegistry,this.host.viewController.viewScale,this.graphicCollectionPresenterSite)),h("0",55e3,"The Gc2 host is enabled.")}dispose(){void 0!==this.graphic&&(void 0!==this.graphicCollectionModel&&this.graphicCollectionModel.removeGraphic(this.graphic),this.graphic.teardown()),this.host.viewController.teardown()}createKpiExtendedProperties(e){const t=new Map,r=[];let i="";try{e.set("isGC2WebGLRenderTargetEnabled",this.config.brsConfig.isGC2WebGLRenderTargetEnabled.toString()),e.forEach((e,n)=>{if(n.toLowerCase().indexOf("actionname")>-1){const t=n.match(/ActionName_([a-zA-Z0-9]+)_ActionId_([a-zA-Z0-9\-]+)_([a-zA-Z]+)/);if(null!==t&&4===t.length){const n=new Map;n.set("ActionName",t[1]),n.set("ActionId",t[2]),i=t[3],n.set(i,e),r.push(pa(n))}}else t.set(n,e)}),t.set("ActionMetadataWith"+i,r.toString())}catch(e){h(`${hc}.${this.createKpiExtendedProperties.name}`,55e3,"Exception: "+e.message)}return t}setRenderData(e,t,r,i){Dn(new c("PowerPointGraphicHost.setRenderData"),r=>{if(void 0===this.graphic)throw new Error("Graphic not initialized.");i.set("graphicType",kh(this.pptGraphicType));const n=this.createKpiExtendedProperties(i);var s;s={kpiMethodType:0,kpiNames:new Set(["GC2SetRenderDataPerf"]),kpiType:1,extendedProperties:n,owningFeatureCrewAlias:sc(this.pptGraphicType)},xi.logStart(s);const o=new _a("GC2SetRenderDataPerf");o.start(),this.eventChainTrackerToAppInfoMap.set(o,i),r.setProp("x",t.pos.x),r.setProp("y",t.pos.y),r.setProp("width",t.size.width),r.setProp("height",t.size.height),this.graphic.model.fallbackRenderData=nc.createFallbackRenderData(e,t),void 0!==this.shapeBuilderMultiplexRenderTarget&&(1!==e.renderDataType?(this.shapeBuilderMultiplexRenderTarget.skipPrepareWebGLCanvas=!0,this.shapeBuilderMultiplexRenderTarget.renderTargetMode=0):this.shapeBuilderMultiplexRenderTarget.skipPrepareWebGLCanvas=!1),this.graphic.model.modelUpdated.emit(new eo(void 0,o))})}setPosition(e,t){}setZoomFactor(e){Dn(new c("PowerPointGraphicHost.setZoomFactor"),t=>{t.setProp("zoomFactor",e),this.host.viewController.viewScale.zoomFactor=e*window.devicePixelRatio})}setTransform(e,t,r){Dn(new c("PowerPointGraphicHost.setTransform"),t=>{if(void 0===this.graphic)throw new Error("Graphic not initialized.");const i=new _a("GC2SetTransformPerf");null!==r&&(r.set("graphicType",kh(this.pptGraphicType)),void 0!==this.shapeBuilderMultiplexRenderTarget&&r.set("ShapeBuilderRenderTargetMode",0===this.shapeBuilderMultiplexRenderTarget.renderTargetMode?aa.name:Va.name),i.start(),this.eventChainTrackerToAppInfoMap.set(i,r)),t.setProp("x",e.pos.x),t.setProp("y",e.pos.y),t.setProp("width",e.size.width),t.setProp("height",e.size.height);const n=function(e){return new vn(new mn(e.pos.x,e.pos.y),new _n(e.size.width,e.size.height),new gn(e.flip.x,e.flip.y),e.rot)}(e);if(0!==window.devicePixelRatio){const e=1/window.devicePixelRatio;n.size.width*=e,n.size.height*=e,n.pos.x*=e,n.pos.y*=e}this.host.viewController.viewScale.viewTransform=n})}tryChangeRenderTarget(e,t){}setSelected(e){if(void 0===this.graphic)throw new Error("Graphic not initialized.");if(!cn(this.host.editController.selection))return;const t=this.host.editController.selection;e?t.addGraphics([this.graphic]):t.removeGraphics([this.graphic])}clearChildSelection(){if(void 0===this.graphic)throw new Error("Graphic not initialized.");if(!cn(this.host.editController.selection))return;this.host.editController.selection.childSelectionCollection.forEach(e=>{8e3===e.type?e.clear():o("0",55e3,"Selection is not of type SmartArtSelection")})}processKeyboardEvent(e){const t=new da(e);return"keyup"===e.type?this.keyboardEventNotifierMap.keyup.valid&&this.keyboardEventNotifierMap.keyup.value.emit(t):"keypress"===e.type?this.keyboardEventNotifierMap.keypress.valid&&this.keyboardEventNotifierMap.keypress.value.emit(t):"keydown"===e.type&&this.keyboardEventNotifierMap.keydown.valid&&this.keyboardEventNotifierMap.keydown.value.emit(t),this.convertEventProcessResultToPPTO(t.eventProcessResult)}processPointerEvent(e){const t=new va(e);return"mousedown"===e.type||"msospPointerDown"===e.type?this.pointerEventNotifierMap.pointerdown.value.emit(t):"mouseup"===e.type||"msospPointerUp"===e.type?this.pointerEventNotifierMap.pointerup.value.emit(t):"mousemove"!==e.type&&"msospPointerMove"!==e.type||this.pointerEventNotifierMap.pointermove.value.emit(t),this.convertEventProcessResultToPPTO(t.eventProcessResult)}getGraphicCollectionSelection(){const e=this.host.editController.selection;if(cn(e))return e}createHost(e,t,r,i,n,s,o,a){const h=new jo(this.getHostConfig(o,a,i));return oc(h.renderTargetRegistry,e.domRenderTarget,r,n,s,this.defaultHitTestPointerDownEventHandler),h.presenterCreatorRegistry.register($i(this.graphicCollectionPresenterSite,h.presenterCreatorRegistry,h.anchorPresenterCreatorRegistry)),o.renderTargetRegistry=h.renderTargetRegistry,h.createViewController(t,new Xo),h}getHostConfig(e,t,r){return{renderTargetEntries:[],anchorPresenterCreatorEntries:[[5e4,Yo],[55e3,Gh]],presenterCreatorEntries:zh,selectionCreatorEntries:Kh,selectionIterableCreatorRegistryEntries:Yh,selectionPresenterCreatorEntries:Qh,selectionViewDataCreatorEntries:jh,renderDataPresenterCreatorEntries:t,editorRegistryEntries:tc,keyboardEventNotifiers:r,actionInvoker:{invoke:this.invokeActionCallback},editPreviewInfo:e,renderDataEventHandlerCreatorRegistryEntries:[]}}convertEventProcessResultToPPTO(e){return new Oh(e)}}var cc=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};const lc=new class{constructor(){this._initStatus=0}createGraphicHost(e){if(0===this._initStatus)throw new Error("Factory isn't initialized");return new hc(e,this.sbContext)}init(e){return cc(this,void 0,void 0,(function*(){if(2!==this._initStatus){var t;if(this._initStatus=1,t=new Si(e.logger),s=t,function(e){xi=e}(new Pi(e.logger)),h("0",55002,"PowerPointGraphicFactory - init started"),void 0!==e.shapeBuilderConfig&&null!==e.shapeBuilderConfig){if(this.sbContext=function(e){return new Ti(e)}(e.shapeBuilderConfig),void 0===this.sbContext)return a("0",55002,"PowerPointGraphicFactory - undefined sbContext"),void(this._initStatus=3);if(yield this.sbContext.setupWebGLContext(),h("0",55002,"PowerPointGraphicFactory - isRendererReady:"+this.sbContext.isRendererReady),!this.sbContext.isRendererReady)return void(this._initStatus=3)}this._initStatus=2,h("0",55002,"PowerPointGraphicFactory - init ended; initStatus:"+this._initStatus)}}))}handleContextLost(){if(0===this._initStatus)throw new Error("Factory isn't initialized");void 0!==this.sbContext?this.sbContext.handleContextLost():h("0",55002,"undefined sbContext")}handleContextRestored(){return cc(this,void 0,void 0,(function*(){if(0===this._initStatus)throw new Error("Factory isn't initialized");void 0!==this.sbContext?yield this.sbContext.handleContextRestored():h("0",55002,"undefined sbContext")}))}getInitStatus(){return this._initStatus}isShapeBuilderRendererReady(){return void 0!==this.sbContext&&this.sbContext.isRendererReady}}}});
//# sourceMappingURL=Gc2HostPpt.js.map